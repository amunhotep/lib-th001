CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_R_CS_LINKS_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID           TYPE OF COLUMN TABL$R_CS_LINKS.CS_ID;
  DECLARE VARIABLE P_CS_CHILD_ID     TYPE OF COLUMN TABL$R_CS_LINKS.CS_CHILD_ID;
  DECLARE VARIABLE P_ID              TYPE OF COLUMN TABL$R_CS_LINKS.ID;
  DECLARE VARIABLE P_ID_NEW          TYPE OF COLUMN TABL$R_CS_LINKS.ID;
  DECLARE VARIABLE P_NAME            TYPE OF COLUMN TABL$R_CS_LINKS.NAME;
  DECLARE VARIABLE P_FLAG_DELETE     TYPE OF COLUMN TABL$R_CS_LINKS.FLAG_DELETE;
  DECLARE VARIABLE P_LINKTYPE_ID     TYPE OF COLUMN TABL$R_CS_LINKS.LINKTYPE_ID;
  DECLARE VARIABLE P_SQL_STMT        TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 2;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB TB WHERE(TRIM(UPPER(TB.ID)) = 'TABL$R_CS_LINKS') INTO :NAME;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_LINKS_ID RESTART WITH -999999;';

  P_SQL_STMT =
    'SELECT C.CS_ID, C.CS_CHILD_ID, C.LINKTYPE_ID, C.ID, C.NAME, C.FLAG_DELETE '||
    'FROM   TABL$R_CS_LINKS C '||
    'ORDER BY C.ID ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_CS_ID, :P_CS_CHILD_ID, :P_LINKTYPE_ID, :P_ID, :P_NAME, :P_FLAG_DELETE
  DO
    IF( (:P_CS_ID <> 0) AND (:P_CS_CHILD_ID <> 0) )THEN
      BEGIN
      UPDATE OR INSERT INTO TABL$R_CS_LINKS(CS_ID, CS_CHILD_ID, LINKTYPE_ID, ID, NAME, FLAG_DELETE)
        VALUES(:P_CS_ID, :P_CS_CHILD_ID, :P_LINKTYPE_ID, :P_ID, :P_NAME, :P_FLAG_DELETE)
        MATCHING(ID)
        RETURNING ID INTO :P_ID_NEW;
      UPDATE TABL$R_CS_LINKS L SET L.ID = :P_ID WHERE (L.ID = :P_ID_NEW);
      CNT = :CNT + 1;
      END

  -- GET SEQUENCE VALUE
  P_ID = 0;
  P_SQL_STMT = 'SELECT FIRST 1 GEN_ID(GENR$R_CS_LINKS_ID, 0) FROM RDB$DATABASE ';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION
    INTO :P_ID;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_LINKS_ID RESTART WITH '||:P_ID||';';
  SUSPEND;
END
