CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_1000062_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID           TYPE OF COLUMN TABL$J_1000062.CS_ID;
  DECLARE VARIABLE P_CS_ADDR_ID      TYPE OF COLUMN TABL$J_1000062.CS_ADDR_ID;
  DECLARE VARIABLE P_TMC_GROUP_ID    TYPE OF COLUMN TABL$J_1000062.TMC_GROUP_ID;
  DECLARE VARIABLE P_DATE_LAST       TYPE OF COLUMN TABL$J_1000062.DATE_LAST;
  DECLARE VARIABLE P_DOCSUMLEFT      TYPE OF COLUMN TABL$J_1000062.DOCSUMLEFT;
  DECLARE VARIABLE P_COUNTRIESTP_ID  TYPE OF COLUMN TABL$J_1000062.COUNTRIESTP_ID;

  DECLARE VARIABLE PD_ID             TYPE OF COLUMN TABL$D_1000062.ID;
  DECLARE VARIABLE PD_ID_NEW         TYPE OF COLUMN TABL$D_1000062.ID;
  DECLARE VARIABLE PD_NAME           TYPE OF COLUMN TABL$D_1000062.NAME;
  DECLARE VARIABLE PD_FLAG_DELETE    TYPE OF COLUMN TABL$D_1000062.FLAG_DELETE;
  DECLARE VARIABLE PD_TMC_GROUP_ID   TYPE OF COLUMN TABL$D_1000062.TMC_GROUP_ID;
  DECLARE VARIABLE PD_COUNTRY_ID     TYPE OF COLUMN TABL$D_1000062.COUNTRY_ID;
  DECLARE VARIABLE PD_PROBE          TYPE OF COLUMN TABL$D_1000062.PROBE;
  DECLARE VARIABLE PD_MASSA_BRUTTO   TYPE OF COLUMN TABL$D_1000062.MASSA_BRUTTO;
  DECLARE VARIABLE PD_PRICE          TYPE OF COLUMN TABL$D_1000062.PRICE;
  DECLARE VARIABLE PD_QUANT          TYPE OF COLUMN TABL$D_1000062.QUANT;
  DECLARE VARIABLE PD_DEV_COUNTRY_ID TYPE OF COLUMN TABL$D_1000062.DEV_COUNTRY_ID;
  DECLARE VARIABLE PD_BRAND_ID       TYPE OF COLUMN TABL$D_1000062.BRAND_ID;
  DECLARE VARIABLE PD_YEAR_ID        TYPE OF COLUMN TABL$D_1000062.YEAR_ID;
  DECLARE VARIABLE PD_STATEFINE      TYPE OF COLUMN TABL$D_1000062.STATEFINE;
  DECLARE VARIABLE PD_COMENT         TYPE OF COLUMN TABL$D_1000062.COMENT;
  DECLARE VARIABLE PD_MODELNAME      TYPE OF COLUMN TABL$D_1000062.MODELNAME;
  DECLARE VARIABLE PD_SERIAL         TYPE OF COLUMN TABL$D_1000062.SERIAL;
  DECLARE VARIABLE PD_IMG            TYPE OF COLUMN TABL$D_1000062.IMG;
  DECLARE VARIABLE PD_LGTH           TYPE OF COLUMN TABL$D_1000062.LGTH;
  DECLARE VARIABLE PD_DIAM           TYPE OF COLUMN TABL$D_1000062.DIAM;
  DECLARE VARIABLE PD_AUTOTYPE       TYPE OF COLUMN TABL$D_1000062.AUTOTYPE;
  DECLARE VARIABLE PD_AUTONUMBER     TYPE OF COLUMN TABL$D_1000062.AUTONUMBER;
  DECLARE VARIABLE PD_AUTOPASSPORT   TYPE OF COLUMN TABL$D_1000062.AUTOPASSPORT;
  DECLARE VARIABLE PD_AUTOWHEELS     TYPE OF COLUMN TABL$D_1000062.AUTOWHEELS;
  DECLARE VARIABLE PD_AUTOENGINE     TYPE OF COLUMN TABL$D_1000062.AUTOENGINE;
  DECLARE VARIABLE PD_AUTOCOLOR      TYPE OF COLUMN TABL$D_1000062.AUTOCOLOR;

  DECLARE VARIABLE PDS_COLOR_ID      TYPE OF COLUMN TABL$D_1000062S.COLOR_ID;
  DECLARE VARIABLE PDS_QUANT         TYPE OF COLUMN TABL$D_1000062S.QUANT;
  DECLARE VARIABLE PDS_MASSA         TYPE OF COLUMN TABL$D_1000062S.MASSA;

  DECLARE VARIABLE P_SQL_STMT        TYPE OF COLUMN TABL$J_4.DOCSTR;
  DECLARE VARIABLE P_SQL_STMT_DETAIL TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000062;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  P_SQL_STMT =
    'SELECT FIRST 1 JZ.CS_ID, JZ.CS_ADDR_ID, JZ.TMC_GROUP_ID, JZ.DATE_LAST, JZ.DOCSUMLEFT, JZ.COUNTRIESTP_ID '||
    'FROM   TABL$J_1000062 JZ '||
    'WHERE  (JZ.J_ID = '''||:Q_J_ID||''') ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO  :P_CS_ID, :P_CS_ADDR_ID, :P_TMC_GROUP_ID, :P_DATE_LAST, :P_DOCSUMLEFT, :P_COUNTRIESTP_ID
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_1000062(J_ID, CS_ID, CS_ADDR_ID, TMC_GROUP_ID, DATE_LAST, DOCSUMLEFT, COUNTRIESTP_ID)
      VALUES (:Q_J_ID, :P_CS_ID, :P_CS_ADDR_ID, :P_TMC_GROUP_ID, :P_DATE_LAST, :P_DOCSUMLEFT, :P_COUNTRIESTP_ID)
      MATCHING(J_ID);
    CNT = :CNT + 1;
    END
  NAME = '    +-- PROC$_EXCHANGE_J_1000062_ARC ('||:Q_J_ID||')';
  SUSPEND;

  CNT = 0;
  SELECT FIRST 1 TB.NAME2 FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;
  DELETE FROM TABL$D_1000062 D62 WHERE D62.J_ID = :Q_J_ID;
  P_SQL_STMT =
    'SELECT  DP.ID, DP.NAME, DP.FLAG_DELETE, DP.TMC_GROUP_ID, DP.COUNTRY_ID, DP.PROBE '||
    '       ,DP.MASSA_BRUTTO, DP.PRICE, DP.QUANT '||
    '       ,DP.DEV_COUNTRY_ID, DP.BRAND_ID, DP.YEAR_ID, DP.STATEFINE '||
    '       ,DP.COMENT, DP.MODELNAME, DP.SERIAL, DP.IMG, DP.LGTH, DP.DIAM '||
    '       ,DP.AUTOTYPE, DP.AUTONUMBER, DP.AUTOPASSPORT, DP.AUTOWHEELS, DP.AUTOENGINE, DP.AUTOCOLOR  '||
    'FROM   TABL$D_1000062 DP '||
    'WHERE  (DP.J_ID = '''||:Q_J_ID||''') ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO  :PD_ID, :PD_NAME, :PD_FLAG_DELETE, :PD_TMC_GROUP_ID, :PD_COUNTRY_ID, :PD_PROBE
         ,:PD_MASSA_BRUTTO, :PD_PRICE, :PD_QUANT
         ,:PD_DEV_COUNTRY_ID, :PD_BRAND_ID, :PD_YEAR_ID, :PD_STATEFINE
         ,:PD_COMENT, :PD_MODELNAME, :PD_SERIAL, :PD_IMG, :PD_LGTH, :PD_DIAM
         ,:PD_AUTOTYPE,:PD_AUTONUMBER,:PD_AUTOPASSPORT,:PD_AUTOWHEELS,:PD_AUTOENGINE,:PD_AUTOCOLOR
  DO
    BEGIN
    -- INSERTING DATA
    INSERT INTO TABL$D_1000062 (J_ID, NAME, FLAG_DELETE, TMC_GROUP_ID, COUNTRY_ID
      ,PROBE, MASSA_BRUTTO, MASSA_INS, PRICE, QUANT
      ,DEV_COUNTRY_ID, BRAND_ID, YEAR_ID, STATEFINE
      ,COMENT, MODELNAME, SERIAL, IMG, LGTH, DIAM
      ,AUTOTYPE, AUTONUMBER, AUTOPASSPORT, AUTOWHEELS, AUTOENGINE, AUTOCOLOR
    )VALUES (:Q_J_ID, :PD_NAME, :PD_FLAG_DELETE, :PD_TMC_GROUP_ID, :PD_COUNTRY_ID
      ,:PD_PROBE, :PD_MASSA_BRUTTO, 0, :PD_PRICE, :PD_QUANT
      ,:PD_DEV_COUNTRY_ID, :PD_BRAND_ID, :PD_YEAR_ID, :PD_STATEFINE
      ,:PD_COMENT, :PD_MODELNAME, :PD_SERIAL, :PD_IMG, :PD_LGTH, :PD_DIAM
      ,:PD_AUTOTYPE, :PD_AUTONUMBER,:PD_AUTOPASSPORT,:PD_AUTOWHEELS,:PD_AUTOENGINE,:PD_AUTOCOLOR
    )RETURNING ID INTO :PD_ID_NEW;
    --INSERTING STONES
    P_SQL_STMT_DETAIL =
      'SELECT S.COLOR_ID, S.MASSA, S.QUANT '||
      'FROM   TABL$D_1000062S S '||
      'WHERE  (S.D_ID = '''||:PD_ID||''') ORDER BY S.ID';
    FOR
      EXECUTE STATEMENT :P_SQL_STMT_DETAIL
        ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
        WITH AUTONOMOUS TRANSACTION
      INTO :PDS_COLOR_ID, :PDS_MASSA, :PDS_QUANT
    DO
      INSERT INTO TABL$D_1000062S(D_ID, COLOR_ID, MASSA, QUANT)
        VALUES(:PD_ID_NEW, :PDS_COLOR_ID, :PDS_MASSA, :PDS_QUANT);

    CNT = :CNT + 1;
    END
  NAME = '        +-- TABL$D_1000062 ('||:Q_J_ID||')';
  SUSPEND;
END
