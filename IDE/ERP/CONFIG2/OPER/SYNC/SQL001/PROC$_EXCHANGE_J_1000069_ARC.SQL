CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_1000069_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID       TYPE OF COLUMN TABL$J_1000069.CS_ID;
  DECLARE VARIABLE P_DATE_RETURN TYPE OF COLUMN TABL$J_1000069.DATE_RETURN;

  DECLARE VARIABLE P_SQL_STMT    TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000069;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  P_SQL_STMT = 'SELECT FIRST 1 JC.CS_ID, JC.DATE_RETURN FROM TABL$J_1000069 JC WHERE(JC.J_ID = '''||:Q_J_ID||''') ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_CS_ID, :P_DATE_RETURN
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_1000069 (J_ID, CS_ID, DATE_RETURN)
      VALUES(:Q_J_ID, :P_CS_ID, :P_DATE_RETURN)
      MATCHING(J_ID);
    CNT = :CNT + 1;
    END
  NAME = '    +-- PROC$_EXCHANGE_J_1000069_ARC ('||:Q_J_ID||')';
  SUSPEND;
END
