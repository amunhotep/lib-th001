CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_1000016_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_FLAG_DEBET      TYPE OF COLUMN TABL$J_1000016.FLAG_DEBET;
  DECLARE VARIABLE P_PAYSRC_ID       TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID;
  DECLARE VARIABLE P_ACC_ID          TYPE OF COLUMN TABL$J_1000016.ACC_ID;
  DECLARE VARIABLE P_SUBKONTO_ID     TYPE OF COLUMN TABL$J_1000016.SUBKONTO_ID;
  DECLARE VARIABLE P_EXPTYPE_ID      TYPE OF COLUMN TABL$J_1000016.EXPTYPE_ID;
  DECLARE VARIABLE P_REASON          TYPE OF COLUMN TABL$J_1000016.REASON;
  DECLARE VARIABLE P_SQL_STMT        TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000016;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  P_SQL_STMT =
    'SELECT FIRST 1 JC.FLAG_DEBET, JC.PAYSRC_ID, JC.ACC_ID, JC.SUBKONTO_ID, JC.EXPTYPE_ID, JC.REASON '||
    'FROM   TABL$J_1000016 JC '||
    'WHERE  (JC.J_ID = '''||:Q_J_ID||''') ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_FLAG_DEBET, :P_PAYSRC_ID, :P_ACC_ID, :P_SUBKONTO_ID, :P_EXPTYPE_ID, :P_REASON
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_1000016 (J_ID, FLAG_DEBET, PAYSRC_ID, ACC_ID, SUBKONTO_ID, EXPTYPE_ID, REASON)
      VALUES (:Q_J_ID, :P_FLAG_DEBET, :P_PAYSRC_ID, :P_ACC_ID, :P_SUBKONTO_ID, :P_EXPTYPE_ID, :P_REASON)
      MATCHING(J_ID);
    CNT = :CNT + 1;
    END

  NAME = '    +-- PROC$_EXCHANGE_J_1000016_ARC ('||:Q_J_ID||')';
  SUSPEND;
END
