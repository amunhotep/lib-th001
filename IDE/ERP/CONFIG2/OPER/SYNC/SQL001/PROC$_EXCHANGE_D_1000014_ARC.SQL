CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_D_1000014_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_ID             TYPE OF COLUMN TABL$D_1000014.ID;

  DECLARE VARIABLE P_NAME           TYPE OF COLUMN TABL$D_1000014.NAME;
  DECLARE VARIABLE P_FLAG_DELETE    TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE;
  DECLARE VARIABLE P_TMC_ID         TYPE OF COLUMN TABL$D_1000014.TMC_ID;
  DECLARE VARIABLE P_PRICE          TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE P_QUANT          TYPE OF COLUMN TABL$D_1000014.QUANT;
  DECLARE VARIABLE P_J_BILLS_ID     TYPE OF COLUMN TABL$D_1000014.J_BILLS_ID;
  DECLARE VARIABLE P_PRICE_TMC      TYPE OF COLUMN TABL$D_1000014.PRICE_TMC;

  DECLARE VARIABLE P_SQL_STMT       TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000014;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME2 FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  DELETE FROM TABL$D_1000014 D WHERE (D.J_ID = :Q_J_ID);

  P_SQL_STMT =
    'SELECT D.NAME, D.FLAG_DELETE, D.TMC_ID, D.PRICE, D.QUANT, D.J_BILLS_ID, D.PRICE_TMC '||
    'FROM   TABL$D_1000014 D '||
    'WHERE  (D.J_ID = '''||:Q_J_ID||''') ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_NAME, :P_FLAG_DELETE, :P_TMC_ID, :P_PRICE, :P_QUANT, :P_J_BILLS_ID, :P_PRICE_TMC
  DO
    BEGIN
    IF(:P_PRICE IS NULL)THEN P_PRICE = 0;
    --EXCEPTION EXPT$_ERROR_00000 'PRICE IS NULL!';
    INSERT INTO TABL$D_1000014 (NAME, FLAG_DELETE, J_ID, TMC_ID, PRICE, QUANT, J_BILLS_ID, PRICE_TMC)
      VALUES (:P_NAME, :P_FLAG_DELETE, :Q_J_ID, :P_TMC_ID, :P_PRICE, :P_QUANT, :P_J_BILLS_ID, :P_PRICE_TMC )
      RETURNING ID INTO :P_ID;
    -- наундхл юбрнгюонкмемхе жемш
    UPDATE TABL$D_1000014 D1 SET
      D1.PRICE     = :P_PRICE
     ,D1.PRICE_TMC = :P_PRICE_TMC
    WHERE (D1.ID = :P_ID);
    CNT = :CNT + 1;
    END
  NAME = '        +-- PROC$_EXCHANGE_D_1000014_ARC ('||:Q_J_ID||')';
  SUSPEND;
END
