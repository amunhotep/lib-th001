CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_PS_ARC001 (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD)
RETURNS (
  FILIAL_ID   TYPE OF COLUMN TABL$R_FILIALS.ID,
  FILIAL_NAME TYPE OF COLUMN TABL$R_FILIALS.NAME,
  TYPE_ID     TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME        TYPE OF COLUMN TABL$_TB.NAME,
  CNT         TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_DB_GIUD  TYPE OF COLUMN TABL$R_FILIALS.GUID;
  DECLARE VARIABLE P_SQL_STMT TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 0;
  NAME    = '';
  CNT     = 0;

  P_SQL_STMT = 'SELECT COUNT(P.RDB$PROCEDURE_ID) FROM RDB$PROCEDURES P WHERE (TRIM(P.RDB$PROCEDURE_NAME) = ''PROC$_DB_GUID'') ';
  EXECUTE STATEMENT :P_SQL_STMT ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION INTO :CNT;
  IF(NOT(:CNT > 0))THEN
    BEGIN
    EXCEPTION EXPT$_ERROR_00000 'Ќеверный формат базы данных !';
    SUSPEND;
    EXIT;
    END
  CNT = 0;

  P_SQL_STMT = 'SELECT FIRST 1 P.GUID FROM PROC$_DB_GUID P ';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION
  INTO :P_DB_GIUD;

  IF(NOT(EXISTS(SELECT F.ID FROM TABL$R_FILIALS F WHERE (F.GUID = :P_DB_GIUD))))THEN
    BEGIN
    EXCEPTION EXPT$_ERROR_00000 '“акого филиала не существует !';
    SUSPEND;
    EXIT;
    END

  SELECT FIRST 1 F.ID, F.NAME
  FROM   TABL$R_FILIALS F
  WHERE  (F.GUID = :P_DB_GIUD)
  INTO   :FILIAL_ID, :FILIAL_NAME;

  IF(NOT(EXISTS(SELECT P.GUID FROM PROC$_DB_GUID P WHERE (P.GUID = :P_DB_GIUD))))THEN
    BEGIN
    EXCEPTION EXPT$_ERROR_00000 'Ёто базы разных филиалов !';
    SUSPEND;
    EXIT;
    END

  P_SQL_STMT = 'EXECUTE BLOCK AS BEGIN RDB$SET_CONTEXT(''USER_SESSION'', ''DATABASE_USER'', '''||
    RDB$GET_CONTEXT('USER_SESSION','DATABASE_USER')||'''); END';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH COMMON TRANSACTION;

  P_SQL_STMT = 'EXECUTE BLOCK AS BEGIN RDB$SET_CONTEXT(''USER_SESSION'',''AMUNHOTEP_VERSION'', ''Firebird v'||
    RDB$GET_CONTEXT('SYSTEM','ENGINE_VERSION')||'''); END';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH COMMON TRANSACTION;

  FOR
    SELECT  P1.TYPE_ID, P1.NAME, P1.CNT
    FROM    PROC$_EXCHANGE_R_CS_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P1
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P2.TYPE_ID, P2.NAME, P2.CNT
    FROM    PROC$_EXCHANGE_R_CS_ADDR_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P2
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P3.TYPE_ID, P3.NAME, P3.CNT
    FROM    PROC$_EXCHANGE_R_CS_PHONES_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P3
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P4.TYPE_ID, P4.NAME, P4.CNT
    FROM    PROC$_EXCHANGE_R_CS_DOCS_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P4
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P4.TYPE_ID, P4.NAME, P4.CNT
    FROM    PROC$_EXCHANGE_R_CS_LINKS_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P4
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P5.TYPE_ID, P5.NAME, P5.CNT
    FROM    PROC$_EXCHANGE_R_TMC_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P5
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  TYPE_ID = 4;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;
  CNT     = 0;
  SUSPEND;
  FOR
    SELECT  P6.TYPE_ID, P6.NAME, P6.CNT
    FROM    PROC$_EXCHANGE_J_4_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P6
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
  FOR
    SELECT  P101.TYPE_ID, P101.NAME, P101.CNT
    FROM    PROC$_EXCHANGE_J_COMENTS_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :FILIAL_ID) P101
    INTO    :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
END
