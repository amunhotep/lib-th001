EXECUTE BLOCK (
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)AS
  DECLARE VARIABLE P_J_ID        TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_PROC_NAME   TYPE OF COLUMN TABL$_TB.ID;
  DECLARE VARIABLE P_SQL_STMT    TYPE OF COLUMN TABL$_EXCHANGE_SQL.SRC;
  DECLARE VARIABLE P_WRK_ID      TYPE OF COLUMN TABL$D_1000046.WRK_ID;
  DECLARE VARIABLE P_WRK_NAME    TYPE OF COLUMN TABL$D_1000046.NAME;
  DECLARE VARIABLE P_WRK_POST_ID TYPE OF COLUMN TABL$D_1000046.WRK_POST_ID;
  DECLARE VARIABLE P_DATE_DOC    TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_DATE_FROM   TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_DATE_TO     TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_DATE_BEGIN  TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_DATE_END    TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_FLAG_DELETE TYPE OF COLUMN TABL$J_4.FLAG_COMMIT;
  DECLARE VARIABLE P_FILIAL_ID   TYPE OF COLUMN TABL$R_FILIALS.ID;
  DECLARE VARIABLE P_SUBKONTO_NAME  TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME;
  DECLARE VARIABLE P_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_SUM_ADV     TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_SUM_PAY     TYPE OF COLUMN TABL$J_4.DOCSUM;
BEGIN
  P_J_ID = :Q_J_ID;
  DELETE FROM TABL$D_1000017 D WHERE (D.J_ID = :P_J_ID) AND (D.ACC_ID = 661); 
  DELETE FROM TABL$D_1000017 D WHERE (D.J_ID = :P_J_ID) AND (D.ACC_ID = 651); 
  DELETE FROM TABL$D_1000017 D WHERE (D.J_ID = :P_J_ID) AND (D.ACC_ID = 6411); 
  SELECT FIRST 1 J.FIRM_ID, j.DATE_COMMIT
  FROM   TABL$J_4 J
  WHERE  (J.ID = :p_J_ID)
  INTO   :P_FIRM_ID, :P_DATE_DOC;
  SELECT FIRST 1 P.BEGIN_OF_MONTH, P.END_OF_MONTH
  FROM   PROC$__DATE_MONTH(:P_DATE_DOC) P
  INTO   :P_DATE_FROM, :P_DATE_TO;
  P_DATE_FROM = DATEADD(-1 MONTH TO :P_DATE_FROM);
  P_DATE_TO   = DATEADD(-1 MONTH TO :P_DATE_TO  );
  FOR
    SELECT W.WRK_ID, W.WRK_POST_ID, W.DATE_BEGIN, W.DATE_END
    FROM   TABL$R_WRK_WORK W
    WHERE  ((W.FIRM_ID+0) = :P_FIRM_ID)
      AND  (W.DATE_BEGIN <= :P_DATE_TO)
      AND  (W.DATE_END   >= :P_DATE_FROM)
    ORDER BY W.WRK_POST_ID
    INTO   :P_WRK_ID, :P_WRK_POST_ID, :P_DATE_BEGIN, :P_DATE_END
  DO
    BEGIN
    P_WRK_NAME = '';
    P_SUBKONTO_NAME = '';
    SELECT FIRST 1 COALESCE(W.NAME,'')
    FROM   TABL$R_WRK W
    WHERE  (W.ID = :P_WRK_ID)
    INTO   :P_WRK_NAME;
    P_FLAG_DELETE = 0;
    P_FILIAL_ID = 0;
    SELECT FIRST 1 COALESCE(F.ID,0)
    FROM   TABL$R_FILIALS F
    WHERE  (F.WRK_ID = :P_WRK_ID)
    INTO   :P_FILIAL_ID;
    IF(:P_FILIAL_ID = 0)THEN
      SELECT FIRST 1 COALESCE(F.ID,0)
      FROM   TABL$R_FILIALS F
      WHERE  (F.WRK_ID2 = :P_WRK_ID)
      INTO   :P_FILIAL_ID;
    P_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :P_DATE_FROM AND :P_DATE_TO)
      AND  ((CND.FIRM_ID+0) = :P_FIRM_ID)
      AND  (CND.ACC_ID_KRED = 661)
      AND  (CND.SUBKONTO_ID_KRED = :P_WRK_ID)
    INTO   :P_SUM; IF(:P_SUM IS NULL)THEN P_SUM = 0;
    P_SUM_PAY = :P_SUM;

    P_SUM_ADV = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :P_DATE_FROM AND :P_DATE_TO)
      AND  ((CND.FIRM_ID+0) = :P_FIRM_ID)
      AND  (CND.ACC_ID_DEB = 661)
      AND  (CND.SUBKONTO_ID_DEB = :P_WRK_ID)
      AND  (CND.ACC_ID_KRED = 651)
      AND  (CND.SUBKONTO_ID_KRED = 1000011)
    INTO   :P_SUM_ADV; IF(:P_SUM_ADV IS NULL)THEN P_SUM_ADV = 0;
    P_SUM_PAY = :P_SUM_PAY - :P_SUM_ADV;
      P_SUBKONTO_NAME = '';
      SELECT FIRST 1 COALESCE(T.NAME,'') FROM TABL$R_TAXES T WHERE (T.ID = 1000011) INTO :P_SUBKONTO_NAME; 
      INSERT INTO TABL$D_1000017(FLAG_DELETE, J_ID, FLAG_DEBET, ACC_ID, SUBKONTO_ID, SUBKONTO_NAME, TAX_ID, SUBTYPE_ID
        ,J_REASON_ID, J_REASON_SUM, J_REASON_NDP, J_REASON_DONE, FLAG_OLD, PAYSUM, PAYSUMCLEAR
        ,PAYSUMNDP, EXPTYPE_ID, FILIAL_ID, FLAG_UPDNDP, NAME
      )VALUES (0, :P_J_ID, 0, 651, 1000011, :P_SUBKONTO_NAME, 1000008, 0, 0, 0, 0, 0, 0, :P_SUM_ADV, 0, 0, 0, :P_FILIAL_ID, 0, :P_WRK_NAME);
    P_SUM_ADV = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :P_DATE_FROM AND :P_DATE_TO)
      AND  ((CND.FIRM_ID+0) = :P_FIRM_ID)
      AND  (CND.ACC_ID_DEB = 661)
      AND  (CND.SUBKONTO_ID_DEB = :P_WRK_ID)
      AND  (CND.ACC_ID_KRED = 6411)
      AND  (CND.SUBKONTO_ID_KRED = 1000012)
    INTO   :P_SUM_ADV; IF(:P_SUM_ADV IS NULL)THEN P_SUM_ADV = 0;
    P_SUM_PAY = :P_SUM_PAY - :P_SUM_ADV;
      P_SUBKONTO_NAME = '';
      SELECT FIRST 1 COALESCE(T.NAME,'') FROM TABL$R_TAXES T WHERE (T.ID = 1000012) INTO :P_SUBKONTO_NAME; 
      INSERT INTO TABL$D_1000017(FLAG_DELETE, J_ID, FLAG_DEBET, ACC_ID, SUBKONTO_ID, SUBKONTO_NAME, TAX_ID, SUBTYPE_ID
        ,J_REASON_ID, J_REASON_SUM, J_REASON_NDP, J_REASON_DONE, FLAG_OLD, PAYSUM, PAYSUMCLEAR
        ,PAYSUMNDP, EXPTYPE_ID, FILIAL_ID, FLAG_UPDNDP, NAME
      )VALUES (0, :P_J_ID, 0, 6411, 1000012, :P_SUBKONTO_NAME, 1000008, 0, 0, 0, 0, 0, 0, :P_SUM_ADV, 0, 0, 0, :P_FILIAL_ID, 0, :P_WRK_NAME);

    P_SUM_ADV = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :P_DATE_FROM AND :P_DATE_TO)
      AND  ((CND.FIRM_ID+0) = :P_FIRM_ID)
      AND  (CND.ACC_ID_DEB = 661)
      AND  (CND.SUBKONTO_ID_DEB = :P_WRK_ID)
      AND  ('~6611~6612~6613~' CONTAINING '~'||CND.ACC_ID_KRED||'~')
    INTO   :P_SUM_ADV; IF(:P_SUM_ADV IS NULL)THEN P_SUM_ADV = 0;
    P_SUM_PAY = :P_SUM_PAY - :P_SUM_ADV;
    INSERT INTO TABL$D_1000017(FLAG_DELETE, J_ID, FLAG_DEBET, ACC_ID, SUBKONTO_ID, SUBKONTO_NAME, TAX_ID, SUBTYPE_ID
      ,J_REASON_ID, J_REASON_SUM, J_REASON_NDP, J_REASON_DONE, FLAG_OLD, PAYSUM, PAYSUMCLEAR
      ,PAYSUMNDP, EXPTYPE_ID, FILIAL_ID, FLAG_UPDNDP
    )VALUES (0, :P_J_ID, 0, 661, :P_WRK_ID, :P_WRK_NAME, 1000008, 0, 0, 0, 0, 0, 0, :P_SUM_PAY, 0, 0, 0, :P_FILIAL_ID, 0);

    P_SUM_ADV = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :P_DATE_FROM AND :P_DATE_TO)
      AND  ((CND.FIRM_ID+0) = :P_FIRM_ID)
      AND  (CND.ACC_ID_DEB = 821)
      AND  (CND.SUBKONTO_ID_DEB = :P_WRK_ID)
      AND  (CND.ACC_ID_KRED = 651)
      AND  (CND.SUBKONTO_ID_KRED = 1000017)
    INTO   :P_SUM_ADV; IF(:P_SUM_ADV IS NULL)THEN P_SUM_ADV = 0;
      P_SUBKONTO_NAME = '';
      SELECT FIRST 1 COALESCE(T.NAME,'') FROM TABL$R_TAXES T WHERE (T.ID = 1000017) INTO :P_SUBKONTO_NAME; 
      INSERT INTO TABL$D_1000017(FLAG_DELETE, J_ID, FLAG_DEBET, ACC_ID, SUBKONTO_ID, SUBKONTO_NAME, TAX_ID, SUBTYPE_ID
        ,J_REASON_ID, J_REASON_SUM, J_REASON_NDP, J_REASON_DONE, FLAG_OLD, PAYSUM, PAYSUMCLEAR
        ,PAYSUMNDP, EXPTYPE_ID, FILIAL_ID, FLAG_UPDNDP, NAME
      )VALUES (0, :P_J_ID, 0, 651, 1000017, :P_SUBKONTO_NAME, 1000008, 0, 0, 0, 0, 0, 0, :P_SUM_ADV, 0, 0, 0, :P_FILIAL_ID, 0, :P_WRK_NAME);
    END
END
