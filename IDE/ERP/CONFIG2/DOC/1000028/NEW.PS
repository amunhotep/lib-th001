{$IFNDEF PEAKTOP:IDE/ERP/CONFIG/REF/FIRMS/DIALOGCASEITEM.INC}
  {$I PEAKTOP:IDE/ERP/CONFIG/REF/FIRMS/DIALOGCASEITEM.INC}
{$ENDIF} 
{$IFNDEF PEAKTOP:IDE/ERP/CONFIG2/DOC/EXTRACT_TYPE.INC}
  {$I ../EXTRACT_TYPE.INC}
{$ENDIF} 
var
  lkFirmId :string;
  lkDocIds :array of string;
  lkSQL    :string;
begin
  if not ERPDialogCaseReferenceItem_Firm_Execute(lkFirmId) then exit;

  lkSQL := 
    'EXECUTE BLOCK RETURNS ( '+SQLCRLF+
    '   J_ID       TYPE OF COLUMN TABL$J_4.ID '+SQLCRLF+
    '  ,DOCTYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID '+SQLCRLF+
    ')AS '+SQLCRLF+
    '  DECLARE VARIABLE P_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_CS_ID         TYPE OF COLUMN TABL$R_CS.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_CS_ADDR_ID    TYPE OF COLUMN TABL$R_ADDRESS.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_CS_DOC_ID     TYPE OF COLUMN TABL$R_DOC.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_CS_AMOUNT     TYPE OF COLUMN TABL$R_CS_P.AMOUNT; '+SQLCRLF+
    '  DECLARE VARIABLE P_PLACE_ID      TYPE OF COLUMN TABL$R_PLACES.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_PLACE_ID_TO   TYPE OF COLUMN TABL$R_PLACES.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_WRK_ID        TYPE OF COLUMN TABL$R_WRK.ID; '+SQLCRLF+
    'BEGIN '+SQLCRLF+
    '  DOCTYPE_ID   = '+ExtractTypeIdFromCurrentScript+'; '+SQLCRLF+
    '  P_FIRM_ID    = '+lkFirmId+'; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_CS_ID      = -2; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_CS_AMOUNT  = 0;  '+SQLCRLF+
    '  SELECT FIRST 1 COALESCE(P.AMOUNT, 0) '+SQLCRLF+
    '  FROM   TABL$R_CS C, TABL$R_CS_P P '+SQLCRLF+
    '  WHERE  (C.ID         = :P_CS_ID) '+SQLCRLF+
    '    AND  (P.CS_ID      = C.ID) '+SQLCRLF+
    '    AND  (P.VALUE_DATE = C.VALUE_DATE) '+SQLCRLF+
    '  INTO   :P_CS_AMOUNT; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_CS_ADDR_ID = 0; '+SQLCRLF+
    '  SELECT FIRST 1 COALESCE(A.ID, 0) '+SQLCRLF+
    '  FROM   VIEW$R_CS_ADDR A '+SQLCRLF+
    '  WHERE  (A.CS_ID          = :P_CS_ID) '+SQLCRLF+
    '    AND  (A.FLAG_JURIDICAL = 1) '+SQLCRLF+
    '  INTO   :P_CS_ADDR_ID; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_CS_DOC_ID  = 0; '+SQLCRLF+
    '  SELECT FIRST 1 COALESCE(D.ID, 0) '+SQLCRLF+
    '  FROM   VIEW$R_CS_DOCS D '+SQLCRLF+
    '  WHERE  (D.CS_ID      = :P_CS_ID) '+SQLCRLF+
    '    AND  (D.DOCTYPE_ID = 1000032) '+SQLCRLF+
    '  INTO   :P_CS_DOC_ID; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_PLACE_ID  = 0; '+SQLCRLF+
    '  SELECT COALESCE(MIN(P.ID), 0) '+SQLCRLF+
    '  FROM   TABL$R_PLACES P '+SQLCRLF+
    '  WHERE  (P.FILIAL_ID = (SELECT FIRST 1 F.ID FROM PROC$R_FILIALS_DEFAULT F)) '+SQLCRLF+
    '  INTO   :P_PLACE_ID; '+SQLCRLF+
    '  IF(:P_PLACE_ID = 0)THEN '+SQLCRLF+
    '    SELECT COALESCE(MIN(P.ID), 0) '+SQLCRLF+
    '    FROM   TABL$R_PLACES P '+SQLCRLF+
    '    INTO   :P_PLACE_ID; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_PLACE_ID_TO  = 0; '+SQLCRLF+
    ' '+SQLCRLF+
    '  P_WRK_ID = 0; '+SQLCRLF+
    '  SELECT FIRST 1 COALESCE(W.ID, 0) '+SQLCRLF+
    '  FROM   TABL$R_WRK W '+SQLCRLF+
    '  WHERE  (TRIM(W.USER_NAME) = RDB$GET_CONTEXT(''USER_SESSION'', '''+ERP_GLOBALVARIABLE_USER_CURRENT+''')) '+SQLCRLF+
    '  INTO   :P_WRK_ID; '+SQLCRLF+
    ' '+SQLCRLF+
    '  SELECT FIRST 1 P.J_ID FROM PROC$J$INS(NULL, :P_FIRM_ID, :DOCTYPE_ID) P INTO :J_ID; '+SQLCRLF+
    ' '+SQLCRLF+
    '  UPDATE OR INSERT INTO TABL$J_1000014(J_ID '+SQLCRLF+
    '    ,CS_ID, CS_ADDR_ID, CS_DOC_ID, CS_POINTS, CS_POINTSPAYED, CS_AMOUNT, FLAG_AMOUNT '+SQLCRLF+
    '    ,PLACE_ID, TO_PLACE_ID, PLATENO, GUESTQUANT, WRK_ID, J_ID_PAY, D_ID_PAY '+SQLCRLF+
    '    ,FLAG_PAY, FLAG_CALC '+SQLCRLF+
    '  )VALUES (:J_ID, :P_CS_ID, :P_CS_ADDR_ID, :P_CS_DOC_ID, 0, 0, :P_CS_AMOUNT, 0 '+SQLCRLF+
    '    ,:P_PLACE_ID, :P_PLACE_ID_TO, 0, 0, :P_WRK_ID, 0, 0 '+SQLCRLF+
    '    ,0, 0 '+SQLCRLF+
    '  )MATCHING (J_ID); '+SQLCRLF+
    ' '+SQLCRLF+
    '  SUSPEND; '+SQLCRLF+
    'END ';
 
  SetLength(lkDocIds, 1)
  if not TERPForm_SelectSQLParams([], lkSQL, [],[], ['J_ID'], lkDocIds)then exit;
  SetGlobalVariable('J_ID', lkDocIds[0]);
  call(StrAbsolutePath('./EDIT.PS', ScriptName));  
end.
