EXECUTE BLOCK (
   Q_DOCSUM        TYPE OF COLUMN TABL$J_4.DOCSUM             = ?DOCSUM
  ,Q_SUMPC         TYPE OF COLUMN TABL$J_4.DOCSUM             = ?SUMPC
  ,Q_SUMPCPEN      TYPE OF COLUMN TABL$J_4.DOCSUM             = ?SUMPCPEN
  ,Q_PC            TYPE OF COLUMN TABL$J_1000063.PC           = ?PC
  ,Q_PCPEN         TYPE OF COLUMN TABL$J_1000063.PC           = ?PCPEN
  ,Q_DAYS_CNT      TYPE OF COLUMN TABL$J_1000063.DAYSCNT      = ?DAYSCNT
  ,Q_DATE_RETURN   TYPE OF COLUMN TABL$J_1000063.DATE_RETURN  = ?DATE_RETURN
  ,Q_CARDNUM       TYPE OF COLUMN TABL$J_1000063.CARDNUM      = ?CARDNUM
  ,Q_CARDAMOUNT    TYPE OF COLUMN TABL$J_1000063.CARDAMOUNT   = ?CARDAMOUNT
  ,Q_PARENT_DOC_ID TYPE OF COLUMN TABL$J_4.ID                 = ?PARENT_DOC_ID
  ,Q_PAYSRC_ID     TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID    = ?PAYSRC_ID
)RETURNS(
   J_ID            TYPE OF COLUMN TABL$J_4.ID
  ,DOCTYPE_ID      TYPE OF COLUMN TABL$J_4.TYPE_ID
)AS
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_CS_ID       TYPE OF COLUMN TABL$J_1000062.CS_ID;
  DECLARE VARIABLE P_J_CASH_ID1  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_CASH_ID2  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_CASH_ID3  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_DOCNAME1    TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DOCNAME2    TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DOCNAME3    TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DOCNAME     TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DOCSSTR     TYPE OF COLUMN TABL$J_4.DOCSTR;
  DECLARE VARIABLE P_DOCDATE     TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  DOCTYPE_ID = 1000063;

  SELECT FIRST 1 P.VAL FROM PROC$C_ENT_PS_J_1000020_3771 P INTO :P_DOCNAME1;
  SELECT FIRST 1 P.VAL FROM PROC$C_ENT_PS_J_1000020_373  P INTO :P_DOCNAME2;
  P_DOCNAME3 = :P_DOCNAME2||' 3731';

  SELECT FIRST 1 J.FIRM_ID
        ,TT.NAME2||'  ¹'||J.DOCNUMBERSTR||' OT "'
        ,(SELECT FIRST 1 P.OUT_STR FROM PROC$__FORMAT_DATETIME(J.DATE_COMMIT, 'DD.MM.YYYY') P )
  FROM   TABL$J_4 J, TABL$J_1000062 JZ, TABL$_TB_TYPES TT
  WHERE  (J.ID = :Q_PARENT_DOC_ID)
    AND  (JZ.J_ID = J.ID)
    AND  (TT.ID = J.TYPE_ID)
  INTO   :P_FIRM_ID, :P_DOCSSTR, :P_DOCDATE;

  P_DOCSSTR = :P_DOCSSTR || :P_DOCDATE || '".';

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_4(:P_FIRM_ID, :DOCTYPE_ID, :Q_PARENT_DOC_ID) P INTO :J_ID;
  UPDATE TABL$J_4 J4 SET
    J4.DOCSUMVAL = :Q_DOCSUM
  WHERE (J4.ID = :J_ID);

  INSERT INTO TABL$J_1000063 (J_ID, J_ZALOG_ID, DAYSCNT, PC, PCSUM, DATE_RETURN, PCPEN, PCPENSUM, CARDNUM, CARDAMOUNT)
    VALUES (:J_ID, :Q_PARENT_DOC_ID, :Q_DAYS_CNT, :Q_PC, :Q_SUMPC, :Q_DATE_RETURN, :Q_PCPEN, :Q_SUMPCPEN, :Q_CARDNUM, :Q_CARDAMOUNT);

  UPDATE TABL$J_4 J4 SET
    J4.FLAG_COMMIT = 1
  WHERE (J4.ID = :J_ID);


  SELECT FIRST 1 J.FIRM_ID, JB.CS_ID
  FROM   TABL$J_4 J, TABL$J_1000063 JB
  WHERE  (J.ID = :J_ID)
    AND  (JB.J_ID = J.ID)
  INTO   :P_FIRM_ID, :P_CS_ID;

  IF(ABS(:Q_DOCSUM - :Q_SUMPC - :Q_SUMPCPEN) > 0.000)THEN
    BEGIN
    SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000020(:P_FIRM_ID, :P_DOCNAME1, :J_ID) P INTO :P_J_CASH_ID1;
    UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = (:Q_DOCSUM - :Q_SUMPC - :Q_SUMPCPEN) WHERE (JRNL.ID = :P_J_CASH_ID1);
    UPDATE TABL$J_1000016 JC SET
       JC.ACC_ID      = 3771
      ,JC.SUBKONTO_ID = :P_CS_ID
      ,JC.REASON      = :P_DOCSSTR
      ,JC.PAYSRC_ID   = :Q_PAYSRC_ID
    WHERE (JC.J_ID = :P_J_CASH_ID1);
    UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_CASH_ID1);
    END

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000020(:P_FIRM_ID, :P_DOCNAME2, :J_ID) P INTO :P_J_CASH_ID2;
  UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = :Q_SUMPC WHERE (JRNL.ID = :P_J_CASH_ID2);
  UPDATE TABL$J_1000016 JC SET
     JC.ACC_ID      = 373
    ,JC.SUBKONTO_ID = :P_CS_ID
    ,JC.REASON      = :P_DOCSSTR
    ,JC.PAYSRC_ID   = :Q_PAYSRC_ID
  WHERE (JC.J_ID = :P_J_CASH_ID2);
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_CASH_ID2);

  IF(ABS(:Q_SUMPCPEN) > 0.000)THEN
    BEGIN
    SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000020(:P_FIRM_ID, :P_DOCNAME3, :J_ID) P INTO :P_J_CASH_ID3;
    UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = :Q_SUMPCPEN WHERE (JRNL.ID = :P_J_CASH_ID3);
    UPDATE TABL$J_1000016 JC SET
       JC.ACC_ID      = 3731
      ,JC.SUBKONTO_ID = :P_CS_ID
      ,JC.REASON      = :P_DOCSSTR
      ,JC.PAYSRC_ID   = :Q_PAYSRC_ID
    WHERE (JC.J_ID = :P_J_CASH_ID3);
    UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_CASH_ID3);
    END

  SUSPEND;
END
