EXECUTE BLOCK
AS
  DECLARE VARIABLE P_J_ID            TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_J_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_WRK_ID          TYPE OF COLUMN TABL$J_1000156.WRK_ID;
  DECLARE VARIABLE P_TMC_ID          TYPE OF COLUMN TABL$J_1000156.TMC_ID;
  DECLARE VARIABLE P_DOC_ID_PASSPORT TYPE OF COLUMN TABL$J_1000156.DOC_ID_PASSPORT;
  DECLARE VARIABLE P_DOC_ID_DRIVER   TYPE OF COLUMN TABL$J_1000156.DOC_ID_DRIVER;
  DECLARE VARIABLE P_DOC_ID_MED      TYPE OF COLUMN TABL$J_1000156.DOC_ID_MED;
  DECLARE VARIABLE P_DOC_ID_WAR      TYPE OF COLUMN TABL$J_1000156.DOC_ID_WAR;
  DECLARE VARIABLE P_J_ID_WORK       TYPE OF COLUMN TABL$J_1000156.J_ID_WORK;
  DECLARE VARIABLE P_J_ID_TMC        TYPE OF COLUMN TABL$J_1000156.J_ID_TMC;
BEGIN
  P_J_ID            = ?J_ID;
  P_WRK_ID          = ?WRK_ID;
  P_TMC_ID          = 0;
  P_DOC_ID_PASSPORT = 0;
  P_DOC_ID_DRIVER   = 0;
  P_DOC_ID_MED      = 0;
  P_DOC_ID_WAR      = 0;
  P_J_ID_WORK       = 0;
  P_J_ID_TMC        = 0;

  SELECT FIRST 1 COALESCE(J.DATE_COMMIT, CURRENT_TIMESTAMP), COALESCE(J.FIRM_ID, 0)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :P_J_ID)
  INTO   :P_J_DATE_COMMIT, :P_J_FIRM_ID;
  
  SELECT FIRST 1 COALESCE(J156.TMC_ID, 0)
  FROM   TABL$J_1000156 J156
  WHERE  (J156.J_ID = :P_J_ID)
  INTO   :P_TMC_ID;
  
  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_WRK_DOCS D
  WHERE  (D.WRK_ID = :P_WRK_ID)
    AND  (D.DOCTYPE_ID = 1000000)
    AND  (D.DOC_DATE <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_PASSPORT;

  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_WRK_DOCS D
  WHERE  (D.WRK_ID = :P_WRK_ID)
    AND  (D.DOCTYPE_ID = 1000006)
    AND  (D.DOC_DATE <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_DRIVER;
  
  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_WRK_DOCS D
  WHERE  (D.WRK_ID     = :P_WRK_ID)
    AND  (D.DOCTYPE_ID IN (1000003,1000041,1000042))
    AND  (D.DOC_DATE <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_MED;

  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_WRK_DOCS D
  WHERE  (D.WRK_ID = :P_WRK_ID)
    AND  (D.DOCTYPE_ID = 1000004)
    AND  (D.DOC_DATE <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_WAR;

  SELECT FIRST 1 COALESCE(J4.ID, 0)
  FROM   TABL$J_4 J4, TABL$J_1000087 J87
  WHERE  (J4.TYPE_ID     = 1000151)
    AND  (J4.DATE_COMMIT <= :P_J_DATE_COMMIT)
    AND  ((J4.FIRM_ID+0) = :P_J_FIRM_ID)
    AND  (J4.FLAG_COMMIT = 1 )
    AND  (J87.J_ID       = J4.ID)
    AND  (J87.WRK_ID     = :P_WRK_ID)
    AND  ( (J87.DATE_END >= :P_J_DATE_COMMIT) OR (J87.DATE_END IS NULL) )
  INTO   :P_J_ID_WORK;

  SELECT FIRST 1 COALESCE(J4.ID, 0)
  FROM   TABL$J_4 J4, TABL$J_1000087 J87
  WHERE  (J4.TYPE_ID     = 1000152)
    AND  (J4.DATE_COMMIT <= :P_J_DATE_COMMIT)
    AND  ((J4.FIRM_ID+0) = :P_J_FIRM_ID)
    AND  (J4.FLAG_COMMIT = 1 )
    AND  (J87.J_ID       = J4.ID)
    AND  (J87.WRK_ID     = :P_WRK_ID)
    AND  (J87.TMC_ID     = :P_TMC_ID)
    AND  ( (J87.DATE_END >= :P_J_DATE_COMMIT) OR (J87.DATE_END IS NULL) )
  INTO   :P_J_ID_TMC;

  UPDATE TABL$J_1000156 JT SET
     JT.WRK_ID          = :P_WRK_ID
    ,JT.TMC_ID          = :P_TMC_ID 
    ,JT.DOC_ID_PASSPORT = :P_DOC_ID_PASSPORT
    ,JT.DOC_ID_DRIVER   = :P_DOC_ID_DRIVER
    ,JT.DOC_ID_MED      = :P_DOC_ID_MED
    ,JT.DOC_ID_WAR      = :P_DOC_ID_WAR
    ,JT.J_ID_WORK       = :P_J_ID_WORK
    ,JT.J_ID_TMC        = :P_J_ID_TMC
  WHERE (JT.J_ID = :P_J_ID);
END
