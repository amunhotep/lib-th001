EXECUTE BLOCK
AS
  DECLARE VARIABLE P_J_ID           TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_J_FIRM_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_WRK_ID         TYPE OF COLUMN TABL$J_1000156.WRK_ID;
  DECLARE VARIABLE P_TMC_ID         TYPE OF COLUMN TABL$J_1000156.TMC_ID;
  DECLARE VARIABLE P_DOC_ID         TYPE OF COLUMN TABL$R_DOC.ID;
  DECLARE VARIABLE P_DOC_ID_TMC1    TYPE OF COLUMN TABL$J_1000156.DOC_ID_TMC1;
  DECLARE VARIABLE P_DOC_ID_TMC2    TYPE OF COLUMN TABL$J_1000156.DOC_ID_TMC2;
  DECLARE VARIABLE P_DOC_ID_LICENSE TYPE OF COLUMN TABL$J_1000156.DOC_ID_LICENSE;
BEGIN
  P_J_ID   = ?J_ID;
  P_TMC_ID = ?TMC_ID;

  SELECT FIRST 1 COALESCE(J.DATE_COMMIT, CURRENT_TIMESTAMP), COALESCE(J.FIRM_ID, 0)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :P_J_ID)
  INTO   :P_J_DATE_COMMIT, :P_J_FIRM_ID;
  
  P_WRK_ID = 0;
  SELECT FIRST 1 COALESCE(J156.WRK_ID, 0)
  FROM   TABL$J_1000156 J156
  WHERE  (J156.J_ID = :P_J_ID)
  INTO   :P_WRK_ID;
  
  P_DOC_ID = 0;
  SELECT FIRST 1 COALESCE(J4.ID, 0)
  FROM   TABL$J_4 J4, TABL$J_1000087 J87
  WHERE  (J4.TYPE_ID     = 1000152)
    AND  (J4.DATE_COMMIT <= :P_J_DATE_COMMIT)
    AND  ((J4.FIRM_ID+0) = :P_J_FIRM_ID)
    AND  (J4.FLAG_COMMIT = 1 )
    AND  (J87.J_ID       = J4.ID)
    AND  (J87.WRK_ID     = :P_WRK_ID)
    AND  (J87.TMC_ID     = :P_TMC_ID)
    AND  ( (J87.DATE_END >= :P_J_DATE_COMMIT) OR (J87.DATE_END IS NULL) )
  INTO   :P_DOC_ID;
  
  P_DOC_ID_TMC1 = 0;
  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_TMC_DOCS D
  WHERE  (D.TMC_ID     = :P_TMC_ID)
    AND  (D.DOCTYPE_ID = 1000039)
    AND  (D.DOC_DATE  <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_TMC1;

  P_DOC_ID_TMC2 = 0;
  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_TMC_DOCS D
  WHERE  (D.TMC_ID     = :P_TMC_ID)
    AND  (D.DOCTYPE_ID = 1000040)
    AND  (D.DOC_DATE  <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_TMC2;
  
  P_DOC_ID_LICENSE = 0;  
  SELECT FIRST 1 COALESCE(D.ID, 0)
  FROM   VIEW$R_TMC_DOCS D
  WHERE  (D.TMC_ID     = :P_TMC_ID)
    AND  (D.DOCTYPE_ID = 1000038)
    AND  (D.DOC_DATE <= :P_J_DATE_COMMIT)
    AND  ( (D.DOC_DATEEND >= :P_J_DATE_COMMIT) OR (D.DOC_DATEEND IS NULL) )
  INTO   :P_DOC_ID_LICENSE;

  UPDATE TABL$J_1000156 JT SET
     JT.WRK_ID          = :P_WRK_ID
    ,JT.TMC_ID          = :P_TMC_ID 
    ,JT.J_ID_TMC        = :P_DOC_ID 
    ,JT.DOC_ID_TMC1     = :P_DOC_ID_TMC1
    ,JT.DOC_ID_TMC2     = :P_DOC_ID_TMC2
    ,JT.DOC_ID_LICENSE  = :P_DOC_ID_LICENSE
  WHERE (JT.J_ID = :P_J_ID);
END
