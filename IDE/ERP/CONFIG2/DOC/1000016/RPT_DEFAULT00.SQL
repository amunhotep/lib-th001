EXECUTE BLOCK (
  Q_J_ID        TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS (
  ID            TYPE OF COLUMN TABL$J_4.ID 
 ,NAME          TYPE OF COLUMN TABL$J_4.NAME
 ,FLAG_DELETE   TYPE OF COLUMN TABL$J_4.FLAG_DELETE
 ,FLAG_COMMIT   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,TYPE_ID       TYPE OF COLUMN TABL$J_4.TYPE_ID
 ,TYPE_NAME     TYPE OF COLUMN TABL$_TB_DOCS.NAME
 ,COLOR_FRG     TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
 ,COLOR_BGR     TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
 ,DOCNUMBER     TYPE OF COLUMN TABL$J_4.DOCNUMBER
 ,DOCSUM        TYPE OF COLUMN TABL$J_4.DOCSUM
 ,DOCSUMVAL     TYPE OF COLUMN TABL$J_4.DOCSUMVAL
 ,VALUTE_ID     TYPE OF COLUMN TABL$J_4.VALUTE_ID
 ,VALUTE_NAME   TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
 ,VALUTE_SHORT  TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE_SHORT
 ,FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID
 ,FIRM_NAME     TYPE OF COLUMN TABL$R_FIRMS.NAME
 ,FILIAL_ID     TYPE OF COLUMN TABL$J_4.FILIAL_ID
 ,FILIAL_NAME   TYPE OF COLUMN TABL$R_FILIALS.NAME
 ,USER_ID       TYPE OF COLUMN TABL$J_4.USER_ID
 ,USER_NAME     TYPE OF COLUMN TABL$_USERS.NAME
 ,WRK_DOVER     TYPE OF COLUMN TABL$R_WRK.DOVER
 ,DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,DOCSTR        TYPE OF COLUMN TABL$J_4.DOCSTR
 ,PAYSRC_ID     TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID
 ,PAYSRC_NAME   TYPE OF COLUMN TABL$R_PAYSRC.NAME
 ,ACC_ID        TYPE OF COLUMN TABL$J_1000016.ACC_ID
 ,ACC_NAME      TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
 ,SUBKONTO_ID   TYPE OF COLUMN TABL$J_1000016.SUBKONTO_ID
 ,SUBKONTO_NAME TYPE OF COLUMN TABL$_TB.NAME
 ,EXPTYPE_ID    TYPE OF COLUMN TABL$J_1000016.EXPTYPE_ID
 ,EXPTYPE_NAME  TYPE OF COLUMN TABL$R_EXPTYPES.NAME
 ,DOCUMENT_NAME TYPE OF COLUMN TABL$R_CS_DOCS.NAME
 ,REASON        TYPE OF COLUMN TABL$J_1000016.REASON
)AS
  DECLARE VARIABLE P_TABLE_NAME TYPE OF COLUMN TABL$_TB.ID;
  DECLARE VARIABLE P_SQL        TYPE OF COLUMN TABL$_TB.NAME;
  DECLARE VARIABLE P_STR        TYPE OF COLUMN TABL$R_CS_DOCS.NAME;
  DECLARE VARIABLE P_DATE       TYPE OF COLUMN TABL$R_CS_DOCS.DOC_DATE;
BEGIN
  DOCUMENT_NAME = '';

  SELECT FIRST 1 J.ID, J.NAME, J.FLAG_DELETE, J.FLAG_COMMIT, J.TYPE_ID, TD.NAME, TD.COLOR_FRG, TD.COLOR_BGR
         ,J.DOCNUMBER, J.DOCSUM, J.DOCSUMVAL, J.VALUTE_ID, CONTR.VALUTE, CONTR.VALUTE_SHORT, J.FIRM_ID, FIRM.NAME
         ,J.FILIAL_ID,(SELECT FIRST 1 COALESCE(FF.NAME,'')        FROM TABL$R_FILIALS FF WHERE (FF.ID = J.FILIAL_ID)) AS FILIAL_NAME
         ,J.USER_ID  ,(SELECT FIRST 1 COALESCE(W.NAME, J.USER_ID) FROM TABL$R_WRK W      WHERE (W.USER_NAME = J.USER_ID)) AS USER_NAME
         ,(SELECT FIRST 1 COALESCE(W.DOVER, '') FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID)) AS WRK_DOVER
         ,J.DATE_COMMIT, J.DOCNUMBERSTR, J.DOCSTR
         ,JC.PAYSRC_ID, PS.NAME, JC.ACC_ID, BA.NAME, BA.SUBKONTO, JC.SUBKONTO_ID, JC.EXPTYPE_ID, EXP.NAME, JC.REASON
  FROM    TABL$J_4 J, TABL$R_FIRMS FIRM, TABL$R_COUNTRIES CONTR, TABL$_TB_DOCS TD
         ,TABL$J_1000016 JC, TABL$R_PAYSRC PS, TABL$R_BUHG_ACCS BA, TABL$R_EXPTYPES EXP
  WHERE  (J.ID     = :Q_J_ID)
    AND  (TD.ID    = J.TYPE_ID)
    AND  (FIRM.ID  = J.FIRM_ID)
    AND  (CONTR.ID = J.VALUTE_ID)
    AND  (JC.J_ID  = J.ID)
    AND  (PS.ID    = JC.PAYSRC_ID)
    AND  (BA.ID    = JC.ACC_ID)
    AND  (EXP.ID   = JC.EXPTYPE_ID)
  INTO   :ID, :NAME, :FLAG_DELETE, :FLAG_COMMIT, :TYPE_ID, :TYPE_NAME, :COLOR_FRG, :COLOR_BGR,
         :DOCNUMBER, :DOCSUM, :DOCSUMVAL, :VALUTE_ID, :VALUTE_NAME, :VALUTE_SHORT, :FIRM_ID, :FIRM_NAME,
         :FILIAL_ID, :FILIAL_NAME, :USER_ID, :USER_NAME, :WRK_DOVER, :DATE_COMMIT, :DOCNUMBERSTR,:DOCSTR,
         :PAYSRC_ID, :PAYSRC_NAME, :ACC_ID, :ACC_NAME, :P_TABLE_NAME, :SUBKONTO_ID, :EXPTYPE_ID, :EXPTYPE_NAME, :REASON;

  SUBKONTO_NAME = '';

  IF(NOT((:P_TABLE_NAME IS NULL)OR(TRIM(:P_TABLE_NAME)='')))THEN
    BEGIN
    P_SQL = 'SELECT FIRST 1 T1.NAME FROM '||:P_TABLE_NAME||' T1 WHERE (T1.ID = '''||:SUBKONTO_ID||''') ';
    EXECUTE STATEMENT :P_SQL INTO :SUBKONTO_NAME;
    END

  IF(UPPER(TRIM(:P_TABLE_NAME)) = 'TABL$R_CS')THEN
    BEGIN
    SELECT FIRST 1 DT.NAME||' CEPÈß "'||CD.DOC_SERIAL||'" ¹'||CD.DOC_NUMBER||'  BÛÄAH: '||CD.NAME||' OT "', CD.DOC_DATE
    FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
    WHERE  (CD.CS_ID = :SUBKONTO_ID)
      AND  (DT.ID    = CD.DOCTYPE_ID)
    INTO   :DOCUMENT_NAME, :P_DATE;
  
    SELECT FIRST 1 P.OUT_STR FROM PROC$__FORMAT_DATETIME(:P_DATE, 'DD.MM.YYYY') P INTO :P_STR;
  
    DOCUMENT_NAME = :DOCUMENT_NAME||:P_STR||'"Ã.';
    END
    
  SUSPEND;
END
