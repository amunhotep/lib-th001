EXECUTE BLOCK(
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS(
  J_ID       TYPE OF COLUMN TABL$J_4.ID
 ,DOCTYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID
)AS
  DECLARE VARIABLE P_FIRM_ID         TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_WRK_ID          TYPE OF COLUMN TABL$J_1000156.WRK_ID;
  DECLARE VARIABLE P_DOC_ID_PASSPORT TYPE OF COLUMN TABL$J_1000156.DOC_ID_PASSPORT;
  DECLARE VARIABLE P_DOC_ID_DRIVER   TYPE OF COLUMN TABL$J_1000156.DOC_ID_DRIVER;
  DECLARE VARIABLE P_DOC_ID_LICENSE  TYPE OF COLUMN TABL$J_1000156.DOC_ID_LICENSE;
  DECLARE VARIABLE P_DOC_ID_MED      TYPE OF COLUMN TABL$J_1000156.DOC_ID_MED;
  DECLARE VARIABLE P_DOC_ID_WAR      TYPE OF COLUMN TABL$J_1000156.DOC_ID_WAR;
  DECLARE VARIABLE P_J_ID_WORK       TYPE OF COLUMN TABL$J_1000156.J_ID_WORK;
  DECLARE VARIABLE P_J_ID_TMC        TYPE OF COLUMN TABL$J_1000156.J_ID_TMC;
  DECLARE VARIABLE P_TMC_ID          TYPE OF COLUMN TABL$J_1000156.TMC_ID;
  DECLARE VARIABLE P_TMC_KM          TYPE OF COLUMN TABL$J_1000156.TMC_KM;
  DECLARE VARIABLE P_DOC_ID_TMC1     TYPE OF COLUMN TABL$J_1000156.DOC_ID_TMC1;
  DECLARE VARIABLE P_DOC_ID_TMC2     TYPE OF COLUMN TABL$J_1000156.DOC_ID_TMC2;
BEGIN
  DOCTYPE_ID = 1000157;

  SELECT FIRST 1 COALESCE(J.FIRM_ID, 0)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :J_ID)
  INTO   :P_FIRM_ID;

  SELECT  WRK_ID
         ,DOC_ID_PASSPORT, DOC_ID_DRIVER, DOC_ID_LICENSE, DOC_ID_MED, DOC_ID_WAR
         ,J_ID_WORK, J_ID_TMC
         ,TMC_ID, TMC_KM
         ,DOC_ID_TMC1, DOC_ID_TMC2
  FROM    TABL$J_1000156 J156
  WHERE   (J156.J_ID = :Q_J_ID)
  INTO    :P_WRK_ID
         ,:P_DOC_ID_PASSPORT, :P_DOC_ID_DRIVER, :P_DOC_ID_LICENSE, :P_DOC_ID_MED, :P_DOC_ID_WAR
         ,:P_J_ID_WORK, :P_J_ID_TMC
         ,:P_TMC_ID, :P_TMC_KM
         ,:P_DOC_ID_TMC1, :P_DOC_ID_TMC2;

  J_ID = 0;
  SELECT FIRST 1 COALESCE(J4.ID, 0)
  FROM   TABL$J_CHILDS JC, TABL$J_4 J4
  WHERE  (JC.J_ID = :Q_J_ID)
    AND  (J4.ID = JC.J_CHILD_ID)
    AND  (J4.TYPE_ID = 1000157)
  INTO   :J_ID;

  IF(:J_ID = 0)THEN
    BEGIN
    SELECT FIRST 1 COALESCE(P1.J_ID, 0)
    FROM   PROC$J_INS(:Q_J_ID, :P_FIRM_ID, :DOCTYPE_ID) P1
    INTO   :J_ID;
    END

  UPDATE OR INSERT INTO TABL$J_1000156(J_ID, WRK_ID
    ,DOC_ID_PASSPORT, DOC_ID_DRIVER, DOC_ID_LICENSE, DOC_ID_MED, DOC_ID_WAR
    ,J_ID_WORK, J_ID_TMC, TMC_ID, TMC_KM, DOC_ID_TMC1, DOC_ID_TMC2
  )VALUES (:J_ID, :P_WRK_ID
    ,:P_DOC_ID_PASSPORT, :P_DOC_ID_DRIVER, :P_DOC_ID_LICENSE, :P_DOC_ID_MED, :P_DOC_ID_WAR
    ,:P_J_ID_WORK, :P_J_ID_TMC, :P_TMC_ID, :P_TMC_KM, :P_DOC_ID_TMC1, :P_DOC_ID_TMC2
  )MATCHING (J_ID);

  SUSPEND;
END
