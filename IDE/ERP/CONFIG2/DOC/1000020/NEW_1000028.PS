{$IFNDEF PEAKTOP:IDE/ERP/CONFIG/REF/FIRMS/DIALOGCASEITEM.INC}
  {$I PEAKTOP:IDE/ERP/CONFIG/REF/FIRMS/DIALOGCASEITEM.INC}
{$ENDIF}  
var
  lkBillId :string;
  lkDocIds :array of string;
  lkSQL    :string;
begin
  lkBillId := GetGlobalVariable('J_ID');

  lkSQL :=  
    'EXECUTE BLOCK RETURNS ( '+SQLCRLF+
    '  J_ID       TYPE OF COLUMN TABL$J_4.ID '+SQLCRLF+ 
    ' ,DOCTYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID '+SQLCRLF+ 
    ')AS '+SQLCRLF+ 
    '  DECLARE VARIABLE P_J_ID_BILL   TYPE OF COLUMN TABL$J_4.ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_FILIAL_ID   TYPE OF COLUMN TABL$J_4.FILIAL_ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_DOCSUM      TYPE OF COLUMN TABL$J_4.DOCSUMVAL; '+SQLCRLF+
    '  DECLARE VARIABLE P_CS_ID       TYPE OF COLUMN TABL$J_1000014.CS_ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_ADDRESS_ID  TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID; '+SQLCRLF+
    '  DECLARE VARIABLE P_PAYSRC_ID   TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID; '+SQLCRLF+
    'BEGIN '+SQLCRLF+                                   
    '  DOCTYPE_ID  = 1000020; '+SQLCRLF+
    '  P_J_ID_BILL = '+lkBillId+'; '+SQLCRLF+
    '  SELECT FIRST 1 J.FIRM_ID, J.FILIAL_ID, J.DOCSUM, J14.CS_ID, J14.CS_ADDR_ID '+SQLCRLF+
    '  FROM   TABL$J_4 J, TABL$J_1000014 J14 '+SQLCRLF+
    '  WHERE  (J.ID = :P_J_ID_BILL) '+SQLCRLF+
    '    AND  (J14.J_ID = J.ID) '+SQLCRLF+
    '  INTO   :P_FIRM_ID, :P_FILIAL_ID, :P_DOCSUM,:P_CS_ID, :P_ADDRESS_ID; '+SQLCRLF+
    '  P_PAYSRC_ID = 0; '+SQLCRLF+
    '  SELECT FIRST 1 COALESCE(PS.ID, 0) '+SQLCRLF+ 
    '  FROM   TABL$R_PAYSRC PS '+SQLCRLF+
    '  WHERE  (PS.FIRM_ID   = :P_FIRM_ID) '+SQLCRLF+
    '    AND  (PS.TYPE_ID   = 2) '+SQLCRLF+
    '    AND  (PS.FILIAL_ID = :P_FILIAL_ID) '+SQLCRLF+
    '  INTO   :P_PAYSRC_ID; '+SQLCRLF+
    '  IF(:P_PAYSRC_ID = 0)THEN '+SQLCRLF+ 
    '    BEGIN '+SQLCRLF+ 
    '    SELECT FIRST 1 COALESCE(PS.ID, 0) '+SQLCRLF+ 
    '    FROM   TABL$R_PAYSRC PS '+SQLCRLF+
    '    WHERE  (PS.FIRM_ID = :P_FIRM_ID) '+SQLCRLF+
    '    INTO   :P_PAYSRC_ID; '+SQLCRLF+
    '    END '+SQLCRLF+ 
    '  SELECT FIRST 1 P.J_ID FROM PROC$J$INS(:P_J_ID_BILL, :P_FIRM_ID, :DOCTYPE_ID) P INTO :J_ID; '+SQLCRLF+
    '  UPDATE TABL$J_4 J SET '+SQLCRLF+
    '    J.FILIAL_ID = :P_FILIAL_ID '+SQLCRLF+
    '   ,J.DOCSUMVAL = :P_DOCSUM '+SQLCRLF+
    '   ,J.NAME      = ''Оплата за товар або надання послуг'' '+SQLCRLF+
    '  WHERE (J.ID = :J_ID); '+SQLCRLF+
    '  UPDATE OR INSERT INTO TABL$J_1000016(J_ID, PAYSRC_ID, ACC_ID, SUBKONTO_ID, ADDRESS_ID, DOC_ID, EXPTYPE_ID, REASON) '+SQLCRLF+
    '    VALUES (:J_ID, :P_PAYSRC_ID, 361, :P_CS_ID, :P_ADDRESS_ID, :P_J_ID_BILL, 1000003, NULL) '+SQLCRLF+
    '    MATCHING(J_ID); '+SQLCRLF+ 
    '  SUSPEND; '+SQLCRLF+
    'END '+SQLCRLF+
    ' '+SQLCRLF;
  SetLength(lkDocIds, 1)
  if not TERPForm_SelectSQLParams([], lkSQL, [],[], ['J_ID'], lkDocIds)then exit;
  SetGlobalVariable('J_ID', lkDocIds[0]);
  call(StrAbsolutePath('../1000016/EDIT.PS', ScriptName));  
end.
