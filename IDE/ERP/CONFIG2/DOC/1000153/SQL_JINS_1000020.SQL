-- PEAKTOP:IDE/ERP/CONFIG2/DOC/1000153/SQL_JINS_1000020.SQL
EXECUTE BLOCK(
   Q_J_ID   TYPE OF COLUMN TABL$J_4.ID     = ?J_ID
  ,Q_DOCSUM TYPE OF COLUMN TABL$J_4.DOCSUM = ?J_DOCSUM
)AS
  DECLARE VARIABLE P_J_ID2          TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID        TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DOCTYPE_ID     TYPE OF COLUMN TABL$J_4.TYPE_ID;
  DECLARE VARIABLE P_CS_ID          TYPE OF COLUMN TABL$R_CS.ID;
  DECLARE VARIABLE P_CS_DOC_ID      TYPE OF COLUMN TABL$R_DOC.ID;
  DECLARE VARIABLE P_CS_AMOUNT      TYPE OF COLUMN TABL$R_CS_P.AMOUNT;
  DECLARE VARIABLE P_PLACE_ID       TYPE OF COLUMN TABL$R_PLACES.ID;
  DECLARE VARIABLE P_PAYSRC_ID      TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID;
BEGIN
  SELECT FIRST 1 J4.FIRM_ID
  FROM   TABL$J_4 J4
  WHERE  (J4.ID = :Q_J_ID)
  INTO   :P_FIRM_ID;

  SELECT FIRST 1 J1.CS_ID, J1.CS_DOC_ID, J1.CS_AMOUNT, J1.PLACE_ID
  FROM   TABL$J_1000153 J1
  WHERE  (J1.J_ID = :Q_J_ID)
  INTO   :P_CS_ID, :P_CS_DOC_ID, :P_CS_AMOUNT, :P_PLACE_ID;

  P_PAYSRC_ID = 0; 
  SELECT FIRST 1 COALESCE(PS.ID, 0) 
  FROM   TABL$R_PAYSRC PS, TABL$R_FILIALS FL 
  WHERE  (PS.FIRM_ID = :P_FIRM_ID) 
    AND  (PS.TYPE_ID = 2) 
    AND  (FL.ID      = PS.FILIAL_ID) 
    AND  (FL.GUID    = (SELECT FIRST 1 P1.GUID FROM PROC$_DB_GUID P1)) 
  INTO   :P_PAYSRC_ID; 
  IF(:P_PAYSRC_ID = 0)THEN 
    BEGIN 
    SELECT FIRST 1 COALESCE(PS.ID, 0) 
    FROM   TABL$R_PAYSRC PS, TABL$R_FILIALS FL 
    WHERE  (PS.FIRM_ID = :P_FIRM_ID) 
      AND  (FL.ID      = PS.FILIAL_ID) 
      AND  (FL.GUID    = (SELECT FIRST 1 P1.GUID FROM PROC$_DB_GUID P1)) 
    INTO   :P_PAYSRC_ID; 
    END 
 
  P_DOCTYPE_ID = 1000020;
  SELECT FIRST 1 P.J_ID FROM PROC$J_INS(:Q_J_ID, :P_FIRM_ID, :P_DOCTYPE_ID) P INTO :P_J_ID2;
  UPDATE TABL$J_4 J SET
     J.DOCSUMVAL = :Q_DOCSUM
    ,J.NAME      = 'Оплата за товар или услуги'
  WHERE (J.ID = :P_J_ID2);

  UPDATE OR INSERT INTO TABL$J_1000016(J_ID, PAYSRC_ID, ACC_ID, SUBKONTO_ID, EXPTYPE_ID, REASON, DOC_ID) 
    VALUES (:P_J_ID2, :P_PAYSRC_ID, 1000062, :P_CS_ID, 1000003, NULL, :Q_J_ID)
    MATCHING(J_ID); 

  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_ID2);
END
