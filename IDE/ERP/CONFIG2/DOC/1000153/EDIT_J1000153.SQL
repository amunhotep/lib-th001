SELECT R0000.ID AS J_ID 
      ,R0000.ID AS DS$ID 
      ,R0000.FLAG_DELETE
      ,R0000.FLAG_COMMIT
      ,R0000.FLAG_LOCK
      ,R0000.ID
      ,R0000.TYPE_ID
      ,(SELECT FIRST 1 T0001.NAME FROM TABL$_TB_DOCS T0001 WHERE (T0001.ID = R0000.TYPE_ID)) AS TYPE_ID_
      ,R0000.DOCNUMBER
      ,R0000.DOCNUMBERSTR
      ,R0000.DOCNUMBERIN
      ,R0001.CS_ID
      ,(SELECT FIRST 1 T0002.NAME FROM TABL$R_CS T0002 WHERE (T0002.ID = R0001.CS_ID)) AS CS_ID_
      ,R0001.CS_AMOUNT
      ,R0001.CS_DOC_ID
      ,(SELECT FIRST 1 T0004.DOC_NAME FROM PROC$R_CS_DOCS_GEITEM(R0001.CS_DOC_ID) T0004) AS CS_DOC_ID_
      ,R0001.TMC_ID
      ,(SELECT FIRST 1 T0003.NAME FROM TABL$R_TMC T0003 WHERE (T0003.ID = R0001.TMC_ID)) AS TMC_ID_
      ,R0001.KM
      ,(SELECT FIRST 1 COALESCE(MAX(P.TMC_KM), 0)
        FROM   TABL$P_TMC_AUTO_KM P
        WHERE  (P.TMC_ID      = R0001.TMC_ID)
          AND  (P.DATE_COMMIT < R0000.DATE_COMMIT)
       )AS KM_WAS
      ,(SELECT FIRST 1 COALESCE(R0001.KM, 0) - COALESCE(MAX(P.TMC_KM), 0)
        FROM   TABL$P_TMC_AUTO_KM P
        WHERE  (P.TMC_ID      = R0001.TMC_ID)
          AND  (P.DATE_COMMIT < R0000.DATE_COMMIT)
       )AS KM_GONE
      ,IIF(R0000.FLAG_COMMIT <> 1, 
        (SELECT COALESCE( (-1) * SUM(J001.DOCSUM), 0)
         FROM   TABL$J_CHILDS JC001, TABL$J_4 J001
         WHERE  (JC001.J_ID       = R0000.ID)
           AND  (J001.ID          = JC001.J_CHILD_ID)
           AND  (J001.TYPE_ID     = 1000020)
           AND  (J001.FLAG_COMMIT = 1)
         ),  
        (SELECT COALESCE(R0000.DOCSUM, 0) - COALESCE(SUM(J001.DOCSUM), 0)
         FROM   TABL$J_CHILDS JC001, TABL$J_4 J001
         WHERE  (JC001.J_ID       = R0000.ID)
           AND  (J001.ID          = JC001.J_CHILD_ID)
           AND  (J001.TYPE_ID     = 1000020)
           AND  (J001.FLAG_COMMIT = 1)
         )
       )AS DOCSUMLEFT 
      ,R0001.PLACE_ID
      ,(SELECT FIRST 1 T0004.NAME FROM TABL$R_PLACES T0004 WHERE (T0004.ID = R0001.PLACE_ID)) AS PLACE_ID_
      ,R0000.VALUTE_ID
      ,(SELECT FIRST 1 T0005.VALUTE_SHORT FROM TABL$R_COUNTRIES T0005 WHERE (T0005.ID = R0000.VALUTE_ID)) AS VALUTE_ID_
      ,R0000.DOCSUMVAL
      ,R0000.DOCSUM
      ,R0000.DOCNDP
      ,R0000.DOCSUMWONDP
      ,R0000.NAME
      ,R0000.DATE_COMMIT
      ,R0000.DATE_IN
      ,R0000.FIRM_ID
      ,(SELECT FIRST 1 T0006.NAME FROM TABL$R_FIRMS T0006 WHERE (T0006.ID = R0000.FIRM_ID)) AS FIRM_ID_
      ,R0000.FILIAL_ID
      ,(SELECT FIRST 1 T0007.NAME FROM TABL$R_FILIALS T0007 WHERE (T0007.ID = R0000.FILIAL_ID)) AS FILIAL_ID_
      ,R0000.USER_ID
      ,(SELECT FIRST 1 T0008.ID FROM TABL$_USERS T0008 WHERE (T0008.ID = R0000.USER_ID)) AS USER_ID_
      ,(SELECT FIRST 1 COALESCE(WZZ.NAME, R0000.USER_ID) FROM TABL$R_WRK WZZ WHERE (TRIM(WZZ.USER_NAME) = R0000.USER_ID) ) AS WRK_NAME
      ,R0000.DOCSTR
      ,(SELECT FIRST 1 TBD01.COLOR_FRG FROM TABL$_TB_DOCS TBD01 WHERE (TBD01.ID = R0000.TYPE_ID)) AS COLOR_FRG
      ,(SELECT FIRST 1 TBD01.COLOR_BGR FROM TABL$_TB_DOCS TBD01 WHERE (TBD01.ID = R0000.TYPE_ID)) AS COLOR_BGR 
FROM   TABL$J_4 R0000, TABL$J_1000153 R0001 
WHERE (R0000.ID   = ?J_ID)
  AND (R0001.J_ID = R0000.ID)
ORDER BY DS$ID ASCENDING
