-- PEAKTOP:IDE/ERP/CONFIG2/DOC/1000153/SQL_COMMIT.SQL
EXECUTE BLOCK(
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)AS
  DECLARE VARIABLE P_J_ID2          TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID        TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DOCTYPE_ID     TYPE OF COLUMN TABL$J_4.TYPE_ID;
  DECLARE VARIABLE P_CS_ID          TYPE OF COLUMN TABL$R_CS.ID;
  DECLARE VARIABLE P_CS_DOC_ID      TYPE OF COLUMN TABL$R_DOC.ID;
  DECLARE VARIABLE P_CS_AMOUNT      TYPE OF COLUMN TABL$R_CS_P.AMOUNT;
  DECLARE VARIABLE P_PLACE_ID       TYPE OF COLUMN TABL$R_PLACES.ID;

  DECLARE VARIABLE PD_ID            TYPE OF COLUMN TABL$D_1000014.ID;
  DECLARE VARIABLE PD_NAME          TYPE OF COLUMN TABL$D_1000014.NAME;
  DECLARE VARIABLE PD_FLAG_DELETE   TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE;
  DECLARE VARIABLE PD_TMC_ID        TYPE OF COLUMN TABL$D_1000014.TMC_ID;
  DECLARE VARIABLE PD_PRICE_TMC     TYPE OF COLUMN TABL$D_1000014.PRICE_TMC;
  DECLARE VARIABLE PD_PRICE         TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE PD_QUANT         TYPE OF COLUMN TABL$D_1000014.QUANT;
BEGIN
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :Q_J_ID);

  SELECT FIRST 1 J4.FIRM_ID
  FROM   TABL$J_4 J4
  WHERE  (J4.ID = :Q_J_ID)
  INTO   :P_FIRM_ID;

  SELECT FIRST 1 J1.CS_ID, J1.CS_DOC_ID, J1.CS_AMOUNT, J1.PLACE_ID
  FROM   TABL$J_1000153 J1
  WHERE  (J1.J_ID = :Q_J_ID)
  INTO   :P_CS_ID, :P_CS_DOC_ID, :P_CS_AMOUNT, :P_PLACE_ID;

  P_DOCTYPE_ID = 1000028;
  SELECT FIRST 1 P.J_ID FROM PROC$J_INS(:Q_J_ID, :P_FIRM_ID, :P_DOCTYPE_ID) P INTO :P_J_ID2;

  UPDATE OR INSERT INTO TABL$J_1000014(J_ID
    ,CS_ID, CS_ADDR_ID, CS_DOC_ID, CS_POINTS, CS_POINTSPAYED, CS_AMOUNT, FLAG_AMOUNT 
    ,PLACE_ID, TO_PLACE_ID, PLATENO, GUESTQUANT, WRK_ID, J_ID_PAY, D_ID_PAY 
    ,FLAG_PAY, FLAG_CALC 
  )VALUES (:P_J_ID2, :P_CS_ID, 0, :P_CS_DOC_ID, 0, 0, :P_CS_AMOUNT, 0
    ,:P_PLACE_ID, 0, 0, 0, 0, 0, 0
    ,0, 0 
  )MATCHING (J_ID); 

  FOR
    SELECT D.ID, D.NAME, D.FLAG_DELETE, D.TMC_ID, D.PRICE_TMC, D.PRICE, D.QUANT
    FROM   TABL$D_1000014 D
    WHERE  (D.J_ID = :Q_J_ID)
    INTO   :PD_ID, :PD_NAME, :PD_FLAG_DELETE, :PD_TMC_ID, :PD_PRICE_TMC, :PD_PRICE, :PD_QUANT
  DO
    BEGIN
    INSERT INTO TABL$D_1000014 (J_ID, NAME, FLAG_DELETE, TMC_ID, PRICE_TMC
      ,PRICE, QUANT, J_ID_PARENT, D_ID_PARENT, J_ID_MARK
    )VALUES (:P_J_ID2, :PD_NAME, :PD_FLAG_DELETE, :PD_TMC_ID, :PD_PRICE_TMC
      ,:PD_PRICE, :PD_QUANT, :Q_J_ID, :PD_ID, 0
    );
    END

  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_ID2);
END
