EXECUTE BLOCK (
   Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS (
   ID                     TYPE OF COLUMN TABL$D_1000014.ID
  ,I                      TYPE OF COLUMN TABL$D_1000014.ID 
  ,NAME                   TYPE OF COLUMN TABL$D_1000014.NAME
  ,FLAG_DELETE            TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE
  ,J_ID                   TYPE OF COLUMN TABL$D_1000014.J_ID
  ,J_TYPE_ID              TYPE OF COLUMN TABL$D_1000014.J_ID
  ,J_TYPE_LISTROOT        TYPE OF COLUMN TABL$J_4.DOCSTR
  ,TMC_ID                 TYPE OF COLUMN TABL$D_1000014.TMC_ID
  ,TMC_LIST_ID            TYPE OF COLUMN TABL$R_TMC.TMC_LIST_ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_NAME2              TYPE OF COLUMN TABL$R_TMC.NAME2
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_NUMSHOW            TYPE OF COLUMN TABL$R_TMC.NUMSHOW
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_MORIONCODE         TYPE OF COLUMN TABL$R_TMC.MORIONCODE
  ,TMC_VEDCODE            TYPE OF COLUMN TABL$R_TMC.VEDCODE
  ,TMC_MODELNAME          TYPE OF COLUMN TABL$R_TMC.MODELNAME
  ,TMC_TYPE_ID            TYPE OF COLUMN TABL$R_TMC.TMC_TYPE_ID
  ,TMC_TYPE_NAME          TYPE OF COLUMN TABL$R_TMC_TYPES.NAME
  ,TMC_TYPE_IMAGE_INDEX   TYPE OF COLUMN TABL$R_TMC_TYPES.IMAGE_INDEX
  ,TMC_CTGR_ID            TYPE OF COLUMN TABL$R_TMC.TMC_CTGR_ID
  ,TMC_CTGR_NAME          TYPE OF COLUMN TABL$R_TMC_CTGR.NAME
  ,TMC_CTGR_PATH          TYPE OF COLUMN TABL$R_TMC_CTGR.PATH
  ,TMC_EDIZM_ID           TYPE OF COLUMN TABL$R_TMC.EDIZM_ID
  ,TMC_EDIZM_NAME         TYPE OF COLUMN TABL$R_EDIZM.NAME
  ,TMC_EDIZM_SHORT        TYPE OF COLUMN TABL$R_EDIZM.SHORT_NAME
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC.TMC_GROUP_ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_COUNTRY_ID         TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,TMC_VALUTE_NAME        TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE              TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_MASSA              TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_QUANTORDER   TYPE OF COLUMN TABL$R_TMC.MASSA_QUANTORDER
  ,TMC_MASSA_QUANTORDER_T TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_TOTAL        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_T            TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS_T        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO_T      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_QUANTORDER_T1000 TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_T1000        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS_T1000    TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO_T1000  TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_TOTAL1000    TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_ORDERQUANT         TYPE OF COLUMN TABL$R_TMC.ORDERQUANT
  ,PRICE_TMC              TYPE OF COLUMN TABL$D_1000014.PRICE_TMC
  ,PRICE                  TYPE OF COLUMN TABL$D_1000014.PRICE
  ,QUANTORDER             TYPE OF COLUMN TABL$D_1000014.QUANT
  ,QUANT                  TYPE OF COLUMN TABL$D_1000014.QUANT
  ,TOTALWOAMOUNT          TYPE OF COLUMN TABL$D_1000014.TOTALWOAMOUNT
  ,TOTALAMOUNT            TYPE OF COLUMN TABL$D_1000014.TOTALAMOUNT
  ,TOTAL                  TYPE OF COLUMN TABL$D_1000014.TOTAL
  ,J_ID_PARENT            TYPE OF COLUMN TABL$D_1000014.J_ID_PARENT
  ,D_ID_PARENT            TYPE OF COLUMN TABL$D_1000014.D_ID_PARENT
  ,QUANT_QUANT            TYPE OF COLUMN TABL$D_1000014.QUANT
  ,QUANT_NOW              TYPE OF COLUMN TABL$D_1000014.QUANT
)AS
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DATE_COMMIT TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_PLACE_ID    TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_SQL_E       TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  SELECT FIRST 1 J4.FIRM_ID, J4.DATE_COMMIT, J4.TYPE_ID 
  FROM   TABL$J_4 J4 
  WHERE  (J4.ID = :Q_J_ID) 
  INTO   :P_FIRM_ID, :P_DATE_COMMIT, :J_TYPE_ID;
  
  SELECT FIRST 1 P.TYPELIST FROM PROC$J$TYPELISTROOT(:J_ID) P INTO :J_TYPE_LISTROOT;

  SELECT FIRST 1 J.PLACE_ID
  FROM   TABL$J_1000014 J 
  WHERE  (J.J_ID = :Q_J_ID) 
  INTO   :P_PLACE_ID;

  I = 0;
  FOR
    SELECT DB.ID, DB.NAME, DB.FLAG_DELETE, DB.J_ID, DB.TMC_ID, TMC.TMC_LIST_ID
          ,TMC.NAME, TMC.NAME2, TMC.ARTICLE, TMC.NUMSHOW, TMC.BARCODE, TMC.VEDCODE, TMC.MODELNAME
          ,TMC.TMC_CTGR_ID , COALESCE(CT.NAME  ,''), COALESCE(CT.NAME       ,'')
          ,TMC.TMC_TYPE_ID , COALESCE(TT.NAME  ,''), COALESCE(TT.IMAGE_INDEX,13)
          ,TMC.EDIZM_ID    , COALESCE(ED.NAME  ,''), COALESCE(ED.SHORT_NAME ,'')
          ,TMC.TMC_GROUP_ID, COALESCE(TG.NAME  ,'')
          ,TMC.COUNTRY_ID  , COALESCE(C1.VALUTE,'')
          ,TMC.PROBE, TMC.LGTH, TMC.DIAM, TMC.MASSA, (TMC.MASSA - TMC.MASSA_NETTO), TMC.MASSA_NETTO, TMC.MASSA_QUANTORDER
          ,TMC.ORDERQUANT, TMC.MORIONCODE
          ,DB.PRICE_TMC, DB.PRICE, DB.QUANT, DB.TOTALWOAMOUNT, DB.TOTALAMOUNT, DB.TOTAL
          ,DB.J_ID_PARENT, DB.D_ID_PARENT
    FROM   TABL$D_1000014 DB
             LEFT OUTER JOIN TABL$R_TMC        TMC ON (TMC.ID = DB.TMC_ID)
             LEFT OUTER JOIN TABL$R_EDIZM      ED  ON (ED.ID  = TMC.EDIZM_ID)
             LEFT OUTER JOIN TABL$R_TMC_GROUP  TG  ON (TG.ID  = TMC.TMC_GROUP_ID)
             LEFT OUTER JOIN TABL$R_TMC_TYPES  TT  ON (TT.ID  = TMC.TMC_TYPE_ID)
             LEFT OUTER JOIN TABL$R_TMC_CTGR   CT  ON (CT.ID  = TMC.TMC_CTGR_ID)
             LEFT OUTER JOIN TABL$R_TMC_BRANDS BT  ON (BT.ID  = TMC.TMC_BRAND_ID)
             LEFT OUTER JOIN TABL$R_COUNTRIES  C1  ON (C1.ID  = TMC.COUNTRY_ID) 
    WHERE  (DB.J_ID = :Q_J_ID)
    ORDER BY CT.ORDERID, BT.ORDERID, CT.NAME, BT.NAME, TMC.ORDERID, TMC.NAME2
    INTO    :ID, :NAME, :FLAG_DELETE, :J_ID, :TMC_ID, :TMC_LIST_ID
           ,:TMC_NAME, :TMC_NAME2, :TMC_ARTICLE, :TMC_NUMSHOW, :TMC_BARCODE, :TMC_VEDCODE, :TMC_MODELNAME
           ,:TMC_CTGR_ID, :TMC_CTGR_NAME, :TMC_CTGR_PATH
           ,:TMC_TYPE_ID, :TMC_TYPE_NAME, :TMC_TYPE_IMAGE_INDEX
           ,:TMC_EDIZM_ID, :TMC_EDIZM_NAME, :TMC_EDIZM_SHORT
           ,:TMC_GROUP_ID, :TMC_GROUP_NAME
           ,:TMC_COUNTRY_ID, :TMC_VALUTE_NAME, :TMC_PROBE, :TMC_LGTH, :TMC_DIAM
           ,:TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO, :TMC_MASSA_QUANTORDER
           ,:TMC_ORDERQUANT, :TMC_MORIONCODE
           ,:PRICE_TMC, :PRICE, :QUANT, :TOTALWOAMOUNT, :TOTALAMOUNT, :TOTAL
           ,:J_ID_PARENT, :D_ID_PARENT
  DO
    BEGIN
    QUANTORDER = 0;
    IF(:TMC_ORDERQUANT <> 0)THEN
      QUANTORDER = :QUANT / :TMC_ORDERQUANT;
    ELSE
      QUANTORDER = :QUANT;
    TMC_MASSA_T                = :TMC_MASSA            * :QUANT;
    TMC_MASSA_INS_T            = :TMC_MASSA_INS        * :QUANT;
    TMC_MASSA_NETTO_T          = :TMC_MASSA_NETTO      * :QUANT;
    TMC_MASSA_QUANTORDER_T     = :TMC_MASSA_QUANTORDER * :QUANTORDER;
    TMC_MASSA_TOTAL            = :TMC_MASSA_T          + :TMC_MASSA_QUANTORDER_T;
    TMC_MASSA_T1000            = :TMC_MASSA_T            / 1000;
    TMC_MASSA_INS_T1000        = :TMC_MASSA_INS_T        / 1000;
    TMC_MASSA_NETTO_T1000      = :TMC_MASSA_NETTO_T      / 1000;
    TMC_MASSA_QUANTORDER_T1000 = :TMC_MASSA_QUANTORDER_T / 1000;
    TMC_MASSA_TOTAL1000        = :TMC_MASSA_TOTAL        / 1000;

    QUANT_QUANT   = 0;
    SELECT COALESCE(SUM(P.QUANT),0)
    FROM   TABL$P_TMCQUANT P
    WHERE  ((P.FIRM_ID+0)  = :P_FIRM_ID)
      AND  ((P.PLACE_ID+0) = :P_PLACE_ID)
      AND  (P.FLAG_DEBET   = 1)
      AND  (P.TMC_ID       = :TMC_ID)
      AND  (P.DATE_COMMIT <= :P_DATE_COMMIT)
    INTO   :QUANT_QUANT; 
    QUANT_NOW = 0;
    SELECT COALESCE(SUM(P.QUANT),0)
    FROM   TABL$P_TMCQUANT P
    WHERE  ((P.FIRM_ID+0)  = :P_FIRM_ID)
      AND  ((P.PLACE_ID+0) = :P_PLACE_ID)
      AND  (P.FLAG_DEBET   = 1)
      AND  (P.TMC_ID       = :TMC_ID)
    INTO   :QUANT_NOW; 

    I = :I + 1;
    SUSPEND;
    END
END
