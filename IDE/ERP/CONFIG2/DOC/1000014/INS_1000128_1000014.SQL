EXECUTE BLOCK (
  Q_PARENT_DOC_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
) RETURNS (
  J_ID       TYPE OF COLUMN TABL$J_4.ID
 ,DOCTYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID
)AS
  DECLARE VARIABLE PP_TYPE_ID      TYPE OF COLUMN TABL$J_4.TYPE_ID;
  DECLARE VARIABLE P_J_ID          TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_PLACE_ID      TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_CS_ID         TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_CS_ADDR_ID    TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID;
  DECLARE VARIABLE P_CS_DOC_ID     TYPE OF COLUMN TABL$J_1000014.CS_DOC_ID;
  DECLARE VARIABLE P_TAX_ID        TYPE OF COLUMN TABL$J_1000014.TAX_ID;
  DECLARE VARIABLE P_WRK_ID        TYPE OF COLUMN TABL$J_1000014.WRK_ID;
  DECLARE VARIABLE P_TMC_GRID_ID   TYPE OF COLUMN TABL$J_1000014.TMC_GRID_ID;

  DECLARE VARIABLE P_J_PAY_ID      TYPE OF COLUMN TABL$J_1000014.J_PAY_ID;
BEGIN
  DOCTYPE_ID = 1000128;

  P_J_PAY_ID = 0;
  SELECT FIRST 1 J.TYPE_ID
  FROM   TABL$J_4 J
  WHERE  (J.ID = :Q_PARENT_DOC_ID)
  INTO   :PP_TYPE_ID;
  IF(:PP_TYPE_ID IN (1000071, 1000135))THEN
    BEGIN
    SELECT FIRST 1 COALESCE(D0017.J_ID,0)
    FROM   TABL$D_1000017 D0017
    WHERE  (D0017.J_REASON_ID = :Q_PARENT_DOC_ID)
    INTO   :P_J_PAY_ID; IF (:P_J_PAY_ID IS NULL) THEN P_J_PAY_ID = 0;
    END

  SELECT FIRST 1 J.FIRM_ID, JB.PLACE_ID, JB.CS_ID, JB.CS_ADDR_ID, JB.CS_DOC_ID
        ,JB.TAX_ID, JB.WRK_ID, JB.TMC_GRID_ID
  FROM   TABL$J_4 J, TABL$J_1000014 JB
  WHERE  (J.ID = :Q_PARENT_DOC_ID)
    AND  (JB.J_ID = J.ID)
  INTO   :P_FIRM_ID, :P_PLACE_ID, :P_CS_ID, :P_CS_ADDR_ID, :P_CS_DOC_ID
        ,:P_TAX_ID, :P_WRK_ID, :P_TMC_GRID_ID;

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_4(:P_FIRM_ID, :DOCTYPE_ID, :Q_PARENT_DOC_ID) P INTO :J_ID;

  UPDATE OR INSERT INTO TABL$J_1000014 (J_ID, CS_ID, CS_ADDR_ID, CS_DOC_ID, PLACE_ID, TAX_ID, TO_PLACE_ID, WRK_ID, TMC_GRID_ID, J_PAY_ID)
    VALUES (:J_ID, :P_CS_ID, :P_CS_ADDR_ID, :P_CS_DOC_ID, :P_PLACE_ID, :P_TAX_ID, 0, :P_WRK_ID, :P_TMC_GRID_ID, :P_J_PAY_ID)
    MATCHING(J_ID);

  UPDATE OR INSERT INTO TABL$J_CHILDS(J_ID, J_CHILD_ID) VALUES (:Q_PARENT_DOC_ID, :J_ID) MATCHING (J_ID, J_CHILD_ID);

  SELECT FIRST 1 P.J_ID
  FROM   PROC$J_INS_1000014_1000014(:Q_PARENT_DOC_ID, :J_ID) P
  INTO   :P_J_ID;

  SUSPEND;
END
