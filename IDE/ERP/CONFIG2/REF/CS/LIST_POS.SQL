EXECUTE BLOCK(
   Q_CS_GROUP_ID   TYPE OF COLUMN TABL$R_CS.CS_GROUP_ID = ?CS_GROUP_ID
  ,Q_LITERA        TYPE OF COLUMN TABL$R_CS.NAME        = ?LITERA
)RETURNS (
 ERP_DATASET_DBKEY TYPE OF COLUMN TABL$R_CS.ID
  ,CS_GROUP_ID     TYPE OF COLUMN TABL$R_CS.CS_GROUP_ID
  ,ID              TYPE OF COLUMN TABL$R_CS.ID
  ,NAME            TYPE OF COLUMN TABL$R_CS.NAME
  ,NAME2           TYPE OF COLUMN TABL$R_CS.NAME2
  ,FLAG_BAD        TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
  ,FLAG_PHOTO      TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
  ,FLAG_DELETE     TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
  ,FLAG_PUBLIC     TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
  ,FLAG_DOVER      TYPE OF COLUMN TABL$R_CS.ID
  ,J_1000062_CNT   TYPE OF COLUMN TABL$R_CS.ID
  ,KIND_ID         TYPE OF COLUMN TABL$R_CS.KIND_ID
  ,KIND_NAME       TYPE OF COLUMN TABL$R_CS_KINDS.NAME
  ,KIND_SHORT_NAME TYPE OF COLUMN TABL$R_CS_KINDS.SHORT_NAME
  ,NDS_PAYED       TYPE OF COLUMN TABL$R_CS.NDS_PAYED
  ,NDS_CODE        TYPE OF COLUMN TABL$R_CS.NDS_CODE
  ,INN             TYPE OF COLUMN TABL$R_CS.INN
  ,BIRTHDAY        TYPE OF COLUMN TABL$R_CS.BIRTHDAY
  ,BIRTHYEAR       TYPE OF COLUMN TABL$R_CS.INN
  ,GUID            TYPE OF COLUMN TABL$R_CS.GUID
  ,COMENT          TYPE OF COLUMN TABL$R_CS.COMENT
  ,COMENT_EX       TYPE OF COLUMN TABL$R_CS.NAME
  ,DATE_LAST       TYPE OF COLUMN TABL$R_CS.DATE_LAST
  ,VALUE_DATE      TYPE OF COLUMN TABL$R_CS.VALUE_DATE
  ,AMOUNT          TYPE OF COLUMN TABL$R_CS_P.AMOUNT
  ,FILIAL_ID       TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME     TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,CODEFLAYER      TYPE OF COLUMN TABL$R_CS.NAME
  ,CODECARD        TYPE OF COLUMN TABL$R_CS.NAME
  ,ADDRLIST        DOMN$PSTRING_512
  ,PHONELIST       DOMN$PSTRING_512
  ,DOCLIST         DOMN$PSTRING_512
)AS
  DECLARE VARIABLE P_CS_LIST_BAD TYPE OF COLUMN TABL$R_CS.COMENT;
  DECLARE VARIABLE P_SQL         TYPE OF COLUMN TABL$R_CS.COMENT;
BEGIN
  SELECT '~'||LIST(CL.CS_ID, '~')||'~'
  FROM   TABL$R_CS_LISTS CL
  WHERE  (CL.LIST_ID = 1000001)
  INTO   :P_CS_LIST_BAD;

  FOR
    SELECT CS.CS_GROUP_ID, CS.ID, CS.NAME, CS.NAME2, CS.FLAG_DELETE, CS.KIND_ID
          ,CSK.NAME, CSK.SHORT_NAME, CS.NDS_PAYED, CS.NDS_CODE, CS.INN, CS.BIRTHDAY, CS.GUID
          ,CS.COMENT, CS.DATE_LAST, CS.VALUE_DATE, CS.FILIAL_ID
          ,(SELECT FIRST 1 COALESCE(FL.NAME,'') FROM TABL$R_FILIALS FL WHERE (FL.ID = CS.FILIAL_ID)) AS FILIAL_NAME
    FROM   TABL$R_CS CS, TABL$R_CS_KINDS CSK
    WHERE  (CS.CS_GROUP_ID = :Q_CS_GROUP_ID)
      AND  ((:Q_LITERA = '') OR (CS.NAME2 STARTING WITH :Q_LITERA))
      AND  (CSK.ID = CS.KIND_ID)
    ORDER BY CS.NAME2  
    INTO   :CS_GROUP_ID, :ID, :NAME, :NAME2, :FLAG_DELETE, :KIND_ID, :KIND_NAME
          ,:KIND_SHORT_NAME, :NDS_PAYED, :NDS_CODE, :INN, :BIRTHDAY, :GUID, :COMENT
          ,:DATE_LAST, :VALUE_DATE, :FILIAL_ID, :FILIAL_NAME
  DO
    BEGIN
    FLAG_PUBLIC = 0;
    IF(EXISTS(
      SELECT RF.RDB$FIELD_ID
      FROM   RDB$RELATION_FIELDS RF
      WHERE  (TRIM(RF.RDB$RELATION_NAME) = 'TABL$R_CS')
        AND  (TRIM(RF.RDB$FIELD_NAME) = 'FLAG_PUBLIC')
    ))THEN
      BEGIN
      P_SQL = 'SELECT FIRST 1 COALESCE(T.FLAG_PUBLIC, 0) FROM TABL$R_CS T WHERE (T.ID = :PQ_ID)';
      EXECUTE STATEMENT (:P_SQL) (
        PQ_ID := :ID
      )INTO :FLAG_PUBLIC;
      END

    ERP_DATASET_DBKEY = :ID;
    BIRTHYEAR  = EXTRACT(YEAR FROM :BIRTHDAY);
    COMENT_EX  = SUBSTRING(:COMENT FROM 1 FOR 250);
    FLAG_BAD   = 0; IF(:P_CS_LIST_BAD CONTAINING '~'||:ID||'~')THEN FLAG_BAD = 1;
    FLAG_PHOTO = 0; IF(EXISTS(SELECT P.ID FROM TABL$R_CS_PHOTO P WHERE (P.CS_ID = :ID)))THEN  FLAG_PHOTO = 1;
    
    J_1000062_CNT = 0; SELECT COALESCE(COUNT(ALL J62.J_ID),0) FROM TABL$J_1000062 J62 WHERE (J62.CS_ID = :ID)INTO :J_1000062_CNT;
    
    AMOUNT = 0;
    SELECT FIRST 1 COALESCE(P.AMOUNT, 0)
    FROM   TABL$R_CS_P P
    WHERE  (P.CS_ID = :ID)
      AND  (P.VALUE_DATE = :VALUE_DATE)
    INTO   :AMOUNT; IF(:AMOUNT IS NULL)THEN AMOUNT = 0;

    ADDRLIST  = '';
    PHONELIST = '';
    DOCLIST   = '';
    SELECT SUBSTRING(LIST(CSA.NAME, ASCII_CHAR(13)||ASCII_CHAR(10)) FROM 1 FOR 510)
    FROM   TABL$R_CS_ADDR CSA
    WHERE  (CSA.CS_ID = :ID)
    INTO   :ADDRLIST;

    SELECT SUBSTRING(LIST(CSP.NAME, '; ') FROM 1 FOR 510)
    FROM   TABL$R_CS_PHONES CSP
    WHERE  (CSP.CS_ID = :ID)
    INTO   :PHONELIST;

    SELECT SUBSTRING(LIST(DT.NAME||' CEPÈß "'||CD.DOC_SERIAL||'" ¹'||CD.DOC_NUMBER||' ÂÛÄÀÍ:'||CD.NAME, ASCII_CHAR(13)||ASCII_CHAR(10)) FROM 1 FOR 510)
    FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
    WHERE  (CD.CS_ID = :ID)
      AND  (DT.ID = CD.DOCTYPE_ID)
    INTO   :DOCLIST;

    FLAG_DOVER = 0;
    IF(EXISTS(
      SELECT FIRST 1 L.ID
      FROM   TABL$R_CS_LINKS L
      WHERE  (L.CS_CHILD_ID = :ID)
        AND  ((L.LINKTYPE_ID+0) = 1000004)
    ))THEN FLAG_DOVER = 1;
    IF(EXISTS(
      SELECT FIRST 1 L.ID
      FROM   TABL$R_CS_LINKS L
      WHERE  (L.CS_ID = :ID)
        AND  ((L.LINKTYPE_ID+0) = 1000004)
    ))THEN FLAG_DOVER = 2;

    SUSPEND;
    END
END
