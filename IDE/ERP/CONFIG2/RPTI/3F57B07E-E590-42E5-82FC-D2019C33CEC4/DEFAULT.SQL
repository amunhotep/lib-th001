EXECUTE BLOCK (
  Q_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID     = ?FIRM_ID
 ,Q_DATE_FROM     TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO       TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_DATE_RPT      TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_RPT
 ,Q_FLAG_KRD      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG_KRD
 ,Q_FLAG_QUOTER   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG_QUOTER
 ,Q_FLAG_O11      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG_O11
 ,Q_FLAG_O12      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG_O12
 ,Q_FLAG_O2X      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG_O2X
)RETURNS(
  FIRM_ID         TYPE OF COLUMN TABL$J_4.FIRM_ID
 ,FIRM_NAME       TYPE OF COLUMN TABL$R_FIRMS.NAME
 ,DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_RPT        TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FLAG_KRD        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_QUOTER     TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O11        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O12        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O2X        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,J_CNTR          TYPE OF COLUMN TABL$J_4.ID
 ,J_DATE          TYPE OF COLUMN TABL$J_4.NAME
 ,J_CS_ID         TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_CS_NAME       TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_CS_NAME2      TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_CS_INN        TYPE OF COLUMN TABL$R_CS.INN
 ,J_P_SUM         TYPE OF COLUMN TABL$J_1000014.P_SUM
 ,J_P_NDP         TYPE OF COLUMN TABL$J_1000014.P_NDP
 ,J_P_SUMNDP      TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
 ,J_P_SUM1        TYPE OF COLUMN TABL$J_1000014.P_SUM
 ,J_P_NDP1        TYPE OF COLUMN TABL$J_1000014.P_NDP
 ,J_P_SUMNDP1     TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
 ,J_P_SUMS        TYPE OF COLUMN TABL$J_1000014.P_SUM
 ,J_P_NDPS        TYPE OF COLUMN TABL$J_1000014.P_NDP
 ,J_P_SUMNDPS     TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
)AS
  DECLARE VARIABLE P_TYPES TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DUMMY TYPE OF COLUMN TABL$J_4.NAME;
BEGIN
  FIRM_ID     = :Q_FIRM_ID;
  DATE_FROM   = :Q_DATE_FROM;
  DATE_TO     = :Q_DATE_TO;
  DATE_RPT    = :Q_DATE_RPT;
  FLAG_KRD    = :Q_FLAG_KRD;
  FLAG_QUOTER = :Q_FLAG_QUOTER;
  FLAG_O11    = :Q_FLAG_O11;
  FLAG_O12    = :Q_FLAG_O12;
  
  FLAG_O2X    = :Q_FLAG_O2X;
  
  SELECT FIRST 1 F.NAME FROM TABL$R_FIRMS F WHERE (F.ID = :FIRM_ID) INTO :FIRM_NAME;
  IF(:FLAG_KRD = 1)THEN
    P_TYPES = '~1000131~';
   ELSE
    P_TYPES = '~1000132~';

  J_P_SUM1    = 0;
  J_P_NDP1    = 0;
  J_P_SUMNDP1 = 0;
  
  SELECT COALESCE(SUM(ROUND(J14.P_SUM,2)),0), COALESCE(SUM(ROUND(J14.P_NDP,2)),0), COALESCE(SUM(ROUND(J14.P_SUMNDP,2)),0)
  FROM   TABL$J_4 J, TABL$J_1000014 J14
  WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
    AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
    AND  (J.FLAG_COMMIT = 1)
    AND  ((J.FIRM_ID+0) = :FIRM_ID)
    AND  (J14.J_ID = J.ID)
    AND  (J14.FLAG_PNP02 = 1)
  INTO   :J_P_SUM1, :J_P_NDP1, :J_P_SUMNDP1;

  SELECT COALESCE(SUM(ROUND(J14.P_SUM,2)),0), COALESCE(SUM(ROUND(J14.P_NDP,2)),0), COALESCE(SUM(ROUND(J14.P_SUMNDP,2)),0)
  FROM   TABL$J_4 J, TABL$J_1000014 J14
  WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
    AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
    AND  (J.FLAG_COMMIT = 1)
    AND  ((J.FIRM_ID+0) = :FIRM_ID)
    AND  (J14.J_ID = J.ID)
  INTO   :J_P_SUMS, :J_P_NDPS, :J_P_SUMNDPS;

  J_DATE = '';
  J_CNTR = 0;
  IF(:FLAG_KRD = 1)THEN
    BEGIN
    FOR
      SELECT C.INN AS CS_INN 
            ,SUM(ROUND(J14.P_SUM,2)), SUM(ROUND(J14.P_NDP,2)), SUM(ROUND(J14.P_SUMNDP,2))
      FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$R_CS C
      WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
        AND  (J.FLAG_COMMIT = 1)
        AND  ((J.FIRM_ID+0) = :FIRM_ID)
        AND  (J14.J_ID = J.ID)
        AND  ( (J14.FLAG_PNP02 <> 1) OR (J14.FLAG_PNP02 IS NULL) )
        AND  (C.ID = J14.CS_ID)
      GROUP BY 1
      INTO   :J_CS_INN, :J_P_SUM, :J_P_NDP, :J_P_SUMNDP
    DO
      BEGIN
      J_CS_ID    = '';
      J_CS_NAME  = '';
      J_CS_NAME2 = '';
      SELECT LIST(DISTINCT C.ID,'; '), LIST(DISTINCT C.NAME,'; '), LIST(DISTINCT C.NAME2,'; ')
      FROM   TABL$R_CS C
      WHERE  (C.INN = :J_CS_INN)
      INTO   :J_CS_ID, :J_CS_NAME, :J_CS_NAME2;
  
      J_CNTR = :J_CNTR + 1;
      SUSPEND;
      END
    END  
  ELSE
    BEGIN
    FOR
      SELECT C.INN AS CS_INN
            ,(LPAD(EXTRACT(MONTH FROM J.DATE_IN),2,'0')||'.'||LPAD(EXTRACT(YEAR FROM J.DATE_IN),4,'0')) AS J_DATE
            ,SUM(ROUND(J14.P_SUM,2)), SUM(ROUND(J14.P_NDP,2)), SUM(ROUND(J14.P_SUMNDP,2))
      FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$R_CS C
      WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
        AND  (J.FLAG_COMMIT = 1)
        AND  ((J.FIRM_ID+0) = :FIRM_ID)
        AND  (J14.J_ID = J.ID)
        AND  ( (J14.FLAG_PNP02 <> 1) OR (J14.FLAG_PNP02 IS NULL) )
        AND  (C.ID = J14.CS_ID)
      GROUP BY 1, 2  
      INTO   :J_CS_INN, :J_DATE, :J_P_SUM, :J_P_NDP, :J_P_SUMNDP
    DO
      BEGIN
      J_CS_ID    = '';
      J_CS_NAME  = '';
      J_CS_NAME2 = '';
      SELECT LIST(DISTINCT C.ID,'; '), LIST(DISTINCT C.NAME,'; '), LIST(DISTINCT C.NAME2,'; ')
      FROM   TABL$R_CS C
      WHERE  (C.INN = :J_CS_INN)
      INTO   :J_CS_ID, :J_CS_NAME, :J_CS_NAME2;
  
      J_CNTR = :J_CNTR + 1;
      SUSPEND;
      END
    END      
END
