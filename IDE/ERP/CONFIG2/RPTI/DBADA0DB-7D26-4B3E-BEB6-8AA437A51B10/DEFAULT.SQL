EXECUTE BLOCK (
   Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_DATEFROM  TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO    TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
)RETURNS (
   DATEFROM             TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO               TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J66_ID               TYPE OF COLUMN TABL$J_4.ID
  ,J66_FIRM_ID          TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,J66_FIRM_NAME        TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,J66_FILIAL_ID        TYPE OF COLUMN TABL$J_4.FILIAL_ID
  ,J66_FILIAL_NAME      TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,J66_DATE_COMMIT      TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J66_DOCSUM           TYPE OF COLUMN TABL$J_4.DOCSUM
  ,J66_QUANT            TYPE OF COLUMN TABL$R_TMC.MASSA
  ,J66_MASSA            TYPE OF COLUMN TABL$R_TMC.MASSA
  ,J66_MASSA_NETTO      TYPE OF COLUMN TABL$R_TMC.MASSA
  ,J66_MASSA_INS        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,J62_ID               TYPE OF COLUMN TABL$J_4.ID
  ,J62_DOCNUMBERSTR     TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J62_DOCSUMLEFT       TYPE OF COLUMN TABL$J_1000062.DOCSUMLEFT
  ,J62_TMC_GROUP_ID     TYPE OF COLUMN TABL$J_1000062.TMC_GROUP_ID
  ,J62_TMC_GROUP_NAME   TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,SUMDEBT              TYPE OF COLUMN TABL$J_1000062.DOCSUMLEFT
)AS
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;
  FOR 
    SELECT J.ID, J.FIRM_ID, J.FILIAL_ID, J.DATE_COMMIT, J.DOCSUM
          ,(SELECT FIRST 1 COALESCE(F1.NAME,'') FROM TABL$R_FIRMS     F1 WHERE (F1.ID = J.FIRM_ID  ) )
          ,(SELECT FIRST 1 COALESCE(F2.NAME,'') FROM TABL$R_FILIALS   F2 WHERE (F2.ID = J.FILIAL_ID) )
          ,JZ.ID, JZ.DOCNUMBERSTR, JZALOG.DOCSUMLEFT, JZALOG.TMC_GROUP_ID
          ,(SELECT FIRST 1 COALESCE(T1.NAME,'') FROM TABL$R_TMC_GROUP T1 WHERE (T1.ID = JZALOG.TMC_GROUP_ID) )
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
    INTO   :J66_ID, :J66_FIRM_ID, :J66_FILIAL_ID, :J66_DATE_COMMIT, :J66_DOCSUM
          ,:J66_FIRM_NAME, :J66_FILIAL_NAME
          ,:J62_ID, :J62_DOCNUMBERSTR, :J62_DOCSUMLEFT, :J62_TMC_GROUP_ID, :J62_TMC_GROUP_NAME
  DO
    BEGIN
    SELECT COALESCE(SUM(D14.QUANT), 0)
          ,COALESCE(SUM(D14.QUANT * T.MASSA ), 0)
          ,COALESCE(SUM(D14.QUANT * T.MASSA_NETTO ), 0)
          ,COALESCE(SUM(D14.QUANT * (T.MASSA - T.MASSA_NETTO)), 0)
    FROM   TABL$D_1000014 D14, TABL$R_TMC T
    WHERE  (D14.J_ID = :J66_ID)
      AND  (T.ID = D14.TMC_ID)
    INTO   :J66_QUANT, :J66_MASSA, :J66_MASSA_NETTO, :J66_MASSA_INS;
    SUMDEBT = :J66_DOCSUM - :J62_DOCSUMLEFT;
    SUSPEND;
    END
END
