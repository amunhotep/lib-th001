EXECUTE BLOCK (
   Q_DATEFROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_FIRMGRP  TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FIRMGRP
)RETURNS(
   DATEFROM     TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,PLACE_ID     TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME   TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,FIRM_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID 
  ,FIRM_IDS     TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FIRM_NAME    TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,SALDOBEGIN   TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,DEBET        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,KREDIT       TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,SALDOEND     TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,SALDODIFF    TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
)AS
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;
  FOR SELECT P.ID, P.NAME, P.ACC_ID FROM TABL$R_PLACES P ORDER BY P.ID INTO :PLACE_ID, :PLACE_NAME, :PLACE_ACC_ID DO
    BEGIN
    SALDOBEGIN = 0;
    DEBET      = 0;
    KREDIT     = 0;
    SALDOEND   = 0;
    SALDODIFF  = 0;
    IF(:Q_FIRMGRP = 1)THEN
      BEGIN
      FIRM_ID = -1;
      FIRM_IDS = :Q_FIRM_IDS;
      SELECT LIST(F.NAME,',') FROM TABL$R_FIRMS F WHERE (:FIRM_IDS CONTAINING '~'||F.ID||'~')INTO :FIRM_NAME;
      FOR
        SELECT COALESCE(SUM(Q.MASSA_NETTO),0)
        FROM   (SELECT  (TQ1.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT TQ1, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQ1.FIRM_ID ||'~')
                  AND  ((TQ1.PLACE_ID+0) = :PLACE_ID)
                  AND  (TMC.ID = TQ1.TMC_ID)
                UNION ALL  -- DEBET
                SELECT  ((-1) * TQD.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQD.FIRM_ID ||'~')
                  AND  ((TQD.PLACE_ID+0) = :PLACE_ID)
                  AND  (TQD.FLAG_DEBET = 1)
                  AND  (TQD.DATE_COMMIT >= :DATETO)
                  AND  (TMC.ID = TQD.TMC_ID)
                UNION ALL  -- KREDIT
                SELECT  (TQK.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQK.FIRM_ID ||'~')
                  AND  ((TQK.PLACE_ID+0) = :PLACE_ID)
                  AND  (TQK.FLAG_DEBET = 0)
                  AND  (TQK.DATE_COMMIT >= :DATETO)
                  AND  (TMC.ID = TQK.TMC_ID)
                )Q
        INTO   :SALDOEND
      DO
        BEGIN
        SELECT COALESCE(SUM(TQD.QUANT * TMC.MASSA_NETTO),0)
        FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
        WHERE  (:FIRM_IDS CONTAINING '~'||TQD.FIRM_ID||'~')
          AND  ((TQD.PLACE_ID+0) = :PLACE_ID)
          AND  (TQD.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
          AND  (TQD.FLAG_DEBET = 1)
          AND  (TMC.ID = TQD.TMC_ID)
        INTO   :DEBET;
        SELECT COALESCE(SUM(TQK.QUANT * TMC.MASSA_NETTO),0)
        FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
        WHERE  (:FIRM_IDS CONTAINING '~'||TQK.FIRM_ID||'~')
          AND  ((TQK.PLACE_ID+0) = :PLACE_ID)
          AND  (TQK.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
          AND  (TQK.FLAG_DEBET = 0)
          AND  (TMC.ID = TQK.TMC_ID)
        INTO   :KREDIT;
        SALDOBEGIN = :SALDOEND - :DEBET + :KREDIT;
        END
      END
     ELSE
      BEGIN
      FOR
        SELECT Q.FIRM_ID, COALESCE(SUM(Q.MASSA_NETTO),0)
        FROM   (SELECT  TQ1.FIRM_ID, (TQ1.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT TQ1, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQ1.FIRM_ID ||'~')
                  AND  ((TQ1.PLACE_ID+0) = :PLACE_ID)
                  AND  (TMC.ID = TQ1.TMC_ID)
                UNION ALL  -- DEBET
                SELECT  TQD.FIRM_ID, ((-1) * TQD.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQD.FIRM_ID ||'~')
                  AND  ((TQD.PLACE_ID+0) = :PLACE_ID)
                  AND  (TQD.FLAG_DEBET = 1)
                  AND  (TQD.DATE_COMMIT >= :DATETO)
                  AND  (TMC.ID = TQD.TMC_ID)
                UNION ALL  -- KREDIT
                SELECT TQK.FIRM_ID, (TQK.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
                FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
                WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TQK.FIRM_ID ||'~')
                  AND  ((TQK.PLACE_ID+0) = :PLACE_ID)
                  AND  (TQK.FLAG_DEBET = 0)
                  AND  (TQK.DATE_COMMIT >= :DATETO)
                  AND  (TMC.ID = TQK.TMC_ID)
                )Q
        GROUP BY Q.FIRM_ID
        INTO    :FIRM_ID, :SALDOEND
      DO
        BEGIN
        FIRM_IDS = '~'||:FIRM_ID||'~';
        SELECT FIRST 1 F.NAME FROM TABL$R_FIRMS F WHERE (F.ID = :FIRM_ID)INTO :FIRM_NAME;
        SELECT COALESCE(SUM(TQD.QUANT * TMC.MASSA_NETTO),0)
        FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
        WHERE  ((TQD.FIRM_ID+0) = :FIRM_ID)
          AND  ((TQD.PLACE_ID+0) = :PLACE_ID)
          AND  (TQD.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
          AND  (TQD.FLAG_DEBET = 1)
          AND  (TMC.ID = TQD.TMC_ID)
        INTO   :DEBET;
        SELECT COALESCE(SUM(TQK.QUANT * TMC.MASSA_NETTO),0)
        FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
        WHERE  ((TQK.FIRM_ID+0) = :FIRM_ID)
          AND  ((TQK.PLACE_ID+0) = :PLACE_ID)
          AND  (TQK.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
          AND  (TQK.FLAG_DEBET = 0)
          AND  (TMC.ID = TQK.TMC_ID)
        INTO   :KREDIT;
        SALDOBEGIN = :SALDOEND - :DEBET + :KREDIT;
        END
      END
    SALDODIFF  = :SALDOEND - :SALDOBEGIN;
    IF((:SALDOBEGIN<>0) OR (:DEBET<>0) OR (:KREDIT<>0) OR (:SALDOEND<>0))THEN SUSPEND;
    END
END
