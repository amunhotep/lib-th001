EXECUTE BLOCK (
   Q_FIRM_IDS              TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_PLACE_IDS             TYPE OF COLUMN TABL$J_4.DOCSTR      = ?PLACES_IDS
  ,Q_DATE                  TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_CHECK_IN_FILIAL       TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?CHECK_IN_FILIAL
  ,Q_FILIAL_DATABASE       TYPE OF COLUMN TABL$J_4.NAME        = ?FILIAL_DATABASE
)RETURNS (
   DATE_RPT                TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FLAG_DIFF               TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  
  ,FIRM_IDS                TYPE OF COLUMN TABL$J_4.DOCSTR
  ,PLACE_IDS               TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FIRM_ID                 TYPE OF COLUMN TABL$R_FIRMS.ID
  ,FIRM_NAME               TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,PLACE_ID                TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME              TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID            TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,TMC_GROUP_ID            TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME          TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_ID                  TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME                TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE             TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE             TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,COUNTRY_ID              TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,VALUTE                  TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE               TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_MASSA               TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS           TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO         TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_              TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS_          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO_        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_LGTH                TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM                TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_VALUE_DATE          TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE                   TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT                   TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT_EXTERNAL          TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTAL                   TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TMC_MASSAG              TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INSG          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTOG        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,QUANTG                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTALG                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,J_1000062_ID            TYPE OF COLUMN TABL$J_4.ID
  ,J_1000062_DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000062_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000062_DATE_RETURN   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000062_FLAG          TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,J_1000026_ID            TYPE OF COLUMN TABL$J_4.ID
  ,J_1000026_DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000026_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
)
AS
  DECLARE VARIABLE P_TMC_GROUP_ID      TYPE OF COLUMN TABL$R_TMC.TMC_GROUP_ID;
  DECLARE VARIABLE P_FILIAL_ID         TYPE OF COLUMN TABL$P_TMC_QUANT.PLACE_ID;
  DECLARE VARIABLE P_PLACE_ID_EXTERNAL TYPE OF COLUMN TABL$P_TMC_QUANT.PLACE_ID;
  DECLARE VARIABLE P_TMC_ID_EXTERNAL   TYPE OF COLUMN TABL$P_TMC_QUANT.TMC_ID;
  DECLARE VARIABLE P_QUANT_EXT         TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT;
  DECLARE VARIABLE P_SQL               TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  DATE_RPT  = :Q_DATE;
  FIRM_IDS  = :Q_FIRM_IDS;
  PLACE_IDS = :Q_PLACE_IDS;
  FLAG_DIFF = 0;
  P_SQL     = 'SELECT FIRST 1 P.QUANT FROM PROC$P_TMC_QUANT_ON_DATE(?FIRM_ID, ?TMC_ID, ?PLACE_ID, ?QDATE) P ';
  TMC_MASSAG       = 0;
  TMC_MASSA_INSG   = 0;
  TMC_MASSA_NETTOG = 0;
  QUANTG           = 0;
  TOTALG           = 0;
  P_TMC_GROUP_ID   = 0;
  FOR
    SELECT Q.FIRM_ID, Q.PLACE_ID, Q.TMC_GROUP_ID, Q.COUNTRY_ID, Q.PROBE, Q.TMC_ID, SUM(Q.QUANT)
    FROM   (SELECT  TQ1.FIRM_ID, TQ1.PLACE_ID, TMC.TMC_GROUP_ID, TMC.COUNTRY_ID, TMC.PROBE, TQ1.TMC_ID, TQ1.QUANT
            FROM    TABL$P_TMC_QUANT TQ1, TABL$R_TMC TMC
            WHERE  (:FIRM_IDS  CONTAINING '~'||TQ1.FIRM_ID ||'~')
              AND  (:PLACE_IDS CONTAINING '~'||TQ1.PLACE_ID||'~')
              AND  (TMC.ID = TQ1.TMC_ID)
            UNION ALL  -- DEBET
            SELECT  TQD.FIRM_ID, TQD.PLACE_ID, TMC.TMC_GROUP_ID, TMC.COUNTRY_ID, TMC.PROBE, TQD.TMC_ID, ((-1) * TQD.QUANT) AS QUANT
            FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
            WHERE  (:FIRM_IDS  CONTAINING '~'||TQD.FIRM_ID ||'~')
              AND  (:PLACE_IDS CONTAINING '~'||TQD.PLACE_ID||'~')
              AND  (TQD.FLAG_DEBET = 1)
              AND  (TQD.DATE_COMMIT >= :DATE_RPT)
              AND  (TMC.ID = TQD.TMC_ID)
            UNION ALL  -- KREDIT
            SELECT TQK.FIRM_ID, TQK.PLACE_ID, TMC.TMC_GROUP_ID, TMC.COUNTRY_ID, TMC.PROBE, TQK.TMC_ID, TQK.QUANT
            FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
            WHERE  (:FIRM_IDS  CONTAINING '~'||TQK.FIRM_ID ||'~')
              AND  (:PLACE_IDS CONTAINING '~'||TQK.PLACE_ID||'~')
              AND  (TQK.FLAG_DEBET = 0)
              AND  (TQK.DATE_COMMIT >= :DATE_RPT)
              AND  (TMC.ID = TQK.TMC_ID)
            )Q
    GROUP BY Q.FIRM_ID, Q.PLACE_ID, Q.TMC_GROUP_ID, Q.COUNTRY_ID, Q.PROBE, Q.TMC_ID
    INTO    :FIRM_ID, :PLACE_ID, :TMC_GROUP_ID, :COUNTRY_ID, :TMC_PROBE, :TMC_ID, :QUANT
  DO
  IF(:QUANT <> 0)THEN
    BEGIN
    SELECT FIRST 1 F.NAME           FROM TABL$R_FIRMS  F WHERE(F.ID = :FIRM_ID )INTO :FIRM_NAME;
    SELECT FIRST 1 P.NAME, P.ACC_ID FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME, :PLACE_ACC_ID;

    SELECT FIRST 1 TMC.NAME, TMC.ARTICLE, TMC.BARCODE, TMC.COUNTRY_ID, TMC.PROBE
          ,(SELECT FIRST 1 C.VALUTE FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE
          ,TMC.MASSA, (TMC.MASSA - TMC.MASSA_NETTO) AS MASSA_INS, TMC.MASSA_NETTO
          ,TMC.LGTH, TMC.DIAM, TMC.TMC_GROUP_ID, TG.NAME AS TMC_GROUP_NAME
    FROM   TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
    WHERE  (TMC.ID = :TMC_ID)
      AND  (TG.ID = TMC.TMC_GROUP_ID)
    INTO   :TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :COUNTRY_ID, :TMC_PROBE, :VALUTE
          ,:TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO, :TMC_LGTH, :TMC_DIAM
          ,:TMC_GROUP_ID, :TMC_GROUP_NAME;
    TMC_MASSA_       = :TMC_MASSA       * :QUANT;
    TMC_MASSA_INS_   = :TMC_MASSA_INS   * :QUANT;
    TMC_MASSA_NETTO_ = :TMC_MASSA_NETTO * :QUANT;
    PRICE        = 0;
    SELECT MAX(P.VALUE_DATE)
    FROM   TABL$R_TMC_P P
    WHERE  (P.TMC_ID = :TMC_ID)
      AND  (P.VALUE_DATE <= :DATE_RPT)
    INTO   :TMC_VALUE_DATE;
    IF(:TMC_VALUE_DATE IS NULL)THEN
      BEGIN
      SELECT FIRST 1 PR.PRICE, PR.VALUE_DATE
      FROM   TABL$R_TMC_P PR, TABL$R_TMC TMC
      WHERE  (TMC.ID        = :TMC_ID)
        AND  (PR.TMC_ID     = TMC.ID)
        AND  (PR.VALUE_DATE = TMC.VALUE_DATE)
      INTO   :PRICE, :TMC_VALUE_DATE; IF(:PRICE IS NULL)THEN PRICE = 0;
      END
     ELSE
      BEGIN
      SELECT FIRST 1 P.PRICE
      FROM   TABL$R_TMC_P P
      WHERE  (P.TMC_ID = :TMC_ID)
        AND  (P.VALUE_DATE = :TMC_VALUE_DATE)
      INTO   :PRICE;
      END
    TOTAL = :PRICE * :QUANT;
    IF(:TMC_GROUP_ID <> :P_TMC_GROUP_ID)THEN
      BEGIN
      TMC_MASSAG       = 0;
      TMC_MASSA_INSG   = 0;
      TMC_MASSA_NETTOG = 0;
      QUANTG           = 0;
      TOTALG           = 0;
      P_TMC_GROUP_ID   = :TMC_GROUP_ID;
      END
    TMC_MASSAG       = :TMC_MASSAG       + :TMC_MASSA_;
    TMC_MASSA_INSG   = :TMC_MASSA_INSG   + :TMC_MASSA_INS_;
    TMC_MASSA_NETTOG = :TMC_MASSA_NETTOG + :TMC_MASSA_NETTO_;
    QUANTG           = :QUANTG + :QUANT;
    TOTALG           = :TOTALG + :TOTAL;

    J_1000062_ID           = 0;
    J_1000062_DOCNUMBERSTR = '';
    J_1000062_DATE_COMMIT  = NULL;
    J_1000062_DATE_RETURN  = NULL;
    J_1000062_FLAG         = 0;
    J_1000026_ID           = 0;
    J_1000026_DOCNUMBERSTR = '';
    J_1000026_DATE_COMMIT  = NULL;
    SELECT FIRST 1 COALESCE(J62.ID,0), COALESCE(J62.DOCNUMBERSTR,''), J62.DATE_COMMIT, JZ.DATE_RETURN
    FROM   TABL$D_1000014 DB, TABL$J_4 J64, TABL$J_CHILDS JC, TABL$J_4 J62, TABL$J_1000062 JZ
    WHERE  (DB.TMC_ID     = :TMC_ID)
      AND  (J64.ID        = DB.J_ID)
      AND  (J64.TYPE_ID   = 1000064)
      AND  (JC.J_CHILD_ID = DB.J_ID)
      AND  (J62.ID        = JC.J_ID)
      AND  (J62.TYPE_ID   = 1000062)
      AND  (JZ.J_ID       = J62.ID)
    INTO   :J_1000062_ID, :J_1000062_DOCNUMBERSTR, :J_1000062_DATE_COMMIT, :J_1000062_DATE_RETURN;
    IF(:J_1000062_ID = 0)THEN
      BEGIN
      SELECT FIRST 1 COALESCE(J26.ID,0), COALESCE(J26.DOCNUMBERSTR,''), J26.DATE_COMMIT
      FROM   TABL$D_1000014 DB, TABL$J_4 J26
      WHERE  (DB.TMC_ID       = :TMC_ID)
        AND  (J26.ID          = DB.J_ID)
        AND  (J26.TYPE_ID     = 1000026)
        AND  (J26.FLAG_COMMIT = 1)
      INTO   :J_1000026_ID, :J_1000026_DOCNUMBERSTR, :J_1000026_DATE_COMMIT;
      END
     ELSE
      BEGIN
      IF(DATEDIFF(DAY FROM :J_1000062_DATE_RETURN TO :DATE_RPT) > 0)THEN
        J_1000062_FLAG = 1;
      END 
    SUSPEND;
    END
END
