EXECUTE BLOCK (
   Q_DATEFROM        TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO          TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS        TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_PLACE_ID        TYPE OF COLUMN TABL$R_PLACES.ID     = ?PLACE_ID
)RETURNS(
   DATEFROM          TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO            TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,PLACE_ID          TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME        TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID      TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,FIRM_ID           TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME         TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,TMC_GROUP_ID      TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME    TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_GROUP_PATH    TYPE OF COLUMN TABL$R_TMC_GROUP.PATH
  ,TMC_ID            TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME          TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE       TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE       TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_COUNTRY_ID    TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,VALUTE            TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE         TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_LGTH          TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM          TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_MASSA         TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_INS     TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_NETTO   TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_VALUE_DATE    TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,TMC_PRICE         TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,TMC_VALUE_DATEEND TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,TMC_PRICE_END     TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,SALDOBEGIN_M      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,DEBET_M           TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,KREDIT_M          TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,SALDOEND_M        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,SALDOBEGIN_Q      TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,DEBET_Q           TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,KREDIT_Q          TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,SALDOEND_Q        TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,SALDOBEGIN_S      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEBET_S           TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEBET_S1          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,KREDIT_S          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,KREDIT_S1         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SALDOEND_S        TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_SUM TYPE OF COLUMN TABL$J_4.DOCSUM;
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;
  PLACE_ID = :Q_PLACE_ID;

  SELECT FIRST 1 P.NAME, P.ACC_ID
  FROM   TABL$R_PLACES P
  WHERE  (P.ID = :PLACE_ID)
  INTO   :PLACE_NAME, :PLACE_ACC_ID;

  FOR
    SELECT DISTINCT T.TMC_ID, T.FIRM_ID, FRM.NAME
          ,TMC.NAME, TMC.ARTICLE, TMC.BARCODE, TMC.LGTH, TMC.DIAM, TMC.COUNTRY_ID, TMC.PROBE
          ,(SELECT FIRST 1 C.VALUTE FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID))
          ,TMC.TMC_GROUP_ID, TG.NAME, TG.PATH, TMC.MASSA, TMC.MASSA_NETTO, (TMC.MASSA - TMC.MASSA_NETTO)
    FROM   ( SELECT TQ.TMC_ID, TQ.FIRM_ID
             FROM   TABL$P_TMC_QUANT TQ
             WHERE  (TQ.PLACE_ID = :PLACE_ID)
               AND  (:Q_FIRM_IDS CONTAINING '~'||TQ.FIRM_ID||'~' )
             UNION ALL
             SELECT TM.TMC_ID, TM.FIRM_ID
             FROM   TABL$P_TMC_QUANT_MOVE TM
             WHERE  (TM.DATE_COMMIT >= :DATEFROM)
               AND  (TM.PLACE_ID = :PLACE_ID)
               AND  (:Q_FIRM_IDS CONTAINING '~'||TM.FIRM_ID||'~' )
             ) T, TABL$R_FIRMS FRM, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
    WHERE  (FRM.ID = (T.FIRM_ID+0))
      AND  (TMC.ID = T.TMC_ID)
      AND  (TG.ID = TMC.TMC_GROUP_ID)
    ORDER BY TG.PATH, TMC.COUNTRY_ID, TMC.PROBE, TMC.NAME, TMC.ARTICLE
    INTO   :TMC_ID, :FIRM_ID, :FIRM_NAME
          ,:TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :TMC_LGTH, :TMC_DIAM, :TMC_COUNTRY_ID, :TMC_PROBE, :VALUTE
          ,:TMC_GROUP_ID, :TMC_GROUP_NAME, :TMC_GROUP_PATH, :TMC_MASSA, :TMC_MASSA_NETTO, :TMC_MASSA_INS
  DO
    BEGIN
    TMC_VALUE_DATE    = NULL;
    TMC_VALUE_DATEEND = NULL;
    TMC_PRICE     = 0;
    TMC_PRICE_END = 0;
    SELECT MAX(P.VALUE_DATE)           FROM TABL$R_TMC_P P WHERE(P.TMC_ID = :TMC_ID)AND(P.VALUE_DATE <= :DATEFROM       )INTO :TMC_VALUE_DATE;
    SELECT MAX(P.VALUE_DATE)           FROM TABL$R_TMC_P P WHERE(P.TMC_ID = :TMC_ID)AND(P.VALUE_DATE <= :DATETO         )INTO :TMC_VALUE_DATEEND;
    SELECT FIRST 1 COALESCE(P.PRICE,0) FROM TABL$R_TMC_P P WHERE(P.TMC_ID = :TMC_ID)AND(P.VALUE_DATE =:TMC_VALUE_DATE   )INTO :TMC_PRICE;
    SELECT FIRST 1 COALESCE(P.PRICE,0) FROM TABL$R_TMC_P P WHERE(P.TMC_ID = :TMC_ID)AND(P.VALUE_DATE =:TMC_VALUE_DATEEND)INTO :TMC_PRICE_END;

    SELECT COALESCE(SUM(TQ.QUANT),0), COALESCE(SUM(TQ.QUANT * :TMC_MASSA_NETTO),0)
    FROM   TABL$P_TMC_QUANT TQ
    WHERE  ((TQ.FIRM_ID+0)  = :FIRM_ID)
      AND  ((TQ.PLACE_ID+0) = :PLACE_ID)
      AND  (TQ.TMC_ID = :TMC_ID)
    INTO   :SALDOEND_Q, :SALDOEND_M;
    SELECT COALESCE(SUM(TM.QUANT),0), COALESCE(SUM(TM.QUANT * :TMC_MASSA_NETTO),0)
    FROM   TABL$P_TMC_QUANT_MOVE TM
    WHERE  (TM.TMC_ID = :TMC_ID)
      AND  ((TM.PLACE_ID+0) = :PLACE_ID)
      AND  ((TM.FIRM_ID+0) = :FIRM_ID)
      AND  (TM.FLAG_DEBET = 1)
      AND  (TM.DATE_COMMIT > :DATETO)
    INTO   :DEBET_Q, :DEBET_M;
    SELECT COALESCE(SUM(TM.QUANT),0), COALESCE(SUM(TM.QUANT * :TMC_MASSA_NETTO),0)
    FROM   TABL$P_TMC_QUANT_MOVE TM
    WHERE  (TM.TMC_ID = :TMC_ID)
      AND  ((TM.PLACE_ID+0) = :PLACE_ID)
      AND  ((TM.FIRM_ID+0) = :FIRM_ID)
      AND  (TM.FLAG_DEBET = 0)
      AND  (TM.DATE_COMMIT > :DATETO)
    INTO   :KREDIT_Q, :KREDIT_M;
    SALDOEND_Q = :SALDOEND_Q - :DEBET_Q + :KREDIT_Q;
    SALDOEND_M = :SALDOEND_M - :DEBET_M + :KREDIT_M;

    SELECT COALESCE(SUM(TM.QUANT),0), COALESCE(SUM(TM.QUANT * TM.PRICE_TMC),0), COALESCE(SUM(TM.QUANT * :TMC_MASSA_NETTO),0)
    FROM   TABL$P_TMC_QUANT_MOVE TM
    WHERE  (TM.TMC_ID = :TMC_ID)
      AND  ((TM.PLACE_ID+0) = :PLACE_ID)
      AND  ((TM.FIRM_ID+0) = :FIRM_ID)
      AND  (TM.FLAG_DEBET = 1)
      AND  (TM.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
    INTO   :DEBET_Q, :DEBET_S, :DEBET_M;
    SELECT COALESCE(SUM(TM.QUANT),0), COALESCE(SUM(TM.QUANT * TM.PRICE_TMC),0), COALESCE(SUM(TM.QUANT * :TMC_MASSA_NETTO),0)
    FROM   TABL$P_TMC_QUANT_MOVE TM
    WHERE  (TM.TMC_ID = :TMC_ID)
      AND  ((TM.PLACE_ID+0) = :PLACE_ID)
      AND  ((TM.FIRM_ID+0) = :FIRM_ID)
      AND  (TM.FLAG_DEBET = 0)
      AND  (TM.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
    INTO   :KREDIT_Q, :KREDIT_S, :KREDIT_M;

    SALDOBEGIN_Q = :SALDOEND_Q - :DEBET_Q + :KREDIT_Q;
    SALDOBEGIN_M = :SALDOEND_M - :DEBET_M + :KREDIT_M;
    SALDOBEGIN_S = :SALDOBEGIN_Q * :TMC_PRICE;
    SALDOEND_S   = :SALDOEND_Q   * :TMC_PRICE_END;
    DEBET_S1     = 0;
    KREDIT_S1    = 0;
    IF((:SALDOEND_S - (:SALDOBEGIN_S + :DEBET_S - :KREDIT_S)) > 0)THEN
      BEGIN
      DEBET_S1  = :SALDOEND_S - (:SALDOBEGIN_S + :DEBET_S - :KREDIT_S);
      END
     ELSE
      BEGIN
      KREDIT_S1 = (:SALDOEND_S - (:SALDOBEGIN_S + :DEBET_S - :KREDIT_S)) * (-1);
      END
    IF((:SALDOBEGIN_Q <> 0) OR (:DEBET_Q <> 0) OR (:KREDIT_Q <> 0) OR (:SALDOEND_Q <> 0))THEN SUSPEND;
    END
END
