EXECUTE BLOCK (
   Q_DATEFROM             TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO               TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS             TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_PLACE_IDS            TYPE OF COLUMN TABL$J_4.DOCSTR      = ?PLACES_IDS
)RETURNS(
   DATEFROM               TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO                 TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,PLACE_ID               TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID           TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,FIRM_ID                TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME              TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_GROUP_PATH         TYPE OF COLUMN TABL$R_TMC_GROUP.PATH
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_COUNTRY_ID         TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,VALUTE                 TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE              TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_MASSA              TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_INS          TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_NETTO        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_             TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS_         TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO_       TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_LIG          TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,PRICE                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,PRICE_IN               TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,GESHEFT                TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,CS_ID_KRD              TYPE OF COLUMN TABL$J_1000014.CS_ID
  ,CS_NAME_KRD            TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_ID                  TYPE OF COLUMN TABL$J_1000014.CS_ID
  ,CS_NAME                TYPE OF COLUMN TABL$R_CS.NAME
  ,J_1000062_ID           TYPE OF COLUMN TABL$J_4.ID
  ,J_1000062_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000062_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000062_DATE_RETURN  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000062_FLAG         TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,J_1000026_ID           TYPE OF COLUMN TABL$J_4.ID
  ,J_1000026_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000026_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000028_ID           TYPE OF COLUMN TABL$J_4.ID
  ,J_1000028_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000028_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
)AS
  DECLARE P_J_ID    TYPE OF COLUMN TABL$J_4.ID;
  DECLARE P_TYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID;
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;

  FOR
    SELECT TM.FIRM_ID, (SELECT FIRST 1 F.NAME FROM TABL$R_FIRMS F WHERE(F.ID = TM.FIRM_ID)) AS FIRM_NAME
          ,TM.PLACE_ID, (SELECT FIRST 1 P.NAME FROM TABL$R_PLACES P WHERE(P.ID = TM.PLACE_ID)) AS PLACE_NAME
          ,(SELECT FIRST 1 P.ACC_ID FROM TABL$R_PLACES P WHERE(P.ID = TM.PLACE_ID)) AS PLACE_ACC_ID
          ,TM.TMC_ID, COALESCE(TM.QUANT,0), COALESCE(TM.PRICE_TMC,0)
          ,TMC.NAME, TMC.ARTICLE, TMC.BARCODE, TMC.COUNTRY_ID, TMC.PROBE
          ,(SELECT FIRST 1 C.VALUTE FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE
          ,TMC.MASSA, (TMC.MASSA - TMC.MASSA_NETTO) AS MASSA_INS, TMC.MASSA_NETTO
          ,TMC.LGTH, TMC.DIAM, TMC.TMC_GROUP_ID, TG.NAME AS TMC_GROUP_NAME
          ,TM.J_ID
    FROM   TABL$P_TMC_QUANT_MOVE TM, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
    WHERE  (:Q_FIRM_IDS  CONTAINING '~'||TM.FIRM_ID||'~' )
      AND  (:Q_PLACE_IDS CONTAINING '~'||TM.PLACE_ID||'~' )
      AND  (TM.FLAG_DEBET = 0)
      AND  (TM.DATE_COMMIT BETWEEN :DATEFROM AND :DATETO)
      AND  (TMC.ID = TM.TMC_ID)
      AND  (TG.ID = TMC.TMC_GROUP_ID)
    ORDER BY TM.DATE_COMMIT
    INTO   :FIRM_ID, :FIRM_NAME, :PLACE_ID, :PLACE_NAME, :PLACE_ACC_ID
          ,:TMC_ID, :QUANT, :PRICE
          ,:TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :TMC_COUNTRY_ID, :TMC_PROBE, :VALUTE
          ,:TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO, :TMC_LGTH, :TMC_DIAM
          ,:TMC_GROUP_ID, :TMC_GROUP_NAME
          ,:P_J_ID
  DO
    BEGIN
    TMC_MASSA_       = :TMC_MASSA       * :QUANT;
    TMC_MASSA_INS_   = :TMC_MASSA_INS   * :QUANT;
    TMC_MASSA_NETTO_ = :TMC_MASSA_NETTO * :QUANT;
    TMC_MASSA_LIG    = 0;
    SELECT FIRST 1 P.MASSA_LIGAT FROM PROC$O_ENT_PS_MASSA_LIG(:TMC_PROBE, :TMC_MASSA_NETTO_) P INTO :TMC_MASSA_LIG;
    TOTAL            = :PRICE           * :QUANT;
    CS_ID     = NULL; CS_NAME     = NULL;
    CS_ID_KRD = NULL; CS_NAME_KRD = NULL;
    SELECT FIRST 1 JB.CS_ID, CS.NAME 
    FROM   TABL$J_1000014 JB, TABL$R_CS CS 
    WHERE  (JB.J_ID = :P_J_ID)
      AND  (CS.ID = JB.CS_ID)
    INTO   :CS_ID_KRD, :CS_NAME_KRD;  
    PRICE_IN = 0;
    GESHEFT  = 0;
    J_1000062_ID           = 0;
    J_1000062_DOCNUMBERSTR = '';
    J_1000062_DATE_COMMIT  = NULL;
    J_1000062_DATE_RETURN  = NULL;
    J_1000062_FLAG         = 0;
    J_1000026_ID           = 0;
    J_1000026_DOCNUMBERSTR = '';
    J_1000026_DATE_COMMIT  = NULL;
    J_1000028_ID           = 0;
    J_1000028_DOCNUMBERSTR = '';
    J_1000028_DATE_COMMIT  = NULL;
    
    SELECT FIRST 1 COALESCE(DB.PRICE,0), COALESCE(J62.ID,0), COALESCE(J62.DOCNUMBERSTR,''), J62.DATE_COMMIT, JZ.DATE_RETURN
          ,COALESCE(JZ.CS_ID,0), (SELECT FIRST 1 CS.NAME FROM TABL$R_CS CS WHERE (CS.ID = JZ.CS_ID))
    FROM   TABL$D_1000014 DB, TABL$J_4 J64, TABL$J_CHILDS JC, TABL$J_4 J62, TABL$J_1000062 JZ
    WHERE  (DB.TMC_ID     = :TMC_ID)
      AND  (J64.ID        = DB.J_ID)
      AND  (J64.TYPE_ID   = 1000064)
      AND  (JC.J_CHILD_ID = DB.J_ID)
      AND  (J62.ID        = JC.J_ID)
      AND  (J62.TYPE_ID   = 1000062)
      AND  (JZ.J_ID       = J62.ID)
    INTO   :PRICE_IN, :J_1000062_ID, :J_1000062_DOCNUMBERSTR, :J_1000062_DATE_COMMIT, :J_1000062_DATE_RETURN, :CS_ID, :CS_NAME;
    IF(:J_1000062_ID = 0)THEN
      BEGIN
      SELECT FIRST 1 COALESCE(DB.PRICE,0), COALESCE(J26.ID,0), COALESCE(J26.DOCNUMBERSTR,''), J26.DATE_COMMIT
            ,COALESCE(JB.CS_ID,0), (SELECT FIRST 1 CS.NAME FROM TABL$R_CS CS WHERE (CS.ID = JB.CS_ID))
      FROM   TABL$D_1000014 DB, TABL$J_4 J26, TABL$J_1000014 JB
      WHERE  (DB.TMC_ID       = :TMC_ID)
        AND  (J26.ID          = DB.J_ID)
        AND  (J26.TYPE_ID     = 1000026)
        AND  (J26.FLAG_COMMIT = 1)
        AND  (JB.J_ID = J26.ID)
      INTO   :PRICE_IN, :J_1000026_ID, :J_1000026_DOCNUMBERSTR, :J_1000026_DATE_COMMIT, :CS_ID, :CS_NAME;

      SELECT FIRST 1 J.TYPE_ID FROM TABL$J_4 J WHERE (J.ID = :P_J_ID) INTO :P_TYPE_ID;
      IF(:P_TYPE_ID = 1000028)THEN
        BEGIN
        SELECT FIRST 1 COALESCE(J28.ID,0), COALESCE(J28.DOCNUMBERSTR,''), J28.DATE_COMMIT
        FROM   TABL$J_4 J28
        WHERE  (J28.ID      = :P_J_ID)
          AND  (J28.TYPE_ID = 1000028)
        INTO   :J_1000028_ID, :J_1000028_DOCNUMBERSTR, :J_1000028_DATE_COMMIT;
        END
      END
    GESHEFT = (:PRICE - :PRICE_IN) * :QUANT;
    SUSPEND;
    END
END
