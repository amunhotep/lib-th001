EXECUTE BLOCK (
  Q_DATE_FROM    TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO      TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS     TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
 ,Q_CS_ID        TYPE OF COLUMN TABL$R_CS.ID         = ?CS_ID
 ,Q_ACC_ID       TYPE OF COLUMN TABL$R_BUHG_ACCS.ID  = ?ACC_ID
 ,Q_ADDRESS_ID   TYPE OF COLUMN TABL$R_ADDRESS.ID    = ?ADDRESS_ID
)RETURNS (
   DATE_FROM         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_COMMIT       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS          TYPE OF COLUMN TABL$J_4.DOCSTR
  ,ACC_ID            TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
  ,ACC_NAME          TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
  ,CS_ID             TYPE OF COLUMN TABL$D_1000019.CS_ID
  ,CS_KIND_ID        TYPE OF COLUMN TABL$R_CS.KIND_ID
  ,CS_KIND_NAME      TYPE OF COLUMN TABL$R_CS_KINDS.NAME
  ,CS_KIND_SHORT     TYPE OF COLUMN TABL$R_CS_KINDS.SHORT_NAME
  ,CS_KIND_JURIDICAL TYPE OF COLUMN TABL$R_CS_KINDS.JURIDICAL
  ,CS_NAME           TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_NAME2          TYPE OF COLUMN TABL$R_CS.NAME2
  ,CS_FLAG_DELETE    TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
  ,CS_INN            TYPE OF COLUMN TABL$R_CS.INN
  ,CS_NDS_PAYED      TYPE OF COLUMN TABL$R_CS.NDS_PAYED
  ,CS_NDS_CODE       TYPE OF COLUMN TABL$R_CS.NDS_CODE
  ,CS_EDRPOU         TYPE OF COLUMN TABL$R_CS.EDRPOU
  ,CS_CERTIFICATE    TYPE OF COLUMN TABL$R_CS.CERTIFICATE
  ,CS_CODEFLAYER     TYPE OF COLUMN TABL$R_CS.CODEFLAYER
  ,CS_CODECARD       TYPE OF COLUMN TABL$R_CS.CODECARD
  ,CS_GUID           TYPE OF COLUMN TABL$R_CS.GUID
  ,CS_COMENT         TYPE OF COLUMN TABL$R_CS.COMENT
  ,CS_WRK_ID_DIR     TYPE OF COLUMN TABL$R_CS.WRK_ID_DIR
  ,CS_WRK_ID_BUH     TYPE OF COLUMN TABL$R_CS.WRK_ID_BUH
  ,CS_WRK_NAME_DIR   TYPE OF COLUMN TABL$R_WRK.NAME
  ,CS_WRK_NAME_BUH   TYPE OF COLUMN TABL$R_WRK.NAME
  ,CS_ADDR_ID        TYPE OF COLUMN TABL$R_CS.ID
  ,CS_ADDR_NAME      TYPE OF COLUMN TABL$R_CS.COMENT
  ,CS_ADDR_NAME_FULL TYPE OF COLUMN TABL$R_CS.COMENT
  ,CS_URLS           TYPE OF COLUMN TABL$R_CS.COMENT
  ,CS_EMAILS         TYPE OF COLUMN TABL$R_CS.COMENT
  ,CS_PHONES         TYPE OF COLUMN TABL$R_CS.COMENT
  ,ADDRESS_ID        TYPE OF COLUMN TABL$R_ADDRESS.ID
  ,ADDRESS_NAME_FULL TYPE OF COLUMN TABL$R_ADDRESS.NAME_FULL
  ,BANK_ID           TYPE OF COLUMN TABL$R_BANKACC.ID
  ,BANK_RS           TYPE OF COLUMN TABL$R_BANKACC.NAME
  ,BANK_MFO          TYPE OF COLUMN TABL$R_BANKS.MFO
  ,BANK_EDRPOU       TYPE OF COLUMN TABL$R_BANKS.EDRPOU
  ,BANK_NAME         TYPE OF COLUMN TABL$R_BANKS.NAME
  ,BANK_ADDRESS      TYPE OF COLUMN TABL$R_BANKS.ADDRESS
  ,FLAG_DEBET        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,NAME              TYPE OF COLUMN TABL$J_4.DOCSTR
  ,COMENT            TYPE OF COLUMN TABL$J_4.DOCSTR
  ,SALDO             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEBET             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,KREDIT            TYPE OF COLUMN TABL$J_4.DOCSUM
  ,J_ID              TYPE OF COLUMN TABL$J_4.ID
  ,J_TYPE_ID         TYPE OF COLUMN TABL$J_4.TYPE_ID
  ,J_TYPE_NAME       TYPE OF COLUMN TABL$_TB_TYPES.NAME
  ,J_DOCNUMBERSTR    TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_DOCNUMBERIN     TYPE OF COLUMN TABL$J_4.DOCNUMBERIN
  ,COLOR_BGR         TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
  ,COLOR_FRG         TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
)AS
  DECLARE VARIABLE P_COUNTRY_NAME   TYPE OF COLUMN TABL$R_COUNTRIES.NAME;
  DECLARE VARIABLE P_REGION_NAME    TYPE OF COLUMN TABL$R_REGIONS.NAME;
  DECLARE VARIABLE P_ADDRESS_ID     TYPE OF COLUMN TABL$R_ADDRESS.ID;
  DECLARE VARIABLE P_ADDRESS_ZIP    TYPE OF COLUMN TABL$R_ADDRESS.ZIP;

  DECLARE VARIABLE P_DEBET          TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_KREDIT         TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_DEBET_SAVE     TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_KREDIT_SAVE    TYPE OF COLUMN TABL$J_4.DOCSUM;
BEGIN 
  DATE_FROM  = :Q_DATE_FROM;
  DATE_TO    = :Q_DATE_TO;
  FIRM_IDS   = :Q_FIRM_IDS;
  CS_ID      = :Q_CS_ID;
  ACC_ID     = :Q_ACC_ID;
  ADDRESS_ID = :Q_ADDRESS_ID;

  SELECT FIRST 1 B.NAME      FROM TABL$R_BUHG_ACCS B WHERE(B.ID = :ACC_ID    )INTO :ACC_NAME;
  SELECT FIRST 1 A.NAME_FULL FROM TABL$R_ADDRESS   A WHERE(A.ID = :ADDRESS_ID)INTO :ADDRESS_NAME_FULL;
  SELECT FIRST 1
         CS.KIND_ID, CSK.NAME, CSK.SHORT_NAME, CSK.JURIDICAL
        ,CS.NAME, CS.NAME2, CS.FLAG_DELETE, CS.GUID, CS.COMENT
        ,CS.INN, CS.NDS_PAYED, CS.NDS_CODE, CS.EDRPOU, CS.CERTIFICATE
        ,CS.CODEFLAYER, CS.CODECARD, CS.WRK_ID_DIR, CS.WRK_ID_BUH
  FROM   TABL$R_CS CS, TABL$R_CS_KINDS CSK
  WHERE  (CS.ID = :CS_ID)
    AND  (CSK.ID = CS.KIND_ID)
  INTO   :CS_KIND_ID, :CS_KIND_NAME, :CS_KIND_SHORT, :CS_KIND_JURIDICAL
        ,:CS_NAME, :CS_NAME2, :CS_FLAG_DELETE, :CS_GUID, :CS_COMENT
        ,:CS_INN, :CS_NDS_PAYED, :CS_NDS_CODE, :CS_EDRPOU, :CS_CERTIFICATE
        ,:CS_CODEFLAYER, :CS_CODECARD, :CS_WRK_ID_DIR, :CS_WRK_ID_BUH
        ;
  SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK W WHERE (W.ID = :CS_WRK_ID_DIR) INTO :CS_WRK_NAME_DIR;
  SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK W WHERE (W.ID = :CS_WRK_ID_BUH) INTO :CS_WRK_NAME_BUH;

  SELECT FIRST 1 P.ADDRESS_NAME, P.ADDRESS_NAME_FULL
  FROM   PROC$R_ADDRESS_GET_CSJURIDICAL(:CS_ID) P
  INTO   :CS_ADDR_NAME, :CS_ADDR_NAME_FULL;

  SELECT LIST(U.NAME,'; ') FROM VIEW$R_CS_URL    U WHERE(U.CS_ID = :CS_ID)INTO :CS_URLS  ; IF(:CS_URLS   IS NULL)THEN CS_URLS   = '';
  SELECT LIST(E.NAME,'; ') FROM VIEW$R_CS_EMAIL  E WHERE(E.CS_ID = :CS_ID)INTO :CS_EMAILS; IF(:CS_EMAILS IS NULL)THEN CS_EMAILS = '';
  SELECT LIST(P.NAME,'; ') FROM VIEW$R_CS_PHONES P WHERE(P.CS_ID = :CS_ID)INTO :CS_PHONES; IF(:CS_PHONES IS NULL)THEN CS_PHONES = '';
  
  SELECT FIRST 1 B.ID
  FROM   VIEW$R_CS_BANK B
  WHERE  (B.CS_ID      = :CS_ID)
    AND  (B.FLAG_MAIN  = 1)
    AND  (B.COUNTRY_ID = 1000071)
  INTO   :BANK_ID;
  
  IF(:BANK_ID IS NULL)THEN
    SELECT FIRST 1 B.ID
    FROM   VIEW$R_CS_BANK B
    WHERE  (B.CS_ID = :CS_ID)
      AND  (B.COUNTRY_ID = 1000071)
    INTO   :BANK_ID;
  
  SELECT FIRST 1 B1.NAME, BB.MFO, BB.EDRPOU, BB.NAME, BB.ADDRESS
  FROM   VIEW$R_CS_BANK B1, TABL$R_BANKS BB
  WHERE  (B1.ID = :BANK_ID)
    AND  (BB.ID = B1.BANK_ID)
  INTO   :BANK_RS, :BANK_MFO, :BANK_EDRPOU, :BANK_NAME, :BANK_ADDRESS;


  FLAG_DEBET     = -1;
  NAME           = '';
  SALDO          = 0;
  DEBET          = 0;
  KREDIT         = 0;
  P_DEBET        = 0;
  P_KREDIT       = 0;
  J_ID           = 0;
  J_TYPE_ID      = 0;
  J_TYPE_NAME    = '';
  J_DOCNUMBERSTR = '';
  COLOR_BGR      = 0xFFFFFF;
  COLOR_FRG      = 0x000000;
  DATE_COMMIT    = :DATE_FROM;

  SELECT COALESCE(SUM(C.CND_VALUE),0)
  FROM   TABL$P_CND C
  WHERE  (C.DATE_COMMIT < :DATE_FROM)
    AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
    AND  (C.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~')
    AND  (C.SUBKONTO_ID_DEB = :CS_ID)
    AND  ( (:ADDRESS_ID = 0) OR (C.ADDRESS_ID = :ADDRESS_ID) )
  INTO   :DEBET;
  SELECT COALESCE(SUM(C.CND_VALUE),0)
  FROM   TABL$P_CND C
  WHERE  (C.DATE_COMMIT < :DATE_FROM)
    AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
    AND  (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~')
    AND  (C.SUBKONTO_ID_KRED = :CS_ID)
    AND  ( (:ADDRESS_ID = 0) OR (C.ADDRESS_ID = :ADDRESS_ID) )
  INTO   :KREDIT;
  SALDO = :DEBET - :KREDIT;
  DEBET  = 0;
  KREDIT = 0;
  IF(:SALDO > 0)THEN
    DEBET  = ABS(:SALDO);
   ELSE
    KREDIT = ABS(:SALDO);
  P_DEBET_SAVE  = :DEBET;
  P_KREDIT_SAVE = :KREDIT;
  NAME = 'ÑÀËÜÄÎ ÏÎ×ÀÒÊÎÂÅ';
  SUSPEND;
  FOR
    SELECT TMP.DATE_COMMIT, TMP.J_ID, TMP.FLAG_DEBET, TMP.NAME, COALESCE(SUM(TMP.CND_VALUE),0)
    FROM   (SELECT  1 AS FLAG_DEBET, C1.J_ID, C1.DATE_COMMIT, C1.NAME, C1.CND_VALUE
            FROM    TABL$P_CND C1
            WHERE   (C1.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
              AND   (:FIRM_IDS CONTAINING '~'||C1.FIRM_ID||'~')
              AND   (C1.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~')
              AND   (C1.SUBKONTO_ID_DEB = :CS_ID)
              AND  ( (:ADDRESS_ID = 0) OR (C1.ADDRESS_ID = :ADDRESS_ID) )
            UNION ALL
            SELECT  0 AS FLAG_DEBET, C2.J_ID, C2.DATE_COMMIT, C2.NAME, C2.CND_VALUE
            FROM    TABL$P_CND C2
            WHERE   (C2.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
              AND   (:FIRM_IDS CONTAINING '~'||C2.FIRM_ID||'~')
              AND   (C2.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~')
              AND   (C2.SUBKONTO_ID_KRED = :CS_ID)
              AND  ( (:ADDRESS_ID = 0) OR (C2.ADDRESS_ID = :ADDRESS_ID) )
            )TMP
    GROUP BY TMP.DATE_COMMIT, TMP.J_ID, TMP.FLAG_DEBET, TMP.NAME
    INTO   :DATE_COMMIT, :J_ID, :FLAG_DEBET, :COMENT, :SALDO
  DO
    BEGIN
    SELECT FIRST 1 J.TYPE_ID, DD.NAME, J.DOCNUMBERSTR, J.DOCNUMBERIN, DD.COLOR_BGR, DD.COLOR_FRG
    FROM   TABL$J_4 J, TABL$_TB_DOCS DD
    WHERE  (J.ID = :J_ID)
      AND  (DD.TYPE_ID = J.TYPE_ID)
    INTO   :J_TYPE_ID, :J_TYPE_NAME, :J_DOCNUMBERSTR, :J_DOCNUMBERIN, :COLOR_BGR, :COLOR_FRG;
    NAME   = '    '||:J_TYPE_NAME||' '||:J_DOCNUMBERSTR;
    DEBET  = 0;
    KREDIT = 0;
    IF(:FLAG_DEBET = 1)THEN
      BEGIN
      DEBET    = :SALDO;
      P_DEBET  = :P_DEBET + :DEBET;
      END
     ELSE
      BEGIN
      KREDIT   = :SALDO;
      P_KREDIT = :P_KREDIT + :KREDIT;
      END
    SUSPEND;
    END
  FLAG_DEBET     = -1;
  J_ID           = 0;
  J_TYPE_ID      = 0;
  J_TYPE_NAME    = '';
  J_DOCNUMBERSTR = '';
  COLOR_BGR      = 0xFFFFFF;
  COLOR_FRG      = 0x000000;
  DATE_COMMIT    = :DATE_TO;
  COMENT         = '';
  NAME           = 'ÎÁ²Ã ÇÀ ÏÅÐ²ÎÄ';
  DEBET          = :P_DEBET;
  KREDIT         = :P_KREDIT;
  SUSPEND;

  NAME           = 'ÑÀËÜÄÎ Ê²ÍÖÅÂÅ';
  DEBET          = 0;
  KREDIT         = 0;
  SALDO          = :P_DEBET_SAVE - :P_KREDIT_SAVE + :P_DEBET - :P_KREDIT;
  IF(:SALDO > 0)THEN DEBET = ABS(:SALDO); ELSE KREDIT = ABS(:SALDO);
  SUSPEND;
END
