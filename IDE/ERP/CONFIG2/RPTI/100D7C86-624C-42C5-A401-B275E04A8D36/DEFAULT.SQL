EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
  DATE_FROM               TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO                 TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_COMMIT             TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS                TYPE OF COLUMN TABL$J_4.DOCSTR
 ,FIRM_NAMES              TYPE OF COLUMN TABL$J_4.DOCSTR
 ,BUHG_ACCS_ID            TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
 ,BUHG_ACCS_PARENT_ID     TYPE OF COLUMN TABL$R_BUHG_ACCS.PARENT_ID
 ,BUHG_ACCS_NAME          TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
 ,BUHG_ACCS_NAMEPATH      TYPE OF COLUMN TABL$J_4.DOCSTR
 ,BUHG_ACCS_IDS           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,SUBKONTO                TYPE OF COLUMN TABL$R_BUHG_ACCS.SUBKONTO
 ,SUBKONTO_ID             TYPE OF COLUMN TABL$J_4.ID
 ,SUBKONTO_NAME           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,NAME                    TYPE OF COLUMN TABL$J_4.DOCSTR
 ,CNDSUM                  TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_FLAG      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT;
  DECLARE VARIABLE P_CNDSUM    TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_SUBKONTOS TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  SELECT FIRST 1 LIST(F.NAME,'; ') FROM TABL$R_FIRMS F WHERE(:FIRM_IDS CONTAINING '~'||F.ID||'~') INTO :FIRM_NAMES;
  IF(:DATE_TO < :DATE_FROM)THEN
    BEGIN
    SUSPEND;
    EXIT;
    END
  DATE_COMMIT = :DATE_FROM;
  WHILE(:DATE_COMMIT < :DATE_TO)DO
    BEGIN
    FOR
      SELECT TMP.ID, TMP.PARENT_ID, TMP.NAME, TMP.NAMEPATH, TMP.SUBKONTO
      FROM   (WITH RECURSIVE BA AS(
                SELECT B1.ID, B1.PARENT_ID, B1.NAME, B1.SUBKONTO, CAST('' AS VARCHAR(1)) AS NAMEPATH
                FROM   TABL$R_BUHG_ACCS B1
                WHERE  ('~91~92~93~' CONTAINING '~'||B1.ID||'~')
                UNION ALL
                SELECT B2.ID, B2.PARENT_ID, B2.NAME, B2.SUBKONTO, CAST('  '||B3.NAMEPATH AS VARCHAR(255)) AS NAMEPATH
                FROM   TABL$R_BUHG_ACCS B2, BA B3
                WHERE  (B2.PARENT_ID = B3.ID)
              )SELECT B.ID, B.PARENT_ID, B.NAME, B.NAMEPATH, B.SUBKONTO FROM BA B
              )TMP
      INTO   :BUHG_ACCS_ID, :BUHG_ACCS_PARENT_ID, :BUHG_ACCS_NAME, :BUHG_ACCS_NAMEPATH, :SUBKONTO
    DO 
      BEGIN
      BUHG_ACCS_NAMEPATH = :BUHG_ACCS_NAMEPATH||:BUHG_ACCS_NAME;
      SUBKONTO_ID      = -1000000;
      SUBKONTO_NAME    = '';
      NAME             = '';
      CNDSUM           = 0;
      WITH RECURSIVE BA AS(
        SELECT B1.ID, B1.PARENT_ID
        FROM   TABL$R_BUHG_ACCS B1
        WHERE  (B1.ID = :BUHG_ACCS_ID)
        UNION ALL
        SELECT B2.ID, B2.PARENT_ID
        FROM   TABL$R_BUHG_ACCS B2, BA B3
        WHERE  (B2.PARENT_ID = B3.ID)
      )
      SELECT COALESCE('~'||LIST(B.ID,'~')||'~', '')
      FROM   BA B
      WHERE  EXISTS(
               SELECT FIRST 1 C.ID
               FROM   TABL$P_CND C
               WHERE  ( (C.ACC_ID_DEB=B.ID) OR (C.ACC_ID_KRED=B.ID) )
                 AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
             )
      INTO :BUHG_ACCS_IDS;
      P_SUBKONTOS = '';
      FOR
        SELECT C.SUBKONTO_ID_DEB, C.NAME, SUM(C.CND_VALUE), LIST(C.SUBKONTO_NAME_DEB,'; ')
        FROM   TABL$P_CND C
        WHERE  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
          AND  (:BUHG_ACCS_IDS CONTAINING '~'||C.ACC_ID_DEB||'~')
          AND  (C.DATE_COMMIT BETWEEN :DATE_COMMIT AND DATEADD(1 DAY TO :DATE_COMMIT))
        GROUP BY 1,2
        INTO    :SUBKONTO_ID, :NAME, :CNDSUM, :P_SUBKONTOS
      DO
        BEGIN
        SUBKONTO_NAME   = '';
        SELECT FIRST 1 P.SUBKONTO_NAME
        FROM   PROC$R_BUHG_ACCS_SUBKONTO(:BUHG_ACCS_ID, :SUBKONTO_ID) P
        INTO   :SUBKONTO_NAME;
        IF(TRIM(:NAME) = '')THEN
          BEGIN
          SELECT LIST(COALESCE(J.DOCSTR,''), '')
          FROM   TABL$P_CND C, TABL$J_4 J
          WHERE  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
            AND  (:BUHG_ACCS_IDS CONTAINING '~'||C.ACC_ID_DEB||'~')
            AND  (C.DATE_COMMIT BETWEEN :DATE_COMMIT AND DATEADD(1 DAY TO :DATE_COMMIT))
            AND  (C.SUBKONTO_ID_DEB = :SUBKONTO_ID)
            AND  (J.ID = C.J_ID_ORD_DEB)
          INTO   :NAME;
          IF( (TRIM(:NAME) = '') OR (:NAME IS NULL) )THEN
            NAME = :P_SUBKONTOS;
          END
        SUSPEND;
        END
      END
    DATE_COMMIT = DATEADD(1 DAY TO :DATE_COMMIT);
    END
END
