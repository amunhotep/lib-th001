EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
  DATE_FROM         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS          TYPE OF COLUMN TABL$J_4.DOCSTR
 ,FIRM_NAMES        TYPE OF COLUMN TABL$J_4.DOCSTR
 ,ACC_ID            TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
 ,ACC_NAME          TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
 ,EXPENSE_ID        TYPE OF COLUMN TABL$R_EXPENSES.ID
 ,EXPENSE_PARENT_ID TYPE OF COLUMN TABL$R_EXPENSES.PARENT_ID
 ,EXPENSE_FLAG      TYPE OF COLUMN TABL$R_EXPENSES.FLAG_DELETE
 ,EXPENSE_NAME      TYPE OF COLUMN TABL$R_EXPENSES.NAME
 ,EXPENSE_INDENT    TYPE OF COLUMN TABL$R_EXPENSES.NAME
 ,EXPENSE_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_EXPENSE_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR;
  DECLARE VARIABLE P_EXPENSE_NAME TYPE OF COLUMN TABL$R_EXPENSES.NAME;
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  SELECT LIST(F.NAME,'; ') FROM TABL$R_FIRMS F WHERE (:FIRM_IDS CONTAINING '~'||F.ID||'~') INTO :FIRM_NAMES;

  --FOR SELECT B.ID, B.NAME FROM TABL$R_BUHG_ACCS B WHERE('~91~92~93~' CONTAINING '~'||B.ID||'~') ORDER BY B.ID INTO :ACC_ID, :ACC_NAME DO
  FOR
    SELECT FL.ID, FL.PARENT_ID, FL.NAME, FL.INDENT
    FROM   (WITH RECURSIVE EEE AS(
              SELECT E1.ID, E1.PARENT_ID, E1.NAME, CAST('' AS DOMN$PSTRING) AS INDENT
              FROM   TABL$R_EXPENSES E1
              WHERE  (E1.PARENT_ID = 0)
              UNION ALL
              SELECT E2.ID, E2.PARENT_ID, E2.NAME, CAST( ('  '||E3.INDENT) AS DOMN$PSTRING) AS INDENT
              FROM   TABL$R_EXPENSES E2, EEE E3
              WHERE  (E2.PARENT_ID = E3.ID)
            )SELECT E.ID, E.PARENT_ID, E.INDENT||E.NAME AS NAME, E.INDENT FROM EEE E
            )FL
    INTO   :EXPENSE_ID, :EXPENSE_PARENT_ID, :P_EXPENSE_NAME, :EXPENSE_INDENT
  DO 
    BEGIN 
    P_EXPENSE_IDS = '';
    WITH RECURSIVE EEE AS(
      SELECT E1.ID, E1.PARENT_ID FROM TABL$R_EXPENSES E1 WHERE (E1.ID = :EXPENSE_ID)
      UNION ALL
      SELECT E2.ID, E2.PARENT_ID FROM TABL$R_EXPENSES E2, EEE E3 WHERE (E2.PARENT_ID = E3.ID)
    )SELECT '~'||LIST(E.ID,'~')||'~' FROM EEE E INTO :P_EXPENSE_IDS;
/*
    IF(:EXPENSE_PARENT_ID = 0)THEN
      BEGIN
      EXPENSE_FLAG  = 1;
      EXPENSE_SUM   = 0;
      EXPENSE_NAME  = :P_EXPENSE_NAME||' другое ['||:ACC_ID||']';
      SELECT COALESCE(SUM(C.CND_VALUE),0)
      FROM   TABL$P_CND C
      WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
        AND  ('~1000025~1000026~1000029~' CONTAINING '~'||C.ACC_ID_DEB||'~')
        AND  (:P_EXPENSE_IDS NOT CONTAINING  '~'||C.SUBKONTO_ID_DEB||'~')
      INTO   :EXPENSE_SUM;
      SUSPEND;
      IF(:EXPENSE_SUM <> 0)THEN
        BEGIN
        EXPENSE_FLAG = 0;
        EXPENSE_NAME = '';
        FOR
          SELECT C.NAME, COALESCE(SUM(C.CND_VALUE),0)
          FROM   TABL$P_CND C
          WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
            AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
            AND  ('~1000025~1000026~1000029~' CONTAINING '~'||C.ACC_ID_DEB||'~')
            AND  (:P_EXPENSE_IDS NOT CONTAINING  '~'||C.SUBKONTO_ID_DEB||'~')
          GROUP BY 1
          INTO   :EXPENSE_NAME, :EXPENSE_SUM
        DO
          BEGIN
          EXPENSE_NAME = :EXPENSE_INDENT||'  --'||:EXPENSE_NAME;
          SUSPEND;
          END
        END
      END
*/
    EXPENSE_FLAG  = 0;
    IF(:EXPENSE_PARENT_ID = 0)THEN EXPENSE_FLAG  = 1;
    EXPENSE_SUM   = 0;
    EXPENSE_NAME  = :P_EXPENSE_NAME;
    SELECT COALESCE(SUM(C.CND_VALUE),0)
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  ('~1000025~1000026~1000029~' CONTAINING '~'||C.ACC_ID_DEB||'~')
      AND  (:P_EXPENSE_IDS CONTAINING  '~'||C.SUBKONTO_ID_DEB||'~')
    INTO   :EXPENSE_SUM;
    SUSPEND;
    END
END
