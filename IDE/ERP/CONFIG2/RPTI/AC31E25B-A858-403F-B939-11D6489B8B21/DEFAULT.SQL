EXECUTE BLOCK(
   Q_FIRM_IDS   TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_DATEFROM   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATEFROM
  ,Q_DATETO     TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATETO
  ,Q_DAYSTOADD  TYPE OF COLUMN TABL$J_4.ID          = ?DAYSTOADD
  ,Q_THOUSAND   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?THOUSAND
)RETURNS(
   DATEFROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,RISK_ID        TYPE OF COLUMN TABL$R_ENTPS_RISK.ID
  ,RISK_NAME      TYPE OF COLUMN TABL$R_ENTPS_RISK.NAME
  ,RISK_DAYSCNT   TYPE OF COLUMN TABL$R_ENTPS_RISK.DAYSCNT
  ,RISK_PCMAX     TYPE OF COLUMN TABL$R_ENTPS_RISK.PCMAX
  ,FIRM_ID        TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME      TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,DOCSUMCALC1    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DOCSUMCALC2    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESERVEBEGIN   TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESERVEEND     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESERVEDELTA   TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;
  FOR
    SELECT   P1.RISK_ID, P1.RISK_NAME, P1.RISK_DAYSCNT, P1.RISK_PCMAX, P1.FIRM_ID, P1.FIRM_NAME
            ,SUM(P1.DOCSUMCALC) AS DOCSUMCALC, SUM(P1.RESERVE) AS RESERVEBEGIN
    FROM     PROC$RPTI_ENTPS_RISKS(:Q_FIRM_IDS, NULL, :DATEFROM, :Q_DAYSTOADD) P1
    GROUP BY P1.RISK_ID, P1.RISK_NAME, P1.RISK_DAYSCNT, P1.RISK_PCMAX, P1.FIRM_ID, P1.FIRM_NAME
    INTO     :RISK_ID, :RISK_NAME, :RISK_DAYSCNT, :RISK_PCMAX, :FIRM_ID, :FIRM_NAME
            ,:DOCSUMCALC1, :RESERVEBEGIN
  DO
    BEGIN
    SELECT   SUM(P2.DOCSUMCALC) AS DOCSUMCALC, SUM(P2.RESERVE) AS RESERVEEND
    FROM     PROC$RPTI_ENTPS_RISKS('~'||:FIRM_ID||'~', NULL, :DATETO, :Q_DAYSTOADD) P2
    WHERE    (P2.RISK_ID = :RISK_ID)
      AND    (P2.FIRM_ID = :FIRM_ID)
    INTO     :DOCSUMCALC2, :RESERVEEND;
    RESERVEDELTA = :RESERVEEND - :RESERVEBEGIN;
    IF(:Q_THOUSAND = 1)THEN
      BEGIN
      DOCSUMCALC1  = :DOCSUMCALC1  / 1000;
      DOCSUMCALC2  = :DOCSUMCALC2  / 1000;
      RESERVEBEGIN = :RESERVEBEGIN / 1000;
      RESERVEEND   = :RESERVEEND   / 1000;
      RESERVEDELTA = :RESERVEDELTA / 1000;
      END
    SUSPEND;
    END
END
