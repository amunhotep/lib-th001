EXECUTE BLOCK (
   Q_TMC_GROUP_ID       TYPE OF COLUMN TABL$R_TMC_GROUP.ID  = ?PQ_TMC_GROUP_ID
  ,Q_QUANT              TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?PQ_QUANT
  ,Q_DATE               TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?PQ_DATE_FROM
  ,Q_FIRM_IDS           TYPE OF COLUMN TABL$J_4.DOCSTR      = ?PQ_FIRM_IDS
  ,Q_PLACE_IDS          TYPE OF COLUMN TABL$J_4.DOCSTR      = ?PQ_PLACE_IDS
  ,Q_ZERO               TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?PQ_ZERO
)RETURNS(
   REPORT_ID            TYPE OF COLUMN TABL$R_TMC.ID
  ,REPORT_NAME          TYPE OF COLUMN TABL$R_TMC.NAME
  ,ID                   TYPE OF COLUMN TABL$R_TMC.ID
  ,ORDERID              TYPE OF COLUMN TABL$R_TMC.ORDERID
  ,FLAG_DELETE          TYPE OF COLUMN TABL$R_TMC.FLAG_DELETE
  ,FLAG_LOCKED          TYPE OF COLUMN TABL$R_TMC.FLAG_LOCKED
  ,FLAG_WWW             TYPE OF COLUMN TABL$R_TMC.FLAG_WWW
  ,FLAG_ALCOHOL         TYPE OF COLUMN TABL$R_TMC.FLAG_ALCOHOL
  ,NAME                 TYPE OF COLUMN TABL$R_TMC.NAME
  ,NAME2                TYPE OF COLUMN TABL$R_TMC.NAME2
  ,ARTICLE              TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,NUMSHOW              TYPE OF COLUMN TABL$R_TMC.NUMSHOW
  ,EDIZM_ID             TYPE OF COLUMN TABL$R_TMC.EDIZM_ID
  ,EDIZM_NAME           TYPE OF COLUMN TABL$R_EDIZM.NAME
  ,EDIZM_SHORT_NAME     TYPE OF COLUMN TABL$R_EDIZM.SHORT_NAME
  ,TMC_GROUP_ID         TYPE OF COLUMN TABL$R_TMC.TMC_GROUP_ID
  ,TMC_GROUP_NAME       TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_GROUP_PATH       TYPE OF COLUMN TABL$R_TMC_GROUP.PATH
  ,TMC_TYPE_ID          TYPE OF COLUMN TABL$R_TMC.TMC_TYPE_ID
  ,TMC_TYPE_NAME        TYPE OF COLUMN TABL$R_TMC_TYPES.NAME
  ,TMC_TYPE_CHECK_QUANT TYPE OF COLUMN TABL$R_TMC_TYPES.CHECK_QUANT
  ,TMC_LIST_ID          TYPE OF COLUMN TABL$R_TMC.TMC_LIST_ID
  ,TMC_BRAND_ID         TYPE OF COLUMN TABL$R_TMC.TMC_BRAND_ID
  ,TMC_BRAND_NAME       TYPE OF COLUMN TABL$R_TMC_BRANDS.NAME
  ,DEV_TMC_BRAND_ID     TYPE OF COLUMN TABL$R_TMC.DEV_TMC_BRAND_ID
  ,DEV_TMC_BRAND_NAME   TYPE OF COLUMN TABL$R_TMC_BRANDS.NAME
  ,TMC_CTGR_ID          TYPE OF COLUMN TABL$R_TMC.TMC_CTGR_ID
  ,TMC_CTGR_NAME        TYPE OF COLUMN TABL$R_TMC_CTGR.NAME
  ,TMC_CTGR_PATH        TYPE OF COLUMN TABL$R_TMC_CTGR.PATH
  ,COUNTRY_ID           TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,COUNTRY_NAME         TYPE OF COLUMN TABL$R_COUNTRIES.NAME
  ,DEV_COUNTRY_ID       TYPE OF COLUMN TABL$R_TMC.DEV_COUNTRY_ID
  ,DEV_COUNTRY_NAME     TYPE OF COLUMN TABL$R_COUNTRIES.NAME
  ,PROBE                TYPE OF COLUMN TABL$R_TMC.PROBE
  ,MASSA                TYPE OF COLUMN TABL$R_TMC.MASSA
  ,MASSA_NETTO          TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,MASSA_QUANTORDER     TYPE OF COLUMN TABL$R_TMC.MASSA_QUANTORDER
  ,MASSA_ED             TYPE OF COLUMN TABL$R_TMC.MASSA
  ,MASSA_NEW            TYPE OF COLUMN TABL$R_TMC.MASSA_NEW
  ,MASSA_NETTO_NEW      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO_NEW
  ,LGTH                 TYPE OF COLUMN TABL$R_TMC.LGTH
  ,DIAM                 TYPE OF COLUMN TABL$R_TMC.DIAM
  ,LIMIT                TYPE OF COLUMN TABL$R_TMC.LIMIT
  ,EXTERNAL_FLAG        TYPE OF COLUMN TABL$R_TMC.EXTERNAL_FLAG
  ,EXTERNAL_FILE        TYPE OF COLUMN TABL$R_TMC.EXTERNAL_FILE
  ,VALUE_DATE           TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE_IN             TYPE OF COLUMN TABL$R_TMC_P.PRICE_IN
  ,PRICE                TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,PRICE_1              TYPE OF COLUMN TABL$R_TMC_P.PRICE_1
  ,PRICE_2              TYPE OF COLUMN TABL$R_TMC_P.PRICE_2
  ,PRICE_3              TYPE OF COLUMN TABL$R_TMC_P.PRICE_3
  ,PRICE_4              TYPE OF COLUMN TABL$R_TMC_P.PRICE_4
  ,PRICE_5              TYPE OF COLUMN TABL$R_TMC_P.PRICE_5
  ,PRICE_ED_IN          TYPE OF COLUMN TABL$R_TMC_P.PRICE_IN
  ,PRICE_ED             TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,PRICE_ED_1           TYPE OF COLUMN TABL$R_TMC_P.PRICE_1
  ,PRICE_ED_2           TYPE OF COLUMN TABL$R_TMC_P.PRICE_2
  ,PRICE_ED_3           TYPE OF COLUMN TABL$R_TMC_P.PRICE_3
  ,PRICE_ED_4           TYPE OF COLUMN TABL$R_TMC_P.PRICE_4
  ,PRICE_ED_5           TYPE OF COLUMN TABL$R_TMC_P.PRICE_5
  ,COMENT               TYPE OF COLUMN TABL$R_TMC.COMENT
  ,DATAXML              TYPE OF COLUMN TABL$R_TMC.DATAXML
  ,IMG                  TYPE OF COLUMN TABL$R_TMC.IMG
  ,MODELNAME            TYPE OF COLUMN TABL$R_TMC.MODELNAME
  ,YEAR_ID              TYPE OF COLUMN TABL$R_TMC.YEAR_ID
  ,STATEFINE            TYPE OF COLUMN TABL$R_TMC.STATEFINE
  ,SUBSTANCE_ID         TYPE OF COLUMN TABL$R_TMC.SUBSTANCE_ID
  ,ORDERQUANT           TYPE OF COLUMN TABL$R_TMC.ORDERQUANT
  ,BARCODE              TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,MORIONCODE           TYPE OF COLUMN TABL$R_TMC.MORIONCODE
  ,VEDCODE              TYPE OF COLUMN TABL$R_TMC.VEDCODE
  ,AMOUNTMAX            TYPE OF COLUMN TABL$R_TMC.AMOUNTMAX
  ,INGREDIENTS          TYPE OF COLUMN TABL$R_TMC.INGREDIENTS
  ,AUTOTYPE             TYPE OF COLUMN TABL$R_TMC.AUTOTYPE
  ,AUTONUMBER           TYPE OF COLUMN TABL$R_TMC.AUTONUMBER
  ,AUTOPASSPORT         TYPE OF COLUMN TABL$R_TMC.AUTOPASSPORT
  ,AUTOWHEELS           TYPE OF COLUMN TABL$R_TMC.AUTOWHEELS
  ,AUTOENGINE           TYPE OF COLUMN TABL$R_TMC.AUTOENGINE
  ,AUTOCOLOR            TYPE OF COLUMN TABL$R_TMC.AUTOCOLOR
  ,PKU_PHENYLALANINE    TYPE OF COLUMN TABL$R_TMC.PKU_PHENYLALANINE
  ,PKU_AALEU            TYPE OF COLUMN TABL$R_TMC.PKU_AALEU
  ,PKU_AATYR            TYPE OF COLUMN TABL$R_TMC.PKU_AATYR
  ,PKU_AAMET            TYPE OF COLUMN TABL$R_TMC.PKU_AAMET
  ,PKU_AALES            TYPE OF COLUMN TABL$R_TMC.PKU_AALES
  ,PKU_ENERGYJOULE      TYPE OF COLUMN TABL$R_TMC.PKU_ENERGYJOULE
  ,PKU_ENERGYKAL        TYPE OF COLUMN TABL$R_TMC.PKU_ENERGYKAL
  ,PKU_PROTEIN          TYPE OF COLUMN TABL$R_TMC.PKU_PROTEIN
  ,PKU_CARBONHYDRATES   TYPE OF COLUMN TABL$R_TMC.PKU_CARBONHYDRATES
  ,PKU_FAT              TYPE OF COLUMN TABL$R_TMC.PKU_FAT
  ,PKU_CHOLESTEROL      TYPE OF COLUMN TABL$R_TMC.PKU_CHOLESTEROL
  ,CS_ID                TYPE OF COLUMN TABL$R_TMC.CS_ID
  ,QUANT                TYPE OF COLUMN TABL$P_TMCQUANT.QUANT
  ,QUANT_ED             TYPE OF COLUMN TABL$P_TMCQUANT.QUANT
  ,MASSA_TOTAL          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,MASSA_TOTALQUANT     TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TOTAL_ED_IN          TYPE OF COLUMN TABL$R_TMC_P.PRICE_IN
  ,TOTAL_ED             TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,TOTAL_ED_1           TYPE OF COLUMN TABL$R_TMC_P.PRICE_1
  ,TOTAL_ED_2           TYPE OF COLUMN TABL$R_TMC_P.PRICE_2
  ,TOTAL_ED_3           TYPE OF COLUMN TABL$R_TMC_P.PRICE_3
  ,TOTAL_ED_4           TYPE OF COLUMN TABL$R_TMC_P.PRICE_4
  ,TOTAL_ED_5           TYPE OF COLUMN TABL$R_TMC_P.PRICE_5
)AS
  DECLARE VARIABLE P_TMC_GROUP_IDS TYPE OF COLUMN TABL$R_TMC.COMENT;
BEGIN
  WITH RECURSIVE TGG AS(
    SELECT T1.ID FROM TABL$R_TMC_GROUP T1         WHERE (T1.ID = :Q_TMC_GROUP_ID)
    UNION ALL
    SELECT T2.ID FROM TABL$R_TMC_GROUP T2, TGG T3 WHERE (T2.PARENT_ID = T3.ID)
  )
  SELECT '~'||LIST(TMP.ID,'~')||'~'
  FROM   TGG TMP
  INTO   :P_TMC_GROUP_IDS;

  FOR
    SELECT T.ID, COALESCE(T.ORDERID,0), T.FLAG_DELETE, T.FLAG_LOCKED, T.FLAG_WWW, T.FLAG_ALCOHOL
          ,T.NAME, T.NAME2, T.ARTICLE, T.NUMSHOW, T.EDIZM_ID, E.NAME, E.SHORT_NAME
          ,T.TMC_GROUP_ID, TG.NAME, TG.PATH
          ,T.TMC_TYPE_ID, TT.NAME, TT.CHECK_QUANT
          ,T.TMC_LIST_ID
          ,T.TMC_BRAND_ID, TB.NAME
          ,T.DEV_TMC_BRAND_ID, TBD.NAME
          ,T.TMC_CTGR_ID, TC.NAME, TC.PATH
          ,T.COUNTRY_ID, C1.NAME
          ,T.DEV_COUNTRY_ID, C2.NAME
          ,T.PROBE, COALESCE(T.MASSA,0), COALESCE(T.MASSA_NETTO,0), COALESCE(T.MASSA_NEW,0), COALESCE(T.MASSA_NETTO_NEW,0), COALESCE(T.MASSA_QUANTORDER,0), T.LGTH, T.DIAM
          ,T.LIMIT, T.MODELNAME, T.EXTERNAL_FLAG, T.EXTERNAL_FILE, T.VALUE_DATE
          ,T.COMENT, T.DATAXML, T.IMG, T.YEAR_ID, T.STATEFINE, T.SUBSTANCE_ID
          ,COALESCE(T.ORDERQUANT,0), T.BARCODE, T.MORIONCODE, T.VEDCODE, T.AMOUNTMAX, T.INGREDIENTS
          ,T.AUTOTYPE, T.AUTONUMBER, T.AUTOPASSPORT, T.AUTOWHEELS, T.AUTOENGINE, T.AUTOCOLOR
          ,T.PKU_PHENYLALANINE, T.PKU_AALEU, T.PKU_AATYR, T.PKU_AAMET, T.PKU_AALES
          ,T.PKU_ENERGYJOULE, T.PKU_ENERGYKAL, T.PKU_PROTEIN, T.PKU_CARBONHYDRATES, T.PKU_FAT
          ,T.PKU_CHOLESTEROL
          ,T.CS_ID
    FROM   TABL$R_TMC T
             LEFT OUTER JOIN TABL$R_TMC_TYPES  TT  ON (TT.ID    = T.TMC_TYPE_ID     )
             LEFT OUTER JOIN TABL$R_TMC_BRANDS TB  ON (TB.ID    = T.TMC_BRAND_ID    )
             LEFT OUTER JOIN TABL$R_TMC_BRANDS TBD ON (TBD.ID   = T.DEV_TMC_BRAND_ID)
             LEFT OUTER JOIN TABL$R_TMC_CTGR   TC  ON (TC.ID    = T.TMC_CTGR_ID     )
             LEFT OUTER JOIN TABL$R_TMC_GROUP  TG  ON (TG.ID    = T.TMC_GROUP_ID    )
             LEFT OUTER JOIN TABL$R_EDIZM      E   ON (E.ID     = T.EDIZM_ID        )
             LEFT OUTER JOIN TABL$R_COUNTRIES  C1  ON (C1.ID    = T.COUNTRY_ID      )
             LEFT OUTER JOIN TABL$R_COUNTRIES  C2  ON (C2.ID    = T.DEV_COUNTRY_ID  )
    WHERE (:P_TMC_GROUP_IDS CONTAINING '~'||T.TMC_GROUP_ID||'~')
      AND (T.FLAG_DELETE = 0)
    ORDER BY /*ORDER*/ T.ORDERID, T.NAME2
    INTO   :ID, :ORDERID, :FLAG_DELETE, :FLAG_LOCKED, :FLAG_WWW, :FLAG_ALCOHOL
          ,:NAME, :NAME2, :ARTICLE, :NUMSHOW, :EDIZM_ID, :EDIZM_NAME, :EDIZM_SHORT_NAME
          ,:TMC_GROUP_ID, :TMC_GROUP_NAME, :TMC_GROUP_PATH
          ,:TMC_TYPE_ID, :TMC_TYPE_NAME, :TMC_TYPE_CHECK_QUANT
          ,:TMC_LIST_ID
          ,:TMC_BRAND_ID, :TMC_BRAND_NAME
          ,:DEV_TMC_BRAND_ID, :DEV_TMC_BRAND_NAME
          ,:TMC_CTGR_ID, :TMC_CTGR_NAME, :TMC_CTGR_PATH
          ,:COUNTRY_ID, :COUNTRY_NAME
          ,:DEV_COUNTRY_ID, :DEV_COUNTRY_NAME
          ,:PROBE, :MASSA, :MASSA_NETTO, :MASSA_NEW, :MASSA_NETTO_NEW, :MASSA_QUANTORDER, :LGTH, :DIAM
          ,:LIMIT, :MODELNAME, :EXTERNAL_FLAG, :EXTERNAL_FILE, :VALUE_DATE
          ,:COMENT, :DATAXML, :IMG, :YEAR_ID, :STATEFINE, :SUBSTANCE_ID
          ,:ORDERQUANT, :BARCODE, :MORIONCODE, :VEDCODE, :AMOUNTMAX, :INGREDIENTS
          ,:AUTOTYPE, :AUTONUMBER, :AUTOPASSPORT, :AUTOWHEELS, :AUTOENGINE, :AUTOCOLOR
          ,:PKU_PHENYLALANINE, :PKU_AALEU, :PKU_AATYR, :PKU_AAMET, :PKU_AALES
          ,:PKU_ENERGYJOULE, :PKU_ENERGYKAL, :PKU_PROTEIN, :PKU_CARBONHYDRATES, :PKU_FAT
          ,:PKU_CHOLESTEROL
          ,:CS_ID
  DO
    BEGIN
    MASSA_ED    = (:MASSA_NETTO * :ORDERQUANT) + :MASSA_QUANTORDER;  
    REPORT_ID   = :TMC_BRAND_ID;
    REPORT_NAME = :TMC_BRAND_NAME; 
    /*SORT*/
    SELECT FIRST 1 COALESCE(P.PRICE,0), COALESCE(P.PRICE_IN,0)
          ,COALESCE(P.PRICE_1,0), COALESCE(P.PRICE_2,0), COALESCE(P.PRICE_3,0)
          ,COALESCE(P.PRICE_4,0), COALESCE(P.PRICE_5,0)
    FROM   TABL$R_TMC_P P
    WHERE  (P.TMC_ID     = :ID)
      AND  (P.VALUE_DATE = :VALUE_DATE)
    INTO   :PRICE, :PRICE_IN
          ,:PRICE_1, :PRICE_2, :PRICE_3, :PRICE_4, :PRICE_5;

    PRICE_ED_IN = :PRICE_IN * :ORDERQUANT;
    PRICE_ED    = :PRICE    * :ORDERQUANT;
    PRICE_ED_1  = :PRICE_1  * :ORDERQUANT;
    PRICE_ED_2  = :PRICE_2  * :ORDERQUANT;
    PRICE_ED_3  = :PRICE_3  * :ORDERQUANT;
    PRICE_ED_4  = :PRICE_4  * :ORDERQUANT;
    PRICE_ED_5  = :PRICE_5  * :ORDERQUANT;
    TOTAL_ED_IN = 0;
    TOTAL_ED    = 0;
    TOTAL_ED_1  = 0;
    TOTAL_ED_2  = 0;
    TOTAL_ED_3  = 0;
    TOTAL_ED_4  = 0;
    TOTAL_ED_5  = 0;
    QUANT       = 0;
    QUANT_ED    = 0;
    MASSA_TOTAL = 0;
    MASSA_TOTALQUANT = 0;
    
    IF(:Q_QUANT = 0)THEN
      BEGIN
      SUSPEND;
      END
     ELSE
      BEGIN
      SELECT COALESCE(SUM(T1.QUANT_IN - T1.QUANT_K),0) AS QUANT
      FROM   (SELECT Q.FIRM_ID, Q.PLACE_ID, Q.TMC_ID, 0 AS J_ID, 0 AS D_ID
                    ,Q.PRICE, Q.PRICE_IN, Q.QUANT_IN
                    ,(SELECT COALESCE(SUM(K.QUANT),0)
                      FROM   TABL$P_TMCQUANT K
                      WHERE  (K.PARENT_ID   = Q.ID)
                        AND  (K.FLAG_DEBET  = 0)
                        AND  (K.DATE_COMMIT <= :Q_DATE)
                        AND  (K.TMC_ID      = :ID)
                      )AS QUANT_K
              FROM   TABL$P_TMCQUANT Q
              WHERE  (Q.FLAG_DEBET = 1)
                AND  (:Q_FIRM_IDS  CONTAINING '~'||Q.FIRM_ID ||'~')
                AND  (:Q_PLACE_IDS CONTAINING '~'||Q.PLACE_ID||'~')
                AND  (Q.DATE_COMMIT <= :Q_DATE)
                AND  (Q.TMC_ID = :ID)
             )T1
      INTO    :QUANT;
      MASSA_TOTALQUANT = :MASSA_NETTO * :QUANT / 1000;
      TOTAL_ED_IN      = :PRICE_IN    * :QUANT;
      TOTAL_ED         = :PRICE       * :QUANT;
      TOTAL_ED_1       = :PRICE_1     * :QUANT;
      TOTAL_ED_2       = :PRICE_2     * :QUANT;
      TOTAL_ED_3       = :PRICE_3     * :QUANT;
      TOTAL_ED_4       = :PRICE_4     * :QUANT;
      TOTAL_ED_5       = :PRICE_5     * :QUANT;

      IF(:ORDERQUANT <> 0)THEN 
        BEGIN
        QUANT_ED         = :QUANT / :ORDERQUANT;
        MASSA_TOTAL      = :QUANT_ED * :MASSA_ED / 1000; 
        END
      
      IF(:Q_ZERO = 0)THEN
        BEGIN
        SUSPEND;
        END 
       ELSE
        BEGIN
        IF(:QUANT <> 0)THEN
          SUSPEND;
        END 
      END 
    END
END
