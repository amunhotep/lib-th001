EXECUTE BLOCK(
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS(
   DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS        TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FILIAL_ID       TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME     TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,PAYSRC_IDS301   TYPE OF COLUMN TABL$J_4.DOCSTR
  ,S0301BEG        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S0301DEB        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S0301KRD        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S0301END        TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_DEB TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_KRD TYPE OF COLUMN TABL$J_4.DOCSUM;
BEGIN
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR
    SELECT F.ID, F.NAME
          ,(SELECT '~'||LIST(PS.ID,'~')||'~'
            FROM   TABL$R_PAYSRC PS
            WHERE  (:FIRM_IDS CONTAINING '~'||PS.FIRM_ID||'~')
              AND  (PS.FILIAL_ID = F.ID)
              AND  (PS.ACC_ID = 301)
           )AS PAYSRC_IDS0301
    FROM   TABL$R_FILIALS F
    WHERE  (F.FLAG_DELETE = 0)
    ORDER BY F.ID
    INTO   :FILIAL_ID, :FILIAL_NAME, :PAYSRC_IDS301
  DO
    BEGIN
    S0301BEG = 0; S0301DEB  = 0; S0301KRD  = 0; S0301END = 0;

    SELECT COALESCE(SUM(TMP.DEB),0), COALESCE(SUM(TMP.KRD),0)
    FROM   (SELECT IIF((P.FLAG_DEBET = 1), P.PAYSRC_VALUE,0)AS DEB, IIF((P.FLAG_DEBET = 0), P.PAYSRC_VALUE,0) AS KRD
            FROM   TABL$P_PAYSRC_MOVE P
            WHERE  (P.DATE_COMMIT < :DATE_FROM)
              AND  (:PAYSRC_IDS301 CONTAINING '~'||P.PAYSRC_ID||'~')
            )TMP
    INTO  :P_DEB, :P_KRD;
    S0301BEG = :P_DEB - :P_KRD;
    SELECT COALESCE(SUM(TMP.DEB),0), COALESCE(SUM(TMP.KRD),0)
    FROM   (SELECT IIF((P.FLAG_DEBET = 1), P.PAYSRC_VALUE,0)AS DEB, IIF((P.FLAG_DEBET = 0), P.PAYSRC_VALUE, 0) AS KRD
            FROM   TABL$P_PAYSRC_MOVE P
            WHERE  (P.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
              AND  (:PAYSRC_IDS301 CONTAINING '~'||P.PAYSRC_ID||'~')
            )TMP
    INTO  :S0301DEB, :S0301KRD;
    S0301END = :S0301BEG + :S0301DEB - :S0301KRD;

    SUSPEND;
    END
END
