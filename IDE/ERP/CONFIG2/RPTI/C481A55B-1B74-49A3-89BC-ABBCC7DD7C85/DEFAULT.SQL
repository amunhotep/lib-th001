EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  DOMN$BLOB_TEXT                      = ?FIRM_IDS
)RETURNS (
  DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,RPT_SECTION     TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,PARAM_ID        TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,PARAM_NAME      TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,PARAM_NAMEX     TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,QUANT_SALES     TYPE OF COLUMN TABL$J_4.ID
 ,QUANT_CS        TYPE OF COLUMN TABL$J_4.ID
 ,SUM_SALES       TYPE OF COLUMN TABL$J_4.DOCSUM
 ,QUANT_TMC       TYPE OF COLUMN TABL$J_4.ID
 ,SUM_SEB         TYPE OF COLUMN TABL$J_4.DOCSUM
 ,SUM_GESHEFT     TYPE OF COLUMN TABL$J_4.DOCSUM
 ,PC_GESHEFT      TYPE OF COLUMN TABL$J_4.DOCSUM
 ,TMC_MASSA       TYPE OF COLUMN TABL$R_TMC.MASSA
 ,TMC_MASSA_INS   TYPE OF COLUMN TABL$R_TMC.MASSA
 ,TMC_MASSA_NETTO TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
)AS
  DECLARE VARIABLE P_PARAM_ID TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR;
BEGIN
  DATE_FROM    = :Q_DATE_FROM;
  DATE_TO      = :Q_DATE_TO;
  RPT_SECTION  = 'По филиалам';
  PARAM_NAMEX  = '';
  FOR
    SELECT FL.ID, '  '||FL.NAME
    FROM   TABL$R_FILIALS FL
    ORDER BY FL.ID
    INTO   :PARAM_ID, :PARAM_NAME
  DO
    BEGIN
    IF(:PARAM_ID = 0)THEN PARAM_NAME = 'BCE';
    SELECT COALESCE(COUNT(ALL J4.ID),0), COALESCE(SUM(ALL J4.DOCSUM),0), COALESCE(COUNT(DISTINCT J14.CS_ID),0)
    FROM   TABL$J_4 J4, TABL$J_1000014 J14
    WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
      AND  (J4.DATE_COMMIT <  :DATE_TO)
      AND  (J4.TYPE_ID = 1000028)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((:PARAM_ID = 0) OR ((J4.FILIAL_ID+0) = :PARAM_ID))
      AND  (J4.FLAG_COMMIT = 1)
      AND  (J14.J_ID = J4.ID)
    INTO   :QUANT_SALES, :SUM_SALES, :QUANT_CS;
    IF(:SUM_SALES <> 0)THEN
      BEGIN
      SELECT COALESCE(SUM(D14.QUANT),0)
            ,SUM(D14.QUANT * (SELECT FIRST 1 D.PRICE
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1))            
            )
            ,SUM(D14.QUANT * TMC.MASSA ),SUM(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)), SUM(D14.QUANT * TMC.MASSA_NETTO)
      FROM   TABL$J_4 J4, TABL$D_1000014 D14, TABL$R_TMC TMC
      WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
        AND  (J4.DATE_COMMIT <  :DATE_TO)
        AND  (J4.TYPE_ID = 1000028)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((:PARAM_ID = 0) OR ((J4.FILIAL_ID+0) = :PARAM_ID))
        AND  (J4.FLAG_COMMIT = 1)
        AND  (D14.J_ID = J4.ID)
        AND  (TMC.ID = D14.TMC_ID)
      INTO   :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO;
      SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
      PC_GESHEFT  = 0;
      IF(:SUM_SALES <> 0)THEN
        PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
      SUSPEND;
      END
    END

  RPT_SECTION = 'По сотрудникам';
  FOR
    SELECT DISTINCT JJ.USER_ID
    FROM   TABL$J_4 JJ
    WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
      AND  (JJ.DATE_COMMIT <  :DATE_TO)
      AND  (JJ.FLAG_COMMIT = 1)
      AND  (JJ.TYPE_ID = 1000028)
      AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
    INTO   :PARAM_ID
  DO
    BEGIN
    SELECT FIRST 1 W.NAME FROM TABL$R_WRK W WHERE (W.USER_NAME = :PARAM_ID)INTO :PARAM_NAME;
    IF((:PARAM_NAME IS NULL) OR (TRIM(:PARAM_NAME) = ''))THEN
      PARAM_NAME = :PARAM_ID;

    SELECT COALESCE(COUNT(ALL J4.ID),0), COALESCE(SUM(ALL J4.DOCSUM),0), COALESCE(COUNT(DISTINCT J14.CS_ID),0)
    FROM   TABL$J_4 J4, TABL$J_1000014 J14
    WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
      AND  (J4.DATE_COMMIT <  :DATE_TO)
      AND  (J4.TYPE_ID = 1000028)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.USER_ID||'') = :PARAM_ID)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (J14.J_ID = J4.ID)
    INTO   :QUANT_SALES, :SUM_SALES, :QUANT_CS;
    IF(:SUM_SALES <> 0)THEN
      BEGIN
      SELECT COALESCE(SUM(D14.QUANT),0)
            ,SUM(D14.QUANT * (SELECT FIRST 1 D.PRICE
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1))            
            )
            ,SUM(D14.QUANT * TMC.MASSA ),SUM(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)), SUM(D14.QUANT * TMC.MASSA_NETTO)
      FROM   TABL$J_4 J4, TABL$D_1000014 D14, TABL$R_TMC TMC
      WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
        AND  (J4.DATE_COMMIT <  :DATE_TO)
        AND  (J4.TYPE_ID = 1000028)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.USER_ID||'') = :PARAM_ID)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (D14.J_ID = J4.ID)
        AND  (TMC.ID = D14.TMC_ID)
      INTO   :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO;
      SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
      PC_GESHEFT  = 0;
      IF(:SUM_SALES <> 0)THEN
        PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
      SUSPEND;
      END
    END

  RPT_SECTION = 'По материалам';
  FOR
    SELECT TMP.COUNTRY_ID, TMP.VALUTE_NAME
          ,COUNT(DISTINCT TMP.J_ID), SUM(ALL TMP.QUANT), SUM(ALL TMP.SUMSEB)
          ,SUM(ALL TMP.MASSA), SUM(ALL TMP.MASSA_INS), SUM(ALL TMP.MASSA_NETTO)
    FROM   (
            SELECT COALESCE(TMC.COUNTRY_ID,0) AS COUNTRY_ID
                  ,(SELECT FIRST 1 COALESCE(C.VALUTE,'') FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE_NAME
                  ,D14.J_ID AS J_ID
                  ,D14.QUANT AS  QUANT
                  ,(SELECT FIRST 1 D.PRICE * D14.QUANT
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1)
                    ) AS SUMSEB
                  ,(D14.QUANT * TMC.MASSA) AS MASSA
                  ,(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)) AS MASSA_INS
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
            FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
            WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
              AND  (JJ.DATE_COMMIT <  :DATE_TO)
              AND  (JJ.TYPE_ID = 1000028)
              AND  (JJ.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
              AND  (D14.J_ID = JJ.ID)
              AND  (TMC.ID   = D14.TMC_ID)
              AND  (TG.ID    = TMC.TMC_GROUP_ID)    
            )TMP
    GROUP BY 1,2
    INTO   :PARAM_ID, :PARAM_NAME, :QUANT_SALES, :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO
  DO
    BEGIN
    SELECT SUM(D14.PRICE * D14.QUANT)
    FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC
    WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
      AND  (JJ.DATE_COMMIT <  :DATE_TO)
      AND  (JJ.TYPE_ID = 1000028)
      AND  (JJ.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
      AND  (D14.J_ID = JJ.ID)
      AND  (TMC.ID   = D14.TMC_ID)
      AND  (COALESCE(TMC.COUNTRY_ID,0) = :PARAM_ID)
    INTO   :SUM_SALES;

    SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
    PC_GESHEFT  = 0;
    IF(:SUM_SALES <> 0)THEN
      PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
    SUSPEND;
    END

  RPT_SECTION = 'По материалам и пробам';
  FOR
    SELECT TMP.COUNTRY_ID, TMP.VALUTE_NAME, TMP.TMC_PROBE 
          ,COUNT(DISTINCT TMP.J_ID), SUM(ALL TMP.QUANT), SUM(ALL TMP.SUMSEB)
          ,SUM(ALL TMP.MASSA), SUM(ALL TMP.MASSA_INS), SUM(ALL TMP.MASSA_NETTO)
    FROM   (
            SELECT COALESCE(TMC.COUNTRY_ID,0) AS COUNTRY_ID
                  ,(SELECT FIRST 1 COALESCE(C.VALUTE,'') FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE_NAME
                  ,COALESCE(TMC.PROBE,'') AS TMC_PROBE
                  ,D14.J_ID AS J_ID
                  ,D14.QUANT AS  QUANT
                  ,(SELECT FIRST 1 COALESCE((D.PRICE * D14.QUANT),0) AS SUMSEB
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1)
                    ) AS SUMSEB
                  ,(D14.QUANT * TMC.MASSA) AS MASSA
                  ,(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)) AS MASSA_INS
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
            FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
            WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
              AND  (JJ.DATE_COMMIT <  :DATE_TO)
              AND  (JJ.TYPE_ID = 1000028)
              AND  (JJ.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
              AND  (D14.J_ID = JJ.ID)
              AND  (TMC.ID   = D14.TMC_ID)
              AND  (TG.ID    = TMC.TMC_GROUP_ID)    
            )TMP
    GROUP BY 1,2,3
    INTO   :PARAM_ID, :PARAM_NAME, :PARAM_NAMEX, :QUANT_SALES, :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO
  DO
    BEGIN
    SELECT SUM(COALESCE(D14.PRICE,0) * COALESCE(D14.QUANT,0) )
    FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC
    WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
      AND  (JJ.DATE_COMMIT <  :DATE_TO)
      AND  (JJ.TYPE_ID = 1000028)
      AND  (JJ.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
      AND  (D14.J_ID = JJ.ID)
      AND  (TMC.ID   = D14.TMC_ID)
      AND  (TMC.COUNTRY_ID = :PARAM_ID)
      AND  (COALESCE(TMC.PROBE,'') = :PARAM_NAMEX)
    INTO   :SUM_SALES;

    SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
    PC_GESHEFT  = 0;
    IF(:SUM_SALES <> 0)THEN
      PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
    SUSPEND;
    END

  RPT_SECTION = 'По группам';
  PARAM_NAMEX = '';
  FOR
    SELECT TMP.TMC_GROUP_ID, TMP.TMC_GROUP_NAME
          ,COUNT(DISTINCT TMP.J_ID),SUM(ALL TMP.QUANT), SUM(ALL TMP.SUMSEB)
          ,SUM(ALL TMP.MASSA), SUM(ALL TMP.MASSA_INS), SUM(ALL TMP.MASSA_NETTO)
    FROM   (
            SELECT TMC.TMC_GROUP_ID AS TMC_GROUP_ID
                  ,TG.NAME AS TMC_GROUP_NAME
                  ,TMC.COUNTRY_ID AS COUNTRY_ID
                  ,(SELECT FIRST 1 COALESCE(C.VALUTE,'') FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE_NAME
                  ,D14.J_ID AS J_ID
                  ,D14.QUANT AS  QUANT
                  ,(SELECT FIRST 1 D.PRICE * D14.QUANT
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1)
                    ) AS SUMSEB
                  ,(D14.QUANT * TMC.MASSA) AS MASSA
                  ,(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)) AS MASSA_INS
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
            FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
            WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
              AND  (JJ.DATE_COMMIT <  :DATE_TO)
              AND  (JJ.TYPE_ID = 1000028)
              AND  (JJ.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
              AND  (D14.J_ID = JJ.ID)
              AND  (TMC.ID   = D14.TMC_ID)
              AND  (TG.ID    = TMC.TMC_GROUP_ID)    
            )TMP
    GROUP BY 1,2
    INTO   :PARAM_ID, :PARAM_NAME, :QUANT_SALES, :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO
  DO
    BEGIN
    SELECT SUM(D14.PRICE * D14.QUANT)
    FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC
    WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
      AND  (JJ.DATE_COMMIT <  :DATE_TO)
      AND  (JJ.TYPE_ID = 1000028)
      AND  (JJ.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
      AND  (D14.J_ID = JJ.ID)
      AND  (TMC.ID   = D14.TMC_ID)
      AND  (TMC.TMC_GROUP_ID = :PARAM_ID)
    INTO   :SUM_SALES;

    SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
    PC_GESHEFT  = 0;
    IF(:SUM_SALES <> 0)THEN
      PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
    SUSPEND;
    END

  RPT_SECTION = 'По группам и материалам';
  FOR
    SELECT TMP.TMC_GROUP_ID, TMP.TMC_GROUP_NAME, TMP.COUNTRY_ID, TMP.VALUTE_NAME
          ,COUNT(DISTINCT TMP.J_ID), SUM(ALL TMP.QUANT), SUM(ALL TMP.SUMSEB)
          ,SUM(ALL TMP.MASSA), SUM(ALL TMP.MASSA_INS), SUM(ALL TMP.MASSA_NETTO)
    FROM   (
            SELECT TMC.TMC_GROUP_ID AS TMC_GROUP_ID
                  ,TG.NAME AS TMC_GROUP_NAME
                  ,COALESCE(TMC.COUNTRY_ID,0) AS COUNTRY_ID
                  ,(SELECT FIRST 1 COALESCE(C.VALUTE,'') FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE_NAME
                  ,D14.J_ID AS J_ID
                  ,D14.QUANT AS  QUANT
                  ,(SELECT FIRST 1 D.PRICE * D14.QUANT
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1)
                    ) AS SUMSEB
                  ,(D14.QUANT * TMC.MASSA) AS MASSA
                  ,(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)) AS MASSA_INS
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS MASSA_NETTO
            FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
            WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
              AND  (JJ.DATE_COMMIT <  :DATE_TO)
              AND  (JJ.TYPE_ID = 1000028)
              AND  (JJ.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
              AND  (D14.J_ID = JJ.ID)
              AND  (TMC.ID   = D14.TMC_ID)
              AND  (TG.ID    = TMC.TMC_GROUP_ID)    
            )TMP
    GROUP BY 1,2,3,4
    INTO   :PARAM_ID, :PARAM_NAME, :P_PARAM_ID, :PARAM_NAMEX, :QUANT_SALES, :QUANT_TMC, :SUM_SEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO
  DO
    BEGIN
    SELECT SUM(D14.PRICE * D14.QUANT)
    FROM   TABL$J_4 JJ, TABL$D_1000014 D14, TABL$R_TMC TMC
    WHERE  (JJ.DATE_COMMIT >= :DATE_FROM)
      AND  (JJ.DATE_COMMIT <  :DATE_TO)
      AND  (JJ.TYPE_ID = 1000028)
      AND  (JJ.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||JJ.FIRM_ID||'~')
      AND  (D14.J_ID = JJ.ID)
      AND  (TMC.ID   = D14.TMC_ID)
      AND  (TMC.TMC_GROUP_ID = :PARAM_ID)
      AND  (TMC.COUNTRY_ID   = :P_PARAM_ID)
    INTO   :SUM_SALES;

    SUM_GESHEFT = :SUM_SALES - :SUM_SEB;
    PC_GESHEFT  = 0;
    IF(:SUM_SALES <> 0)THEN
      PC_GESHEFT  = (:SUM_GESHEFT * 100) / :SUM_SALES;
    SUSPEND;
    END
END
