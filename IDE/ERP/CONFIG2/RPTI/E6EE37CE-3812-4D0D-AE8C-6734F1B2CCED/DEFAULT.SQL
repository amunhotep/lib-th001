EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
 ,Q_ACC_ID    TYPE OF COLUMN TABL$R_BUHG_ACCS.ID  = ?ACC_ID
)RETURNS ( 
  DATE_FROM            TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO              TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS             TYPE OF COLUMN TABL$J_4.DOCSTR
 ,ACC_ID               TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
 ,ACC_NAME             TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
 ,ACC_SUBKONTO         TYPE OF COLUMN TABL$R_BUHG_ACCS.SUBKONTO
 ,DATE_COMMIT          TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FLAG                 TYPE OF COLUMN TABL$P_CND.FLAG_DELETE
 ,FIRM_ID              TYPE OF COLUMN TABL$P_CND.FIRM_ID
 ,FIRM_NAME            TYPE OF COLUMN TABL$P_CND.NAME
 ,FILIAL_ID            TYPE OF COLUMN TABL$P_CND.FILIAL_ID
 ,FILIAL_NAME          TYPE OF COLUMN TABL$P_CND.NAME
 ,NAME                 TYPE OF COLUMN TABL$J_4.DOCSTR
 ,DEBET                TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,KREDIT               TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,SALDO                TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,ACC_ID_DEB           TYPE OF COLUMN TABL$P_CND.ACC_ID_DEB
 ,ACC_ID_KRED          TYPE OF COLUMN TABL$P_CND.ACC_ID_KRED
 ,ACC_IDS_DEB          TYPE OF COLUMN TABL$P_CND.ACC_IDS_DEB
 ,ACC_IDS_KRED         TYPE OF COLUMN TABL$P_CND.ACC_IDS_KRED
 ,SUBKONTO_ID_DEB      TYPE OF COLUMN TABL$P_CND.SUBKONTO_ID_DEB
 ,SUBKONTO_ID_KRED     TYPE OF COLUMN TABL$P_CND.SUBKONTO_ID_KRED
 ,SUBKONTO_QUANT_DEB   TYPE OF COLUMN TABL$P_CND.SUBKONTO_QUANT_DEB
 ,SUBKONTO_QUANT_KRED  TYPE OF COLUMN TABL$P_CND.SUBKONTO_QUANT_KRED
 ,SUBKONTO_NAME_DEB    TYPE OF COLUMN TABL$P_CND.SUBKONTO_NAME_DEB
 ,SUBKONTO_NAME_KRED   TYPE OF COLUMN TABL$P_CND.SUBKONTO_NAME_KRED
 ,J_ID                 TYPE OF COLUMN TABL$J_4.ID
 ,J_TYPE_ID            TYPE OF COLUMN TABL$J_4.TYPE_ID
 ,J_TYPE_NAME          TYPE OF COLUMN TABL$_TB_TYPES.NAME2
 ,J_DOCNUMBERSTR       TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_DOCNUMBERIN        TYPE OF COLUMN TABL$J_4.DOCNUMBERIN
 ,J_DOCSTR             TYPE OF COLUMN TABL$J_4.DOCSTR
 ,COLOR_FRG            TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
 ,COLOR_BGR            TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
)AS
  DECLARE VARIABLE P_DEBET_SAVED  TYPE OF COLUMN TABL$P_CND.CND_VALUE;
  DECLARE VARIABLE P_KREDIT_SAVED TYPE OF COLUMN TABL$P_CND.CND_VALUE;
  DECLARE VARIABLE P_DEBET_TURN   TYPE OF COLUMN TABL$P_CND.CND_VALUE;
  DECLARE VARIABLE P_KREDIT_TURN  TYPE OF COLUMN TABL$P_CND.CND_VALUE;
  DECLARE VARIABLE P_SALDO        TYPE OF COLUMN TABL$P_CND.CND_VALUE;
BEGIN
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  ACC_ID    = :Q_ACC_ID;
  SELECT FIRST 1 B.NAME, B.SUBKONTO FROM TABL$R_BUHG_ACCS B WHERE (B.ID = :ACC_ID)INTO :ACC_NAME, :ACC_SUBKONTO;
  DEBET     = 0;
  KREDIT    = 0;
  SALDO     = 0;
  COLOR_FRG = 0x000000;
  COLOR_BGR = 0xFFFFFF;
  FLAG      = 1;
  FIRM_ID              = NULL;
  FIRM_NAME            = '';
  FILIAL_ID            = NULL;
  FILIAL_NAME          = '';
  ACC_ID_DEB           = NULL;
  ACC_ID_KRED          = NULL;
  ACC_IDS_DEB          = '';
  ACC_IDS_KRED         = '';
  SUBKONTO_ID_DEB      = 0;
  SUBKONTO_ID_KRED     = 0;
  SUBKONTO_QUANT_DEB   = 0;
  SUBKONTO_QUANT_KRED  = 0;
  SUBKONTO_NAME_DEB    = '';
  SUBKONTO_NAME_KRED   = '';
  J_ID                 = 0;
  J_TYPE_ID            = 0;
  J_TYPE_NAME          = '';
  J_DOCNUMBERSTR       = '';
  J_DOCNUMBERIN        = '';
  J_DOCSTR             = '';
  SELECT COALESCE(SUM(C.CND_VALUE),0) AS ACC_VALUE
  FROM   TABL$P_CND C
  WHERE  (C.DATE_COMMIT < :DATE_FROM)
    AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
    AND  (C.ACC_IDS_DEB  CONTAINING '~'||:ACC_ID||'~')
  INTO   :DEBET;
  SELECT COALESCE(SUM(C.CND_VALUE),0) AS ACC_VALUE
  FROM   TABL$P_CND C
  WHERE  (C.DATE_COMMIT < :DATE_FROM)
    AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
    AND  (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~')
  INTO   :KREDIT;
  SALDO = :DEBET - :KREDIT;
  P_DEBET_SAVED  = :DEBET;
  P_KREDIT_SAVED = :KREDIT;
  DEBET     = 0;
  KREDIT    = 0;
  IF(:SALDO < 0)THEN
    KREDIT = (-1) * :SALDO;
   ELSE
    DEBET  = :SALDO;
  DATE_COMMIT = :DATE_FROM;
  NAME     = 'CAËÜÄO BXOÄßÙEE';
  SUSPEND;
  FLAG          = 0;
  DEBET         = 0;
  KREDIT        = 0;
  P_DEBET_TURN  = 0;
  P_KREDIT_TURN = 0;
  FOR
    SELECT C.DATE_COMMIT, C.CND_VALUE, C.J_ID, C.FIRM_ID, C.FILIAL_ID
          ,C.ACC_IDS_DEB ,C.ACC_ID_DEB , C.SUBKONTO_ID_DEB , C.SUBKONTO_NAME_DEB , C.SUBKONTO_QUANT_DEB
          ,C.ACC_IDS_KRED,C.ACC_ID_KRED, C.SUBKONTO_ID_KRED, C.SUBKONTO_NAME_KRED, C.SUBKONTO_QUANT_KRED
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  (  (C.ACC_IDS_DEB  CONTAINING '~'||:ACC_ID||'~')
            OR(C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~'))
    ORDER BY C.DATE_COMMIT        
    INTO   :DATE_COMMIT, :P_SALDO, :J_ID, :FIRM_ID, :FILIAL_ID
          ,:ACC_IDS_DEB ,:ACC_ID_DEB ,:SUBKONTO_ID_DEB , :SUBKONTO_NAME_DEB , :SUBKONTO_QUANT_DEB
          ,:ACC_IDS_KRED,:ACC_ID_KRED,:SUBKONTO_ID_KRED, :SUBKONTO_NAME_KRED, :SUBKONTO_QUANT_KRED
  DO
    BEGIN
    FIRM_NAME      = '';
    FILIAL_NAME    = '';
    J_TYPE_ID      = 0;
    J_TYPE_NAME    = '';
    J_DOCNUMBERSTR = '';
    J_DOCNUMBERIN  = '';
    J_DOCSTR       = '';
    COLOR_FRG = 0x000000;
    COLOR_BGR = 0xFFFFFF;
    DEBET          = 0;
    KREDIT         = 0;
    SELECT FIRST 1 J.TYPE_ID, TT.NAME2, J.DOCNUMBERSTR, J.DOCNUMBERIN, J.DOCSTR
          ,TD.COLOR_FRG, TD.COLOR_BGR
    FROM   TABL$J_4 J, TABL$_TB_TYPES TT, TABL$_TB_DOCS TD
    WHERE  (J.ID = :J_ID)
      AND  (TT.ID = J.TYPE_ID)
      AND  (TD.TYPE_ID = TT.ID)
    INTO   :J_TYPE_ID, :J_TYPE_NAME, :J_DOCNUMBERSTR, :J_DOCNUMBERIN, :J_DOCSTR
          ,:COLOR_FRG, :COLOR_BGR;
    SELECT FIRST 1 F1.NAME FROM TABL$R_FIRMS   F1 WHERE (F1.ID = :FIRM_ID  )INTO :FIRM_NAME;
    SELECT FIRST 1 F2.NAME FROM TABL$R_FILIALS F2 WHERE (F2.ID = :FILIAL_ID)INTO :FILIAL_NAME;
    NAME = :J_DOCSTR;
    IF(:ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~')THEN
      DEBET  = :P_SALDO;
     ELSE
      KREDIT = :P_SALDO;
    SALDO = :SALDO + :DEBET - :KREDIT;
    P_DEBET_TURN  = :P_DEBET_TURN  + :DEBET;
    P_KREDIT_TURN = :P_KREDIT_TURN + :KREDIT;
    SUSPEND;
    END
  COLOR_FRG            = 0x000000;
  COLOR_BGR            = 0xFFFFFF;
  FLAG                 = 1;
  FIRM_ID              = NULL;
  FIRM_NAME            = '';
  FILIAL_ID            = NULL;
  FILIAL_NAME          = '';
  ACC_ID_DEB           = NULL;
  ACC_ID_KRED          = NULL;
  ACC_IDS_DEB          = '';
  ACC_IDS_KRED         = '';
  SUBKONTO_ID_DEB      = 0;
  SUBKONTO_ID_KRED     = 0;
  SUBKONTO_QUANT_DEB   = 0;
  SUBKONTO_QUANT_KRED  = 0;
  SUBKONTO_NAME_DEB    = '';
  SUBKONTO_NAME_KRED   = '';
  J_ID                 = 0;
  J_TYPE_ID            = 0;
  J_TYPE_NAME          = '';
  J_DOCNUMBERSTR       = '';
  J_DOCNUMBERIN        = '';
  J_DOCSTR             = '';
  DATE_COMMIT          = :DATE_TO;
  DEBET    = :P_DEBET_TURN;
  KREDIT   = :P_KREDIT_TURN;
  NAME     = 'OÁOPOT';
  SUSPEND;
  DEBET     = 0;
  KREDIT    = 0;
  IF(:SALDO < 0)THEN
    KREDIT = (-1) * :SALDO;
   ELSE
    DEBET  = :SALDO;
  NAME     = 'CAËÜÄO ÈCXOÄßÙEE';
  SUSPEND;
END
