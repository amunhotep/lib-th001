EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
  DATE_FROM               TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO                 TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS                TYPE OF COLUMN TABL$J_4.DOCSTR
 ,FIRM_NAMES              TYPE OF COLUMN TABL$J_4.DOCSTR
 ,BUHG_ACCS_ID            TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
 ,BUHG_ACCS_PARENT_ID     TYPE OF COLUMN TABL$R_BUHG_ACCS.PARENT_ID
 ,BUHG_ACCS_NAME          TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
 ,BUHG_ACCS_NAMEPATH      TYPE OF COLUMN TABL$J_4.DOCSTR
 ,BUHG_ACCS_IDS           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,BUHG_ACCS_DEBET         TYPE OF COLUMN TABL$J_4.DOCSUM
 ,BUHG_ACCS_KREDIT        TYPE OF COLUMN TABL$J_4.DOCSUM
 ,SUBKONTO                TYPE OF COLUMN TABL$R_BUHG_ACCS.SUBKONTO
 ,SUBKONTO_ID             TYPE OF COLUMN TABL$J_4.ID
 ,SUBKONTO_NAME           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,SUBKONTO_DEBET          TYPE OF COLUMN TABL$J_4.DOCSUM
 ,SUBKONTO_KREDIT         TYPE OF COLUMN TABL$J_4.DOCSUM
 ,NAME                    TYPE OF COLUMN TABL$J_4.DOCSTR
 ,DEBET                   TYPE OF COLUMN TABL$J_4.DOCSUM
 ,KREDIT                  TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_FLAG   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT;
  DECLARE VARIABLE P_CNDSUM TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_STR    TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  SELECT FIRST 1 LIST(F.NAME,'; ') FROM TABL$R_FIRMS F WHERE(:FIRM_IDS CONTAINING '~'||F.ID||'~') INTO :FIRM_NAMES;
  FOR
    SELECT TMP.ID, TMP.PARENT_ID, TMP.NAME, TMP.NAMEPATH, TMP.SUBKONTO
    FROM   (WITH RECURSIVE BA AS(
              SELECT B1.ID, B1.PARENT_ID, B1.NAME, B1.SUBKONTO, CAST('' AS VARCHAR(1)) AS NAMEPATH
              FROM   TABL$R_BUHG_ACCS B1
              WHERE  ('~91~92~93~' CONTAINING '~'||B1.ID||'~')
              UNION ALL
              SELECT B2.ID, B2.PARENT_ID, B2.NAME, B2.SUBKONTO, CAST('  '||B3.NAMEPATH AS VARCHAR(255)) AS NAMEPATH
              FROM   TABL$R_BUHG_ACCS B2, BA B3
              WHERE  (B2.PARENT_ID = B3.ID)
            )SELECT B.ID, B.PARENT_ID, B.NAME, B.NAMEPATH, B.SUBKONTO FROM BA B
            )TMP
    INTO   :BUHG_ACCS_ID, :BUHG_ACCS_PARENT_ID, :BUHG_ACCS_NAME, :BUHG_ACCS_NAMEPATH, :SUBKONTO
  DO 
    BEGIN
    BUHG_ACCS_NAMEPATH = :BUHG_ACCS_NAMEPATH||:BUHG_ACCS_NAME;
    BUHG_ACCS_DEBET  = 0;
    BUHG_ACCS_KREDIT = 0;
    SUBKONTO_ID      = -1000000;
    SUBKONTO_NAME    = '';
    SUBKONTO_DEBET   = 0;
    SUBKONTO_KREDIT  = 0;
    NAME             = '';
    DEBET            = 0;
    KREDIT           = 0;
    WITH RECURSIVE BA AS(
      SELECT B1.ID, B1.PARENT_ID
      FROM   TABL$R_BUHG_ACCS B1
      WHERE  (B1.ID = :BUHG_ACCS_ID)
      UNION ALL
      SELECT B2.ID, B2.PARENT_ID
      FROM   TABL$R_BUHG_ACCS B2, BA B3
      WHERE  (B2.PARENT_ID = B3.ID)
    )
    SELECT COALESCE('~'||LIST(B.ID,'~')||'~', '')
    FROM   BA B
    WHERE  EXISTS(
             SELECT FIRST 1 C.ID
             FROM   TABL$P_CND C
             WHERE  ( (C.ACC_ID_DEB=B.ID) OR (C.ACC_ID_KRED=B.ID) )
               AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
           )
    INTO :BUHG_ACCS_IDS;
    IF( (:BUHG_ACCS_IDS <> '') --AND (:BUHG_ACCS_ID <> 0) 
    )THEN
      BEGIN
      SELECT COALESCE(SUM(C1.CND_VALUE),0)
      FROM   TABL$P_CND C1
      WHERE  (C1.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (C1.ACC_IDS_DEB CONTAINING '~'||:BUHG_ACCS_ID||'~')
        AND  (:FIRM_IDS      CONTAINING '~'||C1.FIRM_ID||'~')
      INTO   :BUHG_ACCS_DEBET;
  
      SELECT COALESCE(SUM(C2.CND_VALUE),0)
      FROM   TABL$P_CND C2
      WHERE  (C2.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (C2.ACC_IDS_KRED CONTAINING '~'||:BUHG_ACCS_ID||'~')
        AND  (:FIRM_IDS      CONTAINING '~'||C2.FIRM_ID||'~')
      INTO   :BUHG_ACCS_KREDIT;
      END
    IF((:BUHG_ACCS_DEBET <> 0) OR (:BUHG_ACCS_KREDIT <> 0))THEN
      BEGIN
      FOR
        SELECT DISTINCT H.SUBKONTO_ID
        FROM   (SELECT C1.SUBKONTO_ID_DEB AS SUBKONTO_ID
                FROM   TABL$P_CND C1
                WHERE  (:FIRM_IDS CONTAINING '~'||C1.FIRM_ID||'~')
                  AND  ((C1.ACC_ID_DEB+0) = :BUHG_ACCS_ID)
                UNION ALL
                SELECT C1.SUBKONTO_ID_KRED AS SUBKONTO_ID
                FROM   TABL$P_CND C1
                WHERE  (:FIRM_IDS CONTAINING '~'||C1.FIRM_ID||'~')
                  AND  ((C1.ACC_ID_KRED+0) = :BUHG_ACCS_ID)
                ) H
        INTO   :SUBKONTO_ID
      DO
        BEGIN
        SUBKONTO_NAME   = '';
        SUBKONTO_DEBET  = 0;
        SUBKONTO_KREDIT = 0;
        NAME            = '';
        DEBET           = 0;
        KREDIT          = 0;
        SELECT FIRST 1 P.SUBKONTO_NAME
        FROM   PROC$R_BUHG_ACCS_SUBKONTO(:BUHG_ACCS_ID, :SUBKONTO_ID) P
        INTO   :SUBKONTO_NAME;
        SELECT COALESCE(SUM(C.CND_VALUE),0)
        FROM   TABL$P_CND C
        WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
          AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
          AND  ((C.ACC_ID_DEB+0)  = :BUHG_ACCS_ID)
          AND  (C.SUBKONTO_ID_DEB = :SUBKONTO_ID)
        INTO   :SUBKONTO_DEBET;
        SELECT COALESCE(SUM(C.CND_VALUE),0)
        FROM   TABL$P_CND C
        WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
          AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
          AND  ((C.ACC_ID_KRED+0)  = :BUHG_ACCS_ID)
          AND  (C.SUBKONTO_ID_KRED = :SUBKONTO_ID)
        INTO   :SUBKONTO_KREDIT;
        IF((:SUBKONTO_DEBET <> 0) OR (:SUBKONTO_KREDIT <> 0))THEN
          BEGIN
          NAME = '';
          FOR
            SELECT TMP.FLAG, COALESCE(TMP.NAME,''), COALESCE(SUM(TMP.CND_VALUE), 0)
            FROM   (SELECT 1 AS FLAG, C1.NAME, C1.CND_VALUE, C1.SUBKONTO_NAME_KRED AS SUBKONTO_NAME
                    FROM   TABL$P_CND C1
                    WHERE  (C1.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
                      AND  (:FIRM_IDS CONTAINING '~'||C1.FIRM_ID||'~')
                      AND  ((C1.ACC_ID_DEB+0)  = :BUHG_ACCS_ID)
                      AND  (C1.SUBKONTO_ID_DEB = :SUBKONTO_ID)
                    UNION ALL
                    SELECT 0 AS FLAG, C2.NAME, C2.CND_VALUE, C2.SUBKONTO_NAME_DEB  AS SUBKONTO_NAME
                    FROM   TABL$P_CND C2
                    WHERE  (C2.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
                      AND  (:FIRM_IDS CONTAINING '~'||C2.FIRM_ID||'~')
                      AND  ((C2.ACC_ID_KRED+0)  = :BUHG_ACCS_ID)
                      AND  (C2.SUBKONTO_ID_KRED = :SUBKONTO_ID)
                    )TMP
            GROUP BY 1,2
            INTO    :P_FLAG, :NAME, :P_CNDSUM
          DO
            BEGIN
            DEBET  = 0;
            KREDIT = 0;
            IF(:P_FLAG = 1)THEN DEBET = :P_CNDSUM; ELSE KREDIT = :P_CNDSUM;
            SUSPEND;
            END
          END
        END
      END
    END
END
