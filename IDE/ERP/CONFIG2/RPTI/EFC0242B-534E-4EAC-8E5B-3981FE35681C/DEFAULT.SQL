EXECUTE BLOCK (
  Q_DATE_FROM   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO     TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
)RETURNS (
  DATE_FROM     TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,CS_ID         TYPE OF COLUMN TABL$R_CS.ID
 ,CS_NAME       TYPE OF COLUMN TABL$R_CS.NAME
 ,CS_NAME2      TYPE OF COLUMN TABL$R_CS.NAME2
 ,CS_CODECARD   TYPE OF COLUMN TABL$R_CS.CODECARD
 ,SALDOBEGIN    TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,DEBET         TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,DEBET0        TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,DEBET1000001  TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,DEBET1000002  TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,DEBET1000003  TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,KREDIT        TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,KREDIT0       TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,KREDIT1000001 TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,KREDIT1000002 TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,KREDIT1000003 TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
 ,SALDOEND      TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS
)AS
  DECLARE VARIABLE P_KREDIT TYPE OF COLUMN TABL$P_CS_RSPOINTS.POINTS;
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FOR
    SELECT DISTINCT P.CS_ID, C.NAME, C.NAME2, C.CODECARD
    FROM   TABL$P_CS_RSPOINTS P, TABL$R_CS C
    WHERE  (C.ID = P.CS_ID)
    ORDER BY C.NAME, C.CODECARD
    INTO   :CS_ID, :CS_NAME, :CS_NAME2, :CS_CODECARD
  DO 
    BEGIN 
    SALDOBEGIN = 0;
    SELECT COALESCE( SUM(T.SALDOFULL), 0), COALESCE( SUM(T.KREDIT), 0)
    FROM   (SELECT P1.J_POINTS AS SALDOFULL
                  ,(SELECT COALESCE( SUM(PP.POINTS), 0)
                    FROM   TABL$P_CS_RSPOINTS PP
                    WHERE  (PP.PARENT_ID     = P1.ID)
                      AND  (PP.J_DATE_COMMIT < :DATE_FROM)
                      AND  (PP.CS_ID         = P1.CS_ID)
                    ) AS KREDIT
            FROM   TABL$P_CS_RSPOINTS P1
            WHERE  (P1.J_DATE_COMMIT < :DATE_FROM)
              AND  (P1.PARENT_ID = 0)
              AND  (P1.CS_ID     = :CS_ID)
            ) T
    INTO    :SALDOBEGIN, :P_KREDIT;
    SALDOBEGIN = :SALDOBEGIN - :P_KREDIT;

    SELECT COALESCE(SUM(P2.J_POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P2
    WHERE  (P2.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P2.PARENT_ID = 0)
      AND  (P2.CS_ID = :CS_ID)
    INTO   :DEBET;

    SELECT COALESCE(SUM(P2.J_POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P2
    WHERE  (P2.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P2.PARENT_ID = 0)
      AND  (P2.CS_ID = :CS_ID)
      AND  (P2.FILIAL_ID = 0)
    INTO   :DEBET0;

    SELECT COALESCE(SUM(P2.J_POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P2
    WHERE  (P2.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P2.PARENT_ID = 0)
      AND  (P2.CS_ID = :CS_ID)
      AND  (P2.FILIAL_ID = 1000001)
    INTO   :DEBET1000001;

    SELECT COALESCE(SUM(P2.J_POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P2
    WHERE  (P2.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P2.PARENT_ID = 0)
      AND  (P2.CS_ID = :CS_ID)
      AND  (P2.FILIAL_ID = 1000002)
    INTO   :DEBET1000002;

    SELECT COALESCE(SUM(P2.J_POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P2
    WHERE  (P2.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P2.PARENT_ID = 0)
      AND  (P2.CS_ID = :CS_ID)
      AND  (P2.FILIAL_ID = 1000003)
    INTO   :DEBET1000003;

    SELECT COALESCE(SUM(P3.POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P3
    WHERE  (P3.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P3.PARENT_ID <> 0)
      AND  (P3.CS_ID     = :CS_ID)
    INTO   :KREDIT;

    SELECT COALESCE(SUM(P30.POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P30
    WHERE  (P30.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P30.PARENT_ID <> 0)
      AND  (P30.CS_ID     = :CS_ID)
      AND  (P30.FILIAL_ID = 0)
    INTO   :KREDIT0;

    SELECT COALESCE(SUM(P31.POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P31
    WHERE  (P31.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P31.PARENT_ID <> 0)
      AND  (P31.CS_ID     = :CS_ID)
      AND  (P31.FILIAL_ID = 1000001)
    INTO   :KREDIT1000001;

    SELECT COALESCE(SUM(P32.POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P32
    WHERE  (P32.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P32.PARENT_ID <> 0)
      AND  (P32.CS_ID     = :CS_ID)
      AND  (P32.FILIAL_ID = 1000002)
    INTO   :KREDIT1000002;

    SELECT COALESCE(SUM(P33.POINTS),0)
    FROM   TABL$P_CS_RSPOINTS P33
    WHERE  (P33.J_DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (P33.PARENT_ID <> 0)
      AND  (P33.CS_ID     = :CS_ID)
      AND  (P33.FILIAL_ID = 1000003)
    INTO   :KREDIT1000003;

    SALDOEND = :SALDOBEGIN + :DEBET - :KREDIT;

    SUSPEND; 
    END 
END
