EXECUTE BLOCK(
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  DOMN$BLOB_TEXT                      = ?FIRM_IDS
  ,Q_CALCTMC   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?CALCTMC
)RETURNS(
   DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FILIAL_ID       TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME     TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,FILIAL_ADDRESS  TYPE OF COLUMN TABL$R_FILIALS.ADDRESS
  ,DAYSCOUNT       TYPE OF COLUMN TABL$J_4.ID
  ,KRD3771SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,KRD3771CNTDOC   TYPE OF COLUMN TABL$J_4.ID
  ,KRD3771CNTCS    TYPE OF COLUMN TABL$J_4.ID
  ,DEB3771_301     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771_6852    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771CNTDOC   TYPE OF COLUMN TABL$J_4.ID
  ,DEB3771CNTCS    TYPE OF COLUMN TABL$J_4.ID
  ,DEB3771SUM1DAY  TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771SUM1DAY_ TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771SUM1CS   TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB3771SUM1CS_  TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB373_301      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB373_702      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB373SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB373SUMPC     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DEB373SUMPC_    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DTMC0_MASSA     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DTMC0_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DTMC1_MASSA     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DTMC1_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TTMC0_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TTMC1_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NTMC0_MASSA     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NTMC0_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NTMC1_MASSA     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NTMC1_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JZ_CNT             TYPE OF COLUMN TABL$J_4.ID
  ,JZ_SUM             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JZ_TMC_CNT         TYPE OF COLUMN TABL$R_TMC.ID
  ,JZ_TMC_MASSA       TYPE OF COLUMN TABL$R_TMC.MASSA
  ,JZ_TMC_MASSA_INS   TYPE OF COLUMN TABL$R_TMC.MASSA
  ,JZ_TMC_MASSA_NETTO TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,JC_SUM_BODY        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JC_SUM_PC          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JC_SUM_TOTAL       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUM_DIFF           TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JB_SUM             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JB_SUM_DIFF        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P661_SUM        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P91_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P92_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P93_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6414_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6416_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6852_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P03_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,PTOTAL_SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_PC       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_PC_      TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_KRD3771SUM TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_PLACES1    TYPE OF COLUMN TABL$J_4.DOCSTR;
  DECLARE VARIABLE P_PLACES2    TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  DAYSCOUNT = ABS(DATEDIFF(DAY FROM :Q_DATE_TO TO :Q_DATE_FROM));
  SELECT COALESCE(SUM(J4.DOCSUM),0), COALESCE(COUNT(DISTINCT JCASH.SUBKONTO_ID),0)
  FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
  WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (J4.FLAG_COMMIT = 1)
    AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
    AND  (J4.TYPE_ID = 1000020)
    AND  (JCASH.J_ID = J4.ID)
    AND  (JCASH.ACC_ID = 3771)
  INTO   :DEB3771_301, :DEB3771CNTCS;
  SELECT COALESCE(SUM(CND.CND_VALUE),0)
  FROM   TABL$P_CND CND
  WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
    AND  (CND.ACC_ID_DEB  = 6852)
    AND  (CND.ACC_ID_KRED = 3771)
  INTO   :DEB3771_6852; IF(:DEB3771_6852 IS NULL)THEN DEB3771_6852 = 0;
  DEB3771SUM = :DEB3771_301 + :DEB3771_6852;
  DEB3771SUM1DAY_ = :DEB3771SUM / :DAYSCOUNT;
  IF(:DEB3771CNTCS <> 0)THEN
    DEB3771SUM1CS_ = :DEB3771SUM / :DEB3771CNTCS;
   ELSE
    DEB3771SUM1CS_ = 0;
  SELECT COALESCE(SUM(J4.DOCSUM),0)
  FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
  WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (J4.FLAG_COMMIT = 1)
    AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
    AND  (J4.TYPE_ID = 1000021)
    AND  (JCASH.J_ID = J4.ID)
    AND  (JCASH.ACC_ID = 3771)
  INTO   :KRD3771SUM; IF(:KRD3771SUM IS NULL)THEN KRD3771SUM = 0;
  P_KRD3771SUM = :KRD3771SUM;
  SELECT COALESCE(SUM(J4.DOCSUM),0)
  FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
  WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (J4.FLAG_COMMIT = 1)
    AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
    AND  (J4.TYPE_ID = 1000020)
    AND  (JCASH.J_ID = J4.ID)
    AND  (JCASH.ACC_ID = 373)
  INTO   :DEB373_301; IF(:DEB373_301 IS NULL)THEN DEB373_301 = 0;
  SELECT COALESCE(SUM(CND.CND_VALUE),0)
  FROM   TABL$P_CND CND
  WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
    AND  (CND.ACC_ID_DEB  = 373)
    AND  (CND.ACC_ID_KRED = 702)
  INTO   :DEB373_702; IF(:DEB373_702 IS NULL)THEN DEB373_702 = 0;
  DEB373SUM = :DEB373_301 + :DEB373_702;
  IF(:KRD3771SUM <> 0)THEN
    DEB373SUMPC_ = (:DEB373SUM * 100) / :KRD3771SUM;
   ELSE  
    DEB373SUMPC_ = 0;

  P661_SUM = 0;
  IF(:Q_DATE_FROM >= '01.11.2013 00:00:00')THEN
    BEGIN
    P661_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB IN(661, 6611, 6612, 651, 6411) )
    INTO   :P661_SUM; IF(:P661_SUM IS NULL)THEN P661_SUM = 0;
    P6852_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 6852)
      AND  (CND.ACC_ID_KRED <> 3771)
    INTO   :P6852_SUM; IF(:P6852_SUM IS NULL)THEN P6852_SUM = 0;
    P6414_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 6414)
    INTO   :P6414_SUM; IF(:P6414_SUM IS NULL)THEN P6414_SUM = 0;
    P6416_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 6416)
    INTO   :P6416_SUM; IF(:P6416_SUM IS NULL)THEN P6416_SUM = 0;
    P91_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 91)
    INTO   :P91_SUM; IF(:P91_SUM IS NULL)THEN P91_SUM = 0;
    P92_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 92)
    INTO   :P92_SUM; IF(:P92_SUM IS NULL)THEN P92_SUM = 0;
    P93_SUM = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  (CND.ACC_ID_DEB = 93)
    INTO   :P93_SUM; IF(:P93_SUM IS NULL)THEN P93_SUM = 0;
    SELECT COALESCE(SUM(J4.DOCSUM),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = -3)
    INTO   :PTOTAL_SUM; IF(:PTOTAL_SUM IS NULL)THEN PTOTAL_SUM = 0;
    PTOTAL_SUM = :PTOTAL_SUM + :P661_SUM + :P6852_SUM + :P6414_SUM + :P6416_SUM + :P91_SUM + :P92_SUM + :P93_SUM;
    END
   ELSE
    BEGIN  
    SELECT COALESCE(SUM(J4.DOCSUM),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  ('~661~6611~6612~651~6411~91~92~93~6414~6416~6852~-3~' CONTAINING '~'||JCASH.ACC_ID||'~')
    INTO   :PTOTAL_SUM; IF(:PTOTAL_SUM IS NULL)THEN PTOTAL_SUM = 0;
    END

  P661_SUM = 0;
  RESULT_SUM = :DEB373SUM - :PTOTAL_SUM;
  IF(:KRD3771SUM <> 0)THEN
    RESULT_PC_ = (:RESULT_SUM * 100) / :KRD3771SUM;
   ELSE  
    RESULT_PC_ = 0;

  DEB3771CNTCS = 0;
  DEB3771SUM   = 0;
  DEB3771_301  = 0;
  DEB3771_6852 = 0;
  KRD3771SUM   = 0;
  DEB373SUM    = 0;
  DEB373_301   = 0;
  DEB373_702   = 0;
  PTOTAL_SUM   = 0;
  RESULT_SUM   = 0;
  FOR 
    SELECT FL.ID, FL.NAME, FL.ADDRESS 
    FROM   TABL$R_FILIALS FL
    WHERE  (FL.FLAG_DELETE <> 1) 
    ORDER BY FL.ID 
    INTO :FILIAL_ID, :FILIAL_NAME, :FILIAL_ADDRESS 
  DO
    BEGIN
    --IF(:FILIAL_ID = 0)THEN FILIAL_NAME = 'BCE'; ELSE FILIAL_NAME = '  '||:FILIAL_NAME;
    SUM_DIFF = 0;
    JB_SUM_DIFF = 0;
    SELECT COALESCE(COUNT(DISTINCT TMP.J_ID),0)
          ,COALESCE(SUM(TMP.TMC_CNT),0), COALESCE(SUM(TMP.TMC_SUM),0)
          ,COALESCE(SUM(TMP.TMC_MASSA),0), COALESCE(SUM(TMP.TMC_MASSA_NETTO),0)
          ,COALESCE(SUM(TMP.JB_SUM),0)
    FROM   (SELECT J.ID AS J_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
                  ,(D14.QUANT                  ) AS TMC_CNT
                  ,(D14.QUANT * D14.PRICE      ) AS TMC_SUM
                  ,(D14.QUANT * TMC.MASSA      ) AS TMC_MASSA
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS TMC_MASSA_NETTO
                  ,(SELECT SUM(QM.PRICE_TMC * QM.QUANT)
                    FROM   TABL$P_TMC_QUANT_MOVE QM
                    WHERE  (QM.TMC_ID = D14.TMC_ID)
                      AND  ((QM.PLACE_ID+0) = J14.TO_PLACE_ID)
                      AND  (:Q_FIRM_IDS CONTAINING '~'||QM.FIRM_ID||'~')
                      AND  (QM.FLAG_DEBET = 0)
                    )AS JB_SUM
            FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$D_1000014 D14, TABL$R_TMC TMC
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000024)
              AND  (J.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (J14.J_ID = J.ID)
              AND  (D14.J_ID = J.ID)
              AND  (TMC.ID = D14.TMC_ID)
           ) TMP
    WHERE  (TMP.JZ_ID <> 0)
    INTO   :JZ_CNT, :JZ_TMC_CNT, :JZ_SUM, :JZ_TMC_MASSA, :JZ_TMC_MASSA_NETTO, :JB_SUM;
    JZ_TMC_MASSA_INS = :JZ_TMC_MASSA - :JZ_TMC_MASSA_NETTO;

    SELECT COALESCE(SUM(TMP.DOCSUM),0)
    FROM   (SELECT J.DOCSUM, J.FIRM_ID AS JC_FIRM_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
            FROM   TABL$J_4 J, TABL$J_1000016 JCASH
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000021)
              AND  (J.FLAG_COMMIT = 1)
              AND  (J.NAME CONTAINING '“≈À¿')
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (JCASH.J_ID = J.ID)
              AND  (JCASH.ACC_ID = 301)
            ) TMP, TABL$J_4 JZ
    WHERE  (JZ.ID = TMP.JZ_ID)
      AND  (JZ.FIRM_ID <> JC_FIRM_ID)
    INTO   :JC_SUM_BODY;

    SELECT COALESCE(SUM(TMP.DOCSUM),0)
    FROM   (SELECT J.DOCSUM, J.FIRM_ID AS JC_FIRM_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
            FROM   TABL$J_4 J, TABL$J_1000016 JCASH
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000021)
              AND  (J.FLAG_COMMIT = 1)
              AND  (J.NAME CONTAINING 'œ–Œ÷≈Õ“Œ¬')
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (JCASH.J_ID = J.ID)
              AND  (JCASH.ACC_ID = 301)
            ) TMP, TABL$J_4 JZ
    WHERE  (JZ.ID = TMP.JZ_ID)
      AND  (JZ.FIRM_ID <> TMP.JC_FIRM_ID)
    INTO   :JC_SUM_PC;
    JC_SUM_TOTAL = :JC_SUM_BODY + :JC_SUM_PC;

    SUM_DIFF    = :JZ_SUM - :JC_SUM_TOTAL;
    JB_SUM_DIFF = :JB_SUM - :JC_SUM_TOTAL;


    SELECT '~'||LIST(PL.ID,'~')||'~'
    FROM   TABL$R_PLACES PL
    WHERE  (PL.ACC_ID = -6)
      AND  (PL.FILIAL_ID = :FILIAL_ID)
    INTO   :P_PLACES1;

    SELECT '~'||LIST(PL.ID,'~')||'~'
    FROM   TABL$R_PLACES PL
    WHERE  (PL.ACC_ID = -61)
      AND  ((PL.FILIAL_ID = :FILIAL_ID) OR (PL.FILIAL_ID = 0))
    INTO   :P_PLACES2;

    SELECT SUM(J4.DOCSUM), COUNT(J4.ID), COUNT(DISTINCT JCASH.SUBKONTO_ID)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 3771)
    INTO   :KRD3771SUM, :KRD3771CNTDOC, :KRD3771CNTCS;
    IF(:KRD3771SUM    IS NULL)THEN KRD3771SUM    = 0;
    IF(:KRD3771CNTDOC IS NULL)THEN KRD3771CNTDOC = 0;
    IF(:KRD3771CNTCS  IS NULL)THEN KRD3771CNTCS  = 0;
    SELECT COALESCE(SUM(J4.DOCSUM),0), COALESCE(COUNT(J4.ID),0), COALESCE(COUNT(DISTINCT JCASH.SUBKONTO_ID),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000020)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 3771)
    INTO   :DEB3771_301, :DEB3771CNTDOC, :DEB3771CNTCS;
    IF(:DEB3771_301   IS NULL)THEN DEB3771_301   = 0;
    IF(:DEB3771CNTDOC IS NULL)THEN DEB3771CNTDOC = 0;
    IF(:DEB3771CNTCS  IS NULL)THEN DEB3771CNTCS  = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
      AND  (CND.ACC_ID_DEB  = 6852)
      AND  (CND.ACC_ID_KRED = 3771)
    INTO   :DEB3771_6852; IF(:DEB3771_6852 IS NULL)THEN DEB3771_6852 = 0;
    DEB3771SUM = :DEB3771_301 + :DEB3771_6852;
    DEB3771SUM1DAY = :DEB3771SUM / :DAYSCOUNT;
    IF(:DEB3771CNTCS <> 0)THEN
      DEB3771SUM1CS = :DEB3771SUM / :DEB3771CNTCS;
     ELSE
      DEB3771SUM1CS = 0;
    DEB373_301 = 0;  
    DEB373_702 = 0;  
    SELECT COALESCE(SUM(J4.DOCSUM),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000020)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 373)
    INTO   :DEB373_301; IF(:DEB373_301 IS NULL)THEN DEB373_301 = 0;
    SELECT COALESCE(SUM(CND.CND_VALUE),0)
    FROM   TABL$P_CND CND
    WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
      AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
      AND  (CND.ACC_ID_DEB  = 373)
      AND  (CND.ACC_ID_KRED = 702)
    INTO   :DEB373_702; IF(:DEB373_702 IS NULL)THEN DEB373_702 = 0;
    DEB373SUM = :DEB373_301 + :DEB373_702;
    IF(:KRD3771SUM <> 0)THEN
      DEB373SUMPC = (:DEB373SUM * 100) / :KRD3771SUM;
     ELSE  
      DEB373SUMPC = 0;
    
    DTMC0_MASSA = 0; DTMC0_SUM = 0; TTMC0_SUM = 0; NTMC0_SUM = 0; NTMC0_MASSA = 0;
    DTMC1_MASSA = 0; DTMC1_SUM = 0; TTMC1_SUM = 0; NTMC1_SUM = 0; NTMC1_MASSA = 0;
    
    IF(:Q_CALCTMC = 1)THEN
      BEGIN  
      IF(:Q_FIRM_IDS CONTAINING '~0~')THEN
        BEGIN
        SELECT SUM(P.MASSA_NETTO),SUM(P.TOTAL) FROM PROC$P_TMC_QUANT_PSEX002('~0~',:P_PLACES1,:DATE_TO,1) P WHERE(P.MASSA_NETTO<>0)INTO :DTMC0_MASSA,:DTMC0_SUM;
        SELECT                    SUM(P.TOTAL) FROM PROC$P_TMC_QUANT_PSEX002('~0~',:P_PLACES1,:DATE_TO,1) P WHERE(P.MASSA_NETTO= 0)INTO :TTMC0_SUM; 
        SELECT SUM(P.PRICE_TMC * P.QUANT), SUM(TMC.MASSA_NETTO * P.QUANT)
        FROM   TABL$P_TMC_QUANT_MOVE P, TABL$J_4 J4, TABL$R_TMC TMC
        WHERE  ((P.FIRM_ID+0) = 0)
          AND  (:P_PLACES2 CONTAINING '~'||P.PLACE_ID||'~')
          AND  (P.FLAG_DEBET = 1)
          AND  (P.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
          AND  (J4.ID = P.J_ID)
          AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
          AND  (J4.FLAG_COMMIT = 1)
          AND  ((J4.TYPE_ID+0) = 1000066)
          AND  (TMC.ID = P.TMC_ID)
          AND  (TRIM(TMC.PROBE) <> '')
        INTO   :NTMC0_SUM, :NTMC0_MASSA;
        END
      IF(:Q_FIRM_IDS CONTAINING '~1~')THEN
        BEGIN
        SELECT SUM(P.MASSA_NETTO),SUM(P.TOTAL) FROM PROC$P_TMC_QUANT_PSEX002('~1~',:P_PLACES1,:DATE_TO,1) P WHERE(P.MASSA_NETTO<>0)INTO :DTMC1_MASSA,:DTMC1_SUM;
        SELECT                    SUM(P.TOTAL) FROM PROC$P_TMC_QUANT_PSEX002('~1~',:P_PLACES1,:DATE_TO,1) P WHERE(P.MASSA_NETTO= 0)INTO :TTMC1_SUM; 
        SELECT SUM(P.PRICE_TMC * P.QUANT), SUM(TMC.MASSA_NETTO * P.QUANT)
        FROM   TABL$P_TMC_QUANT_MOVE P, TABL$J_4 J4, TABL$R_TMC TMC
        WHERE  ((P.FIRM_ID+0) = 1)
          AND  (:P_PLACES2 CONTAINING '~'||P.PLACE_ID||'~')
          AND  (P.FLAG_DEBET = 1)
          AND  (P.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
          AND  (J4.ID = P.J_ID)
          AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
          AND  (J4.FLAG_COMMIT = 1)
          AND  ((J4.TYPE_ID+0) = 1000066)
          AND  (TMC.ID = P.TMC_ID)
          AND  (TRIM(TMC.PROBE) <> '')
        INTO   :NTMC1_SUM, :NTMC1_MASSA;
        END
      IF(:DTMC0_MASSA IS NULL)THEN DTMC0_MASSA = 0;
      IF(:DTMC0_SUM   IS NULL)THEN DTMC0_SUM   = 0;
      IF(:DTMC1_MASSA IS NULL)THEN DTMC1_MASSA = 0;
      IF(:DTMC1_SUM   IS NULL)THEN DTMC1_SUM   = 0;
      IF(:TTMC0_SUM   IS NULL)THEN TTMC0_SUM   = 0;
      IF(:TTMC1_SUM   IS NULL)THEN TTMC1_SUM   = 0;
      IF(:NTMC0_MASSA IS NULL)THEN NTMC0_MASSA = 0;
      IF(:NTMC0_SUM   IS NULL)THEN NTMC0_SUM   = 0;
      IF(:NTMC1_MASSA IS NULL)THEN NTMC1_MASSA = 0;
      IF(:NTMC1_SUM   IS NULL)THEN NTMC1_SUM   = 0;
      END
    IF(:Q_DATE_FROM >= '01.11.2013 00:00:00')THEN
      BEGIN
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB IN (661, 6611, 6612, 651, 6411) )
      INTO   :P661_SUM; IF(:P661_SUM IS NULL)THEN P661_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 6852)
        AND  (CND.ACC_ID_KRED <> 3771)
      INTO   :P6852_SUM; IF(:P6852_SUM IS NULL)THEN P6852_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 6414)
      INTO   :P6414_SUM; IF(:P6414_SUM IS NULL)THEN P6414_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 6416)
      INTO   :P6416_SUM; IF(:P6416_SUM IS NULL)THEN P6416_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 91)
      INTO   :P91_SUM; IF(:P91_SUM IS NULL)THEN P91_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 92)
      INTO   :P92_SUM; IF(:P92_SUM IS NULL)THEN P92_SUM = 0;
      SELECT COALESCE(SUM(CND.CND_VALUE),0)
      FROM   TABL$P_CND CND
      WHERE  (CND.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (:Q_FIRM_IDS CONTAINING '~'||CND.FIRM_ID||'~')
        AND  ((CND.FILIAL_ID+0) = :FILIAL_ID)
        AND  (CND.ACC_ID_DEB = 93)
      INTO   :P93_SUM; IF(:P93_SUM IS NULL)THEN P93_SUM = 0;
      END
     ELSE
      BEGIN  
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID IN(661, 6611, 6612, 651, 6411))
      INTO   :P661_SUM; IF(:P661_SUM IS NULL)THEN P661_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 6852)
      INTO   :P6852_SUM; IF(:P6852_SUM IS NULL)THEN P6852_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 6414)
      INTO   :P6414_SUM; IF(:P6414_SUM IS NULL)THEN P6414_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 6416)
      INTO   :P6416_SUM; IF(:P6416_SUM IS NULL)THEN P6416_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 91)
      INTO   :P91_SUM; IF(:P91_SUM IS NULL)THEN P91_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 92)
      INTO   :P92_SUM; IF(:P92_SUM IS NULL)THEN P92_SUM = 0;
      SELECT COALESCE(SUM(J4.DOCSUM),0)
      FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
      WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.TYPE_ID = 1000021)
        AND  (JCASH.J_ID = J4.ID)
        AND  (JCASH.ACC_ID = 93)
      INTO   :P93_SUM; IF(:P93_SUM IS NULL)THEN P93_SUM = 0;
      END
    
    SELECT COALESCE(SUM(J4.DOCSUM),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = -3)
    INTO   :P03_SUM; IF(:P03_SUM IS NULL)THEN P03_SUM = 0;

    PTOTAL_SUM = :P6414_SUM + :P6416_SUM + :P661_SUM + :P6852_SUM + :P91_SUM + :P92_SUM + :P93_SUM + :P03_SUM;
    RESULT_SUM = :DEB373SUM - :PTOTAL_SUM + :JB_SUM_DIFF;
    IF(:KRD3771SUM <> 0)THEN
      RESULT_PC = (:RESULT_SUM * 100) / :KRD3771SUM;
     ELSE  
      BEGIN
      IF((:P_KRD3771SUM <> 0)AND(:FILIAL_ID = 0))THEN
        RESULT_PC = (:RESULT_SUM * 100) / :P_KRD3771SUM;
       ELSE
        RESULT_PC = 0;
      END

    SUSPEND;
    END
END
