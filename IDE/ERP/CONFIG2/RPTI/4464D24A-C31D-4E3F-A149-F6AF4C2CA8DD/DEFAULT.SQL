EXECUTE BLOCK (
  Q_J_ID1 TYPE OF COLUMN TABL$J_4.ID          = ?J_ID1
 ,Q_J_ID2 TYPE OF COLUMN TABL$J_4.ID          = ?J_ID2
 ,Q_FLAG  TYPE OF COLUMN TABL$J_4.FLAG_DELETE = ?FLAG
)RETURNS (
  J_ID1    TYPE OF COLUMN TABL$J_4.ID
 ,J_ID2    TYPE OF COLUMN TABL$J_4.ID
 ,C1       TYPE OF COLUMN TABL$P_CND.ID
 ,C2       TYPE OF COLUMN TABL$P_CND.ID
 ,TMC_ID   TYPE OF COLUMN TABL$R_TMC.ID
 ,TMC_NAME TYPE OF COLUMN TABL$R_TMC.NAME
 ,CND1     TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,CND2     TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,CNDDELTA TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,Q1       TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,Q2       TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,Q3       TYPE OF COLUMN TABL$P_CND.CND_VALUE
 ,QS       TYPE OF COLUMN TABL$P_CND.CND_VALUE
)AS
BEGIN 
  J_ID1 = :Q_J_ID1;
  J_ID2 = :Q_J_ID2;
  FOR
    SELECT C1.ID AS C1ID, C2.ID AS C2ID
          ,C1.SUBKONTO_ID_KRED AS TMC_ID, C1.SUBKONTO_NAME_KRED AS TMC_NAME
          ,C1.CND_VALUE AS CND1, C2.CND_VALUE AS CND2, (C1.CND_VALUE - C2.CND_VALUE) AS CNDDELTA
    FROM   TABL$P_CND C1, TABL$P_CND C2
    WHERE  (C1.J_ID = :J_ID1)
      AND  (C2.J_ID = :J_ID2)
      AND  (C2.ACC_ID_DEB      = C1.ACC_ID_KRED)
      AND  (C2.SUBKONTO_ID_DEB = C1.SUBKONTO_ID_KRED)
    ORDER BY C1.SUBKONTO_ID_KRED, C1.ID, C2.ID
    INTO   :C1, :C2, :TMC_ID, :TMC_NAME, :CND1, :CND2, :CNDDELTA
  DO
    IF( (:CNDDELTA <> 0) OR (:Q_FLAG = 1) )THEN
      BEGIN
      Q1 = 0; Q2 = 0; Q3 = 0; QS = 0;
      SELECT COALESCE(SUM(Q1.QUANT),0)
      FROM   TABL$P_TMCQUANT Q1
      WHERE  ((Q1.FIRM_ID+0) = 0)
        AND  (Q1.PARENT_ID = 0)
        AND  (Q1.J_ID   = :J_ID2)
        AND  (Q1.TMC_ID = :TMC_ID)
      INTO :Q1;
      SELECT COALESCE(SUM(Q1.QUANT),0)
      FROM   TABL$P_TMCQUANT Q1
      WHERE  ((Q1.FIRM_ID+0) = 1)
        AND  (Q1.PARENT_ID = 0)
        AND  (Q1.J_ID   = :J_ID2)
        AND  (Q1.TMC_ID = :TMC_ID)
      INTO :Q2;
      SELECT COALESCE(SUM(Q1.QUANT),0)
      FROM   TABL$P_TMCQUANT Q1
      WHERE  ((Q1.FIRM_ID+0) = 2)
        AND  (Q1.PARENT_ID = 0)
        AND  (Q1.J_ID   = :J_ID2)
        AND  (Q1.TMC_ID = :TMC_ID)
      INTO :Q3;
      QS = :Q1 + :Q2 + :Q3;
      SUSPEND;
      END 
END
