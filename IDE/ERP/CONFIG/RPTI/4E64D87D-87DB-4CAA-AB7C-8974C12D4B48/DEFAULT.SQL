EXECUTE BLOCK (
   Q_FIRM_IDS      DOMN$BLOB_TEXT                      = ?FIRM_IDS
  ,Q_TMC_GROUP_IDS DOMN$BLOB_TEXT                      = ?TMC_GROUP_IDS
  ,Q_DATEFROM      TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO        TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
)RETURNS (
   FILIAL_ID          TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME        TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,FILIAL_ADDRESS     TYPE OF COLUMN TABL$R_FILIALS.ADDRESS
  ,CASH_SUM           TYPE OF COLUMN TABL$J_4.DOCSUM
  ,CASH_SUMPC         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_CNT          TYPE OF COLUMN TABL$J_4.ID
  ,ZALOG_CS           TYPE OF COLUMN TABL$J_4.ID
  ,ZALOG_SUMCALCBEGIN TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_SUMCALC      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_SUM          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_SUMINSU      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMBEG    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMDEB    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMKRED   TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMEND    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMPC     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,ZALOG_RETSUMPCPC   TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
BEGIN
  FOR 
    SELECT FL.ID, FL.NAME, FL.ADDRESS 
    FROM   TABL$R_FILIALS FL
    WHERE  (FL.FLAG_DELETE = 0) 
    ORDER  BY FL.ID 
    INTO  :FILIAL_ID, :FILIAL_NAME, :FILIAL_ADDRESS 
  DO
    BEGIN
    SELECT SUM(ALL J.DOCSUM)
    FROM   TABL$J_4 J, TABL$J_1000016 JCASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000020)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JCASH.J_ID    = J.ID)
      AND  (JCASH.ACC_ID  = 3771)
    INTO   :CASH_SUM;

    SELECT SUM(ALL J.DOCSUM)
    FROM   TABL$J_4 J, TABL$J_1000016 JCASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000020)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JCASH.J_ID    = J.ID)
      AND  (JCASH.ACC_ID  = 373)
    INTO   :CASH_SUMPC;

    SELECT COUNT(ALL J.ID), SUM(ALL J.DOCSUM), SUM(ALL JZ.DOCSUMLEFT), COUNT(DISTINCT JZ.CS_ID),
           SUM(ALL JZ.DOCSUMCALC), SUM(ALL JZ.DOCSUMCALCBEGIN)
    FROM   TABL$J_4 J, TABL$J_1000062 JZ
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000062)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JZ.J_ID       = J.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZ.TMC_GROUP_ID||'~')
    INTO   :ZALOG_CNT, :ZALOG_RETSUMBEG, :ZALOG_SUM, :ZALOG_CS, :ZALOG_SUMCALC, :ZALOG_SUMCALCBEGIN;
    IF(:ZALOG_SUM     IS NULL)THEN ZALOG_SUM     = 0;
    IF(:ZALOG_SUMCALC IS NULL)THEN ZALOG_SUMCALC = 0;
    ZALOG_SUMINSU = :ZALOG_SUMCALC - :ZALOG_SUM;

    SELECT SUM(ALL JCASH.DOCSUM)
    FROM    TABL$J_4 J, TABL$J_1000062 JZ, TABL$J_CHILDS JCORD, TABL$J_4 JORD
           ,TABL$J_CHILDS JCZ, TABL$J_4 JCASH, TABL$J_1000016 CASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000062)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JZ.J_ID       = J.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZ.TMC_GROUP_ID||'~')
      AND  (JCORD.J_ID    = J.ID)
      AND  (JORD.ID       = JCORD.J_CHILD_ID)
      AND  (JORD.TYPE_ID  = 1000070)
      AND  (JCZ.J_ID          = JORD.ID)
      AND  (JCASH.ID          = JCZ.J_CHILD_ID)
      AND  (JCASH.TYPE_ID     = 1000021)
      AND  (JCASH.FLAG_COMMIT = 1)
      AND  (CASH.J_ID         = JCASH.ID)
      AND  (CASH.ACC_ID       = 3771)
    INTO   :ZALOG_RETSUMKRED; IF(:ZALOG_RETSUMKRED IS NULL)THEN ZALOG_RETSUMKRED = 0;

    SELECT SUM(ALL JCASH.DOCSUM)
    FROM    TABL$J_4 J, TABL$J_1000062 JZ, TABL$J_CHILDS JCORD, TABL$J_4 JORD
           ,TABL$J_CHILDS JCZ, TABL$J_4 JCASH, TABL$J_1000016 CASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000062)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JZ.J_ID       = J.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZ.TMC_GROUP_ID||'~')
      AND  (JCORD.J_ID    = J.ID)
      AND  (JORD.ID       = JCORD.J_CHILD_ID)
      AND  (JORD.TYPE_ID  = 1000063)
      AND  (JCZ.J_ID          = JORD.ID)
      AND  (JCASH.ID          = JCZ.J_CHILD_ID)
      AND  (JCASH.TYPE_ID     = 1000020)
      AND  (JCASH.FLAG_COMMIT = 1)
      AND  (CASH.J_ID         = JCASH.ID)
      AND  (CASH.ACC_ID       = 3771)
    INTO   :ZALOG_RETSUMDEB; IF(:ZALOG_RETSUMDEB IS NULL)THEN ZALOG_RETSUMDEB = 0;

    ZALOG_RETSUMEND = :ZALOG_RETSUMBEG - :ZALOG_RETSUMDEB + :ZALOG_RETSUMKRED;

    SELECT SUM(ALL JCASH.DOCSUM)
    FROM    TABL$J_4 J, TABL$J_1000062 JZ, TABL$J_CHILDS JCORD, TABL$J_4 JORD
           ,TABL$J_CHILDS JCZ, TABL$J_4 JCASH, TABL$J_1000016 CASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000062)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  ((J.FILIAL_ID+0)= :FILIAL_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JZ.J_ID       = J.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZ.TMC_GROUP_ID||'~')
      AND  (JCORD.J_ID    = J.ID)
      AND  (JORD.ID       = JCORD.J_CHILD_ID)
      AND  (JORD.TYPE_ID  = 1000063)
      AND  (JCZ.J_ID          = JORD.ID)
      AND  (JCASH.ID          = JCZ.J_CHILD_ID)
      AND  (JCASH.TYPE_ID     = 1000020)
      AND  (JCASH.FLAG_COMMIT = 1)
      AND  (CASH.J_ID         = JCASH.ID)
      AND  (CASH.ACC_ID       = 373)
    INTO   :ZALOG_RETSUMPC;

    SUSPEND;
    END
END
