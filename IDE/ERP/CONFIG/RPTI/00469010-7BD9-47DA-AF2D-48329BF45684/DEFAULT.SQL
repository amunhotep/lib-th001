EXECUTE BLOCK (
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
   DATE_FROM              TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO                TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS               TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FIRM_ID                TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME              TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,PLACE_ID               TYPE OF COLUMN TABL$J_1000014.PLACE_ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_GROUP_PATH         TYPE OF COLUMN TABL$R_TMC_GROUP.PATH
  ,TMC_CTGR_ID            TYPE OF COLUMN TABL$R_TMC.TMC_CTGR_ID
  ,TMC_CTGR_NAME          TYPE OF COLUMN TABL$R_TMC_CTGR.NAME
  ,TMC_CTGR_PATH          TYPE OF COLUMN TABL$R_TMC_CTGR.PATH
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_NAME2              TYPE OF COLUMN TABL$R_TMC.NAME2
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_VEDCODE            TYPE OF COLUMN TABL$R_TMC.VEDCODE
  ,TMC_NUMSHOW            TYPE OF COLUMN TABL$R_TMC.NUMSHOW
  ,CS_ID                  TYPE OF COLUMN TABL$J_1000014.CS_ID
  ,CS_NAME                TYPE OF COLUMN TABL$R_CS.NAME
  ,WRK_ID                 TYPE OF COLUMN TABL$D_1000014.WRK_ID
  ,WRK_NAME               TYPE OF COLUMN TABL$R_WRK.NAME
  ,QUANT                  TYPE OF COLUMN TABL$D_1000014.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$D_1000014.QUANT
)AS
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR 
    SELECT J.FIRM_ID, J14.PLACE_ID, J14.CS_ID
          ,DB.TMC_ID, TMC.NAME, TMC.NAME2, TMC.ARTICLE, TMC.BARCODE, TMC.VEDCODE, TMC.NUMSHOW
          ,TMC.TMC_GROUP_ID, TMC.TMC_CTGR_ID, DB.WRK_ID
          ,SUM(DB.QUANT), SUM(IIF((DB.NDP < 0), ((DB.PRICE + DB.NDP) * DB.QUANT), (DB.PRICE * DB.QUANT)))
    FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$D_1000014 DB, TABL$R_TMC TMC
    WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.FLAG_COMMIT = 1)
      AND  (J.TYPE_ID = 1000028)
      AND  (J14.J_ID = J.ID)
      AND  (DB.J_ID = J.ID)
      AND  (TMC.ID = DB.TMC_ID)
    GROUP BY J.FIRM_ID, J14.PLACE_ID, J14.CS_ID
          ,DB.TMC_ID, TMC.NAME, TMC.NAME2, TMC.ARTICLE, TMC.BARCODE, TMC.VEDCODE, TMC.NUMSHOW
          ,TMC.TMC_GROUP_ID, TMC.TMC_CTGR_ID, DB.WRK_ID
    INTO   :FIRM_ID, :PLACE_ID, :CS_ID
          ,:TMC_ID, :TMC_NAME, :TMC_NAME2, :TMC_ARTICLE, :TMC_BARCODE, :TMC_VEDCODE, :TMC_NUMSHOW
          ,:TMC_GROUP_ID, :TMC_CTGR_ID, :WRK_ID
          ,:QUANT, :TOTAL
  DO
    BEGIN 
    SELECT FIRST 1 COALESCE(F.NAME,'') FROM TABL$R_FIRMS  F WHERE(F.ID = :FIRM_ID )INTO :FIRM_NAME;
    SELECT FIRST 1 COALESCE(P.NAME,'') FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME;
    SELECT FIRST 1 COALESCE(C.NAME,'') FROM TABL$R_CS     C WHERE(C.ID = :CS_ID   )INTO :CS_NAME;
    SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK    W WHERE(W.ID = :WRK_ID  )INTO :WRK_NAME;

    SELECT FIRST 1 COALESCE(C1.NAME,''), COALESCE(C1.PATH, '')
    FROM   TABL$R_TMC_CTGR C1
    WHERE  (C1.ID = :TMC_CTGR_ID)
    INTO   :TMC_CTGR_NAME, :TMC_CTGR_PATH;

    SELECT FIRST 1 TG.NAME, TG.PATH
    FROM   TABL$R_TMC_GROUP TG
    WHERE  (TG.ID = :TMC_GROUP_ID)
    INTO   :TMC_GROUP_NAME, :TMC_GROUP_PATH;

    SUSPEND; 
    END 
END
