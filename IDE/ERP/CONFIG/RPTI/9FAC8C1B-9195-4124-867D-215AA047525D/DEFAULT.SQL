EXECUTE BLOCK (
   Q_DATE_FROM  TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO    TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS   TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
  ,Q_FILIAL_IDS TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FILIAL_IDS
  ,Q_DELTA      TYPE OF COLUMN TABL$J_4.DOCSUM      = ?DELTA
  ,Q_HIDEZERO   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?HIDEZERO
)RETURNS(
   DATE_FROM  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO    TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS   TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FILIAL_IDS TYPE OF COLUMN TABL$J_4.DOCSTR
  ,DELTA      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMMIN     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMMAX     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMFROM    TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMTO      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JCNT       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JCSCNT     TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JSUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,JAVG       TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_PAYSCR_IDS TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  DATE_FROM  = :Q_DATE_FROM;
  DATE_TO    = :Q_DATE_TO;
  FIRM_IDS   = :Q_FIRM_IDS;
  FILIAL_IDS = :Q_FILIAL_IDS;
  DELTA      = :Q_DELTA;
  IF(:DELTA <= 0)THEN
    BEGIN
    EXCEPTION EXPT$_ERROR_00000 ASCII_CHAR(13)||ASCII_CHAR(10)||'  ØÀÃ ÄÎËÆÅÍ ÁÛÒÜ ÁÎËÜØÅ ÍÓËß !'; 
    EXIT;
    END
  SELECT '~'||LIST(PS.ID,'~')||'~'
  FROM   TABL$R_PAYSRC PS
  WHERE  (:FIRM_IDS   CONTAINING '~'||PS.FIRM_ID||'~')
    AND  (:FILIAL_IDS CONTAINING '~'||PS.FILIAL_ID||'~')
    AND  (PS.TYPE_ID = 2)
  INTO   :P_PAYSCR_IDS;

  SELECT MIN(P.PAYSRC_VALUE), MAX(P.PAYSRC_VALUE)
  FROM   TABL$P_PAYSRC_MOVE P
  WHERE  (P.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
    AND  (:FIRM_IDS CONTAINING '~'||P.FIRM_ID||'~')
    AND  (:P_PAYSCR_IDS CONTAINING '~'||P.PAYSRC_ID||'~')
    AND  (P.ACC_ID = 3771)
    AND  (P.FLAG_DEBET = 0)
  INTO   :SUMMIN, :SUMMAX;

  SUMFROM = 0;
  SUMTO   = :SUMFROM + :DELTA;
  WHILE(:SUMTO <= :SUMMAX)DO
    BEGIN
    JCNT = 0; JSUM = 0; JAVG = 0; JCSCNT = 0;
    SELECT COALESCE(COUNT(ALL P.J_ID),0), COALESCE(COUNT(DISTINCT P.SUBKONTO_ID),0)
          ,COALESCE(SUM(ALL P.PAYSRC_VALUE),0), COALESCE(AVG(ALL P.PAYSRC_VALUE),0)
    FROM   TABL$P_PAYSRC_MOVE P
    WHERE  (P.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (:FIRM_IDS CONTAINING '~'||P.FIRM_ID||'~')
      AND  (:P_PAYSCR_IDS CONTAINING '~'||P.PAYSRC_ID||'~')
      AND  (P.ACC_ID = 3771)
      AND  (P.FLAG_DEBET = 0)
      AND  (P.PAYSRC_VALUE > :SUMFROM)
      AND  (P.PAYSRC_VALUE <=:SUMTO  )
    INTO   :JCNT, :JCSCNT, :JSUM, :JAVG;
    IF(:Q_HIDEZERO = 1)THEN
      BEGIN
      IF(:JCNT > 0)THEN SUSPEND;
      END
     ELSE
      BEGIN
      SUSPEND;
      END
    SUMFROM = :SUMFROM + :DELTA;
    SUMTO   = :SUMFROM + :DELTA;
    END
END
