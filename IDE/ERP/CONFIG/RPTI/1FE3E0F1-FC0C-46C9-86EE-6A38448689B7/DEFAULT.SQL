EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
  DATE_FROM              TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO                TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS               TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_1000017_ID           TYPE OF COLUMN TABL$J_4.ID
 ,J_1000017_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_1000017_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,D17_SUBKONTO_ID        TYPE OF COLUMN TABL$D_1000017.SUBKONTO_ID
 ,D17_SUBKONTO_NAME      TYPE OF COLUMN TABL$D_1000017.SUBKONTO_NAME
 ,D17_PAYSUM             TYPE OF COLUMN TABL$D_1000017.PAYSUM
 ,D17_PAYSUMCLEAR        TYPE OF COLUMN TABL$D_1000017.PAYSUMCLEAR
 ,D17_PAYSUMNDP          TYPE OF COLUMN TABL$D_1000017.PAYSUMNDP
 ,J_REASON_ID            TYPE OF COLUMN TABL$D_1000017.J_REASON_ID
 ,J_REASON_TYPE_ID       TYPE OF COLUMN TABL$_TB_TYPES.ID
 ,J_REASON_TYPE_NAME     TYPE OF COLUMN TABL$_TB_TYPES.NAME
 ,J_REASON_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID
 ,J_REASON_DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_REASON_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,D14_TMC_ID             TYPE OF COLUMN TABL$D_1000014.TMC_ID
 ,D14_TMC_NAME           TYPE OF COLUMN TABL$R_TMC.NAME
 ,D14_TMC_ARTICLE        TYPE OF COLUMN TABL$R_TMC.ARTICLE
 ,D14_PRICE              TYPE OF COLUMN TABL$D_1000014.PRICE
 ,D14_QUANT              TYPE OF COLUMN TABL$D_1000014.QUANT
 ,D14_TOTAL              TYPE OF COLUMN TABL$D_1000014.TOTAL
 ,QUANT_ONDATE           TYPE OF COLUMN TABL$D_1000014.QUANT
 ,J_1000075_ID           TYPE OF COLUMN TABL$J_4.ID
 ,J_1000075_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_1000075_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,J_1000075_CS_ID        TYPE OF COLUMN TABL$J_1000014.CS_ID
 ,J_1000075_CS_NAME      TYPE OF COLUMN TABL$R_CS.NAME
 ,D75_PRICE              TYPE OF COLUMN TABL$D_1000014.PRICE
 ,D75_QUANT              TYPE OF COLUMN TABL$D_1000014.QUANT
 ,D75_TOTAL              TYPE OF COLUMN TABL$D_1000014.TOTAL
 ,DOHOD                  TYPE OF COLUMN TABL$D_1000014.TOTAL
)AS
BEGIN
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR 
    SELECT J.ID, J.DOCNUMBERSTR, J.DATE_COMMIT
          ,D17.SUBKONTO_ID, D17.SUBKONTO_NAME, D17.PAYSUM, D17.PAYSUMCLEAR, D17.PAYSUMNDP
          ,D17.J_REASON_ID, JR.TYPE_ID, TTJR.NAME2, JR.DOCNUMBERSTR
          ,JR.DATE_COMMIT, JR.FIRM_ID
    FROM   TABL$J_4 J, TABL$D_1000017 D17, TABL$J_4 JR, TABL$_TB_TYPES TTJR
    WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (J.TYPE_ID     = 1000017)
      AND  (J.FLAG_COMMIT = 1)
      AND  (:FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (D17.J_ID      = J.ID)
      AND  (D17.ACC_ID    = 631)
      AND  (JR.ID         = D17.J_REASON_ID)
      AND  (TTJR.ID       = JR.TYPE_ID)
    ORDER BY J.DATE_COMMIT, J.DOCNUMBERSTR  
    INTO   :J_1000017_ID, :J_1000017_DOCNUMBERSTR, :J_1000017_DATE_COMMIT
          ,:D17_SUBKONTO_ID, :D17_SUBKONTO_NAME, :D17_PAYSUM, :D17_PAYSUMCLEAR,:D17_PAYSUMNDP
          ,:J_REASON_ID, :J_REASON_TYPE_ID, :J_REASON_TYPE_NAME, :J_REASON_DOCNUMBERSTR
          ,:J_REASON_DATE_COMMIT, :J_REASON_FIRM_ID
  DO 
    FOR
      SELECT D14.TMC_ID, T.NAME, T.ARTICLE
            ,(IIF( D14.NDP<0, D14.PRICE + D14.NDP, D14.PRICE)) AS PRICE
      FROM   TABL$D_1000014 D14, TABL$R_TMC T
      WHERE  (D14.J_ID = :J_REASON_ID)
        AND  (T.ID     = D14.TMC_ID)
      INTO   :D14_TMC_ID, :D14_TMC_NAME, :D14_TMC_ARTICLE
            ,:D14_PRICE
    DO
      FOR
        SELECT J75.ID, J75.DOCNUMBERSTR, J75.DATE_COMMIT
              ,JJ75.CS_ID, CS.NAME
              ,(IIF( D75.NDP<0, D75.PRICE + D75.NDP, D75.PRICE)) AS PRICE
              ,D75.QUANT
        FROM   TABL$J_4 J75, TABL$J_1000014 JJ75, TABL$R_CS CS
              ,TABL$D_1000014 D75
        WHERE  (J75.DATE_COMMIT >= '01.11.2017 00:00:00')
--          AND  (J75.DATE_COMMIT <= :J_1000017_DATE_COMMIT)
          AND  (J75.TYPE_ID     IN (1000075, 1000136) )
          AND  ((J75.FIRM_ID+0) = :J_REASON_FIRM_ID)
          /*
          AND  (NOT(EXISTS(
                   SELECT J28.ID
                   FROM   TABL$J_CHILDS JC28, TABL$J_4 J28
                   WHERE  (JC28.J_ID       = J75.ID)
                     AND  (J28.ID          = JC28.J_CHILD_ID)
                     AND  (J28.TYPE_ID     = 1000028)
                     AND  (J28.FLAG_COMMIT = 1)
                     AND  (J28.DATE_COMMIT <= :J_1000017_DATE_COMMIT)
               )))
          */
          AND  (JJ75.J_ID       = J75.ID)
          AND  (    EXISTS(
                      SELECT JP171.ID
                      FROM   TABL$J_4 JP171
                      WHERE  (JP171.ID          = JJ75.J_PAY_ID)
--                        AND  (JP171.DATE_COMMIT <= :J_1000017_DATE_COMMIT)
                        AND  (JP171.DATE_COMMIT > '01.01.2018 00:00:00')
                        AND  (JP171.TYPE_ID     = 1000017)
                        AND  (JP171.FLAG_COMMIT = 1)
                    )
                 OR EXISTS(
                      SELECT DP17.ID
                      FROM   TABL$J_4 JP17, TABL$D_1000017 DP17
                      WHERE  (JP17.TYPE_ID     = 1000017)
--                        AND  (JP17.DATE_COMMIT <= :J_1000017_DATE_COMMIT)
                        AND  (JP17.DATE_COMMIT > '01.01.2018 00:00:00')
                        AND  (JP17.FLAG_COMMIT = 1)
                        AND  (DP17.J_ID        = JP17.ID)
                        AND  (DP17.J_REASON_ID = J75.ID)

                    )
               )
          AND  (CS.ID           = JJ75.CS_ID)
          AND  (D75.J_ID        = J75.ID)
          AND  (D75.TMC_ID      = :D14_TMC_ID)
        INTO   :J_1000075_ID, :J_1000075_DOCNUMBERSTR, :J_1000075_DATE_COMMIT
              ,:J_1000075_CS_ID, :J_1000075_CS_NAME
              ,:D75_PRICE, :D75_QUANT
      DO
        BEGIN
        D75_TOTAL = TRUNC( (:D75_QUANT * :D75_PRICE), 2);

        QUANT_ONDATE = 0;
        SELECT COALESCE( SUM(P.QUANT), 0)
        FROM   PROC$P_TMCQUANT_MOVESONDATE(:J_REASON_FIRM_ID, NULL, :D14_TMC_ID, :J_1000075_DATE_COMMIT) P
        INTO   :QUANT_ONDATE;

        IF(:QUANT_ONDATE < :D75_QUANT)THEN
          BEGIN
          D14_QUANT = :D75_QUANT - :QUANT_ONDATE;
          D14_TOTAL = TRUNC( (:D14_QUANT * :D14_PRICE), 2);
          DOHOD     = TRUNC( (:D14_QUANT * :D75_PRICE), 2) - :D14_TOTAL;
          SUSPEND; 
          END
          
        END
END
