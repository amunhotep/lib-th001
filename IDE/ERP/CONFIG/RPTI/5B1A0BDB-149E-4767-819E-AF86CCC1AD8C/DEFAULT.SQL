EXECUTE BLOCK (
  Q_DATE_FROM  TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO    TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS   TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
 ,Q_ACC_ID     TYPE OF COLUMN TABL$R_BUHG_ACCS.ID  = ?ACC_ID
 ,Q_FLAG       TYPE OF COLUMN TABL$J_4.FLAG_COMMIT = ?FLAG
)RETURNS ( 
   FLAG_COLOR          TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,DATE_FROM           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO             TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS            TYPE OF COLUMN TABL$J_4.DOCSTR
  ,ACC_ID              TYPE OF COLUMN TABL$R_BUHG_ACCS.ID
  ,ACC_NAME            TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
  ,CS_ID               TYPE OF COLUMN TABL$R_CS.ID
  ,CS_NAME             TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_INN              TYPE OF COLUMN TABL$R_CS.INN
  ,J_ID_ORD            TYPE OF COLUMN TABL$J_4.ID
  ,J_TYPE_ID_ORD       TYPE OF COLUMN TABL$J_4.TYPE_ID
  ,J_TYPE_NAME_ORD     TYPE OF COLUMN TABL$_TB_DOCS.NAME
  ,J_DOCNUMBERSTR_ORD  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_DATE_COMMIT_ORD   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_DOCSUM_ORD        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,J_DOCSUM_ORD_DIFF   TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOBEG            TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOBEG_DEB        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOBEG_KRD        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDO_DEBET         TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDO_KREDIT        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOEND            TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOEND_DEB        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOEND_KRD        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,SALDOENDDIFF        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALBEG            TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALBEG_DEB        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALBEG_KRD        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTAL_DEBET         TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTAL_KREDIT        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALEND            TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALEND_DEB        TYPE OF COLUMN TABL$P_CND.CND_VALUE
  ,TOTALEND_KRD        TYPE OF COLUMN TABL$P_CND.CND_VALUE
)AS
  DECLARE VARIABLE P_CS_ID TYPE OF COLUMN TABL$R_CS.ID; 
  DECLARE VARIABLE P_CNT   TYPE OF COLUMN TABL$R_CS.ID; 
  DECLARE VARIABLE P_CNTT  TYPE OF COLUMN TABL$R_CS.ID; 
BEGIN 
  FLAG_COLOR = 0;
  P_CS_ID    = -999999;
  DATE_FROM  = :Q_DATE_FROM;
  DATE_TO    = :Q_DATE_TO;
  FIRM_IDS   = :Q_FIRM_IDS;
  ACC_ID     = :Q_ACC_ID;
  SELECT FIRST 1 COALESCE(BA.NAME,'') FROM TABL$R_BUHG_ACCS BA WHERE (BA.ID = :ACC_ID)INTO :ACC_NAME;
  SALDOBEG     = 0; SALDOBEG_DEB = 0; SALDOBEG_KRD = 0; SALDO_DEBET  = 0;
  SALDOEND     = 0; SALDOEND_DEB = 0; SALDOEND_KRD = 0; SALDO_KREDIT = 0;
  TOTALBEG     = 0; TOTALBEG_DEB = 0; TOTALBEG_KRD = 0; TOTAL_DEBET  = 0;
  TOTALEND     = 0; TOTALEND_DEB = 0; TOTALEND_KRD = 0; TOTAL_KREDIT = 0;
  IF(:DATE_FROM > :DATE_TO)THEN BEGIN SUSPEND; EXIT; END 
  FOR 
    SELECT DISTINCT TMP.SUBKONTO_ID, TMP.J_ID_ORD
    FROM   ( 
            SELECT CK.SUBKONTO_ID_KRED AS SUBKONTO_ID, CK.J_ID_ORD_KRED AS J_ID_ORD
            FROM   TABL$P_CND CK 
            WHERE  (CK.DATE_COMMIT <= :DATE_TO) 
              AND  (:FIRM_IDS       CONTAINING '~'||CK.FIRM_ID||'~') 
              AND  (CK.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~') 
            UNION ALL 
            SELECT CD.SUBKONTO_ID_DEB AS SUBKONTO_ID , CD.J_ID_ORD_DEB AS J_ID_ORD
            FROM   TABL$P_CND CD 
            WHERE  (CD.DATE_COMMIT <= :DATE_TO) 
              AND  (:FIRM_IDS      CONTAINING '~'||CD.FIRM_ID||'~') 
              AND  (CD.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~') 
            )TMP 
    INTO   :CS_ID, :J_ID_ORD
  DO 
    BEGIN 
    SELECT FIRST 1 COALESCE(CS.NAME ,''), COALESCE(CS.INN,'') FROM TABL$R_CS CS WHERE(CS.ID = :CS_ID) INTO :CS_NAME, :CS_INN;
    J_TYPE_ID_ORD      = 0;
    J_TYPE_NAME_ORD    = '';
    J_DOCNUMBERSTR_ORD = '';
    J_DATE_COMMIT_ORD  = :DATE_FROM;
    J_DOCSUM_ORD       = 0;
    IF(:J_ID_ORD <> 0)THEN
      BEGIN
      SELECT FIRST 1 J.TYPE_ID, DD.NAME, J.DOCNUMBERSTR, J.DATE_COMMIT, J.DOCSUM
      FROM   TABL$J_4 J, TABL$_TB_DOCS DD
      WHERE  (J.ID  = :J_ID_ORD)
        AND  (DD.ID = J.TYPE_ID)
      INTO   :J_TYPE_ID_ORD, :J_TYPE_NAME_ORD, :J_DOCNUMBERSTR_ORD,:J_DATE_COMMIT_ORD, :J_DOCSUM_ORD;
      END

    SALDOBEG     = 0; SALDOBEG_DEB = 0; SALDOBEG_KRD = 0; SALDO_DEBET  = 0;
    SALDOEND     = 0; SALDOEND_DEB = 0; SALDOEND_KRD = 0; SALDO_KREDIT = 0;
    SELECT COALESCE(SUM(C.CND_VALUE),0) 
    FROM   TABL$P_CND C 
    WHERE  (C.DATE_COMMIT < :DATE_FROM) 
      AND  (:FIRM_IDS     CONTAINING '~'||C.FIRM_ID||'~')
      AND  (C.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~') 
      AND  (C.SUBKONTO_ID_DEB = :CS_ID)
      AND  (C.J_ID_ORD_DEB = :J_ID_ORD)
    INTO   :SALDOBEG_DEB;
    SELECT COALESCE(SUM(C.CND_VALUE),0) 
    FROM   TABL$P_CND C 
    WHERE  (C.DATE_COMMIT < :DATE_FROM) 
      AND  (:FIRM_IDS    CONTAINING '~'||C.FIRM_ID||'~') 
      AND  (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~') 
      AND  (C.SUBKONTO_ID_KRED = :CS_ID) 
      AND  (C.J_ID_ORD_KRED = :J_ID_ORD)
    INTO   :SALDOBEG_KRD;
    SALDOBEG = :SALDOBEG_DEB - :SALDOBEG_KRD; 
    SALDOBEG_DEB = 0; SALDOBEG_KRD = 0; 
    IF(:SALDOBEG < 0)THEN SALDOBEG_KRD = ABS(:SALDOBEG); ELSE SALDOBEG_DEB = :SALDOBEG;
    P_CNTT = 0; 
    P_CNT  = 0;
    SELECT COALESCE(SUM(C.CND_VALUE),0), COALESCE(COUNT(C.ID),0) 
    FROM  TABL$P_CND C 
    WHERE (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO) 
      AND (:FIRM_IDS     CONTAINING '~'||C.FIRM_ID||'~') 
      AND (C.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~') 
      AND (C.SUBKONTO_ID_DEB = :CS_ID) 
      AND (C.J_ID_ORD_DEB = :J_ID_ORD)
    INTO  :SALDO_DEBET, :P_CNT; 
    P_CNTT = :P_CNTT + :P_CNT;
    P_CNT  = 0;
    SELECT COALESCE(SUM(C.CND_VALUE),0), COALESCE(COUNT(C.ID),0) 
    FROM   TABL$P_CND C 
    WHERE (C.DATE_COMMIT  BETWEEN :DATE_FROM AND :DATE_TO) 
      AND (:FIRM_IDS      CONTAINING '~'||C.FIRM_ID||'~') 
      AND (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~') 
      AND (C.SUBKONTO_ID_KRED = :CS_ID) 
      AND (C.J_ID_ORD_KRED = :J_ID_ORD)
    INTO  :SALDO_KREDIT, :P_CNT;
    P_CNTT = :P_CNTT + :P_CNT;
    P_CNT  = 0;
    SALDOEND = :SALDOBEG + :SALDO_DEBET - :SALDO_KREDIT; 
    SALDOEND_DEB = 0; SALDOEND_KRD = 0; 
    IF(:SALDOEND < 0)THEN SALDOEND_KRD = ABS(:SALDOEND); ELSE SALDOEND_DEB = :SALDOEND; 
    SALDOENDDIFF = ABS(:SALDOEND) - ABS(:J_DOCSUM_ORD);
    
    J_DOCSUM_ORD_DIFF = 0;
    IF(:ACC_ID = 361)THEN J_DOCSUM_ORD_DIFF = :J_DOCSUM_ORD - :SALDOBEG_DEB - :SALDO_DEBET;
    IF(:ACC_ID = 631)THEN J_DOCSUM_ORD_DIFF = :J_DOCSUM_ORD - :SALDOBEG_KRD - :SALDO_KREDIT;

    IF(:P_CS_ID <> :CS_ID)THEN
      BEGIN
      IF(:FLAG_COLOR = 0)THEN FLAG_COLOR = 1; ELSE FLAG_COLOR = 0;
      P_CS_ID = :CS_ID;
      IF(:Q_FLAG = 0)THEN
        BEGIN
        TOTALBEG     = 0; TOTALBEG_DEB = 0; TOTALBEG_KRD = 0; TOTAL_DEBET  = 0;
        TOTALEND     = 0; TOTALEND_DEB = 0; TOTALEND_KRD = 0; TOTAL_KREDIT = 0;
        SELECT COALESCE(SUM(C.CND_VALUE),0) 
        FROM   TABL$P_CND C 
        WHERE  (C.DATE_COMMIT < :DATE_FROM) 
          AND  (:FIRM_IDS     CONTAINING '~'||C.FIRM_ID||'~')
          AND  (C.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~') 
          AND  (C.SUBKONTO_ID_DEB = :CS_ID)
        INTO   :TOTALBEG_DEB;
        SELECT COALESCE(SUM(C.CND_VALUE),0) 
        FROM   TABL$P_CND C 
        WHERE  (C.DATE_COMMIT < :DATE_FROM) 
          AND  (:FIRM_IDS    CONTAINING '~'||C.FIRM_ID||'~') 
          AND  (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~') 
          AND  (C.SUBKONTO_ID_KRED = :CS_ID) 
        INTO   :TOTALBEG_KRD;
        TOTALBEG = :TOTALBEG_DEB - :TOTALBEG_KRD; 
        TOTALBEG_DEB = 0; TOTALBEG_KRD = 0; 
        IF(:TOTALBEG < 0)THEN TOTALBEG_KRD = ABS(:TOTALBEG); ELSE TOTALBEG_DEB = :TOTALBEG; 
        SELECT COALESCE(SUM(C.CND_VALUE),0) 
        FROM  TABL$P_CND C 
        WHERE (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO) 
          AND (:FIRM_IDS     CONTAINING '~'||C.FIRM_ID||'~') 
          AND (C.ACC_IDS_DEB CONTAINING '~'||:ACC_ID||'~') 
          AND (C.SUBKONTO_ID_DEB = :CS_ID) 
        INTO  :TOTAL_DEBET;
        SELECT COALESCE(SUM(C.CND_VALUE),0) 
        FROM   TABL$P_CND C 
        WHERE (C.DATE_COMMIT  BETWEEN :DATE_FROM AND :DATE_TO) 
          AND (:FIRM_IDS      CONTAINING '~'||C.FIRM_ID||'~') 
          AND (C.ACC_IDS_KRED CONTAINING '~'||:ACC_ID||'~') 
          AND (C.SUBKONTO_ID_KRED = :CS_ID) 
        INTO  :TOTAL_KREDIT;
        TOTALEND = :TOTALBEG + :TOTAL_DEBET - :TOTAL_KREDIT; 
        TOTALEND_DEB = 0; TOTALEND_KRD = 0; 
        IF(:TOTALEND < 0)THEN TOTALEND_KRD = ABS(:TOTALEND); ELSE TOTALEND_DEB = :TOTALEND;
        END 
      END
    IF( (:SALDOBEG<>0) OR (:SALDO_DEBET<>0) OR (:SALDO_KREDIT<>0) OR (:SALDOEND<>0) OR (:P_CNTT <> 0) )THEN 
      SUSPEND;
    END
END
