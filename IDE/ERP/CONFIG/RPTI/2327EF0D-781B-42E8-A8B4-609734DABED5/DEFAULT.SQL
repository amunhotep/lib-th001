EXECUTE BLOCK (
  Q_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID      = ?FIRM_ID
 ,Q_DATE_FROM     TYPE OF COLUMN TABL$J_4.DATE_COMMIT  = ?DATE_FROM
 ,Q_DATE_TO       TYPE OF COLUMN TABL$J_4.DATE_COMMIT  = ?DATE_TO
 ,Q_DATE_RPT      TYPE OF COLUMN TABL$J_4.DATE_COMMIT  = ?DATE_RPT
 ,Q_FLAG_KRD      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  = ?FLAG_KRD
 ,Q_FLAG_QUOTER   TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  = ?FLAG_QUOTER
 ,Q_FLAG_O11      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  = ?FLAG_O11
 ,Q_FLAG_O12      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  = ?FLAG_O12
 ,Q_FLAG_O2X      TYPE OF COLUMN TABL$J_4.FLAG_COMMIT  = ?FLAG_O2X
 ,Q_REGNUM        TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR = ?REGNUM
)RETURNS(
  FIRM_ID         TYPE OF COLUMN TABL$J_4.FIRM_ID
 ,FIRM_NAME       TYPE OF COLUMN TABL$R_FIRMS.NAME
 ,DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_RPT        TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FLAG_KRD        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_QUOTER     TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O11        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O12        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,FLAG_O2X        TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,REGNUM          TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_ID            TYPE OF COLUMN TABL$J_4.ID
 ,J_IDS           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_FLAG_LOCK     TYPE OF COLUMN TABL$J_4.FLAG_LOCK
 ,J_CNTR          TYPE OF COLUMN TABL$J_4.ID
 ,J_TYPE_ID       TYPE OF COLUMN TABL$J_4.TYPE_ID
 ,J_TYP           TYPE OF COLUMN TABL$J_4.NAME
 ,J_DOCNUMBER     TYPE OF COLUMN TABL$J_4.DOCNUMBER
 ,J_DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,J_DOCNUMBERIN   TYPE OF COLUMN TABL$J_4.DOCSTR
 ,J_DATE_IN       TYPE OF COLUMN TABL$J_4.DATE_IN
 ,J_CS_ID         TYPE OF COLUMN TABL$J_1000014.CS_ID
 ,J_CS_NAME       TYPE OF COLUMN TABL$R_CS.NAME
 ,J_CS_NAME2      TYPE OF COLUMN TABL$R_CS.NAME2
 ,J_CS_INN        TYPE OF COLUMN TABL$R_CS.INN
 ,J_P_SUM         TYPE OF COLUMN TABL$J_1000014.P_SUM
 ,J_P_NDP         TYPE OF COLUMN TABL$J_1000014.P_NDP
 ,J_P_SUMNDP      TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
 ,J_P_SUMS        TYPE OF COLUMN TABL$J_1000014.P_SUM
 ,J_P_NDPS        TYPE OF COLUMN TABL$J_1000014.P_NDP
 ,J_P_SUMNDPS     TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
 ,J_FLAG_PNP02    TYPE OF COLUMN TABL$J_1000014.FLAG_PNP02
)AS
  DECLARE VARIABLE P_TYPES TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DUMMY TYPE OF COLUMN TABL$J_4.NAME;
BEGIN
  FIRM_ID     = :Q_FIRM_ID;
  DATE_FROM   = :Q_DATE_FROM;
  DATE_TO     = :Q_DATE_TO;
  DATE_RPT    = :Q_DATE_RPT;
  FLAG_KRD    = :Q_FLAG_KRD;
  FLAG_QUOTER = :Q_FLAG_QUOTER;
  FLAG_O11    = :Q_FLAG_O11;
  FLAG_O12    = :Q_FLAG_O12;
  FLAG_O2X    = :Q_FLAG_O2X;
  REGNUM      = :Q_REGNUM;
  
  J_FLAG_LOCK    = 0;
  J_ID           = 0;
  J_FLAG_LOCK    = 0;
  J_TYPE_ID      = 4;
  J_DOCNUMBER    = '';
  J_DOCNUMBERSTR = '';
  J_DATE_COMMIT  = NULL;
  J_DOCNUMBERIN  = NULL;
  J_DATE_IN      = NULL;
  J_CS_ID        = 0;
  J_P_SUM        = 0;
  J_P_NDP        = 0;
  J_P_SUMNDP     = 0;
  J_FLAG_PNP02   = 0;
  
  SELECT FIRST 1 F.NAME FROM TABL$R_FIRMS F WHERE (F.ID = :FIRM_ID) INTO :FIRM_NAME;
  IF(:FLAG_KRD = 1)THEN
    P_TYPES = '~1000131~1000134~';
   ELSE
    P_TYPES = '~1000132~1000133~';

  SELECT COALESCE(SUM(TMP.P_SUM),0), COALESCE(SUM(TMP.P_NDP),0), COALESCE(SUM(TMP.P_SUMNDP),0)
  FROM   (SELECT IIF(J.TYPE_ID>1000132, ROUND((-1)*J14.P_SUM   ,2), ROUND(J14.P_SUM   ,2)) AS P_SUM
                ,IIF(J.TYPE_ID>1000132, ROUND((-1)*J14.P_NDP   ,2), ROUND(J14.P_NDP   ,2)) AS P_NDP
                ,IIF(J.TYPE_ID>1000132, ROUND((-1)*J14.P_SUMNDP,2), ROUND(J14.P_SUMNDP,2)) AS P_SUMNDP
          FROM   TABL$J_4 J, TABL$J_1000014 J14
          WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
            AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
            AND  (J.FLAG_COMMIT = 1)
            AND  ((J.FIRM_ID+0) = :FIRM_ID)
            AND  (J14.J_ID = J.ID)
         )TMP  
  INTO   :J_P_SUMS, :J_P_NDPS, :J_P_SUMNDPS;

  J_CNTR = 0;
  IF(:FLAG_KRD = 1)THEN
    BEGIN
    FOR
      SELECT ( LPAD(EXTRACT(YEAR FROM J.DATE_COMMIT),4,'0')||LPAD(EXTRACT(MONTH FROM J.DATE_COMMIT),2,'0')||LPAD(EXTRACT(DAY FROM J.DATE_COMMIT),2,'0') ) AS DATEORDER
            ,J.ID, J.FLAG_LOCK, J.TYPE_ID, J.DOCNUMBER, J.DOCNUMBERSTR, J.DATE_COMMIT, J.DOCNUMBERIN, J.DATE_IN
            ,J14.CS_ID, J14.P_SUM, J14.P_NDP, J14.P_SUMNDP, J14.FLAG_PNP02
      FROM   TABL$J_4 J, TABL$J_1000014 J14
      WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
        AND  (J.FLAG_COMMIT = 1)
        AND  ((J.FIRM_ID+0) = :FIRM_ID)
        AND  (J14.J_ID = J.ID)
      ORDER BY DATEORDER, J.TYPE_ID, J.DOCNUMBERSTR 
      INTO   :P_DUMMY
            ,:J_ID, :J_FLAG_LOCK, :J_TYPE_ID, :J_DOCNUMBER, :J_DOCNUMBERSTR, :J_DATE_COMMIT, :J_DOCNUMBERIN, :J_DATE_IN
            ,:J_CS_ID, :J_P_SUM, :J_P_NDP, :J_P_SUMNDP, :J_FLAG_PNP02
    DO
      BEGIN
      J_P_SUM    = ROUND(:J_P_SUM   ,2);
      J_P_NDP    = ROUND(:J_P_NDP   ,2);
      J_P_SUMNDP = ROUND(:J_P_SUMNDP,2);
      J_IDS      = '~'||:J_ID||'~';
      J_CS_NAME  = '';
      J_CS_NAME2 = '';
      J_CS_INN   = '';
      SELECT FIRST 1 C.NAME, C.NAME2, C.INN
      FROM   TABL$R_CS C
      WHERE  (C.ID = :J_CS_ID)
      INTO   :J_CS_NAME, :J_CS_NAME2, :J_CS_INN;
      J_TYP = '';
           IF(:J_TYPE_ID IN (1000131,1000132) )THEN 
             BEGIN
             J_TYP      = 'ПHП';
             END
      ELSE IF(:J_TYPE_ID IN (1000133,1000134) )THEN 
             BEGIN
             J_TYP      = 'PKП';
             J_P_SUM    = (-1) * :J_P_SUM;
             J_P_NDP    = (-1) * :J_P_NDP;
             J_P_SUMNDP = (-1) * :J_P_SUMNDP;
             END
  
      IF(:J_FLAG_PNP02 = 1)THEN
        BEGIN
        J_CS_NAME  = 'Kiнцевий покупець';
        J_CS_NAME2 = 'Kiнцевий покупець';
        IF(:J_TYPE_ID IN (1000131,1000132) )THEN J_TYP = '0ПHП2';
        END
  
      J_CNTR = :J_CNTR + 1;
      SUSPEND;
      END
    END
   ELSE
    BEGIN
    FOR
      SELECT ( LPAD(EXTRACT(YEAR FROM J.DATE_IN),4,'0')||LPAD(EXTRACT(MONTH FROM J.DATE_IN),2,'0')||LPAD(EXTRACT(DAY FROM J.DATE_IN),2,'0') ) AS DATEORDER
            ,J.TYPE_ID, J.DOCNUMBERIN, J.DATE_IN, J14.CS_ID
            ,(LPAD(EXTRACT(DAY FROM J.DATE_COMMIT),2,'0')||'.'||LPAD(EXTRACT(MONTH FROM J.DATE_COMMIT),2,'0')||'.'||LPAD(EXTRACT(YEAR FROM J.DATE_COMMIT),4,'0')||' 00:00:00') AS DATE_COMMIT
            ,'~'||LIST(J.ID,'~')||'~', '~'||LIST(J.DOCNUMBERSTR,'~')||'~'
            ,COALESCE(SUM(J14.P_SUM),0), COALESCE(SUM(J14.P_NDP),0), COALESCE(SUM(J14.P_SUMNDP),0)
            ,COALESCE(SUM(J14.FLAG_PNP02),0)
      FROM   TABL$J_4 J, TABL$J_1000014 J14
      WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
        AND  (:P_TYPES CONTAINING '~'||J.TYPE_ID||'~')
        AND  (J.FLAG_COMMIT = 1)
        AND  ((J.FIRM_ID+0) = :FIRM_ID)
        AND  (J14.J_ID = J.ID)
      GROUP BY DATEORDER, J.TYPE_ID, J.DOCNUMBERIN, J.DATE_IN, J14.CS_ID, DATE_COMMIT 
      INTO   :P_DUMMY
            ,:J_TYPE_ID, :J_DOCNUMBERIN, :J_DATE_IN, :J_CS_ID 
            ,:J_DATE_COMMIT
            ,:J_IDS, :J_DOCNUMBERSTR
            ,:J_P_SUM, :J_P_NDP, :J_P_SUMNDP
            ,:J_FLAG_PNP02
    DO
      BEGIN
      J_P_SUM    = ROUND(:J_P_SUM   ,2);
      J_P_NDP    = ROUND(:J_P_NDP   ,2);
      J_P_SUMNDP = ROUND(:J_P_SUMNDP,2);

      J_CS_NAME  = '';
      J_CS_NAME2 = '';
      J_CS_INN   = '';
      SELECT FIRST 1 C.NAME, C.NAME2, C.INN
      FROM   TABL$R_CS C
      WHERE  (C.ID = :J_CS_ID)
      INTO   :J_CS_NAME, :J_CS_NAME2, :J_CS_INN;
      J_TYP = '';
           IF(:J_TYPE_ID IN (1000131,1000132) )THEN 
             BEGIN
             J_TYP      = 'ПHП';
             END
      ELSE IF(:J_TYPE_ID IN (1000133,1000134) )THEN 
             BEGIN
             J_TYP      = 'PKП';
             J_P_SUM    = (-1) * :J_P_SUM;
             J_P_NDP    = (-1) * :J_P_NDP;
             J_P_SUMNDP = (-1) * :J_P_SUMNDP;
             END
  
      IF(:J_FLAG_PNP02 = 1)THEN
        BEGIN
        J_CS_NAME  = 'Kiнцевий покупець';
        J_CS_NAME2 = 'Kiнцевий покупець';
        IF(:J_TYPE_ID IN (1000131,1000132) )THEN J_TYP = '0ПHП2';
        END
  
      J_CNTR = :J_CNTR + 1;
      SUSPEND;
      END
    END   
END
