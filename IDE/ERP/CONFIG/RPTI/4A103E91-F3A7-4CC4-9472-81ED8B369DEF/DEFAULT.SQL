EXECUTE BLOCK(
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS(
   DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS        TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FILIAL_ID       TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME     TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,S3771BEG        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S3771DEB        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S3771KRD        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,S3771END        TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
  DECLARE VARIABLE P_DEB TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_KRD TYPE OF COLUMN TABL$J_4.DOCSUM;
BEGIN
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR
    SELECT F.ID, F.NAME
    FROM   TABL$R_FILIALS F
    WHERE  (F.FLAG_DELETE = 0)
    ORDER BY F.ID
    INTO   :FILIAL_ID, :FILIAL_NAME
  DO
    BEGIN
    S3771BEG = 0; S3771DEB  = 0; S3771KRD  = 0; S3771END = 0;

    P_DEB = 0; P_KRD = 0;
    SELECT COALESCE(SUM(C.CND_VALUE),0)
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT < :DATE_FROM)
      AND  (C.ACC_ID_DEB = 3771)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  ((C.FILIAL_ID+0) = :FILIAL_ID)
    INTO   :P_DEB;
    SELECT COALESCE(SUM(C.CND_VALUE),0)
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT < :DATE_FROM)
      AND  (C.ACC_ID_KRED = 3771)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  ((C.FILIAL_ID+0) = :FILIAL_ID)
    INTO   :P_KRD;
    S3771BEG = :P_DEB - :P_KRD;
    SELECT COALESCE(SUM(C.CND_VALUE),0)
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (C.ACC_ID_DEB = 3771)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  ((C.FILIAL_ID+0) = :FILIAL_ID)
    INTO   :S3771DEB;
    SELECT COALESCE(SUM(C.CND_VALUE),0)
    FROM   TABL$P_CND C
    WHERE  (C.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (C.ACC_ID_KRED = 3771)
      AND  (:FIRM_IDS CONTAINING '~'||C.FIRM_ID||'~')
      AND  ((C.FILIAL_ID+0) = :FILIAL_ID)
    INTO   :S3771KRD;
    S3771END = :S3771BEG + :S3771DEB - :S3771KRD;
    SUSPEND;
    END
END
