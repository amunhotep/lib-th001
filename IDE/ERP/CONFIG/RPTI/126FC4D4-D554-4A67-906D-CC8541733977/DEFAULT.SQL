EXECUTE BLOCK (
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
   DATE_FROM              TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO                TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FIRM_IDS               TYPE OF COLUMN TABL$J_4.DOCSTR
  ,FIRM_ID                TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME              TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,PLACE_ID               TYPE OF COLUMN TABL$J_1000014.PLACE_ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,TMC_CTGR_ID            TYPE OF COLUMN TABL$R_TMC.TMC_CTGR_ID
  ,TMC_CTGR_NAME          TYPE OF COLUMN TABL$R_TMC_CTGR.NAME
  ,TMC_CTGR_PATH          TYPE OF COLUMN TABL$R_TMC_CTGR.PATH
  ,QUANT                  TYPE OF COLUMN TABL$D_1000014.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$D_1000014.QUANT
)AS
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR 
    SELECT J.FIRM_ID, J14.PLACE_ID, TMC.TMC_CTGR_ID
          ,SUM(DB.QUANT), SUM(IIF((DB.NDP < 0), ((DB.PRICE + DB.NDP) * DB.QUANT), (DB.PRICE * DB.QUANT)))
    FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$D_1000014 DB, TABL$R_TMC TMC
    WHERE  (J.DATE_COMMIT BETWEEN :DATE_FROM AND :DATE_TO)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.FLAG_COMMIT = 1)
      AND  (J.TYPE_ID = 1000028)
      AND  (J14.J_ID = J.ID)
      AND  (DB.J_ID = J.ID)
      AND  (TMC.ID = DB.TMC_ID)
    GROUP BY J.FIRM_ID, J14.PLACE_ID, TMC.TMC_CTGR_ID
    INTO   :FIRM_ID, :PLACE_ID, :TMC_CTGR_ID
          ,:QUANT, :TOTAL
  DO
    BEGIN 
    SELECT FIRST 1 COALESCE(F.NAME,'') FROM TABL$R_FIRMS  F WHERE(F.ID = :FIRM_ID )INTO :FIRM_NAME;
    SELECT FIRST 1 COALESCE(P.NAME,'') FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME;

    SELECT FIRST 1 COALESCE(C1.NAME,''), COALESCE(C1.PATH, '')
    FROM   TABL$R_TMC_CTGR C1
    WHERE  (C1.ID = :TMC_CTGR_ID)
    INTO   :TMC_CTGR_NAME, :TMC_CTGR_PATH;

    SUSPEND; 
    END 
END
