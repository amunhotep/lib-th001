EXECUTE BLOCK (
  Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
 ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
 ,Q_FIRM_IDS  TYPE OF COLUMN TABL$J_4.DOCSTR      = ?FIRM_IDS
)RETURNS ( 
  DATE_FROM          TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DATE_TO            TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,FIRM_IDS           TYPE OF COLUMN TABL$J_4.DOCSTR
 ,FILIAL_ID          TYPE OF COLUMN TABL$R_FILIALS.ID
 ,FILIAL_NAME        TYPE OF COLUMN TABL$R_FILIALS.NAME
 ,FILIAL_ADDRESS     TYPE OF COLUMN TABL$R_FILIALS.ADDRESS
 ,JZ_CNT             TYPE OF COLUMN TABL$J_4.ID
 ,JZ_SUM             TYPE OF COLUMN TABL$J_4.DOCSUM
 ,JZ_TMC_CNT         TYPE OF COLUMN TABL$R_TMC.ID
 ,JZ_TMC_MASSA       TYPE OF COLUMN TABL$R_TMC.MASSA
 ,JZ_TMC_MASSA_INS   TYPE OF COLUMN TABL$R_TMC.MASSA
 ,JZ_TMC_MASSA_NETTO TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
 ,JC_SUM_BODY        TYPE OF COLUMN TABL$J_4.DOCSUM
 ,JC_SUM_PC          TYPE OF COLUMN TABL$J_4.DOCSUM
 ,JC_SUM_TOTAL       TYPE OF COLUMN TABL$J_4.DOCSUM
 ,SUM_DIFF           TYPE OF COLUMN TABL$J_4.DOCSUM
 ,JB_SUM             TYPE OF COLUMN TABL$J_4.DOCSUM
 ,JB_SUM_DIFF        TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
BEGIN 
  DATE_FROM = :Q_DATE_FROM;
  DATE_TO   = :Q_DATE_TO;
  FIRM_IDS  = :Q_FIRM_IDS;
  FOR 
    SELECT FL.ID, FL.NAME, FL.ADDRESS
    FROM   TABL$R_FILIALS FL 
    WHERE  (FL.FLAG_DELETE = 0)
    ORDER BY FL.ID
    INTO   :FILIAL_ID, :FILIAL_NAME, :FILIAL_ADDRESS
  DO 
    BEGIN 
    SUM_DIFF = 0;
    JB_SUM_DIFF = 0;
    SELECT COALESCE(COUNT(DISTINCT TMP.J_ID),0)
          ,COALESCE(SUM(TMP.TMC_CNT),0), COALESCE(SUM(TMP.TMC_SUM),0)
          ,COALESCE(SUM(TMP.TMC_MASSA),0), COALESCE(SUM(TMP.TMC_MASSA_NETTO),0)
          ,COALESCE(SUM(TMP.JB_SUM),0)
    FROM   (SELECT J.ID AS J_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
                  ,(D14.QUANT                  ) AS TMC_CNT
                  ,(D14.QUANT * D14.PRICE      ) AS TMC_SUM
                  ,(D14.QUANT * TMC.MASSA      ) AS TMC_MASSA
                  ,(D14.QUANT * TMC.MASSA_NETTO) AS TMC_MASSA_NETTO
                  ,(SELECT SUM(QM.PRICE_TMC * QM.QUANT)
                    FROM   TABL$P_TMC_QUANT_MOVE QM
                    WHERE  (QM.TMC_ID = D14.TMC_ID)
                      AND  ((QM.PLACE_ID+0) = J14.TO_PLACE_ID)
                      AND  (:Q_FIRM_IDS CONTAINING '~'||QM.FIRM_ID||'~')
                      AND  (QM.FLAG_DEBET = 0)
                    )AS JB_SUM
            FROM   TABL$J_4 J, TABL$J_1000014 J14, TABL$D_1000014 D14, TABL$R_TMC TMC
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000024)
              AND  (J.FLAG_COMMIT = 1)
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (J14.J_ID = J.ID)
              AND  (D14.J_ID = J.ID)
              AND  (TMC.ID = D14.TMC_ID)
           ) TMP
    WHERE  (TMP.JZ_ID <> 0)
    INTO   :JZ_CNT, :JZ_TMC_CNT, :JZ_SUM, :JZ_TMC_MASSA, :JZ_TMC_MASSA_NETTO, :JB_SUM;
    JZ_TMC_MASSA_INS = :JZ_TMC_MASSA - :JZ_TMC_MASSA_NETTO;

    SELECT COALESCE(SUM(TMP.DOCSUM),0)
    FROM   (SELECT J.DOCSUM, J.FIRM_ID AS JC_FIRM_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
            FROM   TABL$J_4 J, TABL$J_1000016 JCASH
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000021)
              AND  (J.FLAG_COMMIT = 1)
              AND  (J.NAME CONTAINING '“≈À¿')
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (JCASH.J_ID = J.ID)
              AND  (JCASH.ACC_ID = 301)
            ) TMP, TABL$J_4 JZ
    WHERE  (JZ.ID = TMP.JZ_ID)
      AND  (JZ.FIRM_ID <> JC_FIRM_ID)
    INTO   :JC_SUM_BODY;

    SELECT COALESCE(SUM(TMP.DOCSUM),0)
    FROM   (SELECT J.DOCSUM, J.FIRM_ID AS JC_FIRM_ID
                  ,(SELECT FIRST 1 P.J_ID FROM PROC$D_GET_4_ROOT(J.ID, 1000062) P) AS JZ_ID
            FROM   TABL$J_4 J, TABL$J_1000016 JCASH
            WHERE  (J.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
              AND  (J.TYPE_ID = 1000021)
              AND  (J.FLAG_COMMIT = 1)
              AND  (J.NAME CONTAINING 'œ–Œ÷≈Õ“Œ¬')
              AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
              AND  (J.FILIAL_ID = :FILIAL_ID)
              AND  (JCASH.J_ID = J.ID)
              AND  (JCASH.ACC_ID = 301)
            ) TMP, TABL$J_4 JZ
    WHERE  (JZ.ID = TMP.JZ_ID)
      AND  (JZ.FIRM_ID <> TMP.JC_FIRM_ID)
    INTO   :JC_SUM_PC;
    JC_SUM_TOTAL = :JC_SUM_BODY + :JC_SUM_PC;

    SUM_DIFF    = :JZ_SUM - :JC_SUM_TOTAL;
    JB_SUM_DIFF = :JB_SUM - :JC_SUM_TOTAL;
    SUSPEND;
    END 
END
