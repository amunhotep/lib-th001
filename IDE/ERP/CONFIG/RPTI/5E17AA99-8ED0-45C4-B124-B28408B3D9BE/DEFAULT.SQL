EXECUTE BLOCK (
   Q_FIRM_IDS      DOMN$BLOB_TEXT                      = ?FIRM_IDS
  ,Q_TMC_GROUP_IDS DOMN$BLOB_TEXT                      = ?TMC_GROUP_IDS
  ,Q_DATEFROM      TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATETO        TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
)RETURNS (
   DATEFROM             TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATETO               TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,USER_ID              TYPE OF COLUMN TABL$_USERS.ID
  ,USER_NAME            TYPE OF COLUMN TABL$_USERS.NAME
  ,NEV_CNT              TYPE OF COLUMN TABL$J_4.ID
  ,NEV_CS               TYPE OF COLUMN TABL$J_4.ID
  ,NEV_SUMCALC          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_SUMCALCB         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_SUM1             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_SUM2             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_SUM3             TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_RETBODY          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_RETPC            TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_RETTOTAL         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,NEV_SUMLEFT          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TMC_MASSA            TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_QUANT      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_SALED      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_PRICE            TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_PRICE1G          TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA9999        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO9999  TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA585         TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO585   TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
)AS
BEGIN
  DATEFROM = :Q_DATEFROM;
  DATETO   = :Q_DATETO;
  FOR
    SELECT DISTINCT J.USER_ID, (SELECT FIRST 1 COALESCE(W.NAME, J.USER_ID) FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID))
    FROM   TABL$J_4 J
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
    INTO   :USER_ID, :USER_NAME
  DO
    BEGIN
    SELECT COUNT(DISTINCT J.ID), COUNT(DISTINCT JZALOG.CS_ID), SUM(ALL JZALOG.DOCSUMCALC)
           ,SUM(ALL JZALOG.DOCSUMCALCBEGIN), SUM(ALL JZALOG.DOCSUMLEFT), SUM(ALL JZ.DOCSUM)
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.USER_ID     = :USER_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
      AND  (JZALOG.DAYSCNT <= 0)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZALOG.TMC_GROUP_ID||'~')
    INTO   :NEV_CNT, :NEV_CS, :NEV_SUMCALC, :NEV_SUMCALCB, :NEV_SUMLEFT, :NEV_SUM1;

    SELECT SUM(ALL CJ.DOCSUM)
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG,
           TABL$J_CHILDS CJC, TABL$J_4 CJ, TABL$J_1000016 CCASH
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.USER_ID     = :USER_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZALOG.TMC_GROUP_ID||'~')
      AND  (JZALOG.DAYSCNT <= 0)
      AND  (CJC.J_ID = JZ.ID)
      AND  (CJ.ID = CJC.J_CHILD_ID)
      AND  (CJ.TYPE_ID = 1000021)
      AND  (CJ.FLAG_COMMIT = 1)
      AND  (CCASH.J_ID = CJ.ID)
      AND  (CCASH.ACC_ID = 3771)
    INTO   :NEV_SUM3;

    NEV_SUM2 = :NEV_SUM3 - :NEV_SUM1;

    SELECT SUM(ORD.DOCSUM), SUM(ORDDET.PCSUM)
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG
          ,TABL$J_CHILDS JCHLD, TABL$J_4 ORD, TABL$J_1000063 ORDDET
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.USER_ID     = :USER_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZALOG.TMC_GROUP_ID||'~')
      AND  (JZALOG.DAYSCNT <= 0)
      AND  (JCHLD.J_ID = JZ.ID)
      AND  (ORD.ID = JCHLD.J_CHILD_ID)
      AND  (ORD.TYPE_ID = 1000063)
      AND  (ORD.FLAG_COMMIT = 1)
      AND  (ORDDET.J_ID = ORD.ID)
    INTO   :NEV_RETTOTAL, :NEV_RETPC;
    NEV_RETBODY = :NEV_RETTOTAL - :NEV_RETPC;

    SELECT  SUM(D.QUANT * TMC.MASSA) AS TMC_MASSA
           ,SUM(D.QUANT * TMC.MASSA_NETTO) AS TMC_MASSA_NETTO
           ,SUM(D.QUANT * TMC.MASSA_NETTO * CE.KURS) AS TMC_PRICE
           ,SUM(D.QUANT * TMC.MASSA * CAST(TMC.PROBE AS INTEGER) / 585) AS TMC_MASSA_585
           ,SUM(D.QUANT * TMC.MASSA_NETTO * CAST(TMC.PROBE AS INTEGER) / 585) AS TMC_MASSA_NETTO_585
           ,SUM(D.QUANT * TMC.MASSA * CAST(TMC.PROBE AS INTEGER) / 999.9) AS TMC_MASSA_9999
           ,SUM(D.QUANT * TMC.MASSA_NETTO * CAST(TMC.PROBE AS INTEGER) / 999.9) AS TMC_MASSA_NETTO_9999
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG, TABL$J_CHILDS JC62, TABL$J_4 J66
          ,TABL$D_1000014 D, TABL$R_TMC TMC, TABL$R_COUNTRIESEX CE
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.USER_ID     = :USER_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZALOG.TMC_GROUP_ID||'~')
      AND  (JZALOG.DAYSCNT <= 0)
      AND  (JC62.J_ID = JC.J_ID)
      AND  (J66.ID = JC62.J_CHILD_ID)
      AND  (J66.TYPE_ID = 1000066)
      AND  (D.J_ID = J66.ID)
      AND  (TMC.ID = D.TMC_ID)
      AND  (CE.COUNTRY_ID = TMC.COUNTRY_ID)
      AND  (CE.NAME = TMC.PROBE)
      AND  (CE.COUNTRIESTP_ID = 0)
    INTO   :TMC_MASSA, :TMC_MASSA_NETTO, :TMC_PRICE, :TMC_MASSA585, :TMC_MASSA_NETTO585,
           :TMC_MASSA9999, :TMC_MASSA_NETTO9999;

    SELECT SUM(D68.QUANT * TMC.MASSA_NETTO) AS TMC_MASSA_QUANT
    FROM   TABL$J_4 J, TABL$J_CHILDS JC, TABL$J_4 JZ, TABL$J_1000062 JZALOG, TABL$J_CHILDS JC62, TABL$J_4 J66
          ,TABL$D_1000014 D, TABL$D_1000014 D68, TABL$J_4 J68, TABL$R_TMC TMC
    WHERE  (J.DATE_COMMIT >= :Q_DATEFROM)
      AND  (J.DATE_COMMIT <  :Q_DATETO)
      AND  (J.TYPE_ID     = 1000066)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J.FIRM_ID||'~')
      AND  (J.USER_ID     = :USER_ID)
      AND  (J.FLAG_COMMIT = 1)
      AND  (JC.J_CHILD_ID = J.ID)
      AND  (JZ.ID = JC.J_ID)
      AND  (JZ.TYPE_ID = 1000062)
      AND  (JZALOG.J_ID = JZ.ID)
      AND  (:Q_TMC_GROUP_IDS CONTAINING '~'||JZALOG.TMC_GROUP_ID||'~')
      AND  (JZALOG.DAYSCNT <= 0)
      AND  (JC62.J_ID = JC.J_ID)
      AND  (J66.ID = JC62.J_CHILD_ID)
      AND  (J66.TYPE_ID = 1000066)
      AND  (D.J_ID = J66.ID)
      AND  (D68.TMC_ID = D.TMC_ID)
      AND  (J68.ID = D68.J_ID)
      AND  (J68.FLAG_COMMIT = 1)
      AND  (J68.TYPE_ID = 1000068)
      AND  (TMC.ID = D68.TMC_ID)    
    INTO   :TMC_MASSA_SALED; IF(:TMC_MASSA_SALED IS NULL)THEN TMC_MASSA_SALED = 0;
    
    TMC_MASSA_QUANT = :TMC_MASSA_NETTO - :TMC_MASSA_SALED;
    TMC_PRICE1G = 0; 
    IF(:TMC_MASSA_NETTO <> 0)THEN
      TMC_PRICE1G = :TMC_PRICE / :TMC_MASSA_NETTO;  
    SUSPEND;
    END
END
