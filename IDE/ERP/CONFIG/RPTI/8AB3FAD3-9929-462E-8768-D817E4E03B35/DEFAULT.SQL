EXECUTE BLOCK(
   Q_DATE_FROM TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_FROM
  ,Q_DATE_TO   TYPE OF COLUMN TABL$J_4.DATE_COMMIT = ?DATE_TO
  ,Q_FIRM_IDS  DOMN$BLOB_TEXT                      = ?FIRM_IDS
)RETURNS(
   DATE_FROM       TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DATE_TO         TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,FILIAL_ID       TYPE OF COLUMN TABL$R_FILIALS.ID
  ,FILIAL_NAME     TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,SUMSALES        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,QUANTSALES      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,QUANTCS         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMSEB          TYPE OF COLUMN TABL$J_4.DOCSUM
  ,SUMGESHEFT      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,PCGESHEFT       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,PCGESHEFT_      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TMC_QUANT       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TMC_MASSA       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TMC_MASSA_INS   TYPE OF COLUMN TABL$J_4.DOCSUM
  ,TMC_MASSA_NETTO TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P661_SUM        TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P91_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P92_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P93_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6414_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6416_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P6852_SUM       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,P03_SUM         TYPE OF COLUMN TABL$J_4.DOCSUM
  ,PTOTAL_SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_SUM      TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_PC       TYPE OF COLUMN TABL$J_4.DOCSUM
  ,RESULT_PC_      TYPE OF COLUMN TABL$J_4.DOCSUM
)AS
BEGIN
  DATE_FROM  = :Q_DATE_FROM;
  DATE_TO    = :Q_DATE_TO;
  SUMSALES   = 0;
  SUMSEB     = 0;
  SUMGESHEFT = 0;
  PTOTAL_SUM = 0;
  RESULT_SUM = 0;
  RESULT_PC_ = 0;
  SELECT COALESCE(SUM(ALL J4.DOCSUM),0)
  FROM   TABL$J_4 J4, TABL$J_1000014 J14
  WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
    AND  (J4.TYPE_ID = 1000028)
    AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
    AND  (J4.FLAG_COMMIT = 1)
    AND  (J14.J_ID = J4.ID)
  INTO   :SUMSALES;
  IF(:SUMSALES <> 0)THEN
    BEGIN
    SELECT SUM(D14.QUANT * (SELECT FIRST 1 D.PRICE
                  FROM   TABL$D_1000014 D, TABL$J_4 J
                  WHERE  (D.TMC_ID = TMC.ID)
                    AND  (J.ID = D.J_ID)
                    AND  (J.TYPE_ID = 1000026)
                    AND  (J.FLAG_COMMIT = 1))            
          )
    FROM   TABL$J_4 J4, TABL$D_1000014 D14, TABL$R_TMC TMC
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.TYPE_ID = 1000028)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  (J4.FLAG_COMMIT = 1)
      AND  (D14.J_ID = J4.ID)
      AND  (TMC.ID = D14.TMC_ID)
    INTO   :SUMSEB;
    SUMGESHEFT = :SUMSALES - :SUMSEB;
    SELECT COALESCE(SUM(J4.DOCSUM),0)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT BETWEEN :Q_DATE_FROM AND :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  ('~6852~661~6611~6612~651~6411~6414~6416~91~92~93~-3~' CONTAINING '~'||JCASH.ACC_ID||'~')
    INTO   :PTOTAL_SUM; IF(:PTOTAL_SUM IS NULL)THEN PTOTAL_SUM = 0;
    RESULT_SUM = :SUMGESHEFT - :PTOTAL_SUM;
    RESULT_PC_ = (:RESULT_SUM * 100) / :SUMSALES;
    END


  FOR SELECT FL.ID, FL.NAME FROM TABL$R_FILIALS FL ORDER BY FL.ID INTO :FILIAL_ID, :FILIAL_NAME DO
    BEGIN
    SUMSALES         = 0;
    QUANTSALES       = 0;
    QUANTCS          = 0;
    SUMSEB           = 0;
    SUMGESHEFT       = 0;
    PCGESHEFT        = 0;
    TMC_QUANT        = 0;
    TMC_MASSA        = 0;
    TMC_MASSA_INS    = 0;
    TMC_MASSA_NETTO  = 0;
    P661_SUM         = 0;
    P91_SUM          = 0;
    P92_SUM          = 0;
    P93_SUM          = 0;
    P6414_SUM        = 0;
    P6416_SUM        = 0;
    P6852_SUM        = 0;
    P03_SUM          = 0;
    PTOTAL_SUM       = 0;
    RESULT_SUM       = 0;
    RESULT_PC        = 0;

    SELECT COALESCE(COUNT(ALL J4.ID),0), COALESCE(SUM(ALL J4.DOCSUM),0), COALESCE(COUNT(DISTINCT J14.CS_ID),0)
    FROM   TABL$J_4 J4, TABL$J_1000014 J14
    WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
      AND  (J4.DATE_COMMIT <  :DATE_TO)
      AND  (J4.TYPE_ID = 1000028)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (J14.J_ID = J4.ID)
    INTO   :QUANTSALES, :SUMSALES, :QUANTCS;
    IF(:SUMSALES <> 0)THEN
      BEGIN
      SELECT COALESCE(SUM(D14.QUANT),0)
            ,SUM(D14.QUANT * (SELECT FIRST 1 D.PRICE
                    FROM   TABL$D_1000014 D, TABL$J_4 J
                    WHERE  (D.TMC_ID = TMC.ID)
                      AND  (J.ID = D.J_ID)
                      AND  (J.TYPE_ID = 1000026)
                      AND  (J.FLAG_COMMIT = 1))            
            )      
            ,SUM(D14.QUANT * TMC.MASSA ),SUM(D14.QUANT * (TMC.MASSA - TMC.MASSA_NETTO)), SUM(D14.QUANT * TMC.MASSA_NETTO)
      FROM   TABL$J_4 J4, TABL$D_1000014 D14, TABL$R_TMC TMC
      WHERE  (J4.DATE_COMMIT >= :DATE_FROM)
        AND  (J4.DATE_COMMIT <  :DATE_TO)
        AND  (J4.TYPE_ID = 1000028)
        AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
        AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
        AND  (J4.FLAG_COMMIT = 1)
        AND  (D14.J_ID = J4.ID)
        AND  (TMC.ID = D14.TMC_ID)
      INTO   :TMC_QUANT, :SUMSEB, :TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO;
      SUMGESHEFT = :SUMSALES - :SUMSEB;
      PCGESHEFT  = (:SUMGESHEFT * 100) / :SUMSALES;
      END

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID IN(661, 6611, 6612, 651, 6411))
    INTO   :P661_SUM; IF(:P661_SUM IS NULL)THEN P661_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 91)
    INTO   :P91_SUM; IF(:P91_SUM IS NULL)THEN P91_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 92)
    INTO   :P92_SUM; IF(:P92_SUM IS NULL)THEN P92_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 93)
    INTO   :P93_SUM; IF(:P93_SUM IS NULL)THEN P93_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 6414)
    INTO   :P6414_SUM; IF(:P6414_SUM IS NULL)THEN P6414_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 6416)
    INTO   :P6416_SUM; IF(:P6416_SUM IS NULL)THEN P6416_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = 6852)
    INTO   :P6852_SUM; IF(:P6852_SUM IS NULL)THEN P6852_SUM = 0;

    SELECT SUM(J4.DOCSUM)
    FROM   TABL$J_4 J4, TABL$J_1000016 JCASH
    WHERE  (J4.DATE_COMMIT >= :Q_DATE_FROM)
      AND  (J4.DATE_COMMIT <= :Q_DATE_TO)
      AND  (J4.FLAG_COMMIT = 1)
      AND  (:Q_FIRM_IDS CONTAINING '~'||J4.FIRM_ID||'~')
      AND  ((J4.FILIAL_ID+0) = :FILIAL_ID)
      AND  (J4.TYPE_ID = 1000021)
      AND  (JCASH.J_ID = J4.ID)
      AND  (JCASH.ACC_ID = -3)
    INTO   :P03_SUM; IF(:P03_SUM IS NULL)THEN P03_SUM = 0;

    PTOTAL_SUM = :P6414_SUM + :P6416_SUM + :P661_SUM + :P6852_SUM + :P91_SUM + :P92_SUM + :P93_SUM + :P03_SUM;
    RESULT_SUM = :SUMGESHEFT - :PTOTAL_SUM;
    IF(:SUMSALES <> 0)THEN
      RESULT_PC = (:RESULT_SUM * 100) / :SUMSALES;
     ELSE  
      BEGIN
      RESULT_PC = 0;
      END

    SUSPEND;
    END
END
