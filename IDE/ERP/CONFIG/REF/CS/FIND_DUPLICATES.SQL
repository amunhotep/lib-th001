EXECUTE BLOCK RETURNS(
  CNT TYPE OF COLUMN TABL$R_CS.ID
)AS
  DECLARE VARIABLE P_CS_ID     TYPE OF COLUMN TABL$R_CS.ID;
  DECLARE VARIABLE P_NAME      TYPE OF COLUMN TABL$R_CS.NAME2;
  DECLARE VARIABLE P_BIRTHDATE TYPE OF COLUMN TABL$R_CS.BIRTHDAY;
  DECLARE VARIABLE P_CS_ID2    TYPE OF COLUMN TABL$R_CS.ID;
BEGIN
  CNT = 0;
  FOR
    SELECT C.ID, C.NAME2, C.BIRTHDAY
    FROM   TABL$R_CS C
    ORDER BY C.ID
    INTO   :P_CS_ID, :P_NAME, :P_BIRTHDATE
  DO
    FOR
      SELECT CS.ID
      FROM   TABL$R_CS CS
      WHERE  (CS.BIRTHDAY    = :P_BIRTHDATE)
        AND  (TRIM(CS.NAME2) = TRIM(:P_NAME))
        AND  (CS.ID          <> :P_CS_ID)
      INTO   :P_CS_ID2
    DO
      BEGIN
      UPDATE OR INSERT INTO TABL$R_CS_LINKS(CS_ID, CS_CHILD_ID, LINKTYPE_ID, NAME)
        VALUES(:P_CS_ID, :P_CS_ID2, 1000005, 'Автоматический поиск дубликатов')
        MATCHING(CS_ID, CS_CHILD_ID, LINKTYPE_ID);
      UPDATE OR INSERT INTO TABL$R_CS_LINKS(CS_ID, CS_CHILD_ID, LINKTYPE_ID, NAME)
        VALUES(:P_CS_ID2, :P_CS_ID, 1000005, 'Автоматический поиск дубликатов')
        MATCHING(CS_ID, CS_CHILD_ID, LINKTYPE_ID);
      CNT = :CNT + 1;
      END
  SUSPEND;
END
