-- PEAKTOP:IDE/ERP/CONFIG/REF/CS/RPT0000.SQL
EXECUTE BLOCK(
  Q_CS_ID TYPE OF COLUMN TABL$R_CS.ID = ?CS_ID
)RETURNS(
  CS_ID             TYPE OF COLUMN TABL$R_CS.ID
 ,CS_KIND_ID        TYPE OF COLUMN TABL$R_CS.KIND_ID
 ,CS_KIND_NAME      TYPE OF COLUMN TABL$R_CS_KINDS.NAME
 ,CS_KIND_SHORT     TYPE OF COLUMN TABL$R_CS_KINDS.SHORT_NAME
 ,CS_KIND_JURIDICAL TYPE OF COLUMN TABL$R_CS_KINDS.JURIDICAL
 ,CS_NAME           TYPE OF COLUMN TABL$R_CS.NAME
 ,CS_NAME2          TYPE OF COLUMN TABL$R_CS.NAME2
 ,CS_FLAG_DELETE    TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
 ,CS_INN            TYPE OF COLUMN TABL$R_CS.INN
 ,CS_INN_2          TYPE OF COLUMN TABL$R_CS.INN
 ,CS_NDS_PAYED      TYPE OF COLUMN TABL$R_CS.NDS_PAYED
 ,CS_NDS_CODE       TYPE OF COLUMN TABL$R_CS.NDS_CODE
 ,CS_NDS_CODE_2     TYPE OF COLUMN TABL$R_CS.NDS_CODE
 ,CS_EDRPOU         TYPE OF COLUMN TABL$R_CS.EDRPOU
 ,CS_EDRPOU_2       TYPE OF COLUMN TABL$R_CS.EDRPOU
 ,CS_CERTIFICATE    TYPE OF COLUMN TABL$R_CS.CERTIFICATE
 ,CS_CERTIFICATE_2  TYPE OF COLUMN TABL$R_CS.CERTIFICATE
 ,CS_CODEFLAYER     TYPE OF COLUMN TABL$R_CS.CODEFLAYER
 ,CS_CODECARD       TYPE OF COLUMN TABL$R_CS.CODECARD
 ,CS_GUID           TYPE OF COLUMN TABL$R_CS.GUID
 ,CS_COMENT         TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_WRK_ID_DIR     TYPE OF COLUMN TABL$R_CS.WRK_ID_DIR
 ,CS_WRK_ID_BUH     TYPE OF COLUMN TABL$R_CS.WRK_ID_BUH
 ,CS_WRK_NAME_DIR   TYPE OF COLUMN TABL$R_WRK.NAME
 ,CS_WRK_NAME_BUH   TYPE OF COLUMN TABL$R_WRK.NAME
 ,CS_ADDR_ID        TYPE OF COLUMN TABL$R_CS_ADDR.ID
 ,CS_ADDR_NAME      TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_ADDR_NAME_FULL TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_URLS           TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_EMAILS         TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_PHONES         TYPE OF COLUMN TABL$R_CS.COMENT
 ,CS_PHONE_2        TYPE OF COLUMN TABL$R_CS.COMENT
 ,BANK_ID               TYPE OF COLUMN TABL$R_CS_BANK.ID
 ,BANK_RS               TYPE OF COLUMN TABL$R_CS_BANK.NAME
 ,BANK_MFO              TYPE OF COLUMN TABL$R_BANKS.MFO
 ,BANK_EDRPOU           TYPE OF COLUMN TABL$R_BANKS.EDRPOU
 ,BANK_NAME             TYPE OF COLUMN TABL$R_BANKS.NAME
 ,BANK_ADDRESS          TYPE OF COLUMN TABL$R_BANKS.ADDRESS
)AS
  DECLARE VARIABLE P_COUNTRY_NAME   TYPE OF COLUMN TABL$R_COUNTRIES.NAME;
  DECLARE VARIABLE P_REGION_NAME    TYPE OF COLUMN TABL$R_REGIONS.NAME;
  DECLARE VARIABLE P_ADDRESS_ID     TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_ADDRESS_ZIP    TYPE OF COLUMN TABL$R_CS_ADDR.ZIP;
BEGIN
  CS_ID = :Q_CS_ID;

  SELECT FIRST 1
         CS.KIND_ID, CSK.NAME, CSK.SHORT_NAME, CSK.JURIDICAL
        ,CS.NAME, CS.NAME2, CS.FLAG_DELETE, CS.GUID, CS.COMENT
        ,CS.INN, CS.NDS_PAYED, CS.NDS_CODE, CS.EDRPOU, CS.CERTIFICATE
        ,CS.CODEFLAYER, CS.CODECARD, CS.WRK_ID_DIR, CS.WRK_ID_BUH
  FROM   TABL$R_CS CS, TABL$R_CS_KINDS CSK
  WHERE  (CS.ID = :CS_ID)
    AND  (CSK.ID = CS.KIND_ID)
  INTO   :CS_KIND_ID, :CS_KIND_NAME, :CS_KIND_SHORT, :CS_KIND_JURIDICAL
        ,:CS_NAME, :CS_NAME2, :CS_FLAG_DELETE, :CS_GUID, :CS_COMENT
        ,:CS_INN, :CS_NDS_PAYED, :CS_NDS_CODE, :CS_EDRPOU, :CS_CERTIFICATE
        ,:CS_CODEFLAYER, :CS_CODECARD, :CS_WRK_ID_DIR, :CS_WRK_ID_BUH
        ;
  SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK W WHERE (W.ID = :CS_WRK_ID_DIR) INTO :CS_WRK_NAME_DIR;
  SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK W WHERE (W.ID = :CS_WRK_ID_BUH) INTO :CS_WRK_NAME_BUH;

  SELECT LIST(U.NAME,'; ') FROM TABL$R_CS_URL    U WHERE(U.CS_ID = :CS_ID)INTO :CS_URLS  ; IF(:CS_URLS   IS NULL)THEN CS_URLS   = '';
  SELECT LIST(E.NAME,'; ') FROM TABL$R_CS_EMAIL  E WHERE(E.CS_ID = :CS_ID)INTO :CS_EMAILS; IF(:CS_EMAILS IS NULL)THEN CS_EMAILS = '';
  SELECT LIST(P.NAME,'; ') FROM TABL$R_CS_PHONES P WHERE(P.CS_ID = :CS_ID)INTO :CS_PHONES; IF(:CS_PHONES IS NULL)THEN CS_PHONES = '';

  SELECT FIRST 1 P.CYPHERS
  FROM   TABL$R_CS_PHONES P
  WHERE  (P.CS_ID = :CS_ID)
  INTO   :CS_PHONE_2; IF(:CS_PHONE_2 IS NULL)THEN CS_PHONE_2 = '';
  WHILE(CHAR_LENGTH(:CS_PHONE_2) < 10)DO
    CS_PHONE_2 = ' '||:CS_PHONE_2;
  IF(CHAR_LENGTH(:CS_PHONE_2) > 10)THEN
    CS_PHONE_2 = SUBSTRING(:CS_PHONE_2 FROM CHAR_LENGTH(:CS_PHONE_2)-9);

  SELECT FIRST 1 CSA.ID
  FROM   TABL$R_CS_ADDR CSA
  WHERE  (CSA.CS_ID = :CS_ID)
    AND  (CSA.FLAG_JURIDICAL = 1)
  INTO   :CS_ADDR_ID;

  SELECT FIRST 1 CSA.ZIP, CSA.NAME, CNTR.NAME, REGN.NAME
  FROM   TABL$R_CS_ADDR CSA, TABL$R_COUNTRIES CNTR, TABL$R_REGIONS REGN
  WHERE  (CSA.ID = :CS_ADDR_ID)
    AND  (CNTR.ID = CSA.COUNTRY_ID)
    AND  (REGN.ID = CSA.REGION_ID)
  INTO   :P_ADDRESS_ZIP, :CS_ADDR_NAME, :P_COUNTRY_NAME, :P_REGION_NAME; IF(:CS_ADDR_NAME IS NULL)THEN CS_ADDR_NAME = '';

  CS_ADDR_NAME_FULL = :CS_ADDR_NAME||', '||:P_REGION_NAME||', '||:P_COUNTRY_NAME||', '||:P_ADDRESS_ZIP;

  SELECT FIRST 1 B.ID
  FROM   TABL$R_CS_BANK B
  WHERE  (B.CS_ID = :CS_ID)
    AND  (B.BASE_ACCOUNT = 1)
    AND  (B.COUNTRY_ID   = 1000071)
  INTO   :BANK_ID;

  IF(:BANK_ID IS NULL)THEN
    SELECT FIRST 1 B.ID
    FROM   TABL$R_CS_BANK B
    WHERE  (B.CS_ID = :CS_ID)
      AND  (B.COUNTRY_ID = 1000071)
    INTO   :BANK_ID;

  SELECT FIRST 1 B1.NAME, BB.MFO, BB.EDRPOU, BB.NAME, BB.ADDRESS
  FROM   TABL$R_CS_BANK B1, TABL$R_BANKS BB
  WHERE  (B1.ID = :BANK_ID)
    AND  (BB.ID = B1.BANK_ID)
  INTO   :BANK_RS, :BANK_MFO, :BANK_EDRPOU, :BANK_NAME, :BANK_ADDRESS;

  CS_INN_2 = :CS_INN;
  WHILE(CHAR_LENGTH(:CS_INN_2) < 12)DO
    CS_INN_2 = ' '||:CS_INN_2;

  CS_EDRPOU_2 = :CS_EDRPOU;
  WHILE(CHAR_LENGTH(:CS_EDRPOU_2) < 12)DO
    CS_EDRPOU_2 = ' '||:CS_EDRPOU_2;

  CS_NDS_CODE_2 = :CS_NDS_CODE;
  WHILE(CHAR_LENGTH(:CS_NDS_CODE_2) < 10)DO
    CS_NDS_CODE_2 = ' '||:CS_NDS_CODE_2;

  CS_CERTIFICATE_2 = COALESCE(:CS_CERTIFICATE,'');
  WHILE(CHAR_LENGTH(:CS_CERTIFICATE_2) < 10)DO
    CS_CERTIFICATE_2 = ' '||:CS_CERTIFICATE_2;

  CS_NDS_CODE_2 = :CS_CERTIFICATE_2;  

  SUSPEND;
END
