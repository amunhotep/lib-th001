CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_R_CS_ADDR_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID          TYPE OF COLUMN TABL$R_CS_ADDR.CS_ID;
  DECLARE VARIABLE P_ID             TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_ID_NEW         TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_COUNTRY_ID     TYPE OF COLUMN TABL$R_CS_ADDR.COUNTRY_ID;
  DECLARE VARIABLE P_REGION_ID      TYPE OF COLUMN TABL$R_CS_ADDR.REGION_ID;
  DECLARE VARIABLE P_NAME           TYPE OF COLUMN TABL$R_CS_ADDR.NAME;
  DECLARE VARIABLE P_ZIP            TYPE OF COLUMN TABL$R_CS_ADDR.ZIP;
  DECLARE VARIABLE P_FLAG_DELETE    TYPE OF COLUMN TABL$R_CS_ADDR.FLAG_DELETE;
  DECLARE VARIABLE P_FLAG_JURIDICAL TYPE OF COLUMN TABL$R_CS_ADDR.FLAG_JURIDICAL;

  DECLARE VARIABLE P_SQL_STMT       TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 2;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB TB WHERE(TRIM(UPPER(TB.ID)) = 'TABL$R_CS_ADDR') INTO :NAME;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_ADDR_ID RESTART WITH -999999;';

  P_SQL_STMT =
    'SELECT CSA.CS_ID, CSA.ID, CSA.COUNTRY_ID, CSA.REGION_ID, CSA.NAME, CSA.ZIP, CSA.FLAG_DELETE, CSA.FLAG_JURIDICAL '||
    'FROM   TABL$R_CS_ADDR CSA '||
    'WHERE  (CSA.ID > 0) '||
    '  AND  (CSA.CS_ID > 0) '||
    'ORDER BY CSA.ID ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_CS_ID, :P_ID, :P_COUNTRY_ID, :P_REGION_ID, :P_NAME, :P_ZIP, :P_FLAG_DELETE, :P_FLAG_JURIDICAL
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$R_CS_ADDR (CS_ID, ID, COUNTRY_ID, REGION_ID, NAME, ZIP, FLAG_DELETE, FLAG_JURIDICAL)
      VALUES (:P_CS_ID, :P_ID, :P_COUNTRY_ID, :P_REGION_ID, :P_NAME, :P_ZIP, :P_FLAG_DELETE, :P_FLAG_JURIDICAL)
      MATCHING (ID) RETURNING ID INTO :P_ID_NEW;

    UPDATE TABL$R_CS_ADDR CSA SET CSA.ID = :P_ID WHERE (CSA.ID = :P_ID_NEW);
    CNT = :CNT + 1;
    END

  -- GET SEQUENCE VALUE
  P_ID = 0;
  P_SQL_STMT = 'SELECT FIRST 1 GEN_ID(GENR$R_CS_ADDR_ID, 0) FROM RDB$DATABASE ';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION
    INTO :P_ID;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_ADDR_ID RESTART WITH '||:P_ID||';';

  SUSPEND;
END
