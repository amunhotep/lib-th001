CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_COMENTS_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_ID          TYPE OF COLUMN TABL$J_COMENTS.ID;
  DECLARE VARIABLE P_NEW_ID      TYPE OF COLUMN TABL$J_COMENTS.ID;
  DECLARE VARIABLE P_NAME        TYPE OF COLUMN TABL$J_COMENTS.NAME;
  DECLARE VARIABLE P_FLAG_DELETE TYPE OF COLUMN TABL$J_COMENTS.FLAG_DELETE;
  DECLARE VARIABLE P_J_ID        TYPE OF COLUMN TABL$J_COMENTS.J_ID;
  DECLARE VARIABLE P_USER_ID     TYPE OF COLUMN TABL$J_COMENTS.USER_ID;
  DECLARE VARIABLE P_DATE_CREATE TYPE OF COLUMN TABL$J_COMENTS.DATE_CREATE;

  DECLARE VARIABLE P_SQL_STMT    TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 2;
  CNT     = 0;
  NAME    = 'Примечания к документам';
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$J_COMENTS_ID RESTART WITH -999999;';

  P_SQL_STMT =
    'SELECT JC.J_ID, JC.ID, JC.NAME, JC.FLAG_DELETE, JC.USER_ID, JC.DATE_CREATE '||
    'FROM   TABL$J_COMENTS JC '||
    'ORDER BY JC.J_ID, JC.ID ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_J_ID, :P_ID, :P_NAME, :P_FLAG_DELETE, :P_USER_ID, :P_DATE_CREATE
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_COMENTS(J_ID, ID, NAME, FLAG_DELETE, USER_ID, DATE_CREATE)
      VALUES (:P_J_ID, :P_ID, :P_NAME, :P_FLAG_DELETE, :P_USER_ID, :P_DATE_CREATE)
      MATCHING (ID) RETURNING ID INTO :P_NEW_ID;
    UPDATE TABL$J_COMENTS JC SET JC.ID = :P_ID WHERE (JC.ID = :P_NEW_ID);
    CNT = :CNT + 1;
    END

  -- GET SEQUENCE VALUE
  P_ID = 0;
  P_SQL_STMT = 'SELECT FIRST 1 GEN_ID(GENR$J_COMENTS_ID, 0) FROM RDB$DATABASE ';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION
    INTO :P_ID;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$J_COMENTS_ID RESTART WITH '||:P_ID||';';

  SUSPEND;
END
