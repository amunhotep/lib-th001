CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_1000063_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID           TYPE OF COLUMN TABL$J_1000063.CS_ID;
  DECLARE VARIABLE P_J_ZALOG_ID      TYPE OF COLUMN TABL$J_1000063.J_ZALOG_ID;
  DECLARE VARIABLE P_DATE_LAST       TYPE OF COLUMN TABL$J_1000063.DATE_LAST;
  DECLARE VARIABLE P_DOMSUMLEFT      TYPE OF COLUMN TABL$J_1000063.DOMSUMLEFT;
  DECLARE VARIABLE P_DAYSCNT         TYPE OF COLUMN TABL$J_1000063.DAYSCNT;
  DECLARE VARIABLE P_PC              TYPE OF COLUMN TABL$J_1000063.PC;
  DECLARE VARIABLE P_PCSUM           TYPE OF COLUMN TABL$J_1000063.PCSUM;
  DECLARE VARIABLE P_PCPEN           TYPE OF COLUMN TABL$J_1000063.PC;
  DECLARE VARIABLE P_PCPENSUM        TYPE OF COLUMN TABL$J_1000063.PCSUM;
  DECLARE VARIABLE P_DATE_RETURN     TYPE OF COLUMN TABL$J_1000063.DATE_RETURN;
  DECLARE VARIABLE P_CARDNUM         TYPE OF COLUMN TABL$J_1000063.CARDNUM;
  DECLARE VARIABLE P_CARDAMOUNT      TYPE OF COLUMN TABL$J_1000063.CARDAMOUNT;

  DECLARE VARIABLE P_SQL_STMT        TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000063;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  P_SQL_STMT =
    'SELECT FIRST 1 JZ.J_ZALOG_ID, JZ.CS_ID, JZ.DATE_LAST, JZ.DOMSUMLEFT, JZ.DAYSCNT, JZ.PC, JZ.PCSUM, JZ.DATE_RETURN '||
    '      ,JZ.PCPEN, JZ.PCPENSUM, JZ.CARDNUM, JZ.CARDAMOUNT '||
    'FROM   TABL$J_1000063 JZ '||
    'WHERE  (JZ.J_ID = '''||:Q_J_ID||''') ';

  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO  :P_J_ZALOG_ID, :P_CS_ID, :P_DATE_LAST, :P_DOMSUMLEFT, :P_DAYSCNT, :P_PC, :P_PCSUM
         ,:P_DATE_RETURN, :P_PCPEN, :P_PCPENSUM, :P_CARDNUM, :P_CARDAMOUNT
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_1000063 (J_ID, J_ZALOG_ID, CS_ID, DATE_LAST, DOMSUMLEFT
      ,DAYSCNT, PC, PCSUM, DATE_RETURN, PCPEN, PCPENSUM, CARDNUM, CARDAMOUNT
    )VALUES (:Q_J_ID, :P_J_ZALOG_ID, :P_CS_ID, :P_DATE_LAST, :P_DOMSUMLEFT
      ,:P_DAYSCNT, :P_PC, :P_PCSUM, :P_DATE_RETURN, :P_PCPEN, :P_PCPENSUM, :P_CARDNUM, :P_CARDAMOUNT
    )MATCHING(J_ID);
    CNT = :CNT + 1;
    END
  NAME = '    +-- PROC$_EXCHANGE_J_1000063_ARC ('||:Q_J_ID||')';
  SUSPEND;
END
