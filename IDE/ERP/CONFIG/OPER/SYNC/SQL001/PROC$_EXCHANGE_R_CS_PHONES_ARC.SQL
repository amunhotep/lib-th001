CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_R_CS_PHONES_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID          TYPE OF COLUMN TABL$R_CS_PHONES.CS_ID;
  DECLARE VARIABLE P_ID             TYPE OF COLUMN TABL$R_CS_PHONES.ID;
  DECLARE VARIABLE P_ID_NEW         TYPE OF COLUMN TABL$R_CS_PHONES.ID;
  DECLARE VARIABLE P_NAME           TYPE OF COLUMN TABL$R_CS_PHONES.NAME;
  DECLARE VARIABLE P_FLAG_DELETE    TYPE OF COLUMN TABL$R_CS_PHONES.FLAG_DELETE;
  DECLARE VARIABLE P_FLAG_FAX       TYPE OF COLUMN TABL$R_CS_PHONES.FLAG_FAX;
  DECLARE VARIABLE P_FLAG_MOBIL     TYPE OF COLUMN TABL$R_CS_PHONES.FLAG_MOBIL;

  DECLARE VARIABLE P_SQL_STMT       TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 2;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB TB WHERE(TRIM(UPPER(TB.ID)) = 'TABL$R_CS_PHONES') INTO :NAME;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_PHONES_ID RESTART WITH -999999;';

  P_SQL_STMT =
    'SELECT P.CS_ID, P.ID, P.NAME, P.FLAG_DELETE, P.FLAG_FAX, P.FLAG_MOBIL '||
    'FROM   TABL$R_CS_PHONES P '||
    'WHERE  (P.ID > 0) '||
    '  AND  (P.CS_ID > 0) '||
    'ORDER BY P.ID ';
  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_CS_ID, :P_ID, :P_NAME, :P_FLAG_DELETE, :P_FLAG_FAX, :P_FLAG_MOBIL
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$R_CS_PHONES (CS_ID, ID, NAME, FLAG_DELETE, FLAG_FAX, FLAG_MOBIL)
      VALUES (:P_CS_ID, :P_ID, :P_NAME, :P_FLAG_DELETE, :P_FLAG_FAX, :P_FLAG_MOBIL)
      MATCHING(ID) RETURNING ID INTO :P_ID_NEW;

    UPDATE TABL$R_CS_PHONES CSP SET CSP.ID = :P_ID WHERE (CSP.ID = :P_ID_NEW);
    CNT = :CNT + 1;
    END
  -- GET SEQUENCE VALUE
  P_ID = 0;
  P_SQL_STMT = 'SELECT FIRST 1 GEN_ID(GENR$R_CS_PHONES_ID, 0) FROM RDB$DATABASE ';
  EXECUTE STATEMENT :P_SQL_STMT
    ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
    WITH AUTONOMOUS TRANSACTION
    INTO :P_ID;
  -- EXECUTE LOCAL !
  EXECUTE STATEMENT 'ALTER SEQUENCE GENR$R_CS_PHONES_ID RESTART WITH '||:P_ID||';';

  SUSPEND;
END
