CREATE OR ALTER PROCEDURE PROC$_EXCHANGE_J_1000014_ARC (
  Q_DATABASEPATH TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME,
  Q_USERNAME     TYPE OF COLUMN TABL$_USERS.ID,
  Q_USERPWD      TYPE OF COLUMN TABL$_USERS.PWD,
  Q_FILIAL_ID    TYPE OF COLUMN TABL$R_FILIALS.ID,
  Q_J_ID         TYPE OF COLUMN TABL$J_4.ID)
RETURNS (
  TYPE_ID TYPE OF COLUMN TABL$_TB_TYPES.ID,
  NAME    TYPE OF COLUMN TABL$_TB.NAME,
  CNT     TYPE OF COLUMN TABL$J_4.ID)
AS
  DECLARE VARIABLE P_CS_ID          TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_CS_ID_NEW      TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_CS_ADDR_ID     TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID;
  DECLARE VARIABLE P_CS_ADDR_ID_NEW TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID;
  DECLARE VARIABLE P_PLACE_ID       TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_TAX_ID         TYPE OF COLUMN TABL$J_1000014.TAX_ID;
  DECLARE VARIABLE P_TO_PLACE_ID    TYPE OF COLUMN TABL$J_1000014.TO_PLACE_ID;
  DECLARE VARIABLE P_WRK_ID         TYPE OF COLUMN TABL$J_1000014.WRK_ID;
  DECLARE VARIABLE P_TMC_GRID_ID    TYPE OF COLUMN TABL$J_1000014.TMC_GRID_ID;

  DECLARE VARIABLE P_SQL_STMT       TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  TYPE_ID = 1000014;
  CNT     = 0;
  SELECT FIRST 1 TB.NAME FROM TABL$_TB_TYPES TB WHERE(TB.ID = :TYPE_ID) INTO :NAME;

  P_SQL_STMT =
    'SELECT FIRST 1 JB.CS_ID, JB.CS_ADDR_ID, JB.PLACE_ID, JB.TAX_ID, JB.TO_PLACE_ID, '||
    '       JB.WRK_ID, JB.TMC_GRID_ID '||
    'FROM   TABL$J_1000014 JB '||
    'WHERE  (JB.J_ID = '''||:Q_J_ID||''') ';

  FOR
    EXECUTE STATEMENT :P_SQL_STMT
      ON EXTERNAL DATA SOURCE :Q_DATABASEPATH AS USER :Q_USERNAME PASSWORD :Q_USERPWD
      WITH AUTONOMOUS TRANSACTION
    INTO :P_CS_ID, :P_CS_ADDR_ID, :P_PLACE_ID, :P_TAX_ID, :P_TO_PLACE_ID,
         :P_WRK_ID, :P_TMC_GRID_ID
  DO
    BEGIN
    UPDATE OR INSERT INTO TABL$J_1000014 (J_ID, CS_ID, CS_ADDR_ID, PLACE_ID, TAX_ID, TO_PLACE_ID, WRK_ID, TMC_GRID_ID)
      VALUES (:Q_J_ID, :P_CS_ID, :P_CS_ADDR_ID, :P_PLACE_ID, :P_TAX_ID, :P_TO_PLACE_ID, :P_WRK_ID, :P_TMC_GRID_ID)
      MATCHING(J_ID);
    NAME = '    +-- PROC$_EXCHANGE_J_1000014_ARC ('||:Q_J_ID||')';
    CNT = :CNT + 1;
    END
  SUSPEND;

  FOR
    SELECT P1000014.TYPE_ID, P1000014.NAME, P1000014.CNT
    FROM   PROC$_EXCHANGE_D_1000014_ARC(:Q_DATABASEPATH, :Q_USERNAME, :Q_USERPWD, :Q_FILIAL_ID, :Q_J_ID) P1000014
    INTO   :TYPE_ID, :NAME, :CNT
  DO
    SUSPEND;
END
