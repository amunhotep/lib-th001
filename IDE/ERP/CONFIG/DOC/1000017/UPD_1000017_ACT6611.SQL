EXECUTE BLOCK (
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)AS 
  DECLARE VARIABLE P_J_ID        TYPE OF COLUMN TABL$J_4.ID; 
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID; 
  DECLARE VARIABLE P_PROC_NAME   TYPE OF COLUMN TABL$_TB.ID;  
  DECLARE VARIABLE P_SQL_STMT    TYPE OF COLUMN TABL$_EXCHANGE_SQL.SRC;  
  DECLARE VARIABLE P_WRK_ID      TYPE OF COLUMN TABL$D_1000046.WRK_ID; 
  DECLARE VARIABLE P_WRK_NAME    TYPE OF COLUMN TABL$D_1000046.NAME; 
  DECLARE VARIABLE P_WRK_POST_ID TYPE OF COLUMN TABL$D_1000046.WRK_POST_ID; 
  DECLARE VARIABLE P_DATE_DOC    TYPE OF COLUMN TABL$J_4.DATE_COMMIT; 
  DECLARE VARIABLE P_DATE_FROM   TYPE OF COLUMN TABL$J_4.DATE_COMMIT; 
  DECLARE VARIABLE P_DATE_TO     TYPE OF COLUMN TABL$J_4.DATE_COMMIT; 
  DECLARE VARIABLE P_DATE_BEGIN  TYPE OF COLUMN TABL$J_4.DATE_COMMIT; 
  DECLARE VARIABLE P_DATE_END    TYPE OF COLUMN TABL$J_4.DATE_COMMIT; 
  DECLARE VARIABLE P_FLAG_DELETE TYPE OF COLUMN TABL$J_4.FLAG_COMMIT;  
  DECLARE VARIABLE P_FILIAL_ID   TYPE OF COLUMN TABL$R_FILIALS.ID; 
BEGIN 
  P_J_ID = :Q_J_ID; 
  DELETE FROM TABL$D_1000017 D WHERE (D.J_ID = :P_J_ID) AND (D.ACC_ID = 6611); 
  SELECT FIRST 1 J.FIRM_ID, J.DATE_COMMIT  
  FROM   TABL$J_4 J 
  WHERE  (J.ID = :p_J_ID) 
  INTO   :P_FIRM_ID, :P_DATE_DOC; 
  SELECT FIRST 1 P.BEGIN_OF_MONTH, P.END_OF_MONTH 
  FROM   PROC$__DATE_MONTH(:P_DATE_DOC) P 
  INTO   :P_DATE_FROM, :P_DATE_TO; 
  FOR 
    SELECT W.WRK_ID, W.WRK_POST_ID, W.DATE_BEGIN, W.DATE_END 
    FROM   TABL$R_WRK_WORK W 
    WHERE  ((W.FIRM_ID+0) = :P_FIRM_ID) 
      AND  (W.DATE_BEGIN <= :P_DATE_TO) 
      AND  (W.DATE_END   >= :P_DATE_FROM) 
    ORDER BY W.WRK_POST_ID 
    INTO   :P_WRK_ID, :P_WRK_POST_ID, :P_DATE_BEGIN, :P_DATE_END 
  DO 
    BEGIN 
    P_WRK_NAME = ''; 
    SELECT FIRST 1 COALESCE(W.NAME,'') 
    FROM   TABL$R_WRK W 
    WHERE  (W.ID = :P_WRK_ID) 
    INTO   :P_WRK_NAME; 
    P_FLAG_DELETE = 0; 
    P_FILIAL_ID = 0; 
    SELECT FIRST 1 COALESCE(F.ID,0) 
    FROM   TABL$R_FILIALS F 
    WHERE  (F.WRK_ID = :P_WRK_ID) 
    INTO   :P_FILIAL_ID; 
    IF(:P_FILIAL_ID = 0)THEN 
      SELECT FIRST 1 COALESCE(F.ID,0) 
      FROM   TABL$R_FILIALS F 
      WHERE  (F.WRK_ID2 = :P_WRK_ID) 
      INTO   :P_FILIAL_ID; 
    INSERT INTO TABL$D_1000017(FLAG_DELETE, J_ID, FLAG_DEBET, ACC_ID, SUBKONTO_ID, SUBKONTO_NAME, TAX_ID, SUBTYPE_ID 
      ,J_REASON_ID, J_REASON_SUM, J_REASON_NDP, J_REASON_DONE, FLAG_OLD, PAYSUM, PAYSUMCLEAR 
      ,PAYSUMNDP, EXPTYPE_ID, FILIAL_ID, FLAG_UPDNDP 
    )VALUES (0, :P_J_ID, 0, 6611, :P_WRK_ID, :P_WRK_NAME, 1000008, 0, 0, 0, 0, 0, 0, 850, 0, 0, 0, :P_FILIAL_ID, 0); 
    END 
END
