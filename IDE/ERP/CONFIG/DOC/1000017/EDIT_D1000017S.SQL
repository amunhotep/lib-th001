EXECUTE BLOCK (
   Q_J_ID                TYPE OF COLUMN TABL$D_1000017.ID = ?ID
)RETURNS (
   ID                    TYPE OF COLUMN TABL$D_1000017.ID
  ,NAME                  TYPE OF COLUMN TABL$D_1000017.NAME
  ,FLAG_DELETE           TYPE OF COLUMN TABL$D_1000017.FLAG_DELETE
  ,J_ID                  TYPE OF COLUMN TABL$D_1000017.J_ID
  ,FLAG_DEBET            TYPE OF COLUMN TABL$D_1000017.FLAG_DEBET
  ,ACC_ID                TYPE OF COLUMN TABL$D_1000017.ACC_ID
  ,ACC_NAME              TYPE OF COLUMN TABL$R_BUHG_ACCS.NAME
  ,ACC_SUBKONTO          TYPE OF COLUMN TABL$R_BUHG_ACCS.SUBKONTO
  ,ACC_SUBKONTOTYPE      TYPE OF COLUMN TABL$_TB_TYPES.ROOT_ID
  ,SUBKONTO_ID           TYPE OF COLUMN TABL$D_1000017.SUBKONTO_ID
  ,SUBKONTO_NAME         TYPE OF COLUMN TABL$D_1000017.SUBKONTO_NAME
  ,TAX_ID                TYPE OF COLUMN TABL$D_1000017.TAX_ID
  ,TAX_NAME              TYPE OF COLUMN TABL$R_TAXES.NAME
  ,SUBTYPE_ID            TYPE OF COLUMN TABL$D_1000017.SUBTYPE_ID
  ,J_REASON_ID           TYPE OF COLUMN TABL$D_1000017.J_REASON_ID
  ,J_REASON_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_REASON_DOCSTR       TYPE OF COLUMN TABL$J_4.DOCSTR
  ,J_REASON_SUM          TYPE OF COLUMN TABL$D_1000017.J_REASON_SUM
  ,J_REASON_NDP          TYPE OF COLUMN TABL$D_1000017.J_REASON_NDP
  ,J_REASON_CLEAR        TYPE OF COLUMN TABL$D_1000017.J_REASON_NDP
  ,J_REASON_DONE         TYPE OF COLUMN TABL$D_1000017.J_REASON_DONE
  ,TRID                  TYPE OF COLUMN TABL$D_1000017.TRID
  ,DCID                  TYPE OF COLUMN TABL$D_1000017.DCID
  ,J_ID_ORDER            TYPE OF COLUMN TABL$J_4.ID
  ,J_ID_LOAD             TYPE OF COLUMN TABL$J_4.ID
  ,J_ID_PAYMENT          TYPE OF COLUMN TABL$J_4.ID
  ,FLAG_OLD              TYPE OF COLUMN TABL$D_1000017.FLAG_OLD
  ,FLAG_UPDNDP           TYPE OF COLUMN TABL$D_1000017.FLAG_UPDNDP
  ,PAYSUM                TYPE OF COLUMN TABL$D_1000017.PAYSUM
  ,PAYSUMCLEAR           TYPE OF COLUMN TABL$D_1000017.PAYSUMCLEAR
  ,PAYSUMNDP             TYPE OF COLUMN TABL$D_1000017.PAYSUMNDP
  ,EXPTYPE_ID            TYPE OF COLUMN TABL$D_1000017.EXPTYPE_ID
  ,EXPTYPE_NAME          TYPE OF COLUMN TABL$R_EXPTYPES.NAME
  ,FILIAL_ID             TYPE OF COLUMN TABL$D_1000017.FILIAL_ID
  ,FILIAL_NAME           TYPE OF COLUMN TABL$R_FILIALS.NAME
)AS
  DECLARE VARIABLE P_REASON_TYPE_ID TYPE OF COLUMN TABL$J_4.TYPE_ID;
  DECLARE VARIABLE P_FIRM_ID        TYPE OF COLUMN TABL$J_4.FIRM_ID;
BEGIN
  SELECT FIRST 1 J.FIRM_ID FROM TABL$J_4 J WHERE(J.ID = :Q_J_ID)INTO :P_FIRM_ID;
  FOR
    SELECT D.ID, D.NAME, D.FLAG_DELETE, D.J_ID, D.FLAG_DEBET, D.ACC_ID, BA.NAME, BA.SUBKONTO
          ,D.SUBKONTO_ID, D.SUBKONTO_NAME, D.TAX_ID, D.SUBTYPE_ID
          ,D.J_REASON_ID, COALESCE(D.J_REASON_SUM,0), COALESCE(D.J_REASON_NDP,0), D.J_REASON_DONE
          ,D.PAYSUM, D.PAYSUMCLEAR, D.PAYSUMNDP, D.EXPTYPE_ID, D.FILIAL_ID, D.FLAG_OLD, D.FLAG_UPDNDP
          ,(SELECT FIRST 1 COALESCE(FL.NAME,'') FROM TABL$R_FILIALS FL WHERE(FL.ID = D.FILIAL_ID)) AS FILIAL_NAME
          ,D.TRID, D.DCID
    FROM   TABL$D_1000017 D, TABL$R_BUHG_ACCS BA
    WHERE  (D.J_ID = :Q_J_ID)
      AND  (BA.ID = D.ACC_ID)
    ORDER BY D.ID  
    INTO   :ID, :NAME,:FLAG_DELETE, :J_ID,:FLAG_DEBET, :ACC_ID, :ACC_NAME, :ACC_SUBKONTO
          ,:SUBKONTO_ID, :SUBKONTO_NAME, :TAX_ID, :SUBTYPE_ID
          ,:J_REASON_ID, :J_REASON_SUM, :J_REASON_NDP, :J_REASON_DONE
          ,:PAYSUM, :PAYSUMCLEAR, :PAYSUMNDP, :EXPTYPE_ID, :FILIAL_ID, :FLAG_OLD, :FLAG_UPDNDP
          ,:FILIAL_NAME
          ,:TRID, :DCID
  DO
    BEGIN
    J_REASON_CLEAR = :J_REASON_SUM - :J_REASON_NDP;
    SELECT FIRST 1 T.BASE_TYPE_ID FROM TABL$_TB T WHERE(TRIM(T.ID) = TRIM(:ACC_SUBKONTO)) INTO :ACC_SUBKONTOTYPE;
    SELECT FIRST 1 E.NAME  FROM TABL$R_EXPTYPES E WHERE(E.ID = :EXPTYPE_ID)INTO :EXPTYPE_NAME;
    SELECT FIRST 1 T.NAME  FROM TABL$R_TAXES    T WHERE(T.ID = :TAX_ID    )INTO :TAX_NAME;

    J_ID_ORDER   = 0;
    J_ID_LOAD    = 0;
    J_ID_PAYMENT = 0;
    J_REASON_DOCNUMBERSTR = '';
    J_REASON_DOCSTR       = '';
    IF(:J_REASON_ID <> 0)THEN
      BEGIN
      SELECT FIRST 1 J.DOCNUMBERSTR, J.DOCSTR, J.TYPE_ID
      FROM   TABL$J_4 J
      WHERE  (J.ID = :J_REASON_ID)
      INTO   :J_REASON_DOCNUMBERSTR, :J_REASON_DOCSTR, :P_REASON_TYPE_ID;
      IF('~1000071~1000135~1000026~1000128~' CONTAINING '~'||:P_REASON_TYPE_ID||'~')THEN
        BEGIN
        SELECT COALESCE(MIN(P.J_ID), :J_REASON_ID)
        FROM   PROC$D_GET_4_ROOTTYPES(:J_REASON_ID, '~1000071~1000135~') P
        INTO   :J_ID_ORDER; IF(:J_ID_ORDER = 0)THEN J_ID_ORDER = :J_REASON_ID;
        SELECT FIRST 1 COALESCE(J.ID, 0)
        FROM   TABL$J_CHILDS JC, TABL$J_4 J
        WHERE  (JC.J_ID = :J_ID_ORDER)
          AND  (J.ID = JC.J_CHILD_ID)
          AND  ('~1000017~1000020~1000021~' CONTAINING '~'||J.TYPE_ID||'~')
          AND  (J.FLAG_COMMIT = 1)
          AND  (J.ID <> :J_ID)
        INTO   :J_ID_PAYMENT;
        SELECT FIRST 1 COALESCE(J.ID, 0)
        FROM   TABL$J_CHILDS JC, TABL$J_4 J
        WHERE  (JC.J_ID = :J_ID_ORDER)
          AND  (J.ID = JC.J_CHILD_ID)
          AND  ('~1000026~1000128~' CONTAINING '~'||J.TYPE_ID||'~')
          AND  (J.FLAG_COMMIT = 1)
        INTO   :J_ID_LOAD;
        END
       ELSE
        BEGIN
        SELECT FIRST 1 COALESCE(P.J_ID, :J_REASON_ID)
        FROM   PROC$D_GET_4_ROOTTYPES(:J_REASON_ID, '~1000075~1000136~') P
        INTO   :J_ID_ORDER; IF(:J_ID_ORDER = 0)THEN J_ID_ORDER = :J_REASON_ID;
        SELECT FIRST 1 COALESCE(J.ID,0)
        FROM   TABL$J_CHILDS JC, TABL$J_4 J
        WHERE  (JC.J_ID = :J_ID_ORDER)
          AND  (J.ID = JC.J_CHILD_ID)
          AND  ('~1000017~1000020~1000021~' CONTAINING '~'||J.TYPE_ID||'~')
          AND  (J.FLAG_COMMIT = 1)
          AND  (J.ID <> :J_ID)
        INTO   :J_ID_PAYMENT;
        SELECT FIRST 1 COALESCE(J.ID, 0)
        FROM   TABL$J_CHILDS JC, TABL$J_4 J
        WHERE  (JC.J_ID = :J_ID_ORDER)
          AND  (J.ID = JC.J_CHILD_ID)
          AND  ('~1000028~1000127~' CONTAINING '~'||J.TYPE_ID||'~')
          AND  (J.FLAG_COMMIT = 1)
        INTO   :J_ID_LOAD;
        END
      END

    SUSPEND;
    END
END
