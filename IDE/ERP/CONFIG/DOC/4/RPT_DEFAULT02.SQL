-- PEAKTOP:IDE/ERP/CONFIG/DOC/4/RPT_DEFAULT02.SQL
EXECUTE BLOCK(
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS(
  J_ID                  TYPE OF COLUMN TABL$J_4.ID
 ,ID                    TYPE OF COLUMN TABL$R_FIRMS.ID
 ,NAME                  TYPE OF COLUMN TABL$R_FIRMS.NAME
 ,PATH_LOGO             TYPE OF COLUMN TABL$R_FIRMS.PATH_LOGO
 ,ENT_CS_ID             TYPE OF COLUMN TABL$R_CS.ID
 ,ENT_CS_KIND_ID        TYPE OF COLUMN TABL$R_CS.KIND_ID
 ,ENT_CS_KIND_NAME      TYPE OF COLUMN TABL$R_CS_KINDS.NAME
 ,ENT_CS_KIND_SHORT     TYPE OF COLUMN TABL$R_CS_KINDS.SHORT_NAME
 ,ENT_CS_KIND_JURIDICAL TYPE OF COLUMN TABL$R_CS_KINDS.JURIDICAL
 ,ENT_CS_NAME           TYPE OF COLUMN TABL$R_CS.NAME
 ,ENT_CS_NAME2          TYPE OF COLUMN TABL$R_CS.NAME2
 ,ENT_CS_FLAG_DELETE    TYPE OF COLUMN TABL$R_CS.FLAG_DELETE
 ,ENT_CS_INN            TYPE OF COLUMN TABL$R_CS.INN
 ,ENT_CS_INN_2          TYPE OF COLUMN TABL$R_CS.INN
 ,ENT_CS_NDS_PAYED      TYPE OF COLUMN TABL$R_CS.NDS_PAYED
 ,ENT_CS_NDS_CODE       TYPE OF COLUMN TABL$R_CS.NDS_CODE
 ,ENT_CS_NDS_CODE_2     TYPE OF COLUMN TABL$R_CS.NDS_CODE
 ,ENT_CS_EDRPOU         TYPE OF COLUMN TABL$R_CS.EDRPOU
 ,ENT_CS_EDRPOU_2       TYPE OF COLUMN TABL$R_CS.EDRPOU
 ,ENT_CS_CERTIFICATE    TYPE OF COLUMN TABL$R_CS.CERTIFICATE
 ,ENT_CS_CERTIFICATE_2  TYPE OF COLUMN TABL$R_CS.CERTIFICATE
 ,ENT_CS_CODEFLAYER     TYPE OF COLUMN TABL$R_CS.CODEFLAYER
 ,ENT_CS_CODECARD       TYPE OF COLUMN TABL$R_CS.CODECARD
 ,ENT_CS_GUID           TYPE OF COLUMN TABL$R_CS.GUID
 ,ENT_CS_COMENT         TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_WRK_ID_DIR       TYPE OF COLUMN TABL$R_CS.WRK_ID_DIR
 ,ENT_CS_WRK_NAME_DIR     TYPE OF COLUMN TABL$R_WRK.NAME
 ,ENT_CS_WRK_INN_DIR      TYPE OF COLUMN TABL$R_WRK.DPA_NUMBER
 ,ENT_CS_WRK_ID_BUH       TYPE OF COLUMN TABL$R_CS.WRK_ID_BUH
 ,ENT_CS_WRK_NAME_BUH     TYPE OF COLUMN TABL$R_WRK.NAME
 ,ENT_CS_WRK_INN_BUH      TYPE OF COLUMN TABL$R_WRK.DPA_NUMBER
 ,ENT_CS_WRK_ID_1000075   TYPE OF COLUMN TABL$R_CS.WRK_ID_DIR
 ,ENT_CS_WRK_NAME_1000075 TYPE OF COLUMN TABL$R_WRK.NAME
 ,ENT_CS_WRK_INN_1000075  TYPE OF COLUMN TABL$R_WRK.DPA_NUMBER
 ,ENT_CS_ADDR_ID        TYPE OF COLUMN TABL$R_CS_ADDR.ID
 ,ENT_CS_ADDR_NAME      TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_ADDR_NAME_2    TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_URLS           TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_EMAILS         TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_PHONES         TYPE OF COLUMN TABL$R_CS.COMENT
 ,ENT_CS_PHONE_2        TYPE OF COLUMN TABL$R_CS.COMENT
 ,BANK_ID               TYPE OF COLUMN TABL$R_CS_BANK.ID
 ,BANK_RS               TYPE OF COLUMN TABL$R_CS_BANK.NAME
 ,BANK_MFO              TYPE OF COLUMN TABL$R_BANKS.MFO
 ,BANK_EDRPOU           TYPE OF COLUMN TABL$R_BANKS.EDRPOU
 ,BANK_NAME             TYPE OF COLUMN TABL$R_BANKS.NAME
 ,BANK_ADDRESS          TYPE OF COLUMN TABL$R_BANKS.ADDRESS
 ,FILIAL_ID             TYPE OF COLUMN TABL$R_FILIALS.ID
 ,FILIAL_NAME           TYPE OF COLUMN TABL$R_FILIALS.NAME
 ,FILIAL_FLAG_DELETE    TYPE OF COLUMN TABL$R_FILIALS.FLAG_DELETE
 ,FILIAL_PREFIX         TYPE OF COLUMN TABL$R_FILIALS.PREFIX
 ,FILIAL_GUID           TYPE OF COLUMN TABL$R_FILIALS.GUID
 ,FILIAL_DATABASE_NAME  TYPE OF COLUMN TABL$R_FILIALS.DATABASE_NAME
 ,FILIAL_ADDRESS        TYPE OF COLUMN TABL$R_FILIALS.ADDRESS
 ,FILIAL_PHONE          TYPE OF COLUMN TABL$R_FILIALS.PHONE
 ,FILIAL_COMMAND_ID     TYPE OF COLUMN TABL$R_FILIALS.COMMAND_ID
 ,FILIAL_WRK_ID         TYPE OF COLUMN TABL$R_FILIALS.WRK_ID
 ,FILIAL_GRAPHIK        TYPE OF COLUMN TABL$R_FILIALS.GRAPHIK
)AS
  DECLARE VARIABLE P_COUNTRY_NAME   TYPE OF COLUMN TABL$R_COUNTRIES.NAME;
  DECLARE VARIABLE P_REGION_NAME    TYPE OF COLUMN TABL$R_REGIONS.NAME;
  DECLARE VARIABLE P_ADDRESS_ID     TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_ADDRESS_ZIP    TYPE OF COLUMN TABL$R_CS_ADDR.ZIP;
  DECLARE VARIABLE P_ADDRESS_NAME   TYPE OF COLUMN TABL$R_CS_ADDR.NAME;
BEGIN
  J_ID = :Q_J_ID;

  SELECT FIRST 1 J.FIRM_ID, J.FILIAL_ID
  FROM   TABL$J_4 J
  WHERE  (J.ID = :Q_J_ID)
  INTO   :ID, :FILIAL_ID;

  SELECT FIRST 1 FL.NAME, FL.FLAG_DELETE, FL.PREFIX, FL.GUID,
         FL.DATABASE_NAME, FL.ADDRESS, FL.PHONE, FL.COMMAND_ID, FL.WRK_ID,
         FL.GRAPHIK
  FROM   TABL$R_FILIALS FL
  WHERE  (FL.ID = :FILIAL_ID)
  INTO   :FILIAL_NAME, :FILIAL_FLAG_DELETE, :FILIAL_PREFIX, :FILIAL_GUID,
         :FILIAL_DATABASE_NAME, :FILIAL_ADDRESS, :FILIAL_PHONE, :FILIAL_COMMAND_ID,
         :FILIAL_WRK_ID, :FILIAL_GRAPHIK;

  SELECT FIRST 1 FF.NAME, FF.PATH_LOGO
        ,CS.KIND_ID, CSK.NAME, CSK.SHORT_NAME, CSK.JURIDICAL
        ,CS.ID, CS.NAME, CS.NAME2, CS.FLAG_DELETE, CS.GUID, CS.COMENT
        ,CS.INN, CS.NDS_PAYED, CS.NDS_CODE, CS.EDRPOU, CS.CERTIFICATE
        ,CS.CODEFLAYER, CS.CODECARD, CS.WRK_ID_DIR, CS.WRK_ID_BUH, CS.WRK_ID_1000075
  FROM   TABL$R_FIRMS FF, TABL$R_CS CS, TABL$R_CS_KINDS CSK
  WHERE  (FF.ID = :ID)
    AND  (CS.ID = FF.CS_ID)
    AND  (CSK.ID = CS.KIND_ID)
  INTO   :NAME, :PATH_LOGO
        ,:ENT_CS_KIND_ID, :ENT_CS_KIND_NAME, :ENT_CS_KIND_SHORT, :ENT_CS_KIND_JURIDICAL
        ,:ENT_CS_ID, :ENT_CS_NAME, :ENT_CS_NAME2, :ENT_CS_FLAG_DELETE, :ENT_CS_GUID, :ENT_CS_COMENT
        ,:ENT_CS_INN, :ENT_CS_NDS_PAYED, :ENT_CS_NDS_CODE, :ENT_CS_EDRPOU, :ENT_CS_CERTIFICATE
        ,:ENT_CS_CODEFLAYER, :ENT_CS_CODECARD, :ENT_CS_WRK_ID_DIR, :ENT_CS_WRK_ID_BUH, :ENT_CS_WRK_ID_1000075
        ;
  SELECT FIRST 1 COALESCE(W.NAME,''), COALESCE(W.DPA_NUMBER,'') FROM TABL$R_WRK W WHERE (W.ID = :ENT_CS_WRK_ID_DIR    ) INTO :ENT_CS_WRK_NAME_DIR    , :ENT_CS_WRK_INN_DIR;
  SELECT FIRST 1 COALESCE(W.NAME,''), COALESCE(W.DPA_NUMBER,'') FROM TABL$R_WRK W WHERE (W.ID = :ENT_CS_WRK_ID_BUH    ) INTO :ENT_CS_WRK_NAME_BUH    , :ENT_CS_WRK_INN_BUH;
  SELECT FIRST 1 COALESCE(W.NAME,''), COALESCE(W.DPA_NUMBER,'') FROM TABL$R_WRK W WHERE (W.ID = :ENT_CS_WRK_ID_1000075) INTO :ENT_CS_WRK_NAME_1000075, :ENT_CS_WRK_INN_1000075;

  SELECT LIST(U.NAME,'; ') FROM TABL$R_CS_URL    U WHERE(U.CS_ID = :ENT_CS_ID)INTO :ENT_CS_URLS  ; IF(:ENT_CS_URLS   IS NULL)THEN ENT_CS_URLS   = '';
  SELECT LIST(E.NAME,'; ') FROM TABL$R_CS_EMAIL  E WHERE(E.CS_ID = :ENT_CS_ID)INTO :ENT_CS_EMAILS; IF(:ENT_CS_EMAILS IS NULL)THEN ENT_CS_EMAILS = '';
  SELECT LIST(P.NAME,'; ') FROM TABL$R_CS_PHONES P WHERE(P.CS_ID = :ENT_CS_ID)INTO :ENT_CS_PHONES; IF(:ENT_CS_PHONES IS NULL)THEN ENT_CS_PHONES = '';

  SELECT FIRST 1 P.CYPHERS
  FROM   TABL$R_CS_PHONES P
  WHERE  (P.CS_ID = :ENT_CS_ID)
  INTO   :ENT_CS_PHONE_2; IF(:ENT_CS_PHONE_2 IS NULL)THEN ENT_CS_PHONE_2 = '';
  WHILE(CHAR_LENGTH(:ENT_CS_PHONE_2) < 10)DO
    ENT_CS_PHONE_2 = ' '||:ENT_CS_PHONE_2;
  IF(CHAR_LENGTH(:ENT_CS_PHONE_2) > 10)THEN
    ENT_CS_PHONE_2 = SUBSTRING(:ENT_CS_PHONE_2 FROM CHAR_LENGTH(:ENT_CS_PHONE_2)-9);

  SELECT FIRST 1 CSA.ID
  FROM   TABL$R_CS_ADDR CSA
  WHERE  (CSA.CS_ID = :ENT_CS_ID)
    AND  (CSA.FLAG_JURIDICAL = 1)
  INTO   :ENT_CS_ADDR_ID;

  SELECT FIRST 1 CSA.ZIP, CSA.NAME, CNTR.NAME, REGN.NAME
  FROM   TABL$R_CS_ADDR CSA, TABL$R_COUNTRIES CNTR, TABL$R_REGIONS REGN
  WHERE  (CSA.ID = :ENT_CS_ADDR_ID)
    AND  (CNTR.ID = CSA.COUNTRY_ID)
    AND  (REGN.ID = CSA.REGION_ID)
  INTO   :P_ADDRESS_ZIP, :ENT_CS_ADDR_NAME_2, :P_COUNTRY_NAME, :P_REGION_NAME; IF(:ENT_CS_ADDR_NAME_2 IS NULL)THEN ENT_CS_ADDR_NAME_2 = '';

--  ENT_CS_ADDR_NAME = :P_ADDRESS_ZIP||', '||:P_COUNTRY_NAME||', '||:P_REGION_NAME||', '||:ENT_CS_ADDR_NAME_2;
  ENT_CS_ADDR_NAME = :ENT_CS_ADDR_NAME_2;

  SELECT FIRST 1 B.ID
  FROM   TABL$R_CS_BANK B
  WHERE  (B.CS_ID = :ENT_CS_ID)
    AND  (B.BASE_ACCOUNT = 1)
    AND  (B.COUNTRY_ID   = 1000071)
  INTO   :BANK_ID;

  IF(:BANK_ID IS NULL)THEN
    SELECT FIRST 1 B.ID
    FROM   TABL$R_CS_BANK B
    WHERE  (B.CS_ID = :ENT_CS_ID)
      AND  (B.COUNTRY_ID = 1000071)
    INTO   :BANK_ID;

  SELECT FIRST 1 B1.NAME, BB.MFO, BB.EDRPOU, BB.NAME, BB.ADDRESS
  FROM   TABL$R_CS_BANK B1, TABL$R_BANKS BB
  WHERE  (B1.ID = :BANK_ID)
    AND  (BB.ID = B1.BANK_ID)
  INTO   :BANK_RS, :BANK_MFO, :BANK_EDRPOU, :BANK_NAME, :BANK_ADDRESS;

  ENT_CS_INN_2 = :ENT_CS_INN;
  WHILE(CHAR_LENGTH(:ENT_CS_INN_2) < 12)DO 
    ENT_CS_INN_2 = ' '||:ENT_CS_INN_2;

  ENT_CS_EDRPOU_2 = :ENT_CS_EDRPOU;
  WHILE(CHAR_LENGTH(:ENT_CS_EDRPOU_2) < 12)DO 
    ENT_CS_EDRPOU_2 = ' '||:ENT_CS_EDRPOU_2;
  
  ENT_CS_NDS_CODE_2 = :ENT_CS_NDS_CODE;
  WHILE(CHAR_LENGTH(:ENT_CS_NDS_CODE_2) < 10)DO
    ENT_CS_NDS_CODE_2 = ' '||:ENT_CS_NDS_CODE_2;
  
  ENT_CS_CERTIFICATE_2 = COALESCE(:ENT_CS_CERTIFICATE,'');
  WHILE(CHAR_LENGTH(:ENT_CS_CERTIFICATE_2) < 10)DO
    ENT_CS_CERTIFICATE_2 = ' '||:ENT_CS_CERTIFICATE_2;
  
  ENT_CS_NDS_CODE_2 = :ENT_CS_CERTIFICATE_2;  
  SUSPEND;
END
