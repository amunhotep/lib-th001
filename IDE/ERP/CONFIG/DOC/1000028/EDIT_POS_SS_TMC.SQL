EXECUTE BLOCK (
   Q_PLACE_ID             TYPE OF COLUMN TABL$R_PLACES.ID             = ?PLACE_ID
  ,Q_FIRM_ID              TYPE OF COLUMN TABL$R_FIRMS.ID              = ?FIRM_ID
  ,Q_TMC_GROUP_ID         TYPE OF COLUMN TABL$R_TMC_GROUP.ID          = ?TMC_GROUP_ID
  ,Q_TMC_CTGR_ID          TYPE OF COLUMN TABL$R_TMC_CTGR.ID           = ?TMC_CTGR_ID
  ,Q_FLAG_HIDEZERO        TYPE OF COLUMN TABL$R_TMC_GROUP.FLAG_DELETE = ?FLAG_HIDEZERO
  ,Q_FLAG_SHOWALL         TYPE OF COLUMN TABL$R_TMC_GROUP.FLAG_DELETE = ?FLAG_SHOWALL
)RETURNS (
   FLAG_HIDEZERO          TYPE OF COLUMN TABL$R_TMC_GROUP.FLAG_DELETE
  ,FIRM_ID                TYPE OF COLUMN TABL$R_FIRMS.ID  
  ,PLACE_ID               TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID           TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_VALUE_DATE         TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  /*DOMAINS*/
)
AS
  DECLARE VARIABLE P_TMC_GROUPS TYPE OF COLUMN TABL$J_4.DOCSTR;
  DECLARE VARIABLE P_TMC_CTGRS  TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  FLAG_HIDEZERO = :Q_FLAG_HIDEZERO;
  FIRM_ID  = :Q_FIRM_ID;
  PLACE_ID = :Q_PLACE_ID;
  SELECT FIRST 1 P.NAME, P.ACC_ID FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME, :PLACE_ACC_ID;
  P_TMC_GROUPS = '~';
  P_TMC_CTGRS  = '~';

  IF(:Q_FLAG_SHOWALL <> 1)THEN
    BEGIN
    IF(:Q_TMC_CTGR_ID = 0)THEN
      WITH RECURSIVE TGG AS(
        SELECT TG1.ID, TG1.PARENT_ID FROM TABL$R_TMC_GROUP TG1 WHERE (TG1.ID = :Q_TMC_GROUP_ID)
        UNION ALL
        SELECT TG2.ID, TG2.PARENT_ID FROM TABL$R_TMC_GROUP TG2, TGG TG3 WHERE (TG2.PARENT_ID = TG3.ID)
      )SELECT '~'||LIST(T.ID,'~')||'~' FROM TGG T INTO :P_TMC_GROUPS;
  
    IF(:Q_TMC_GROUP_ID = 0)THEN
      WITH RECURSIVE TGG AS(
        SELECT TG1.ID, TG1.PARENT_ID FROM TABL$R_TMC_CTGR TG1 WHERE (TG1.ID = :Q_TMC_CTGR_ID)
        UNION ALL
        SELECT TG2.ID, TG2.PARENT_ID FROM TABL$R_TMC_CTGR TG2, TGG TG3 WHERE (TG2.PARENT_ID = TG3.ID)
      )SELECT '~'||LIST(T.ID,'~')||'~' FROM TGG T INTO :P_TMC_CTGRS;
    END
  FOR
    SELECT TMC.ID, TMC.NAME, TMC.ARTICLE, TMC.BARCODE,TMC.LGTH, TMC.DIAM, TMC.TMC_GROUP_ID
          ,(SELECT FIRST 1 TG.NAME FROM TABL$R_TMC_GROUP TG WHERE(TG.ID = TMC.TMC_GROUP_ID)) AS TMC_GROUP_NAME
    FROM   TABL$R_TMC TMC
    WHERE  (TMC.FLAG_DELETE <> 1)
      AND  (  (:Q_FLAG_SHOWALL = 1)
            OR( (:Q_TMC_CTGR_ID  = 0) AND (:P_TMC_GROUPS CONTAINING '~'||TMC.TMC_GROUP_ID||'~') )
            OR( (:Q_TMC_GROUP_ID = 0) AND (:P_TMC_CTGRS  CONTAINING '~'||TMC.TMC_CTGR_ID||'~' ) )
           ) 
    ORDER BY TMC.NAME, TMC.ARTICLE
    INTO   :TMC_ID, :TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :TMC_LGTH, :TMC_DIAM, :TMC_GROUP_ID, :TMC_GROUP_NAME
  DO
    BEGIN
    PRICE = 0;
    SELECT FIRST 1 PR.PRICE, PR.VALUE_DATE
    FROM   TABL$R_TMC_P PR, TABL$R_TMC TMC
    WHERE  (TMC.ID        = :TMC_ID)
      AND  (PR.TMC_ID     = TMC.ID)
      AND  (PR.VALUE_DATE = TMC.VALUE_DATE)
    INTO   :PRICE, :TMC_VALUE_DATE; IF(:PRICE IS NULL)THEN PRICE = 0;
    
    /*SELECT*/    
    
    TOTAL = :PRICE * :QUANT;
    IF(NOT ((:Q_FLAG_HIDEZERO = 1)AND(:QUANT = 0)))THEN
      SUSPEND;
    END
END
