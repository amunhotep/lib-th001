EXECUTE BLOCK (
  Q_J_ID           TYPE OF COLUMN TABL$J_4.ID = ?ID
 ,Q_COUNTRIESTP_ID TYPE OF COLUMN TABL$R_COUNTRIESTP.ID   = ?COUNTRIESTP_ID
)RETURNS(
  J_ID             TYPE OF COLUMN TABL$J_4.ID
)AS
  DECLARE VARIABLE P_ID          TYPE OF COLUMN TABL$D_1000014.ID;
  DECLARE VARIABLE P_TMC_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_COUNTRY_ID  TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID;
  DECLARE VARIABLE P_PROBE       TYPE OF COLUMN TABL$R_TMC.PROBE;
  DECLARE VARIABLE P_MASSA_NETTO TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO;
  DECLARE VARIABLE P_PRICE       TYPE OF COLUMN TABL$R_TMC_P.PRICE;
BEGIN
  J_ID = :Q_J_ID;
  FOR
    SELECT D.ID, D.TMC_ID, TMC.COUNTRY_ID, TMC.PROBE, TMC.MASSA_NETTO
    FROM   TABL$D_1000014 D, TABL$R_TMC TMC
    WHERE  (D.J_ID = :J_ID)
      AND  (TMC.ID = D.TMC_ID)
    INTO   :P_ID, :P_TMC_ID, :P_COUNTRY_ID, :P_PROBE, :P_MASSA_NETTO
  DO
    BEGIN
    SELECT FIRST 1 COALESCE((:P_MASSA_NETTO * CE.KURS),0) AS PRICE
    FROM   TABL$R_COUNTRIESEX CE
    WHERE  (CE.COUNTRY_ID     = :P_COUNTRY_ID)
      AND  (CE.NAME           = :P_PROBE)
      AND  (CE.COUNTRIESTP_ID = :Q_COUNTRIESTP_ID)
    INTO   :P_PRICE; IF(:P_PRICE IS NULL)THEN P_PRICE = 0;
    P_PRICE = ROUND(:P_PRICE, 2);
    UPDATE TABL$D_1000014 D SET
      D.PRICE     = :P_PRICE
     ,D.PRICE_TMC = :P_PRICE
    WHERE (D.ID = :P_ID);
    END
  SUSPEND;
END
