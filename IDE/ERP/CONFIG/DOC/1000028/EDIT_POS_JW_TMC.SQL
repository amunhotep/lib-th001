EXECUTE BLOCK (
   Q_PLACE_ID             TYPE OF COLUMN TABL$R_PLACES.ID    = ?PLACE_ID
  ,Q_TMC_GROUP_ID         TYPE OF COLUMN TABL$R_TMC_GROUP.ID = ?TMC_GROUP_ID
  ,Q_FIRM_ID              TYPE OF COLUMN TABL$R_TMC_GROUP.ID = ?FIRM_ID
)RETURNS (
   FIRM_ID                TYPE OF COLUMN TABL$R_FIRMS.ID
  ,FIRM_NAME              TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,PLACE_ID               TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID           TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,COUNTRY_ID             TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,VALUTE                 TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE              TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_MASSA              TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_VALUE_DATE         TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
)
AS
BEGIN
  FIRM_ID  = :Q_FIRM_ID;
  PLACE_ID = :Q_PLACE_ID;
  SELECT FIRST 1 F.NAME           FROM TABL$R_FIRMS  F WHERE(F.ID = :FIRM_ID )INTO :FIRM_NAME;
  SELECT FIRST 1 P.NAME, P.ACC_ID FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME, :PLACE_ACC_ID;

  FOR
    SELECT TQ1.TMC_ID, TQ1.QUANT
          ,TMC.NAME, TMC.ARTICLE, TMC.BARCODE, TMC.COUNTRY_ID, TMC.PROBE
          ,(SELECT FIRST 1 C.VALUTE FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID)) AS VALUTE
          ,TMC.MASSA, (TMC.MASSA - TMC.MASSA_NETTO) AS MASSA_INS, TMC.MASSA_NETTO
          ,TMC.LGTH, TMC.DIAM, TMC.TMC_GROUP_ID, TG.NAME AS TMC_GROUP_NAME
    FROM    TABL$P_TMC_QUANT TQ1, TABL$R_TMC TMC, TABL$R_TMC_GROUP TG
    WHERE  ((TQ1.FIRM_ID+0)  = :FIRM_ID)
      AND  ((TQ1.PLACE_ID+0) = :PLACE_ID)
      AND  (TMC.ID = TQ1.TMC_ID)
      AND  (TMC.TMC_GROUP_ID = :Q_TMC_GROUP_ID)
      AND  (TG.ID = TMC.TMC_GROUP_ID)
    ORDER BY TMC.NAME, TMC.ARTICLE
    INTO   :TMC_ID, :QUANT
          ,:TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :COUNTRY_ID, :TMC_PROBE, :VALUTE
          ,:TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO, :TMC_LGTH, :TMC_DIAM
          ,:TMC_GROUP_ID, :TMC_GROUP_NAME
  DO
    IF(:QUANT <> 0)THEN
      BEGIN
      SELECT FIRST 1 PR.PRICE, PR.VALUE_DATE
      FROM   TABL$R_TMC_P PR, TABL$R_TMC TMC
      WHERE  (TMC.ID        = :TMC_ID)
        AND  (PR.TMC_ID     = TMC.ID)
        AND  (PR.VALUE_DATE = TMC.VALUE_DATE)
      INTO   :PRICE, :TMC_VALUE_DATE; IF(:PRICE IS NULL)THEN PRICE = 0;
      TOTAL = :PRICE * :QUANT;
      SUSPEND;
      END
END
