EXECUTE BLOCK (
  Q_J_ID       TYPE OF COLUMN TABL$J_4.ID = ?ID
 ,Q_PAYSRC_ID  TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID = ?PAYSRC_ID
 ,Q_PAYSRC_ID2 TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID = ?PAYSRC_ID2
)RETURNS (
  ID     TYPE OF COLUMN TABL$J_4.ID
)
AS
  DECLARE VARIABLE P_DOCSUM       TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_DOCSUM2      TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_FIRM_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_CS_ID        TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_J_1000020_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000021_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000026_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_TMC_ID       TYPE OF COLUMN TABL$R_TMC_P.TMC_ID;
  DECLARE VARIABLE P_PRICE        TYPE OF COLUMN TABL$R_TMC_P.PRICE;
  DECLARE VARIABLE P_VALUE_DATE   TYPE OF COLUMN TABL$R_TMC_P.VALUE_DATE;
BEGIN
  ID = :Q_J_ID;
  SELECT FIRST 1 J.DOCSUM, J.FIRM_ID, J14.CS_ID
  FROM   TABL$J_4 J, TABL$J_1000014 J14
  WHERE  (J.ID = :ID)
    AND  (J14.J_ID = J.ID)
  INTO   :P_DOCSUM, :P_FIRM_ID, :P_CS_ID;
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :ID);
  
  P_J_1000026_ID = 0;
  SELECT COALESCE(MIN(J.ID),0)
  FROM   TABL$J_CHILDS JC, TABL$J_4 J
  WHERE  (JC.J_ID = :ID)
    AND  (J.ID = JC.J_CHILD_ID)
    AND  (J.TYPE_ID = 1000026)
  INTO   :P_J_1000026_ID;

  -- PAYMENT
  SELECT FIRST 1 P.J_ID
  FROM   PROC$J_INS_1000020(:P_FIRM_ID, 'Оплата за ювелiрнi вироби', :ID) P
  INTO   :P_J_1000020_ID;
  UPDATE TABL$J_1000016 J16 SET
     J16.ACC_ID      = 361
    ,J16.SUBKONTO_ID = :P_CS_ID
    ,J16.PAYSRC_ID   = :Q_PAYSRC_ID2
  WHERE (J16.J_ID = :P_J_1000020_ID);
  IF((:Q_PAYSRC_ID2 <> :Q_PAYSRC_ID) AND (:P_J_1000026_ID<>0))THEN
    BEGIN
    SELECT FIRST 1 COALESCE(J.DOCSUM,0) FROM TABL$J_4 J WHERE (J.ID = :P_J_1000026_ID) INTO :P_DOCSUM2;
    UPDATE TABL$J_4 J SET J.DOCSUMVAL = COALESCE((:P_DOCSUM - :P_DOCSUM2), :P_DOCSUM) WHERE (J.ID = :P_J_1000020_ID);
    END
   ELSE
    BEGIN 
    UPDATE TABL$J_4 J SET J.DOCSUMVAL = :P_DOCSUM WHERE (J.ID = :P_J_1000020_ID);
    END
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_1000020_ID);

  IF(:P_J_1000026_ID = 0)THEN EXIT;
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_1000026_ID);
  SELECT FIRST 1 COALESCE(J.DOCSUM,0), J.DATE_COMMIT FROM TABL$J_4 J WHERE (J.ID = :P_J_1000026_ID) INTO :P_DOCSUM, :P_VALUE_DATE;
  FOR
    SELECT D.TMC_ID, D.PRICE
    FROM   TABL$D_1000014 D
    WHERE  (D.J_ID = :P_J_1000026_ID)
    INTO   :P_TMC_ID, :P_PRICE
  DO
    UPDATE OR INSERT INTO TABL$R_TMC_P (
      TMC_ID, VALUE_DATE, PRICE, PRICE_IN, PRICE_1, PRICE_2, PRICE_3, PRICE_4, PRICE_5, J_ID
    )VALUES(
      :P_TMC_ID, :P_VALUE_DATE, :P_PRICE, :P_PRICE, :P_PRICE, :P_PRICE, :P_PRICE, :P_PRICE, :P_PRICE, :P_J_1000026_ID
    )MATCHING (TMC_ID, VALUE_DATE);      

  IF(:Q_PAYSRC_ID2 <> :Q_PAYSRC_ID)THEN EXIT;
  SELECT FIRST 1 P.J_ID
  FROM   PROC$J_INS_1000021(:P_FIRM_ID, 'Оплата за брухт дорогоцінних металiв', :P_J_1000026_ID) P
  INTO   :P_J_1000021_ID;
  UPDATE TABL$J_1000016 J16 SET
     J16.ACC_ID      = 3611
    ,J16.SUBKONTO_ID = :P_CS_ID
    ,J16.PAYSRC_ID   = :Q_PAYSRC_ID
  WHERE (J16.J_ID = :P_J_1000021_ID);
  UPDATE TABL$J_4 J SET J.DOCSUMVAL = :P_DOCSUM WHERE (J.ID = :P_J_1000021_ID);
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_1000021_ID);

  SUSPEND;
END
