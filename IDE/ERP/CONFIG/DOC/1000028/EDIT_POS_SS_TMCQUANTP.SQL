EXECUTE BLOCK (
   Q_FIRM_ID       TYPE OF COLUMN TABL$R_FIRMS.ID        = ?FIRM_ID
  ,Q_PLACE_ID      TYPE OF COLUMN TABL$R_PLACES.ID       = ?PLACE_ID
  ,Q_TMC_ID        TYPE OF COLUMN TABL$R_TMC.ID          = ?TMC_ID
  ,Q_FLAG_HIDEZERO TYPE OF COLUMN TABL$R_TMC.FLAG_DELETE = ?FLAG_HIDEZERO
)RETURNS (
   FIRM_ID                TYPE OF COLUMN TABL$R_FIRMS.ID
  ,FIRM_NAME              TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,PLACE_ID               TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_VALUE_DATE         TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE                  TYPE OF COLUMN TABL$P_TMCQUANT.PRICE
  ,QUANT                  TYPE OF COLUMN TABL$P_TMCQUANT.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$P_TMCQUANT.TOTAL
  ,J_ID                   TYPE OF COLUMN TABL$J_4.ID
  ,J_TYPE_NAME            TYPE OF COLUMN TABL$J_4.NAME
  ,J_DOCNUMBERSTR         TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_DATE_COMMIT          TYPE OF COLUMN TABL$J_4.DATE_COMMIT
)
AS
  DECLARE VARIABLE P_SAVE_PLACE_ID TYPE OF COLUMN TABL$R_PLACES.ID;
BEGIN
  P_SAVE_PLACE_ID  = :Q_PLACE_ID;
  FIRM_ID   = :Q_FIRM_ID;
  TMC_ID    = :Q_TMC_ID;
  SELECT FIRST 1 P.NAME FROM TABL$R_FIRMS  P WHERE(P.ID = :FIRM_ID )INTO :FIRM_NAME;
  SELECT FIRST 1 TMC.NAME, TMC.ARTICLE, TMC.BARCODE
  FROM   TABL$R_TMC TMC
  WHERE  (TMC.ID = :TMC_ID)
  INTO   :TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE;

  FOR
    SELECT Q.PLACE_ID, Q.QUANT, Q.PRICE_IN, TT.NAME2, J.DOCNUMBERSTR, Q.J_ID, Q.DATE_COMMIT
    FROM   TABL$P_TMCQUANT Q, TABL$J_4 J, TABL$_TB_TYPES TT
    WHERE  ((Q.FIRM_ID+0)  = :FIRM_ID)
      AND  ( (:P_SAVE_PLACE_ID = 0) OR ((Q.PLACE_ID+0) = :P_SAVE_PLACE_ID))
      AND  (Q.TMC_ID = :TMC_ID)
      AND  (Q.FLAG_DEBET = 1)
      AND  (J.ID = Q.J_ID)
      AND  (TT.ID = J.TYPE_ID)
      AND  ( (:Q_FLAG_HIDEZERO = 0) OR (Q.QUANT > 0) )
    ORDER BY Q.DATE_COMMIT  
    INTO   :PLACE_ID, :QUANT, :PRICE, :J_TYPE_NAME, :J_DOCNUMBERSTR, :J_ID, :J_DATE_COMMIT
  DO
    BEGIN
    SELECT FIRST 1 P.NAME FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME;
    TOTAL = :PRICE * :QUANT;
    IF(:QUANT <> 0)THEN
      SUSPEND;
    END
END
