EXECUTE BLOCK (
  Q_J_ID       TYPE OF COLUMN TABL$J_4.ID = ?ID
 ,Q_PAYSRC_ID  TYPE OF COLUMN TABL$J_1000016.PAYSRC_ID = ?PAYSRC_ID
 ,Q_PAYSUM     TYPE OF COLUMN TABL$J_4.DOCSUM = ?PAYSUM
)RETURNS (
  ID     TYPE OF COLUMN TABL$J_4.ID
)
AS
  DECLARE VARIABLE P_DOCSUM       TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_DOCSUM2      TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_FIRM_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_CS_ID        TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_DOCNUMBER    TYPE OF COLUMN TABL$J_4.DOCNUMBER;
  DECLARE VARIABLE P_J_1000020_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000021_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000026_ID TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_TMC_ID       TYPE OF COLUMN TABL$R_TMC_P.TMC_ID;
  DECLARE VARIABLE P_PRICE        TYPE OF COLUMN TABL$R_TMC_P.PRICE;
  DECLARE VARIABLE P_VALUE_DATE   TYPE OF COLUMN TABL$R_TMC_P.VALUE_DATE;
BEGIN
  ID = :Q_J_ID;
  SELECT FIRST 1 J.DOCSUM, J.FIRM_ID, J14.CS_ID, J.DATE_COMMIT
  FROM   TABL$J_4 J, TABL$J_1000014 J14
  WHERE  (J.ID = :ID)
    AND  (J14.J_ID = J.ID)
  INTO   :P_DOCSUM, :P_FIRM_ID, :P_CS_ID, :P_DATE_COMMIT;

  SELECT FIRST 1 P.NEW_NUMBER FROM PROC$J_GEN_4(1000028, :P_FIRM_ID)P INTO :P_DOCNUMBER;
  
  UPDATE TABL$J_4 J SET J.TYPE_ID = 1000028, J.DOCNUMBER = :P_DOCNUMBER WHERE (J.ID = :ID);

  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :ID);
  
  -- PAYMENT
  SELECT FIRST 1 P.J_ID
  FROM   PROC$J_INS_1000020(:P_FIRM_ID, 'Оплата за товар, или доставку, или предоставление услуг', :ID) P
  INTO   :P_J_1000020_ID;
  
  UPDATE TABL$J_1000016 J16 SET
     J16.ACC_ID      = 361
    ,J16.SUBKONTO_ID = :P_CS_ID
    ,J16.PAYSRC_ID   = :Q_PAYSRC_ID
  WHERE (J16.J_ID = :P_J_1000020_ID);
  
  UPDATE TABL$J_4 J SET 
     J.DOCSUMVAL   = :Q_PAYSUM 
    ,J.DATE_COMMIT = :P_DATE_COMMIT 
  WHERE (J.ID = :P_J_1000020_ID);
  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :P_J_1000020_ID);

  SUSPEND;
END
