EXECUTE BLOCK (
   Q_PLACE_ID      TYPE OF COLUMN TABL$R_PLACES.ID       = ?PLACE_ID
  ,Q_TMC_ID        TYPE OF COLUMN TABL$R_TMC.ID          = ?TMC_ID
  ,Q_FLAG_HIDEZERO TYPE OF COLUMN TABL$R_TMC.FLAG_DELETE = ?FLAG_HIDEZERO
)RETURNS (
   PLACE_ID               TYPE OF COLUMN TABL$R_PLACES.ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,PLACE_ACC_ID           TYPE OF COLUMN TABL$R_PLACES.ACC_ID
  ,IN_TMC_ID              TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_REPLACELVLS_ID     TYPE OF COLUMN TABL$R_TMC_REPLACELVLS.ID
  ,TMC_REPLACELVLS_NAME   TYPE OF COLUMN TABL$R_TMC_REPLACELVLS.NAME
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC_GROUP.ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_ID                 TYPE OF COLUMN TABL$R_TMC.ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_VALUE_DATE         TYPE OF COLUMN TABL$R_TMC.VALUE_DATE
  ,PRICE                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,QUANT                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$P_TMC_QUANT.QUANT
  /*DOMAINS*/
)
AS
BEGIN
  PLACE_ID  = :Q_PLACE_ID;
  IN_TMC_ID = :Q_TMC_ID;
  SELECT FIRST 1 P.NAME, P.ACC_ID FROM TABL$R_PLACES P WHERE(P.ID = :PLACE_ID)INTO :PLACE_NAME, :PLACE_ACC_ID;
  FOR
    SELECT TMP.ID, TMP.NAME
          ,TMC.ID, TMC.NAME, TMC.ARTICLE, TMC.BARCODE,TMC.LGTH, TMC.DIAM, TMC.TMC_GROUP_ID
          ,(SELECT FIRST 1 TG.NAME FROM TABL$R_TMC_GROUP TG WHERE(TG.ID = TMC.TMC_GROUP_ID)) AS TMC_GROUP_NAME
    FROM   TABL$R_TMC TMC, (
             SELECT RR1.TMC_REPLACE_ID AS TMC_ID, RL1.ID, RL1.NAME
             FROM   TABL$R_TMC_REPLACE RR1, TABL$R_TMC_REPLACELVLS RL1
             WHERE  (RR1.TMC_ID = :IN_TMC_ID)
               AND  (RR1.TMC_REPLACELVLS_ID = 4)
               AND  (RL1.ID = RR1.TMC_REPLACELVLS_ID)
             UNION ALL
             SELECT RR2.TMC_ID AS TMC_ID, RL2.ID, RL2.NAME
             FROM   TABL$R_TMC_REPLACE RR2, TABL$R_TMC_REPLACELVLS RL2
             WHERE  (RR2.TMC_REPLACE_ID = :IN_TMC_ID)
               AND  (RR2.TMC_REPLACELVLS_ID = 4)
               AND  (RL2.ID = RR2.TMC_REPLACELVLS_ID)
           )TMP
    WHERE  (TMC.ID = TMP.TMC_ID)
    ORDER BY TMC.NAME, TMC.ARTICLE
    INTO   :TMC_REPLACELVLS_ID, :TMC_REPLACELVLS_NAME
          ,:TMC_ID, :TMC_NAME, :TMC_ARTICLE, :TMC_BARCODE, :TMC_LGTH, :TMC_DIAM, :TMC_GROUP_ID, :TMC_GROUP_NAME
  DO
    BEGIN
    PRICE = 0;
    SELECT FIRST 1 PR.PRICE, PR.VALUE_DATE
    FROM   TABL$R_TMC_P PR, TABL$R_TMC TMC
    WHERE  (TMC.ID        = :TMC_ID)
      AND  (PR.TMC_ID     = TMC.ID)
      AND  (PR.VALUE_DATE = TMC.VALUE_DATE)
    INTO   :PRICE, :TMC_VALUE_DATE; IF(:PRICE IS NULL)THEN PRICE = 0;
    
    /*SELECT*/

    TOTAL = :PRICE * :QUANT;
    IF(NOT ((:Q_FLAG_HIDEZERO = 1)AND(:QUANT = 0)))THEN
      SUSPEND;
    END
END
