EXECUTE BLOCK (
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?ID
)RETURNS (
  ID     TYPE OF COLUMN TABL$J_4.ID
)
AS
  DECLARE VARIABLE P_DOCSUM       TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_DOCSUM2      TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_FIRM_ID      TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_CS_ID        TYPE OF COLUMN TABL$J_1000014.CS_ID;
  DECLARE VARIABLE P_TAX_ID       TYPE OF COLUMN TABL$J_1000014.TAX_ID;
  DECLARE VARIABLE P_TAX_RATE     TYPE OF COLUMN TABL$J_1000014.TAX_ID;
  DECLARE VARIABLE P_VALUE_DATE   TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_DOCNUMBER    TYPE OF COLUMN TABL$J_4.DOCNUMBER;

  DECLARE VARIABLE P_D_ID         TYPE OF COLUMN TABL$D_1000014.ID;
  DECLARE VARIABLE P_D_PRICE      TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE P_D_QUANT      TYPE OF COLUMN TABL$D_1000014.QUANT;
  DECLARE VARIABLE P_D_TOTAL      TYPE OF COLUMN TABL$D_1000014.TOTAL;
  DECLARE VARIABLE P_D_NDPTOTAL   TYPE OF COLUMN TABL$D_1000014.NDPTOTAL;
BEGIN
  ID = :Q_J_ID;
  SELECT FIRST 1 J.DOCSUM, J.FIRM_ID, J14.CS_ID, J14.TAX_ID
  FROM   TABL$J_4 J, TABL$J_1000014 J14
  WHERE  (J.ID = :ID)
    AND  (J14.J_ID = J.ID)
  INTO   :P_DOCSUM, :P_FIRM_ID, :P_CS_ID, :P_TAX_ID;

  -- GETTING NDP
  P_VALUE_DATE = NULL;
  P_TAX_RATE   = 0;
  SELECT MAX(TP.VALUE_DATE)
  FROM   TABL$R_TAXES_FIRMS TF, TABL$R_TAXES_FIRMS_P TP
  WHERE  ((TF.FIRM_ID+0) = :P_FIRM_ID)
    AND  (TF.TAX_ID = :P_TAX_ID)
    AND  (TP.TAXFIRM_ID = TF.ID)
    AND  (TP.VALUE_DATE <= CURRENT_TIMESTAMP)
  INTO   :P_VALUE_DATE;
  IF(:P_VALUE_DATE IS NULL)THEN
    SELECT MAX(TP.VALUE_DATE)
    FROM   TABL$R_TAXES_FIRMS TF, TABL$R_TAXES_FIRMS_P TP
    WHERE  ((TF.FIRM_ID+0) = :P_FIRM_ID)
      AND  (TF.TAX_ID = :P_TAX_ID)
      AND  (TP.TAXFIRM_ID = TF.ID)
    INTO   :P_VALUE_DATE;
  SELECT FIRST 1 COALESCE(TP.RATE,0)
  FROM   TABL$R_TAXES_FIRMS TF, TABL$R_TAXES_FIRMS_P TP
  WHERE  ((TF.FIRM_ID+0) = :P_FIRM_ID)
    AND  (TF.TAX_ID      = :P_TAX_ID)
    AND  (TP.TAXFIRM_ID  = TF.ID)
    AND  (TP.VALUE_DATE  = :P_VALUE_DATE)
  INTO   :P_TAX_RATE;

  SELECT FIRST 1 P.NEW_NUMBER FROM PROC$J_GEN_4(1000075, :P_FIRM_ID)P INTO :P_DOCNUMBER;
  
  UPDATE TABL$J_4 J SET J.TYPE_ID = 1000075, J.DOCNUMBER = :P_DOCNUMBER WHERE (J.ID = :ID);

  FOR
    SELECT D.ID, D.QUANT, D.TOTAL, D.NDPTOTAL
    FROM   TABL$D_1000014 D
    WHERE  (D.J_ID = :ID)
    INTO   :P_D_ID, :P_D_QUANT, :P_D_TOTAL, :P_D_NDPTOTAL
  DO
    BEGIN
    IF(:P_TAX_ID = 1000010)THEN
      P_D_PRICE = (:P_D_TOTAL - ABS(:P_D_NDPTOTAL)) / :P_D_QUANT;
    ELSE
      P_D_PRICE = :P_D_TOTAL / :P_D_QUANT;

    IF((:P_D_PRICE - TRUNC(:P_D_PRICE,0)) <= 0.5)THEN
      P_D_PRICE = TRUNC(:P_D_PRICE, 0) + 0.50;
    ELSE
      P_D_PRICE = TRUNC(:P_D_PRICE, 0) + 1.00;

    IF(:P_TAX_ID = 1000010)THEN
      P_D_PRICE = :P_D_PRICE * (100 + ABS(:P_TAX_RATE)) / 100;

    UPDATE TABL$D_1000014 D SET
      D.PRICE = :P_D_PRICE
    WHERE (D.ID = :P_D_ID);
    END

  UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = :ID);
  
  SUSPEND;
END
