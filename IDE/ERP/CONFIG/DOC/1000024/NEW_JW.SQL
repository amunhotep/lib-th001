EXECUTE BLOCK AS
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DATE        TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_PLACE_ID    TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_TO_PLACE_ID TYPE OF COLUMN TABL$J_1000014.TO_PLACE_ID;
  DECLARE VARIABLE P_ID          TYPE OF COLUMN TABL$D_1000014.ID;
  DECLARE VARIABLE P_J_ID        TYPE OF COLUMN TABL$D_1000014.J_ID;
  DECLARE VARIABLE P_TMC_ID      TYPE OF COLUMN TABL$D_1000014.TMC_ID;
  DECLARE VARIABLE P_PRICE       TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE P_DATEPRICE   TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_QUANT       TYPE OF COLUMN TABL$D_1000014.QUANT;
BEGIN
  P_J_ID        = ?ID;

  P_PLACE_ID    = 1000004;
  P_TO_PLACE_ID = 1000000;
  SELECT FIRST 1 J.FIRM_ID, J.DATE_COMMIT
  FROM   TABL$J_4 J
  WHERE  (J.ID = :P_J_ID)
  INTO   :P_FIRM_ID, :P_DATE;
  UPDATE TABL$J_4 J SET J.NAME = 'Сдача лома драгоценных металлов, приобретенного на обмен' WHERE (J.ID = :P_J_ID);
  UPDATE TABL$J_1000014 J SET J.PLACE_ID = :P_PLACE_ID, J.TO_PLACE_ID = :P_TO_PLACE_ID WHERE (J.J_ID = :P_J_ID);

  DELETE FROM TABL$D_1000014 D WHERE (D.J_ID = :P_J_ID);
  FOR
    SELECT Q.TMC_ID, SUM(Q.QUANT)
    FROM   (SELECT  TQ1.FIRM_ID, TQ1.PLACE_ID, TQ1.TMC_ID, TQ1.QUANT
            FROM    TABL$P_TMC_QUANT TQ1, TABL$R_TMC TMC
            WHERE  ((TQ1.FIRM_ID+0) = :P_FIRM_ID)
              AND  (TQ1.PLACE_ID = :P_PLACE_ID)
              AND  (TMC.ID = TQ1.TMC_ID)
              AND  (TMC.TMC_GROUP_ID = 3000091)
            UNION ALL  -- DEBET
            SELECT  TQD.FIRM_ID, TQD.PLACE_ID, TQD.TMC_ID, ((-1) * TQD.QUANT) AS QUANT
            FROM    TABL$P_TMC_QUANT_MOVE TQD, TABL$R_TMC TMC
            WHERE  ((TQD.FIRM_ID+0) = :P_FIRM_ID)
              AND  ((TQD.PLACE_ID+0) = :P_PLACE_ID)
              AND  (TQD.FLAG_DEBET = 1)
              AND  (TQD.DATE_COMMIT >= :P_DATE)
              AND  (TMC.ID = TQD.TMC_ID)
              AND  (TMC.TMC_GROUP_ID = 3000091)
            UNION ALL  -- KREDIT
            SELECT TQK.FIRM_ID, TQK.PLACE_ID, TQK.TMC_ID, TQK.QUANT
            FROM    TABL$P_TMC_QUANT_MOVE TQK, TABL$R_TMC TMC
            WHERE  ((TQK.FIRM_ID+0) = :P_FIRM_ID)
              AND  ((TQK.PLACE_ID+0) = :P_PLACE_ID)
              AND  (TQK.FLAG_DEBET = 0)
              AND  (TQK.DATE_COMMIT >= :P_DATE)
              AND  (TMC.ID = TQK.TMC_ID)
              AND  (TMC.TMC_GROUP_ID = 3000091)
            )Q
    GROUP BY Q.FIRM_ID, Q.PLACE_ID, Q.TMC_ID
    INTO    :P_TMC_ID, :P_QUANT
  DO
    BEGIN
    SELECT MAX(P1.VALUE_DATE)
    FROM   TABL$R_TMC_P P1
    WHERE  (P1.TMC_ID = :P_TMC_ID)
      AND  (P1.VALUE_DATE <= :P_DATE)
    INTO   :P_DATEPRICE;
    SELECT FIRST 1 COALESCE(P2.PRICE,0)
    FROM   TABL$R_TMC_P P2
    WHERE  (P2.TMC_ID = :P_TMC_ID)
      AND  (P2.VALUE_DATE = :P_DATEPRICE)
    INTO   :P_PRICE; IF(:P_PRICE IS NULL)THEN P_PRICE = 0;
    IF(:P_PRICE = 0)THEN                 
      SELECT FIRST 1 COALESCE(P2.PRICE,0)
      FROM   TABL$R_TMC TMC, TABL$R_TMC_P P2
      WHERE  (TMC.ID = :P_TMC_ID)
        AND  (P2.TMC_ID = TMC.ID)
        AND  (P2.VALUE_DATE = TMC.VALUE_DATE)
      INTO   :P_PRICE;
    
    INSERT INTO TABL$D_1000014 (NAME, J_ID, TMC_ID, PRICE, QUANT, J_BILLS_ID, PRICE_TMC)
      VALUES ('Автоматическое перемещение лома драг. металлов',:P_J_ID, :P_TMC_ID, :P_PRICE, :P_QUANT, 0, :P_PRICE)
      RETURNING id into :P_ID;
    UPDATE TABL$D_1000014 D SET D.PRICE = :P_PRICE WHERE (D.ID = :P_ID);
    END
END
