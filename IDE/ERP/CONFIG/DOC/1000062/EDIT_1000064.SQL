EXECUTE BLOCK (
  Q_J_ID           TYPE OF COLUMN TABL$J_4.ID = ?ID
)RETURNS(
  ID               TYPE OF COLUMN TABL$D_1000014.ID,
  NAME             TYPE OF COLUMN TABL$D_1000014.NAME,
  FLAG_DELETE      TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE,
  J_ID             TYPE OF COLUMN TABL$D_1000014.J_ID,
  TMC_ID           TYPE OF COLUMN TABL$D_1000014.TMC_ID,
  TMC_LIST_ID      TYPE OF COLUMN TABL$R_TMC.TMC_LIST_ID,
  TMC_NAME         TYPE OF COLUMN TABL$R_TMC.NAME,
  TMC_ARTICLE      TYPE OF COLUMN TABL$R_TMC.ARTICLE,
  TMC_NUMSHOW      TYPE OF COLUMN TABL$R_TMC.NUMSHOW,
  TMC_EDIZM_ID     TYPE OF COLUMN TABL$R_TMC.EDIZM_ID,
  TMC_COUNTRY_ID   TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID,
  TMC_COUNTRY_NAME TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE,
  TMC_PROBE        TYPE OF COLUMN TABL$R_TMC.PROBE,
  TMC_MASSA        TYPE OF COLUMN TABL$R_TMC.MASSA,
  TMC_MASSA_INS    TYPE OF COLUMN TABL$R_TMC.MASSA,
  TMC_MASSA_NETTO  TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO,
  EDIZM_NAME       TYPE OF COLUMN TABL$R_EDIZM.NAME,
  EDIZM_SHORT      TYPE OF COLUMN TABL$R_EDIZM.SHORT_NAME,
  PRICE            TYPE OF COLUMN TABL$D_1000014.PRICE,
  QUANT            TYPE OF COLUMN TABL$D_1000014.QUANT,
  TOTAL            TYPE OF COLUMN TABL$D_1000014.PRICE,
  PRICEPL          TYPE OF COLUMN TABL$D_1000014.PRICE,
  QUANTPL          TYPE OF COLUMN TABL$D_1000014.QUANT,
  TOTALPL          TYPE OF COLUMN TABL$D_1000014.PRICE
)AS
  DECLARE VARIABLE P_J_ID       TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID    TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_PLACE_ID   TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_PRICE_DATE TYPE OF COLUMN TABL$R_TMC_P.VALUE_DATE;
BEGIN
  SELECT FIRST 1 J4.ID
  FROM   TABL$J_CHILDS JC, TABL$J_4 J4
  WHERE  (JC.J_ID = :Q_J_ID)
    AND  (J4.ID = JC.J_CHILD_ID)
    AND  (J4.TYPE_ID = 1000064)
  INTO   :P_J_ID;
  SELECT FIRST 1 J4.FIRM_ID, J14.PLACE_ID
  FROM   TABL$J_4 J4, TABL$J_1000014 J14
  WHERE  (J4.ID = :P_J_ID)
    AND  (J14.J_ID = J4.ID)
  INTO   :P_FIRM_ID, :P_PLACE_ID;
  FOR
    SELECT DB.ID, DB.NAME, DB.J_ID, DB.TMC_ID, TMC.NAME, TMC.ARTICLE, TMC.NUMSHOW,
           TMC.TMC_LIST_ID,  TMC.EDIZM_ID, E.NAME, E.SHORT_NAME, TMC.COUNTRY_ID, TMC.PROBE,
           TMC.MASSA, TMC.MASSA_NETTO, DB.QUANT, DB.PRICE
    FROM   TABL$D_1000014 DB, TABL$R_TMC TMC, TABL$R_EDIZM E
    WHERE  (DB.J_ID = :P_J_ID)
      AND  (TMC.ID  = DB.TMC_ID)
      AND  (E.ID    = TMC.EDIZM_ID)
    INTO   :ID, :NAME, :J_ID, :TMC_ID, :TMC_NAME, :TMC_ARTICLE, :TMC_NUMSHOW,
           :TMC_LIST_ID, :TMC_EDIZM_ID, :EDIZM_NAME, :EDIZM_SHORT, :TMC_COUNTRY_ID, :TMC_PROBE,
           :TMC_MASSA, :TMC_MASSA_NETTO, :QUANT, :PRICE
  DO
    BEGIN
    TOTAL   = :PRICE * :QUANT;
    PRICEPL = 0;
    QUANTPL = 0;
    SELECT FIRST 1 MAX(P.VALUE_DATE)
    FROM   TABL$R_TMC_P P
    WHERE  (P.TMC_ID = :TMC_ID)
      AND  (P.VALUE_DATE <= CURRENT_TIMESTAMP)
    INTO   :P_PRICE_DATE;
    SELECT FIRST 1 COALESCE(P.PRICE, :PRICE)
    FROM   TABL$R_TMC_P P
    WHERE  (P.TMC_ID     = :TMC_ID)
      AND  (P.VALUE_DATE = :P_PRICE_DATE)
    INTO   :PRICEPL;
    SELECT COALESCE(SUM(TQ.QUANT),0)
    FROM   TABL$P_TMC_QUANT TQ
    WHERE  ((TQ.FIRM_ID+0) = :P_FIRM_ID)
      AND  ((TQ.PLACE_ID+0) = :P_PLACE_ID)
      AND  (TQ.TMC_ID = :TMC_ID)
    INTO   :QUANTPL;
    TOTALPL = :PRICEPL * :QUANTPL;
    FLAG_DELETE = 0;
    IF(:QUANT <> :QUANTPL)THEN FLAG_DELETE = 1;
    TMC_MASSA_INS = :TMC_MASSA - :TMC_MASSA_NETTO;
    TMC_COUNTRY_NAME = '';
    SELECT FIRST 1 COALESCE(C.VALUTE,' ') FROM TABL$R_COUNTRIES C WHERE (C.ID = :TMC_COUNTRY_ID) INTO :TMC_COUNTRY_NAME;
    SUSPEND;
    END
END
