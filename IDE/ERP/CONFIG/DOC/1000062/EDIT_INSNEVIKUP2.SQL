EXECUTE BLOCK(
   Q_J_1000062_ID TYPE OF COLUMN TABL$J_4.ID                 = ?J_1000062_ID
  ,Q_FIRM_ID_NEW  TYPE OF COLUMN TABL$J_4.FIRM_ID            = ?FIRM_ID_NEW
  ,Q_DOCSUM       TYPE OF COLUMN TABL$J_4.DOCSUM             = ?DOCSUM
  ,Q_SUMPC        TYPE OF COLUMN TABL$J_4.DOCSUM             = ?SUMPC
  ,Q_PC           TYPE OF COLUMN TABL$J_1000063.PC           = ?PC
  ,Q_DAYS_CNT     TYPE OF COLUMN TABL$J_1000063.DAYSCNT      = ?DAYS_CNT
  ,Q_DATE_RETURN  TYPE OF COLUMN TABL$J_1000063.DATE_RETURN  = ?DATE_RETURN
)AS
  DECLARE VARIABLE P_J_1000063_ID  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_FIRM_ID       TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_CS_ID         TYPE OF COLUMN TABL$J_1000062.CS_ID;
  DECLARE VARIABLE P_J_1000020_ID1 TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000020_ID2 TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000021_ID1 TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000021_ID2 TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_DOCNAME1      TYPE OF COLUMN TABL$J_4.NAME;
  DECLARE VARIABLE P_DOCNAME2      TYPE OF COLUMN TABL$J_4.NAME;

  DECLARE VARIABLE P_PLACE_ID      TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_PLACE_IDNVK   TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_J_1000065_ID  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000027_ID  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_J_1000024_ID  TYPE OF COLUMN TABL$J_4.ID;
  DECLARE VARIABLE P_NAME          TYPE OF COLUMN TABL$D_1000014.NAME;
  DECLARE VARIABLE P_FLAG_DELETE   TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE;
  DECLARE VARIABLE P_TMC_ID        TYPE OF COLUMN TABL$D_1000014.TMC_ID;
  DECLARE VARIABLE P_PRICE         TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE P_QUANT         TYPE OF COLUMN TABL$D_1000014.QUANT;
  DECLARE VARIABLE P_PRICE_TMC     TYPE OF COLUMN TABL$D_1000014.PRICE_TMC;
BEGIN
  SELECT FIRST 1 P.VAL FROM PROC$C_ENT_PS_J_1000020_3771 P INTO :P_DOCNAME1;
  SELECT FIRST 1 P.VAL FROM PROC$C_ENT_PS_J_1000020_373  P INTO :P_DOCNAME2;

  SELECT FIRST 1 J.FIRM_ID, JZ.CS_ID
  FROM   TABL$J_4 J, TABL$J_1000062 JZ
  WHERE  (J.ID = :Q_J_1000062_ID)
    AND  (JZ.J_ID = J.ID)
  INTO   :P_FIRM_ID, :P_CS_ID;

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_4(:P_FIRM_ID, 1000063, :Q_J_1000062_ID) P INTO :P_J_1000063_ID;
  UPDATE TABL$J_4 J4 SET J4.DOCSUMVAL = :Q_DOCSUM WHERE (J4.ID = :P_J_1000063_ID);
  INSERT INTO TABL$J_1000063 (J_ID, J_ZALOG_ID, DAYSCNT, PC, PCSUM, DATE_RETURN)
    VALUES (:P_J_1000063_ID, :Q_J_1000062_ID, :Q_DAYS_CNT, :Q_PC, :Q_SUMPC, :Q_DATE_RETURN);
  UPDATE TABL$J_4 J4 SET J4.FLAG_COMMIT = 1 WHERE (J4.ID = :P_J_1000063_ID);

  IF(ABS(:Q_DOCSUM - :Q_SUMPC) > 0.000)THEN
    BEGIN
    SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000020(:P_FIRM_ID, :P_DOCNAME1, :P_J_1000063_ID) P INTO :P_J_1000020_ID1;
    UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = (:Q_DOCSUM - :Q_SUMPC) WHERE (JRNL.ID = :P_J_1000020_ID1);
    UPDATE TABL$J_1000016 JC SET
       JC.ACC_ID      = 3771
      ,JC.SUBKONTO_ID = :P_CS_ID
    WHERE (JC.J_ID = :P_J_1000020_ID1);
    UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000020_ID1);

    SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000021(:Q_FIRM_ID_NEW, 'Изъято на '||:P_DOCNAME1, 0) P INTO :P_J_1000021_ID1;
    UPDATE TABL$J_4 JRNL SET
      JRNL.DOCSUMVAL = (:Q_DOCSUM - :Q_SUMPC)
    WHERE (JRNL.ID = :P_J_1000021_ID1);
    UPDATE TABL$J_1000016 JC SET
       JC.ACC_ID      = 301
      ,JC.SUBKONTO_ID = 0
    WHERE (JC.J_ID = :P_J_1000021_ID1);

    UPDATE OR INSERT INTO TABL$J_CHILDS(J_ID, J_CHILD_ID)
      VALUES(:P_J_1000020_ID1, :P_J_1000021_ID1)
      MATCHING(J_ID, J_CHILD_ID);
    UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000021_ID1);
    END

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000020(:P_FIRM_ID, :P_DOCNAME2, :P_J_1000063_ID) P INTO :P_J_1000020_ID2;
  UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = :Q_SUMPC WHERE (JRNL.ID = :P_J_1000020_ID2);
  UPDATE TABL$J_1000016 JC SET
     JC.ACC_ID      = 373
    ,JC.SUBKONTO_ID = :P_CS_ID
  WHERE (JC.J_ID = :P_J_1000020_ID2);
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000020_ID2);

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000021(:Q_FIRM_ID_NEW, 'Изъято на '||:P_DOCNAME2, 0) P INTO :P_J_1000021_ID2;
  UPDATE TABL$J_4 JRNL SET JRNL.DOCSUMVAL = :Q_SUMPC WHERE (JRNL.ID = :P_J_1000021_ID2);
  UPDATE TABL$J_1000016 JC SET
     JC.ACC_ID      = 301
    ,JC.SUBKONTO_ID = 0
  WHERE (JC.J_ID = :P_J_1000021_ID2);
  UPDATE OR INSERT INTO TABL$J_CHILDS(J_ID, J_CHILD_ID)
    VALUES(:P_J_1000020_ID2, :P_J_1000021_ID2)
    MATCHING(J_ID, J_CHILD_ID);
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000021_ID2);


  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000065_1000062(:Q_J_1000062_ID) P INTO :P_J_1000065_ID;
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000065_ID);

  SELECT FIRST 1 J14.PLACE_ID FROM TABL$J_1000014 J14 WHERE (J14.J_ID = :P_J_1000065_ID)INTO :P_PLACE_ID;

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000027(:Q_FIRM_ID_NEW, :P_PLACE_ID, 0) P INTO :P_J_1000027_ID;
  UPDATE TABL$J_1000014 J14 SET J14.CS_ID = :P_CS_ID WHERE (J14.J_ID = :P_J_1000027_ID);
  UPDATE TABL$J_4 JRNL SET JRNL.NAME = 'Ввод остаков при закрытиии Д.Ф.К.' WHERE (JRNL.ID = :P_J_1000027_ID);
  FOR
    SELECT D.NAME, D.FLAG_DELETE, D.TMC_ID, D.PRICE, D.QUANT
    FROM   TABL$D_1000014 D
    WHERE  (D.J_ID = :P_J_1000065_ID)
    INTO   :P_NAME, :P_FLAG_DELETE, :P_TMC_ID, :P_PRICE, :P_QUANT
  DO
    BEGIN
    P_PRICE_TMC = :P_PRICE;
    INSERT INTO TABL$D_1000014(J_ID, NAME, FLAG_DELETE, TMC_ID, PRICE, QUANT, J_BILLS_ID, PRICE_TMC)
      VALUES(:P_J_1000027_ID, :P_NAME, :P_FLAG_DELETE, :P_TMC_ID, :P_PRICE, :P_QUANT, :P_J_1000065_ID, :P_PRICE_TMC);
    END

  UPDATE OR INSERT INTO TABL$J_CHILDS(J_ID, J_CHILD_ID)
    VALUES(:P_J_1000065_ID, :P_J_1000027_ID)
    MATCHING(J_ID, J_CHILD_ID);
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000027_ID);

  SELECT FIRST 1 PL.ID FROM TABL$R_PLACES PL WHERE (PL.ACC_ID = -61) INTO :P_PLACE_IDNVK;

  SELECT FIRST 1 P.J_ID FROM PROC$J_INS_1000024_1000026(:P_PLACE_IDNVK, :P_J_1000027_ID) P INTO :P_J_1000024_ID;
  UPDATE TABL$J_4 JRNL SET JRNL.NAME = 'Перемещение остаков при закрытиии Д.Ф.К.' WHERE (JRNL.ID = :P_J_1000024_ID);
  UPDATE OR INSERT INTO TABL$J_CHILDS(J_ID, J_CHILD_ID)
    VALUES(:P_J_1000027_ID, :P_J_1000024_ID)
    MATCHING(J_ID, J_CHILD_ID);
  UPDATE TABL$J_4 JRNL SET JRNL.FLAG_COMMIT = 1 WHERE (JRNL.ID = :P_J_1000024_ID);

END
