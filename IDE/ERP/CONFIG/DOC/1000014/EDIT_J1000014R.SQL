EXECUTE BLOCK (
   Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?ID
)RETURNS (
   ID                    TYPE OF COLUMN TABL$J_4.ID
  ,NAME                  TYPE OF COLUMN TABL$J_4.NAME
  ,FLAG_DELETE           TYPE OF COLUMN TABL$J_4.FLAG_DELETE
  ,FLAG_COMMIT           TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,TYPE_ID               TYPE OF COLUMN TABL$J_4.TYPE_ID
  ,TYPE_NAME             TYPE OF COLUMN TABL$_TB_DOCS.NAME
  ,COLOR_FRG             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
  ,COLOR_BGR             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
  ,DOCNUMBER             TYPE OF COLUMN TABL$J_4.DOCNUMBER
  ,DOCSUM                TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DOCSUMVAL             TYPE OF COLUMN TABL$J_4.DOCSUMVAL
  ,VALUTE_ID             TYPE OF COLUMN TABL$J_4.VALUTE_ID
  ,VALUTE_NAME           TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,VALUTE_SHORT          TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE_SHORT
  ,FIRM_ID               TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME             TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,FILIAL_ID             TYPE OF COLUMN TABL$J_4.FILIAL_ID
  ,FILIAL_NAME           TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,FILIAL_PREFIX         TYPE OF COLUMN TABL$R_FILIALS.PREFIX
  ,USER_ID               TYPE OF COLUMN TABL$J_4.USER_ID
  ,USER_NAME             TYPE OF COLUMN TABL$_USERS.NAME
  ,WRK_DOVER             TYPE OF COLUMN TABL$R_WRK.DOVER
  ,DATE_COMMIT           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DOCNUMBERSTR          TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,DOCSTR                TYPE OF COLUMN TABL$J_4.DOCSTR
  ,CS_ID                 TYPE OF COLUMN TABL$J_1000014.CS_ID
  ,CS_NAME               TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_INN                TYPE OF COLUMN TABL$R_CS.INN
  ,CS_AMOUNT             TYPE OF COLUMN TABL$R_CS_P.AMOUNT
  ,CS_ADDR_ID            TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID
  ,CS_ADDR_NAME          TYPE OF COLUMN TABL$R_CS_ADDR.NAME
  ,CS_DOC_ID             TYPE OF COLUMN TABL$J_1000014.CS_DOC_ID
  ,CS_DOC_NAME           TYPE OF COLUMN TABL$R_CS_DOCS.NAME
  ,PLACE_ID              TYPE OF COLUMN TABL$J_1000014.PLACE_ID
  ,PLACE_NAME            TYPE OF COLUMN TABL$R_PLACES.NAME
  ,TAX_ID                TYPE OF COLUMN TABL$J_1000014.TAX_ID
  ,TO_PLACE_ID           TYPE OF COLUMN TABL$J_1000014.TO_PLACE_ID
  ,TO_PLACE_NAME         TYPE OF COLUMN TABL$R_PLACES.NAME
  ,WRK_ID                TYPE OF COLUMN TABL$J_1000014.WRK_ID
  ,WRK_NAME              TYPE OF COLUMN TABL$R_WRK.NAME
  ,TMC_GRID_ID           TYPE OF COLUMN TABL$J_1000014.TMC_GRID_ID
  ,TMC_GRID_NAME         TYPE OF COLUMN TABL$R_TMC_GRID.NAME
  ,NDP                   TYPE OF COLUMN TABL$J_1000014.NDP
  ,DOCSUMNDP             TYPE OF COLUMN TABL$J_1000014.DOCSUMNDP
  ,DOCSUMPRINT           TYPE OF COLUMN TABL$J_1000014.NDP
  ,NDPPRINT              TYPE OF COLUMN TABL$J_1000014.NDP
  ,DOCSUMNDPPRINT        TYPE OF COLUMN TABL$J_1000014.DOCSUMNDP
  ,J_PAY_ID              TYPE OF COLUMN TABL$J_1000014.J_PAY_ID
  ,J_PAY_DOCSTR          TYPE OF COLUMN TABL$J_4.DOCSTR
)AS
  DECLARE VARIABLE P_CS_ADDR_ID TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_CS_DOC_ID  TYPE OF COLUMN TABL$R_CS_DOCS.ID;
  DECLARE VARIABLE P_VAL_DATE   TYPE OF COLUMN TABL$R_CS.VALUE_DATE;
  DECLARE VARIABLE P_STR        TYPE OF COLUMN TABL$R_CS_DOCS.NAME;
  DECLARE VARIABLE P_DATE       TYPE OF COLUMN TABL$R_CS_DOCS.DOC_DATE;
BEGIN
  SELECT FIRST 1 J.ID, J.NAME, J.FLAG_DELETE, J.FLAG_COMMIT, J.TYPE_ID, TD.NAME, TD.COLOR_FRG, TD.COLOR_BGR,
         J.DOCNUMBER, J.DOCSUM, J.DOCSUMVAL, J.VALUTE_ID, CONTR.VALUTE, CONTR.VALUTE_SHORT, J.FIRM_ID, FIRM.NAME, J.FILIAL_ID,
         (SELECT FIRST 1 COALESCE(FF.NAME,'') FROM TABL$R_FILIALS FF WHERE (FF.ID = J.FILIAL_ID)) AS FILIAL_NAME,
         J.USER_ID, (SELECT FIRST 1 COALESCE(W.NAME,J.USER_ID) FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID)) AS USER_NAME,
         (SELECT FIRST 1 COALESCE(W.DOVER,'') FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID)) AS WRK_DOVER,
         J.DATE_COMMIT, J.DOCNUMBERSTR,J.DOCSTR
  FROM   TABL$J_4 J, TABL$R_FIRMS FIRM, TABL$R_COUNTRIES CONTR, TABL$_TB_DOCS TD
  WHERE  (J.ID     = :Q_J_ID)
    AND  (TD.ID    = J.TYPE_ID)
    AND  (FIRM.ID  = J.FIRM_ID)
    AND  (CONTR.ID = J.VALUTE_ID)
  INTO   :ID, :NAME, :FLAG_DELETE, :FLAG_COMMIT, :TYPE_ID, :TYPE_NAME, :COLOR_FRG, :COLOR_BGR,
         :DOCNUMBER, :DOCSUM, :DOCSUMVAL, :VALUTE_ID, :VALUTE_NAME, :VALUTE_SHORT, :FIRM_ID, :FIRM_NAME, :FILIAL_ID, :FILIAL_NAME,
         :USER_ID, :USER_NAME, :WRK_DOVER, :DATE_COMMIT, :DOCNUMBERSTR,:DOCSTR
         ;

  SELECT FIRST 1 JB.CS_ID, CS.NAME, CS.INN, JB.CS_ADDR_ID, JB.PLACE_ID, PLACE.NAME, JB.TAX_ID, JB.TO_PLACE_ID,
         (SELECT FIRST 1 COALESCE(PL.NAME,'') FROM TABL$R_PLACES PL WHERE (PL.ID = JB.TO_PLACE_ID)) AS TO_PLACE_NAME,
         JB.TMC_GRID_ID, JB.CS_DOC_ID, COALESCE(JB.NDP,0), COALESCE(JB.DOCSUMNDP,0), JB.J_PAY_ID
  FROM   TABL$J_1000014 JB, TABL$R_CS CS, TABL$R_PLACES PLACE
  WHERE  (JB.J_ID = :ID)
    AND  (CS.ID = JB.CS_ID)
    AND  (PLACE.ID = JB.PLACE_ID)
  INTO   :CS_ID, :CS_NAME, :CS_INN, :CS_ADDR_ID,  :PLACE_ID, :PLACE_NAME, :TAX_ID, :TO_PLACE_ID, :TO_PLACE_NAME,
         :TMC_GRID_ID, :CS_DOC_ID, :NDP, :DOCSUMNDP, :J_PAY_ID;

  DOCSUMNDP      = COALESCE(:DOCSUM + :NDP, 0);
  DOCSUMPRINT    = COALESCE(:DOCSUM,0);
  NDPPRINT       = COALESCE(:NDP,0);
  DOCSUMNDPPRINT = COALESCE(:DOCSUMNDP,0);
  IF(:NDP < 0)THEN
    BEGIN
    NDPPRINT    = (-1) * :NDPPRINT;
    DOCSUMPRINT = :DOCSUMPRINT - :NDPPRINT;
    END

  SELECT FIRST 1 J.DOCSTR FROM TABL$J_4 J WHERE (J.ID = :J_PAY_ID)INTO :J_PAY_DOCSTR;
  SELECT FIRST 1 COALESCE(TG.NAME,'') FROM TABL$R_TMC_GRID TG WHERE(TG.ID = :TMC_GRID_ID) INTO :TMC_GRID_NAME;

  P_CS_ADDR_ID = :CS_ADDR_ID;
  IF((:CS_ADDR_ID IS NULL)OR(:CS_ADDR_ID = 0))THEN
    SELECT FIRST 1 CSA.ID FROM TABL$R_CS_ADDR CSA WHERE(CSA.CS_ID = :CS_ID) INTO :P_CS_ADDR_ID;
  SELECT FIRST 1 PR.ADDRESS_NAME_FULL FROM PROC$R_CS_ADDR_GET(:P_CS_ADDR_ID) PR INTO :CS_ADDR_NAME;

  P_CS_DOC_ID = :CS_DOC_ID;
  IF((:CS_DOC_ID IS NULL)OR(:CS_DOC_ID = 0))THEN
    SELECT FIRST 1 CSD.ID FROM TABL$R_CS_DOCS CSD WHERE(CSD.CS_ID = :CS_ID) INTO :P_CS_DOC_ID;

  SELECT FIRST 1 COALESCE(DT.NAME,'')||' Серия "'||COALESCE(CD.DOC_SERIAL,'')||
         '" №'||COALESCE(CD.DOC_NUMBER,'')||'  Выдан: '||COALESCE(CD.NAME,'')||' от "', CD.DOC_DATE
  FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
  WHERE  (CD.ID    = :P_CS_DOC_ID)
    AND  (DT.ID    = CD.DOCTYPE_ID)
  INTO   :CS_DOC_NAME, :P_DATE; IF(:P_DATE IS NULL)THEN P_DATE = CURRENT_TIMESTAMP;
  SELECT FIRST 1 P.OUT_STR FROM PROC$__FORMAT_DATETIME(:P_DATE, 'DD.MM.YYYY') P INTO :P_STR;
  CS_DOC_NAME = :CS_DOC_NAME||:P_STR||'"A.';


  SELECT FIRST 1 COALESCE(W.ID, -1), COALESCE(W.NAME, :USER_ID)
  FROM   TABL$R_WRK W
  WHERE  (TRIM(W.USER_NAME) = :USER_ID)
  INTO   :WRK_ID, :WRK_NAME;

  SELECT MAX(P.VALUE_DATE)
  FROM   TABL$R_CS_P P
  WHERE  (P.CS_ID = :CS_ID)
    AND  (P.VALUE_DATE <= CURRENT_TIMESTAMP)
  INTO   :P_VAL_DATE;

  IF(:P_VAL_DATE IS NULL)THEN
    BEGIN
    CS_AMOUNT = 0.000;
    END
   ELSE
    BEGIN
    SELECT FIRST 1 PW.AMOUNT
    FROM   TABL$R_CS_P PW
    WHERE  (PW.CS_ID = :CS_ID)
      AND  (PW.VALUE_DATE = :P_VAL_DATE)
    INTO   :CS_AMOUNT;
    END

  SUSPEND;
END
