EXECUTE BLOCK (
   Q_ID                   TYPE OF COLUMN TABL$D_1000014.ID = ?ID
  ,Q_I                    TYPE OF COLUMN TABL$D_1000014.ID = ?I 
)RETURNS (
   ID                     TYPE OF COLUMN TABL$D_1000014.ID
  ,I                      TYPE OF COLUMN TABL$D_1000014.ID 
  ,NAME                   TYPE OF COLUMN TABL$D_1000014.NAME
  ,FLAG_DELETE            TYPE OF COLUMN TABL$D_1000014.FLAG_DELETE
  ,FLAG_UPDNDP            TYPE OF COLUMN TABL$D_1000014.FLAG_UPDNDP
  ,J_ID                   TYPE OF COLUMN TABL$D_1000014.J_ID
  ,J_TYPE_ID              TYPE OF COLUMN TABL$D_1000014.J_ID
  ,TMC_ID                 TYPE OF COLUMN TABL$D_1000014.TMC_ID
  ,TMC_LIST_ID            TYPE OF COLUMN TABL$R_TMC.TMC_LIST_ID
  ,TMC_NAME               TYPE OF COLUMN TABL$R_TMC.NAME
  ,TMC_NAME2              TYPE OF COLUMN TABL$R_TMC.NAME2
  ,TMC_ARTICLE            TYPE OF COLUMN TABL$R_TMC.ARTICLE
  ,TMC_NUMSHOW            TYPE OF COLUMN TABL$R_TMC.NUMSHOW
  ,TMC_BARCODE            TYPE OF COLUMN TABL$R_TMC.BARCODE
  ,TMC_VEDCODE            TYPE OF COLUMN TABL$R_TMC.VEDCODE
  ,TMC_MODELNAME          TYPE OF COLUMN TABL$R_TMC.MODELNAME
  ,TMC_TYPE_ID            TYPE OF COLUMN TABL$R_TMC.TMC_TYPE_ID
  ,TMC_TYPE_NAME          TYPE OF COLUMN TABL$R_TMC_TYPES.NAME
  ,TMC_CTGR_ID            TYPE OF COLUMN TABL$R_TMC.TMC_CTGR_ID
  ,TMC_CTGR_NAME          TYPE OF COLUMN TABL$R_TMC_CTGR.NAME
  ,TMC_CTGR_PATH          TYPE OF COLUMN TABL$R_TMC_CTGR.PATH
  ,TMC_EDIZM_ID           TYPE OF COLUMN TABL$R_TMC.EDIZM_ID
  ,TMC_EDIZM_NAME         TYPE OF COLUMN TABL$R_EDIZM.NAME
  ,TMC_EDIZM_SHORT        TYPE OF COLUMN TABL$R_EDIZM.SHORT_NAME
  ,TMC_EDIZM_KSPOVO_ID    TYPE OF COLUMN TABL$R_TMC.EDIZM_ID
  ,TMC_EDIZM_KSPOVO_CODE  TYPE OF COLUMN TABL$R_EDIZM.NAME
  ,TMC_GROUP_ID           TYPE OF COLUMN TABL$R_TMC.TMC_GROUP_ID
  ,TMC_GROUP_NAME         TYPE OF COLUMN TABL$R_TMC_GROUP.NAME
  ,TMC_COUNTRY_ID         TYPE OF COLUMN TABL$R_TMC.COUNTRY_ID
  ,TMC_VALUTE_NAME        TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,TMC_PROBE              TYPE OF COLUMN TABL$R_TMC.PROBE
  ,TMC_LGTH               TYPE OF COLUMN TABL$R_TMC.LGTH
  ,TMC_DIAM               TYPE OF COLUMN TABL$R_TMC.DIAM
  ,TMC_MASSA              TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS          TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO        TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_MASSA_T            TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_INS_T        TYPE OF COLUMN TABL$R_TMC.MASSA
  ,TMC_MASSA_NETTO_T      TYPE OF COLUMN TABL$R_TMC.MASSA_NETTO
  ,TMC_STATEFINE          TYPE OF COLUMN TABL$R_TMC.STATEFINE
  ,TMC_PRICE              TYPE OF COLUMN TABL$R_TMC_P.PRICE
  ,TMC_PRICE_IN           TYPE OF COLUMN TABL$R_TMC_P.PRICE_IN
  ,PRICE_IN               TYPE OF COLUMN TABL$D_1000014.PRICE
  ,TOTAL_IN               TYPE OF COLUMN TABL$D_1000014.PRICE
  ,GESHEFT                TYPE OF COLUMN TABL$D_1000014.PRICE
  ,GESHEFT_PC             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,GESHEFT_PCTOTAL        TYPE OF COLUMN TABL$D_1000014.PRICE
  ,PRICE_TMC              TYPE OF COLUMN TABL$D_1000014.PRICE_TMC
  ,PRICE                  TYPE OF COLUMN TABL$D_1000014.PRICE
  ,QUANT                  TYPE OF COLUMN TABL$D_1000014.QUANT
  ,TOTAL                  TYPE OF COLUMN TABL$D_1000014.PRICE
  ,NDP                    TYPE OF COLUMN TABL$D_1000014.NDP
  ,NDPTOTAL               TYPE OF COLUMN TABL$D_1000014.NDP
  ,NDPPRINT               TYPE OF COLUMN TABL$D_1000014.NDP
  ,NDPTOTALPRINT          TYPE OF COLUMN TABL$D_1000014.NDP
  ,PRICEPRINT             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,TOTALPRINTWONDP        TYPE OF COLUMN TABL$D_1000014.PRICE
  ,TOTALWONDP             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,TOTALPRINT             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,BILL_PRICE             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,BILL_QUANT             TYPE OF COLUMN TABL$D_1000014.QUANT
  ,BILL_TOTAL             TYPE OF COLUMN TABL$D_1000014.PRICE
  ,BILL_NDP               TYPE OF COLUMN TABL$D_1000014.NDP
  ,BILL_NDPTOTAL          TYPE OF COLUMN TABL$D_1000014.NDP
  ,BILL_NDPPRINT          TYPE OF COLUMN TABL$D_1000014.NDP
  ,BILL_NDPTOTALPRINT     TYPE OF COLUMN TABL$D_1000014.NDP
  ,BILL_PRICEPRINT        TYPE OF COLUMN TABL$D_1000014.PRICE
  ,BILL_TOTALWONDP        TYPE OF COLUMN TABL$D_1000014.PRICE
  ,BILL_TOTALPRINT        TYPE OF COLUMN TABL$D_1000014.PRICE
  ,DELTA_PRICE            TYPE OF COLUMN TABL$D_1000014.PRICE
  ,DELTA_QUANT            TYPE OF COLUMN TABL$D_1000014.PRICE
  ,DELTA_PRICEPRINT       TYPE OF COLUMN TABL$D_1000014.PRICE
  ,DELTA_NDPTOTALPRINT    TYPE OF COLUMN TABL$D_1000014.NDP
  ,DELTA_TOTALPRINT       TYPE OF COLUMN TABL$D_1000014.PRICE
  ,ENTRYDATE              TYPE OF COLUMN TABL$D_1000014.ENTRYDATE
  ,ENTRYBILL              TYPE OF COLUMN TABL$D_1000014.ENTRYBILL
  ,WRK_ID                 TYPE OF COLUMN TABL$D_1000014.WRK_ID
  ,WRK_NAME               TYPE OF COLUMN TABL$R_WRK.NAME
  ,J_BILLS_ID             TYPE OF COLUMN TABL$D_1000014.J_BILLS_ID
  ,J_ID_PARENT            TYPE OF COLUMN TABL$D_1000014.J_ID_PARENT
  ,D_ID_PARENT            TYPE OF COLUMN TABL$D_1000014.D_ID_PARENT
  ,QUANT_QUANT            TYPE OF COLUMN TABL$D_1000014.QUANT
  ,QUANT_NOW              TYPE OF COLUMN TABL$D_1000014.QUANT
)AS
  DECLARE VARIABLE P_FIRM_ID     TYPE OF COLUMN TABL$J_4.FIRM_ID;
  DECLARE VARIABLE P_DATE_COMMIT TYPE OF COLUMN TABL$J_4.DATE_COMMIT;
  DECLARE VARIABLE P_PLACE_ID    TYPE OF COLUMN TABL$J_1000014.PLACE_ID;
  DECLARE VARIABLE P_SUM         TYPE OF COLUMN TABL$J_1000014.P_SUM;
  DECLARE VARIABLE P_SEBEST      TYPE OF COLUMN TABL$J_1000014.P_SUM;
  DECLARE VARIABLE P_SQL_E   TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  I = :Q_I;
  FOR
    SELECT  DB.ID, DB.NAME, DB.FLAG_DELETE, DB.J_ID, DB.TMC_ID
           ,TMC.NAME, TMC.NAME2, TMC.ARTICLE, TMC.NUMSHOW, TMC.BARCODE, TMC.VEDCODE, TMC.MODELNAME
           ,TMC.TMC_CTGR_ID, TMC.TMC_TYPE_ID
           ,TMC.TMC_LIST_ID,  TMC.EDIZM_ID, E.NAME, E.SHORT_NAME
           ,TMC.TMC_GROUP_ID, TG.NAME, TMC.COUNTRY_ID
           ,(SELECT FIRST 1 C.VALUTE FROM TABL$R_COUNTRIES C WHERE (C.ID = TMC.COUNTRY_ID))
           ,TMC.PROBE, TMC.LGTH, TMC.DIAM, TMC.MASSA, (TMC.MASSA - TMC.MASSA_NETTO), TMC.MASSA_NETTO, TMC.STATEFINE
           ,DB.WRK_ID, (SELECT FIRST 1 COALESCE(W.NAME,'') FROM TABL$R_WRK W WHERE(W.ID = DB.WRK_ID))AS WRK_NAME
           ,DB.PRICE, DB.QUANT, DB.J_BILLS_ID, DB.PRICE_TMC, DB.TOTAL
           ,DB.NDP, DB.NDPTOTAL, DB.ENTRYDATE, DB.ENTRYBILL, DB.FLAG_UPDNDP
           ,DB.J_ID_PARENT, DB.D_ID_PARENT
    FROM   TABL$D_1000014 DB, TABL$R_TMC TMC, TABL$R_EDIZM E, TABL$R_TMC_GROUP TG
    WHERE  (DB.ID   = :Q_ID)
      AND  (TMC.ID  = DB.TMC_ID)
      AND  (E.ID    = TMC.EDIZM_ID)
      AND  (TG.ID   = TMC.TMC_GROUP_ID)
    INTO    :ID, :NAME, :FLAG_DELETE, :J_ID, :TMC_ID
           ,:TMC_NAME, :TMC_NAME2, :TMC_ARTICLE, :TMC_NUMSHOW, :TMC_BARCODE, :TMC_VEDCODE, :TMC_MODELNAME
           ,:TMC_CTGR_ID, :TMC_TYPE_ID, :TMC_LIST_ID, :TMC_EDIZM_ID, :TMC_EDIZM_NAME, :TMC_EDIZM_SHORT
           ,:TMC_GROUP_ID, :TMC_GROUP_NAME, :TMC_COUNTRY_ID, :TMC_VALUTE_NAME, :TMC_PROBE, :TMC_LGTH, :TMC_DIAM
           ,:TMC_MASSA, :TMC_MASSA_INS, :TMC_MASSA_NETTO, :TMC_STATEFINE
           ,:WRK_ID, :WRK_NAME
           ,:PRICE, :QUANT, :J_BILLS_ID, :PRICE_TMC, :TOTAL
           ,:NDP, :NDPTOTAL, :ENTRYDATE, :ENTRYBILL, :FLAG_UPDNDP
           ,:J_ID_PARENT, :D_ID_PARENT
  DO
    BEGIN
    TMC_PRICE    = 0;
    TMC_PRICE_IN = 0;
    SELECT FIRST 1 P1.PRICE, P1.PRICE_IN
    FROM   TABL$R_TMC T1, TABL$R_TMC_P P1
    WHERE  (T1.ID = :TMC_ID)
      AND  (P1.TMC_ID = T1.ID)
      AND  (P1.VALUE_DATE = T1.VALUE_DATE)
    INTO   :TMC_PRICE, :TMC_PRICE_IN;  

    SELECT FIRST 1 J4.FIRM_ID, J4.DATE_COMMIT, J4.TYPE_ID 
    FROM   TABL$J_4 J4 
    WHERE  (J4.ID = :J_ID) 
    INTO   :P_FIRM_ID, :P_DATE_COMMIT, :J_TYPE_ID;
    
    SELECT FIRST 1 J.PLACE_ID, J.P_SUM 
    FROM   TABL$J_1000014 J 
    WHERE  (J.J_ID = :J_ID) 
    INTO   :P_PLACE_ID, :P_SUM;
    GESHEFT_PCTOTAL = 0;
    SELECT COALESCE(SUM(Q.PRICE_IN * Q.QUANT),0)
    FROM   TABL$P_TMCQUANT Q
    WHERE  (Q.J_ID = :J_ID)
    INTO   :P_SEBEST; 
    IF(:P_SEBEST <> 0)THEN
      GESHEFT_PCTOTAL = (:P_SUM / :P_SEBEST) * 100;


    TMC_TYPE_NAME = '';
    SELECT FIRST 1 COALESCE(C.NAME,'') 
    FROM   TABL$R_TMC_TYPES C 
    WHERE  (C.ID = :TMC_TYPE_ID)
    INTO   :TMC_TYPE_NAME;

    SELECT FIRST 1 COALESCE(C.NAME,''), COALESCE(C.PATH,'')
    FROM   TABL$R_TMC_CTGR C
    WHERE  (C.ID = :TMC_CTGR_ID)
    INTO   :TMC_CTGR_NAME, :TMC_CTGR_PATH;
    TMC_MASSA_T       = :TMC_MASSA       * :QUANT;
    TMC_MASSA_INS_T   = :TMC_MASSA_INS   * :QUANT;
    TMC_MASSA_NETTO_T = :TMC_MASSA_NETTO * :QUANT;
    
    IF(:NDPTOTAL < 0)THEN
      BEGIN
      PRICEPRINT    = :PRICE - ABS(:NDP);
      TOTALPRINT    = :TOTAL;
      END
     ELSE
      BEGIN
      PRICEPRINT    = :PRICE;
      TOTALPRINT    = :TOTAL + ABS(:NDPTOTAL);
      END
    TOTALWONDP      = :PRICEPRINT * :QUANT;
    TOTALPRINTWONDP = :TOTALWONDP; 
    NDPPRINT        = ABS(:NDP);
    NDPTOTALPRINT   = ABS(:NDPTOTAL);

    PRICE_IN = 0;
    TOTAL_IN = 0;
    GESHEFT  = 0;
    SELECT FIRST 1 COALESCE(SUM(Q.PRICE_IN * Q.QUANT),0)
    FROM   TABL$P_TMCQUANT Q
    WHERE  (Q.J_ID = :J_ID)
      AND  (Q.D_ID = :ID)
    INTO   :TOTAL_IN; 
    GESHEFT = :TOTALWONDP - :TOTAL_IN;
    GESHEFT_PC = 0;
    IF(:TOTAL_IN <> 0)THEN
      GESHEFT_PC = (:TOTALWONDP / :TOTAL_IN) * 100;

    QUANT_QUANT   = 0;
    SELECT COALESCE(SUM(P.QUANT),0)
    FROM   TABL$P_TMCQUANT P
    WHERE  ((P.FIRM_ID+0)  = :P_FIRM_ID)
      AND  ((P.PLACE_ID+0) = :P_PLACE_ID)
      AND  (P.FLAG_DEBET = 1)
      AND  (P.TMC_ID       = :TMC_ID)
      AND  (P.DATE_COMMIT <= :P_DATE_COMMIT)
    INTO   :QUANT_QUANT; 
    QUANT_NOW = 0;
    SELECT COALESCE(SUM(P.QUANT),0)
    FROM   TABL$P_TMCQUANT P
    WHERE  ((P.FIRM_ID+0)  = :P_FIRM_ID)
      AND  ((P.PLACE_ID+0) = :P_PLACE_ID)
      AND  (P.FLAG_DEBET = 1)
      AND  (P.TMC_ID       = :TMC_ID)
    INTO   :QUANT_NOW; 

    BILL_PRICE         = 0;
    BILL_QUANT         = 0;
    BILL_TOTAL         = 0;
    BILL_NDP           = 0;
    BILL_NDPTOTAL      = 0;
    BILL_NDPPRINT      = 0;
    BILL_NDPTOTALPRINT = 0;
    BILL_PRICEPRINT    = 0;
    BILL_TOTALWONDP    = 0;
    BILL_TOTALPRINT    = 0;
    DELTA_PRICE        = 0;
    DELTA_QUANT        = 0;
    DELTA_PRICEPRINT   = 0;
    DELTA_TOTALPRINT   = 0;
    SELECT FIRST 1  DB.PRICE, DB.QUANT, DB.TOTAL, DB.NDP, DB.NDPTOTAL
    FROM   TABL$D_1000014 DB
    WHERE  (DB.ID = :D_ID_PARENT)
    ORDER BY DB.ID
    INTO   :BILL_PRICE, :BILL_QUANT, :BILL_TOTAL, :BILL_NDP, :BILL_NDPTOTAL;
    IF(:BILL_NDPTOTAL < 0)THEN
      BEGIN
      BILL_PRICEPRINT    = :BILL_PRICE - ABS(:BILL_NDP);
      BILL_TOTALPRINT    = :BILL_TOTAL;
      BILL_TOTALWONDP    = :BILL_TOTALPRINT - ABS(:BILL_NDPTOTAL);
      END
     ELSE
      BEGIN
      BILL_PRICEPRINT    = :BILL_PRICE;
      BILL_TOTALPRINT    = :BILL_TOTAL + ABS(:BILL_NDPTOTAL);
      BILL_TOTALWONDP    = :BILL_TOTAL;
      END
    BILL_NDPPRINT       = ABS(:BILL_NDP);
    BILL_NDPTOTALPRINT  = ABS(:BILL_NDPTOTAL);
    DELTA_PRICE         = :PRICE - :BILL_PRICE;
    IF(:DELTA_PRICE = 0)THEN
      BEGIN
      DELTA_QUANT         = :QUANT;
      DELTA_PRICEPRINT    = :PRICEPRINT;
      DELTA_NDPTOTALPRINT = :NDPTOTALPRINT;
      DELTA_TOTALPRINT    = :TOTALPRINT;
      END
     ELSE
      BEGIN  
      DELTA_QUANT         = :QUANT         - :BILL_QUANT;
      DELTA_PRICEPRINT    = :PRICEPRINT    - :BILL_PRICEPRINT;
      DELTA_NDPTOTALPRINT = :NDPTOTALPRINT - :BILL_NDPTOTALPRINT;
      DELTA_TOTALPRINT    = :TOTALPRINT    - :BILL_TOTALPRINT;
      END

    TMC_EDIZM_KSPOVO_ID   = 0;
    TMC_EDIZM_KSPOVO_CODE = '';
    IF(EXISTS(
      SELECT RF.RDB$FIELD_ID
      FROM   RDB$RELATION_FIELDS RF
      WHERE  (TRIM(RF.RDB$RELATION_NAME) = 'TABL$R_EDIZM')
        AND  (TRIM(RF.RDB$FIELD_NAME) = 'KSPOVO')
    ))THEN
      BEGIN
      P_SQL_E = 'SELECT FIRST 1 COALESCE(E.KSPOVO, 0) FROM TABL$R_EDIZM E WHERE (E.ID = '||:TMC_EDIZM_ID||') ';
      EXECUTE STATEMENT :P_SQL_E INTO :TMC_EDIZM_KSPOVO_ID;
      P_SQL_E = 'SELECT FIRST 1 COALESCE(K.CODE,'''') FROM TABL$R_ENTZZ_IZM K WHERE (K.ID = '||:TMC_EDIZM_KSPOVO_ID ||')';
      EXECUTE STATEMENT :P_SQL_E INTO :TMC_EDIZM_KSPOVO_CODE;
      END
    SUSPEND;
    END
END
