EXECUTE BLOCK (
   Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS (
   ID                    TYPE OF COLUMN TABL$J_4.ID
  ,NAME                  TYPE OF COLUMN TABL$J_4.NAME
  ,FLAG_DELETE           TYPE OF COLUMN TABL$J_4.FLAG_DELETE
  ,FLAG_COMMIT           TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
  ,FLAG_LOCK             TYPE OF COLUMN TABL$J_4.FLAG_LOCK
  ,TYPE_ID               TYPE OF COLUMN TABL$J_4.TYPE_ID
  ,TYPE_NAME             TYPE OF COLUMN TABL$_TB_DOCS.NAME
  ,COLOR_FRG             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
  ,COLOR_BGR             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
  ,DOCNUMBER             TYPE OF COLUMN TABL$J_4.DOCNUMBER
  ,DOCSUM                TYPE OF COLUMN TABL$J_4.DOCSUM
  ,DOCSUMVAL             TYPE OF COLUMN TABL$J_4.DOCSUMVAL
  ,VALUTE_ID             TYPE OF COLUMN TABL$J_4.VALUTE_ID
  ,VALUTE_NAME           TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
  ,VALUTE_SHORT          TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE_SHORT
  ,FIRM_ID               TYPE OF COLUMN TABL$J_4.FIRM_ID
  ,FIRM_NAME             TYPE OF COLUMN TABL$R_FIRMS.NAME
  ,FILIAL_ID             TYPE OF COLUMN TABL$J_4.FILIAL_ID
  ,FILIAL_NAME           TYPE OF COLUMN TABL$R_FILIALS.NAME
  ,FILIAL_PREFIX         TYPE OF COLUMN TABL$R_FILIALS.PREFIX
  ,FILIAL_COLOR_BGR      TYPE OF COLUMN TABL$R_FILIALS.COLOR_BGR
  ,FILIAL_COLOR_FRG      TYPE OF COLUMN TABL$R_FILIALS.COLOR_FRG
  ,USER_ID               TYPE OF COLUMN TABL$J_4.USER_ID
  ,USER_NAME             TYPE OF COLUMN TABL$_USERS.NAME
  ,WRK_DOVER             TYPE OF COLUMN TABL$R_WRK.DOVER
  ,DATE_COMMIT           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,DOCNUMBER_2           TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,DOCNUMBERSTR          TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,DOCSTR                 TYPE OF COLUMN TABL$J_4.DOCSTR
  ,CS_ID                  TYPE OF COLUMN TABL$J_1000014.CS_ID
  ,CS_NAME                TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_NAME2               TYPE OF COLUMN TABL$R_CS.NAME
  ,CS_INN                 TYPE OF COLUMN TABL$R_CS.INN
  ,CS_CODECARD            TYPE OF COLUMN TABL$R_CS.CODECARD
  ,CS_AMOUNT              TYPE OF COLUMN TABL$R_CS_P.AMOUNT
  ,CS_POINTS              TYPE OF COLUMN TABL$R_CS_P.AMOUNT
  ,CS_ADDR_ID             TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID
  ,CS_ADDR_NAME           TYPE OF COLUMN TABL$J_4.DOCSTR
  ,CS_DOC_ID              TYPE OF COLUMN TABL$J_1000014.CS_DOC_ID
  ,CS_DOC_NAME            TYPE OF COLUMN TABL$R_CS_DOCS.NAME
  ,CS_DOCS_TYPE           TYPE OF COLUMN TABL$R_CS_DOCS.NAME
  ,CS_DOCS_SERIAL         TYPE OF COLUMN TABL$R_CS_DOCS.DOC_SERIAL
  ,CS_DOCS_NUMBER         TYPE OF COLUMN TABL$R_CS_DOCS.DOC_NUMBER
  ,CS_DOCS_DATE           TYPE OF COLUMN TABL$R_CS_DOCS.DOC_DATE
  ,CS_DOCS_NAME           TYPE OF COLUMN TABL$R_CS_DOCS.NAME
  ,CS_DOCS_RECEPIENT      TYPE OF COLUMN TABL$R_CS_DOCS.RECEPIENT
  ,PLACE_ID               TYPE OF COLUMN TABL$J_1000014.PLACE_ID
  ,PLACE_NAME             TYPE OF COLUMN TABL$R_PLACES.NAME
  ,TAX_ID                 TYPE OF COLUMN TABL$J_1000014.TAX_ID
  ,TO_PLACE_ID            TYPE OF COLUMN TABL$J_1000014.TO_PLACE_ID
  ,TO_PLACE_NAME          TYPE OF COLUMN TABL$R_PLACES.NAME
  ,WRK_ID                 TYPE OF COLUMN TABL$J_1000014.WRK_ID
  ,WRK_NAME               TYPE OF COLUMN TABL$R_WRK.NAME
  ,TMC_GRID_ID            TYPE OF COLUMN TABL$J_1000014.TMC_GRID_ID
  ,TMC_GRID_NAME          TYPE OF COLUMN TABL$R_TMC_GRID.NAME
  ,PLATENO                TYPE OF COLUMN TABL$J_1000014.PLATENO
  ,GUESTQUANT             TYPE OF COLUMN TABL$J_1000014.GUESTQUANT
  ,POINTS                 TYPE OF COLUMN TABL$J_1000014.POINTS
  ,PAYPOINTS              TYPE OF COLUMN TABL$J_1000014.PAYPOINTS
  ,P_SUM                  TYPE OF COLUMN TABL$J_1000014.P_SUM
  ,P_NDP                  TYPE OF COLUMN TABL$J_1000014.P_NDP
  ,P_SUMNDP               TYPE OF COLUMN TABL$J_1000014.P_SUMNDP
  ,NDP                    TYPE OF COLUMN TABL$J_1000014.NDP
  ,DOCSUMNDP              TYPE OF COLUMN TABL$J_1000014.DOCSUMNDP
  ,DOCSUMPRINT            TYPE OF COLUMN TABL$J_1000014.NDP
  ,NDPPRINT               TYPE OF COLUMN TABL$J_1000014.NDP
  ,DOCSUMNDPPRINT         TYPE OF COLUMN TABL$J_1000014.DOCSUMNDP
  ,FLAG_PNP02             TYPE OF COLUMN TABL$J_1000014.FLAG_PNP02
  ,J_PAY_ID               TYPE OF COLUMN TABL$J_1000014.J_PAY_ID
  ,J_PAY_DOCSTR           TYPE OF COLUMN TABL$J_4.DOCSTR
  ,J_1000075_ID           TYPE OF COLUMN TABL$J_1000014.J_PAY_ID
  ,J_1000075_DOCSTR       TYPE OF COLUMN TABL$J_4.DOCSTR
  ,J_1000075_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000075_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000131_ID           TYPE OF COLUMN TABL$J_4.ID
  ,J_1000131_DOCSTR       TYPE OF COLUMN TABL$J_4.DOCSTR
  ,J_1000131_DOCNUMBER    TYPE OF COLUMN TABL$J_4.DOCNUMBER
  ,J_1000131_DOCNUMBER_2  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000131_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000131_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000131_DATE_PAY     TYPE OF COLUMN TABL$J_4.DATE_COMMIT
  ,J_1000141_ID           TYPE OF COLUMN TABL$J_4.ID
  ,J_1000141_DOCSTR       TYPE OF COLUMN TABL$J_4.DOCSTR
  ,J_1000141_DOCNUMBER    TYPE OF COLUMN TABL$J_4.DOCNUMBER
  ,J_1000141_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
  ,J_1000141_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
)AS
  DECLARE VARIABLE P_CS_ADDR_ID TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_CS_DOC_ID  TYPE OF COLUMN TABL$R_CS_DOCS.ID;
  DECLARE VARIABLE P_VAL_DATE   TYPE OF COLUMN TABL$R_CS.VALUE_DATE;
  DECLARE VARIABLE P_STR        TYPE OF COLUMN TABL$R_CS_DOCS.NAME;
  DECLARE VARIABLE P_DATE       TYPE OF COLUMN TABL$R_CS_DOCS.DOC_DATE;
  DECLARE VARIABLE P_J_ROOT_ID  TYPE OF COLUMN TABL$J_4.ID;
BEGIN
  SELECT FIRST 1 J.ID, J.NAME, J.FLAG_DELETE, J.FLAG_COMMIT, J.FLAG_LOCK, J.TYPE_ID, TD.NAME, TD.COLOR_FRG, TD.COLOR_BGR,
         J.DOCNUMBER, J.DOCSUM, J.DOCSUMVAL, J.VALUTE_ID, CONTR.VALUTE, CONTR.VALUTE_SHORT, J.FIRM_ID, FIRM.NAME, J.FILIAL_ID,
         FF.NAME, FF.COLOR_BGR, FF.COLOR_FRG,
         J.USER_ID, J.DATE_COMMIT, J.DOCNUMBERSTR,J.DOCSTR
  FROM   TABL$J_4 J, TABL$R_FIRMS FIRM, TABL$R_FILIALS FF, TABL$R_COUNTRIES CONTR, TABL$_TB_DOCS TD
  WHERE  (J.ID     = :Q_J_ID)
    AND  (TD.ID    = J.TYPE_ID)
    AND  (FIRM.ID  = J.FIRM_ID)
    AND  (FF.ID    = J.FILIAL_ID)
    AND  (CONTR.ID = J.VALUTE_ID)
  INTO   :ID, :NAME, :FLAG_DELETE, :FLAG_COMMIT, :FLAG_LOCK, :TYPE_ID, :TYPE_NAME, :COLOR_FRG, :COLOR_BGR,
         :DOCNUMBER, :DOCSUM, :DOCSUMVAL, :VALUTE_ID, :VALUTE_NAME, :VALUTE_SHORT, :FIRM_ID, :FIRM_NAME, :FILIAL_ID, :FILIAL_NAME,
         :FILIAL_COLOR_BGR, :FILIAL_COLOR_FRG, 
         :USER_ID, :DATE_COMMIT, :DOCNUMBERSTR,:DOCSTR
         ;
  SELECT FIRST 1 COALESCE(W.NAME, :USER_ID), COALESCE(W.DOVER,'') 
  FROM   TABL$R_WRK W 
  WHERE  (TRIM(W.USER_NAME) = :USER_ID)
  INTO   :USER_NAME, :WRK_DOVER; IF(:USER_NAME IS NULL)THEN USER_NAME = :USER_ID;
  
  SELECT FIRST 1 JB.CS_ID, CS.NAME, CS.NAME2, CS.INN, CS.CODECARD, JB.CS_ADDR_ID, JB.PLACE_ID, PLACE.NAME, JB.TAX_ID, JB.TO_PLACE_ID,
         (SELECT FIRST 1 COALESCE(PL.NAME,'') FROM TABL$R_PLACES PL WHERE (PL.ID = JB.TO_PLACE_ID)) AS TO_PLACE_NAME,
         JB.TMC_GRID_ID, JB.CS_DOC_ID, COALESCE(JB.NDP,0), COALESCE(JB.DOCSUMNDP,0), JB.J_PAY_ID, JB.P_SUM, JB.P_NDP, JB.P_SUMNDP,
         JB.FLAG_PNP02, JB.GUESTQUANT, JB.PLATENO, JB.POINTS, JB.PAYPOINTS
  FROM   TABL$J_1000014 JB, TABL$R_CS CS, TABL$R_PLACES PLACE
  WHERE  (JB.J_ID = :ID)
    AND  (CS.ID = JB.CS_ID)
    AND  (PLACE.ID = JB.PLACE_ID)
  INTO   :CS_ID, :CS_NAME, :CS_NAME2, :CS_INN, :CS_CODECARD, :CS_ADDR_ID,  :PLACE_ID, :PLACE_NAME, :TAX_ID, :TO_PLACE_ID, :TO_PLACE_NAME,
         :TMC_GRID_ID, :CS_DOC_ID, :NDP, :DOCSUMNDP, :J_PAY_ID, :P_SUM, :P_NDP, :P_SUMNDP,
         :FLAG_PNP02, :GUESTQUANT, :PLATENO, :POINTS, :PAYPOINTS;

  DOCSUMNDP      = COALESCE(:DOCSUM + :NDP, 0);
  DOCSUMPRINT    = COALESCE(:DOCSUM,0);
  NDPPRINT       = COALESCE(:NDP,0);
  DOCSUMNDPPRINT = COALESCE(:DOCSUMNDP,0);
  IF(:NDP < 0)THEN
    BEGIN
    NDPPRINT    = (-1) * :NDPPRINT;
    DOCSUMPRINT = :DOCSUMPRINT - :NDPPRINT;
    DOCSUMNDP   = ROUND(:DOCSUM,2);
    END

  J_1000131_DATE_PAY = NULL;

  SELECT FIRST 1 J.DOCSTR, J.DATE_COMMIT 
  FROM   TABL$J_4 J 
  WHERE  (J.ID = :J_PAY_ID)
  INTO   :J_PAY_DOCSTR, :J_1000131_DATE_PAY;
  
  SELECT FIRST 1 COALESCE(TG.NAME,'') FROM TABL$R_TMC_GRID TG WHERE(TG.ID = :TMC_GRID_ID) INTO :TMC_GRID_NAME;

  P_CS_ADDR_ID = :CS_ADDR_ID;
  IF((:CS_ADDR_ID IS NULL)OR(:CS_ADDR_ID = 0))THEN
    SELECT FIRST 1 CSA.ID FROM TABL$R_CS_ADDR CSA WHERE(CSA.CS_ID = :CS_ID) INTO :P_CS_ADDR_ID;
  SELECT FIRST 1 PR.ADDRESS_NAME_FULL FROM PROC$R_CS_ADDR_GET(:P_CS_ADDR_ID) PR INTO :CS_ADDR_NAME;

  CS_POINTS = 0;
  SELECT COALESCE(SUM(P.POINTS),0)
  FROM   TABL$P_CS_RSPOINTS P
  WHERE  (P.PARENT_ID = 0)
    AND  (P.CS_ID = :CS_ID)
  INTO :CS_POINTS;  
  
  P_CS_DOC_ID = :CS_DOC_ID;
  IF( (:CS_DOC_ID IS NULL) OR (:CS_DOC_ID = 0) )THEN
    BEGIN
    SELECT FIRST 1 CSD.ID FROM TABL$R_CS_DOCS CSD WHERE(CSD.CS_ID = :CS_ID) INTO :P_CS_DOC_ID;
    SELECT COALESCE(MIN(P.ID), 0)
    FROM   PROC$J_PARENTS(:ID) P
    WHERE  (P.TYPE_ID IN (1000075, 1000028))
    INTO   :P_J_ROOT_ID;

    CS_DOCS_SERIAL    = ''; 
    CS_DOCS_NUMBER    = '-';
    CS_DOCS_NAME      = 'Договiр поставки';
    CS_DOCS_RECEPIENT = '';    
    SELECT FIRST 1 JJ.DATE_COMMIT 
    FROM   TABL$J_4 JJ
    WHERE  (JJ.ID = :P_J_ROOT_ID)
    INTO   :CS_DOCS_DATE;
    END
   ELSE
    BEGIN
    CS_DOCS_NAME = 'Договiр поставки';
    SELECT FIRST 1 COALESCE(DT.NAME,''), COALESCE(CD.DOC_SERIAL,''), COALESCE(CD.DOC_NUMBER,'')
          ,COALESCE(CD.NAME,'Договiр поставки'), CD.DOC_DATE, COALESCE(CD.RECEPIENT,'')
    FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
    WHERE  (CD.ID    = :P_CS_DOC_ID)
      AND  (DT.ID    = CD.DOCTYPE_ID)
    INTO   :CS_DOCS_TYPE, :CS_DOCS_SERIAL, :CS_DOCS_NUMBER, :CS_DOCS_NAME, :CS_DOCS_DATE, :CS_DOCS_RECEPIENT;
    CS_DOCS_NAME = :CS_DOCS_TYPE;
    IF(TRIM(:CS_DOCS_NAME) = '')THEN 
      CS_DOCS_NAME = 'Договiр поставки';
    END 

  SELECT FIRST 1 COALESCE(DT.NAME,'')||' Серия "'||COALESCE(CD.DOC_SERIAL,'')||'" №'||COALESCE(CD.DOC_NUMBER,'')||'  Выдан: '||COALESCE(CD.NAME,'')||' от "', CD.DOC_DATE
  FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
  WHERE  (CD.ID    = :P_CS_DOC_ID)
    AND  (DT.ID    = CD.DOCTYPE_ID)
  INTO   :CS_DOC_NAME, :P_DATE; IF(:P_DATE IS NULL)THEN P_DATE = CURRENT_TIMESTAMP;
  SELECT FIRST 1 P.OUT_STR FROM PROC$__FORMAT_DATETIME(:P_DATE, 'DD.MM.YYYY') P INTO :P_STR;
  CS_DOC_NAME = :CS_DOC_NAME||:P_STR||'"p.';


  SELECT FIRST 1 COALESCE(W.ID, -1), COALESCE(W.NAME, :USER_ID)
  FROM   TABL$R_WRK W
  WHERE  (TRIM(W.USER_NAME) = :USER_ID)
  INTO   :WRK_ID, :WRK_NAME;

  SELECT MAX(P.VALUE_DATE)
  FROM   TABL$R_CS_P P
  WHERE  (P.CS_ID = :CS_ID)
    AND  (P.VALUE_DATE <= CURRENT_TIMESTAMP)
  INTO   :P_VAL_DATE;

  IF(:P_VAL_DATE IS NULL)THEN
    BEGIN
    CS_AMOUNT = 0.000;
    END
   ELSE
    BEGIN
    SELECT FIRST 1 PW.AMOUNT
    FROM   TABL$R_CS_P PW
    WHERE  (PW.CS_ID = :CS_ID)
      AND  (PW.VALUE_DATE = :P_VAL_DATE)
    INTO   :CS_AMOUNT;
    END

  DOCNUMBER_2 = :DOCNUMBER;
  WHILE(CHAR_LENGTH(:DOCNUMBER_2) < 7)DO
    DOCNUMBER_2 = ' '||:DOCNUMBER_2;

  J_1000075_ID = 0; J_1000075_DOCSTR = ''; J_1000075_DOCNUMBERSTR = '';
  J_1000131_ID = 0; J_1000131_DOCSTR = ''; J_1000131_DOCNUMBERSTR = ''; J_1000131_DOCNUMBER = '';
  J_1000141_ID = 0; J_1000141_DOCSTR = ''; J_1000141_DOCNUMBERSTR = ''; J_1000141_DOCNUMBER = '';

  SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000075) P INTO :J_1000075_ID;
  IF(:J_1000075_ID = 0)THEN
    SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000136) P INTO :J_1000075_ID;
  SELECT FIRST 1 COALESCE(J.DOCNUMBERSTR,''), COALESCE(J.DOCSTR,''), COALESCE(J.DATE_COMMIT,CURRENT_TIMESTAMP)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :J_1000075_ID)
  INTO   :J_1000075_DOCNUMBERSTR, :J_1000075_DOCSTR, :J_1000075_DATE_COMMIT;

  SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000131) P INTO :J_1000131_ID;
  SELECT FIRST 1 COALESCE(J.DOCNUMBER,''), COALESCE(J.DOCNUMBERSTR,''), COALESCE(J.DOCSTR,''), COALESCE(J.DATE_COMMIT,CURRENT_TIMESTAMP)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :J_1000131_ID)
  INTO   :J_1000131_DOCNUMBER, :J_1000131_DOCNUMBERSTR, :J_1000131_DOCSTR, :J_1000131_DATE_COMMIT;
  
  J_1000131_DOCNUMBER_2 = :J_1000131_DOCNUMBER;
  WHILE(CHAR_LENGTH(:J_1000131_DOCNUMBER_2) < 7)DO
    J_1000131_DOCNUMBER_2 = ' '||:J_1000131_DOCNUMBER_2;

  SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000141) P INTO :J_1000141_ID;
  SELECT FIRST 1 COALESCE(J.DOCNUMBER,''), COALESCE(J.DOCNUMBERSTR,''), COALESCE(J.DOCSTR,''), COALESCE(J.DATE_COMMIT,CURRENT_TIMESTAMP)
  FROM   TABL$J_4 J
  WHERE  (J.ID = :J_1000141_ID)
  INTO   :J_1000141_DOCNUMBER, :J_1000141_DOCNUMBERSTR, :J_1000141_DOCSTR, :J_1000141_DATE_COMMIT;

  SUSPEND;
END
