EXECUTE BLOCK(
  Q_J_ID TYPE OF COLUMN TABL$J_4.ID = ?J_ID
)RETURNS(
  ID                    TYPE OF COLUMN TABL$J_4.ID
 ,NAME                  TYPE OF COLUMN TABL$J_4.NAME
 ,FLAG_DELETE           TYPE OF COLUMN TABL$J_4.FLAG_DELETE
 ,FLAG_COMMIT           TYPE OF COLUMN TABL$J_4.FLAG_COMMIT
 ,TYPE_ID               TYPE OF COLUMN TABL$J_4.TYPE_ID
 ,TYPE_NAME             TYPE OF COLUMN TABL$_TB_DOCS.NAME
 ,COLOR_FRG             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_FRG
 ,COLOR_BGR             TYPE OF COLUMN TABL$_TB_DOCS.COLOR_BGR
 ,DOCNUMBER             TYPE OF COLUMN TABL$J_4.DOCNUMBER
 ,DOCSUM                TYPE OF COLUMN TABL$J_4.DOCSUM
 ,DOCSUMVAL             TYPE OF COLUMN TABL$J_4.DOCSUMVAL
 ,VALUTE_ID             TYPE OF COLUMN TABL$J_4.VALUTE_ID
 ,VALUTE_NAME           TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE
 ,VALUTE_SHORT          TYPE OF COLUMN TABL$R_COUNTRIES.VALUTE_SHORT
 ,FIRM_ID               TYPE OF COLUMN TABL$J_4.FIRM_ID
 ,FIRM_NAME             TYPE OF COLUMN TABL$R_FIRMS.NAME
 ,FILIAL_ID             TYPE OF COLUMN TABL$J_4.FILIAL_ID
 ,FILIAL_NAME           TYPE OF COLUMN TABL$R_FILIALS.NAME
 ,USER_ID               TYPE OF COLUMN TABL$J_4.USER_ID
 ,USER_NAME             TYPE OF COLUMN TABL$_USERS.NAME
 ,WRK_DOVER             TYPE OF COLUMN TABL$R_WRK.DOVER
 ,DATE_COMMIT           TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,DOCNUMBERSTR          TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,DOCSTR                TYPE OF COLUMN TABL$J_4.DOCSTR
 ,CS_ID                 TYPE OF COLUMN TABL$J_1000014.CS_ID
 ,CS_NAME               TYPE OF COLUMN TABL$R_CS.NAME
 ,CS_INN                TYPE OF COLUMN TABL$R_CS.INN
 ,CS_AMOUNT             TYPE OF COLUMN TABL$R_CS_P.AMOUNT
 ,CS_ADDR_ID            TYPE OF COLUMN TABL$J_1000014.CS_ADDR_ID
 ,CS_ADDR_NAME          TYPE OF COLUMN TABL$R_CS_ADDR.NAME
 ,CS_DOC_NAME           TYPE OF COLUMN TABL$R_CS_DOCS.NAME
 ,PLACE_ID              TYPE OF COLUMN TABL$J_1000014.PLACE_ID
 ,PLACE_NAME            TYPE OF COLUMN TABL$R_PLACES.NAME
 ,TAX_ID                TYPE OF COLUMN TABL$J_1000014.TAX_ID
 ,TO_PLACE_ID           TYPE OF COLUMN TABL$J_1000014.TO_PLACE_ID
 ,TO_PLACE_NAME         TYPE OF COLUMN TABL$R_PLACES.NAME
 ,WRK_ID                TYPE OF COLUMN TABL$J_1000014.WRK_ID
 ,WRK_NAME              TYPE OF COLUMN TABL$R_WRK.NAME
 ,TMC_GRID_ID           TYPE OF COLUMN TABL$J_1000014.TMC_GRID_ID
 ,J_ZALOG_ID            TYPE OF COLUMN TABL$J_4.ID
 ,J_ZALOG_DOCNUMBERSTR  TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_ZALOG_DATE_COMMIT   TYPE OF COLUMN TABL$J_4.DATE_COMMIT
 ,J_ZAKLAD_ID           TYPE OF COLUMN TABL$J_4.ID
 ,J_ZAKLAD_DOCNUMBERSTR TYPE OF COLUMN TABL$J_4.DOCNUMBERSTR
 ,J_ZAKLAD_DATE_COMMIT  TYPE OF COLUMN TABL$J_4.DATE_COMMIT
)AS
  DECLARE VARIABLE P_CS_ADDR_ID TYPE OF COLUMN TABL$R_CS_ADDR.ID;
  DECLARE VARIABLE P_CS_PHONES  TYPE OF COLUMN TABL$R_CS_ADDR.NAME;
  DECLARE VARIABLE P_STR        TYPE OF COLUMN TABL$R_CS_DOCS.NAME;
  DECLARE VARIABLE P_DATE       TYPE OF COLUMN TABL$R_CS_DOCS.DOC_DATE;
  DECLARE VARIABLE P_VAL_DATE   TYPE OF COLUMN TABL$R_CS.VALUE_DATE;
BEGIN
  SELECT FIRST 1 J.ID, J.NAME, J.FLAG_DELETE, J.FLAG_COMMIT, J.TYPE_ID, TD.NAME, TD.COLOR_FRG, TD.COLOR_BGR
         ,J.DOCNUMBER, J.DOCSUM, J.DOCSUMVAL, J.VALUTE_ID, CONTR.VALUTE, CONTR.VALUTE_SHORT, J.FIRM_ID, FIRM.NAME, J.FILIAL_ID
         ,(SELECT FIRST 1 COALESCE(FF.NAME,'') FROM TABL$R_FILIALS FF WHERE (FF.ID = J.FILIAL_ID)) AS FILIAL_NAME
         ,J.USER_ID
         ,(SELECT FIRST 1 COALESCE(W.NAME, J.USER_ID) FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID)) AS USER_NAME
         ,(SELECT FIRST 1 COALESCE(W.DOVER, '') FROM TABL$R_WRK W WHERE (W.USER_NAME = J.USER_ID)) AS WRK_DOVER
         ,J.DATE_COMMIT, J.DOCNUMBERSTR, J.DOCSTR
         ,JB.CS_ID, CS.NAME, CS.INN, JB.CS_ADDR_ID, JB.PLACE_ID, PLACE.NAME, JB.TAX_ID, JB.TO_PLACE_ID
         ,(SELECT FIRST 1 COALESCE(PL.NAME,'') FROM TABL$R_PLACES PL WHERE (PL.ID = JB.TO_PLACE_ID)) AS TO_PLACE_NAME
         ,JB.TMC_GRID_ID, JB.WRK_ID
         ,(SELECT FIRST 1 COALESCE(W1.NAME, '') FROM TABL$R_WRK W1 WHERE (W1.ID = JB.WRK_ID)) AS WRK_NAME
  FROM    TABL$J_4 J, TABL$R_FIRMS FIRM, TABL$R_COUNTRIES CONTR, TABL$_TB_DOCS TD
         ,TABL$J_1000014 JB, TABL$R_CS CS, TABL$R_PLACES PLACE
  WHERE  (J.ID     = :Q_J_ID)
    AND  (TD.ID    = J.TYPE_ID)
    AND  (FIRM.ID  = J.FIRM_ID)
    AND  (CONTR.ID = J.VALUTE_ID)
    AND  (JB.J_ID  = J.ID)
    AND  (CS.ID    = JB.CS_ID)
    AND  (PLACE.ID = JB.PLACE_ID)
  INTO   :ID, :NAME, :FLAG_DELETE, :FLAG_COMMIT, :TYPE_ID, :TYPE_NAME, :COLOR_FRG, :COLOR_BGR
        ,:DOCNUMBER, :DOCSUM, :DOCSUMVAL, :VALUTE_ID, :VALUTE_NAME, :VALUTE_SHORT, :FIRM_ID, :FIRM_NAME, :FILIAL_ID, :FILIAL_NAME
        ,:USER_ID, :USER_NAME, :WRK_DOVER, :DATE_COMMIT, :DOCNUMBERSTR, :DOCSTR
        ,:CS_ID, :CS_NAME, :CS_INN, :CS_ADDR_ID,  :PLACE_ID, :PLACE_NAME, :TAX_ID, :TO_PLACE_ID, :TO_PLACE_NAME
        ,:TMC_GRID_ID, :WRK_ID, :WRK_NAME
        ;

  P_CS_ADDR_ID = :CS_ADDR_ID;
  IF((:CS_ADDR_ID IS NULL) OR (:CS_ADDR_ID = 0))THEN
    SELECT FIRST 1 CSA.ID FROM TABL$R_CS_ADDR CSA WHERE(CSA.CS_ID = :CS_ID) INTO :P_CS_ADDR_ID;
  SELECT FIRST 1 CSA.NAME  FROM TABL$R_CS_ADDR CSA WHERE(CSA.ID = :CS_ADDR_ID)INTO :CS_ADDR_NAME;
  SELECT LIST(P.NAME, '; ')FROM TABL$R_CS_PHONES P WHERE(P.CS_ID = :CS_ID)    INTO   :P_CS_PHONES;
  IF(:CS_ADDR_NAME IS NULL)THEN CS_ADDR_NAME = '';
  IF(:P_CS_PHONES  IS NULL)THEN P_CS_PHONES  = '';
  CS_ADDR_NAME  = :CS_ADDR_NAME||'. T.:'||:P_CS_PHONES;

  SELECT FIRST 1 DT.NAME||' CEPÈß "'||CD.DOC_SERIAL||'" ¹'||CD.DOC_NUMBER||'  BÛÄAH: '||CD.NAME||' OT "', CD.DOC_DATE
  FROM   TABL$R_CS_DOCS CD, TABL$R_WRK_DOCTYPES DT
  WHERE  (CD.CS_ID = :CS_ID)
    AND  (DT.ID    = CD.DOCTYPE_ID)
  INTO   :CS_DOC_NAME, :P_DATE;

  SELECT FIRST 1 P.OUT_STR FROM PROC$__FORMAT_DATETIME(:P_DATE, 'DD.MM.YYYY') P INTO :P_STR;

  CS_DOC_NAME = :CS_DOC_NAME||:P_STR||'"Ã.';

  SELECT MAX(P.VALUE_DATE)
  FROM   TABL$R_CS_P P
  WHERE  (P.CS_ID = :CS_ID)
    AND  (P.VALUE_DATE <= CURRENT_TIMESTAMP)
  INTO   :P_VAL_DATE;

  IF(:P_VAL_DATE IS NULL)THEN
    BEGIN
    CS_AMOUNT = 0.000;
    END
   ELSE
    BEGIN
    SELECT FIRST 1 PW.AMOUNT
    FROM   TABL$R_CS_P PW
    WHERE  (PW.CS_ID = :CS_ID)
      AND  (PW.VALUE_DATE = :P_VAL_DATE)
    INTO   :CS_AMOUNT;
    END

  SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000062) P INTO :J_ZALOG_ID;
  IF(:J_ZALOG_ID <> 0)THEN
    SELECT FIRST 1 JF.DOCNUMBERSTR, JF.DATE_COMMIT
    FROM   TABL$J_4 JF
    WHERE  (JF.ID = :J_ZALOG_ID)
    INTO   :J_ZALOG_DOCNUMBERSTR, :J_ZALOG_DATE_COMMIT;

  SELECT FIRST 1 COALESCE(P.J_ID,0) FROM PROC$D_GET_4_ROOT(:ID, 1000064) P INTO :J_ZAKLAD_ID;
  IF(:J_ZAKLAD_ID <> 0)THEN
    SELECT FIRST 1 JF.DOCNUMBERSTR, JF.DATE_COMMIT
    FROM   TABL$J_4 JF
    WHERE  (JF.ID = :J_ZAKLAD_ID)
    INTO   :J_ZAKLAD_DOCNUMBERSTR, :J_ZAKLAD_DATE_COMMIT;
  SUSPEND;
END
