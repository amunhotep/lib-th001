EXECUTE BLOCK (
  Q_J_ID   TYPE OF COLUMN TABL$J_4.ID     = ?J_ID
 ,Q_DOCSUM TYPE OF COLUMN TABL$J_4.DOCSUM = ?DOCSUM
)AS
  DECLARE VARIABLE P_DOCSUM   TYPE OF COLUMN TABL$J_4.DOCSUM;
  DECLARE VARIABLE P_D_ID     TYPE OF COLUMN TABL$D_1000014.ID;
  DECLARE VARIABLE P_TMC_ID   TYPE OF COLUMN TABL$D_1000014.TMC_ID;
  DECLARE VARIABLE P_PRICE    TYPE OF COLUMN TABL$D_1000014.PRICE;
  DECLARE VARIABLE P_QUANT    TYPE OF COLUMN TABL$D_1000014.QUANT;
  DECLARE VARIABLE P_NDPTOTAL TYPE OF COLUMN TABL$D_1000014.NDPTOTAL;
  DECLARE VARIABLE P_TOTAL    TYPE OF COLUMN TABL$D_1000014.TOTAL;
BEGIN
  IF(NOT(EXISTS(SELECT JP.ID FROM TABL$J_4 JP WHERE(JP.ID = :Q_J_ID     ))))THEN EXIT;

  SELECT FIRST 1 J.P_SUMNDP
  FROM   TABL$J_1000014 J
  WHERE  (J.J_ID = :Q_J_ID)
  INTO   :P_DOCSUM;

  FOR
    SELECT D.ID, D.TMC_ID, D.PRICE, D.QUANT, D.NDPTOTAL, D.TOTAL
    FROM   TABL$D_1000014 D
    WHERE  (D.J_ID = :Q_J_ID)
    INTO   :P_D_ID, :P_TMC_ID, :P_PRICE, :P_QUANT, :P_NDPTOTAL, :P_TOTAL
  DO
    BEGIN
    P_TOTAL = :P_TOTAL * (:P_DOCSUM + :Q_DOCSUM) /:P_DOCSUM;
    P_PRICE = :P_TOTAL / :P_QUANT;
    UPDATE TABL$D_1000014 D SET
      D.PRICE = :P_PRICE
    WHERE (D.ID = :P_D_ID);
    END
END
