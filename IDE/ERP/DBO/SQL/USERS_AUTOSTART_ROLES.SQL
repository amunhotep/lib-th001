EXECUTE BLOCK (
  Q_USER_VARIABLE TYPE OF COLUMN TABL$_USERS.NAME          = ?USER_VARIABLE
 ,Q_INITIAL_PATH  TYPE OF COLUMN TABL$_EXCHANGE_FILES.NAME = ?INITIAL_PATH
)RETURNS(
  PATH TYPE OF COLUMN TABL$_EXCHANGE_FILES.NAME
 ,SRC  TYPE OF COLUMN TABL$_FS.SRC
)AS
  DECLARE VARIABLE P_ROLE_ID   TYPE OF COLUMN TABL$_USERS_ROLES.ID;
  DECLARE VARIABLE P_TEMP_PATH TYPE OF COLUMN TABL$_EXCHANGE_FILES.NAME;
BEGIN
  FOR
    SELECT UA.ROLE_ID
    FROM   TABL$_USERS_ACCS UA
    WHERE  ( UA.USER_ID = RDB$GET_CONTEXT('USER_SESSION', :Q_USER_VARIABLE) )
    INTO   :P_ROLE_ID
  DO
    BEGIN
    P_TEMP_PATH = :Q_INITIAL_PATH||:P_ROLE_ID||'%.PS';
    IF(:P_TEMP_PATH STARTING WITH 'DB:')THEN
      P_TEMP_PATH = SUBSTRING(:P_TEMP_PATH FROM 4);
    FOR
      SELECT 'DB:'||TMP.PATH, TMP.SRC
      FROM   (
                WITH RECURSIVE FS AS(
                  SELECT F1.ID, F1.PARENT_ID, F1.NAME, F1.EXT, F1.SRC
                        ,CASE F1.EXT WHEN '..' THEN F1.NAME||'/' ELSE F1.NAME||'.'||F1.EXT END AS PATH
                  FROM   TABL$_FS F1 WHERE (F1.PARENT_ID = 0)
                  UNION ALL
                  SELECT F2.ID, F2.PARENT_ID, F2.NAME, F2.EXT, F2.SRC
                        ,CASE F2.EXT WHEN '..' THEN F3.PATH||F2.NAME||'/' ELSE F3.PATH||F2.NAME||'.'||F2.EXT END AS PATH
                  FROM   TABL$_FS F2, FS F3 WHERE (F2.PARENT_ID = F3.ID)
                )SELECT F.PATH, F.SRC FROM FS F WHERE (F.PATH LIKE :P_TEMP_PATH) AND (F.EXT<>'..')
             )TMP
      INTO   :PATH, :SRC
    DO
      SUSPEND;
    END
END
