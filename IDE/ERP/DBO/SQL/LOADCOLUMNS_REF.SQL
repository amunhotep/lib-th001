EXECUTE BLOCK(
   Q_TB_ID         TYPE OF COLUMN TABL$_TB_COLS.TB_ID = ?PQ_TB_ID
  ,Q_USER_VAR      TYPE OF COLUMN TABL$_USERS.ID      = ?PQ_USER_VAR
)RETURNS (
   USER_ID           TYPE OF COLUMN TABL$_USERS.ID
  ,MAINTB_ID         TYPE OF COLUMN TABL$_TB_COLS.TB_ID
  ,MAIN_BASE_TYPE_ID TYPE OF COLUMN TABL$_TB.BASE_TYPE_ID
  ,MAIN_BUFFER_VAR   TYPE OF COLUMN TABL$_TB.BUFFER_VAR
  ,MAIN_SC_REF       TYPE OF COLUMN TABL$_TB.SC_REF
  ,MAIN_SC_REF_DLG   TYPE OF COLUMN TABL$_TB.SC_REF_DLG
  ,MAIN_SC_ITEM      TYPE OF COLUMN TABL$_TB.SC_ITEM
  ,MAIN_SC_ITEM_DLG  TYPE OF COLUMN TABL$_TB.SC_ITEM_DLG
  ,TB_ID             TYPE OF COLUMN TABL$_TB_COLS.TB_ID
  ,ID                TYPE OF COLUMN TABL$_TB_COLS.ID
  ,NAME              TYPE OF COLUMN TABL$_TB_COLS.NAME
  ,HINT              TYPE OF COLUMN TABL$_TB_COLS.HINT
  ,FLAG_DELETE       TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE
  ,FIELD_TYPE        TYPE OF COLUMN TABL$_TB_COLS.FIELD_TYPE
  ,ALIGNMENT         TYPE OF COLUMN TABL$_TB_COLS.ALIGNMENT
  ,FORMAT            TYPE OF COLUMN TABL$_TB_COLS.FORMAT
  ,WIDTH             TYPE OF COLUMN TABL$_TB_COLS.WIDTH
  ,COLOR             TYPE OF COLUMN TABL$_TB_COLS.EDT_LEFT
  ,COL_INDEX         TYPE OF COLUMN TABL$_TB_COLS.COL_INDEX
  ,ROW_INDEX         TYPE OF COLUMN TABL$_TB_COLS.ROW_INDEX
  ,ORIENTATION       TYPE OF COLUMN TABL$_TB_COLS.ORIENTATION
  ,PICK_LIST         TYPE OF COLUMN TABL$_TB_COLS.PICK_LIST
  ,KEY_LIST          TYPE OF COLUMN TABL$_TB_COLS.KEY_LIST
  ,DEFAULT_VALUE     TYPE OF COLUMN TABL$_TB_COLS.DEFAULT_VALUE
  ,CALC_SQL          TYPE OF COLUMN TABL$_TB_COLS.CALC_SQL
  ,EDT_LEFT          TYPE OF COLUMN TABL$_TB_COLS.EDT_LEFT
  ,EDT_TOP           TYPE OF COLUMN TABL$_TB_COLS.EDT_TOP
  ,REF_TABLE         TYPE OF COLUMN TABL$_TB_COLS.REF_TABLE
  ,REF_FIELD         TYPE OF COLUMN TABL$_TB_COLS.REF_FIELD
  ,REF_KEYFIELD      TYPE OF COLUMN TABL$_TB_COLS.REF_KEYFIELD
  ,REF_WHERE         TYPE OF COLUMN TABL$_TB_COLS.REF_WHERE
  ,REF_WHEREEDIT     TYPE OF COLUMN TABL$_TB_COLS.REF_WHEREEDIT
  ,REF_BUFFER_VAR    TYPE OF COLUMN TABL$_TB.BUFFER_VAR
  ,REF_SC_REF        TYPE OF COLUMN TABL$_TB.SC_REF
  ,REF_SC_REF_DLG    TYPE OF COLUMN TABL$_TB.SC_REF_DLG
  ,REF_SC_ITEM       TYPE OF COLUMN TABL$_TB.SC_ITEM
  ,REF_SC_ITEM_DLG   TYPE OF COLUMN TABL$_TB.SC_ITEM_DLG
  ,SUBKONTO_FIELD    TYPE OF COLUMN TABL$_TB_COLS.SUBKONTO_FIELD
  ,FLAG_FOOTER       TYPE OF COLUMN TABL$_TB_COLS.FLAG_FOOTER
  ,FOOTER_COUNT      TYPE OF COLUMN TABL$_TB_COLS.COL_INDEX
  ,FLAG_ADDITIONAL   TYPE OF COLUMN TABL$_TB_COLS.FLAG_ADDITIONAL
  ,FLAG_PERIODICAL   TYPE OF COLUMN TABL$_TB_COLS.FLAG_PERIODICAL
  ,FLAG_UPDNULL      TYPE OF COLUMN TABL$_TB_COLS.FLAG_PERIODICAL
  ,EMPTY_VALUE       TYPE OF COLUMN TABL$_TB_COLS.DEFAULT_VALUE
  ,FLAG_UPDDEFAULT   TYPE OF COLUMN TABL$_TB_COLS.FLAG_PERIODICAL
  ,ACCS_FLAG_READ    TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE
  ,ACCS_FLAG_WRITE   TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE
)AS
  DECLARE VARIABLE P_VER20111001 TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE;
  DECLARE VARIABLE P_VER20111101 TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE;
BEGIN
  TB_ID   = :Q_TB_ID;
  USER_ID = RDB$GET_CONTEXT('USER_SESSION',:Q_USER_VAR);
  P_VER20111001 = 0;
  P_VER20111101 = 0;
  IF(EXISTS(
    SELECT RF.RDB$FIELD_ID
    FROM   RDB$RELATION_FIELDS RF
    WHERE  (TRIM(RF.RDB$RELATION_NAME) = 'TABL$_TB_COLS')
      AND  (TRIM(RF.RDB$FIELD_NAME) = 'COLOR')
  ))THEN P_VER20111001 = 1;
  IF(EXISTS(
    SELECT RF.RDB$FIELD_ID
    FROM   RDB$RELATION_FIELDS RF
    WHERE  (TRIM(RF.RDB$RELATION_NAME) = 'TABL$_TB_COLS')
      AND  (TRIM(RF.RDB$FIELD_NAME) = 'FLAG_UPDNULL')
  ))THEN P_VER20111101 = 1;

  MAINTB_ID = :TB_ID;
  SELECT FIRST 1 TBM.BASE_TYPE_ID, TBM.BUFFER_VAR, TBM.SC_REF, TBM.SC_REF_DLG, TBM.SC_ITEM, TBM.SC_ITEM_DLG
  FROM   TABL$_TB TBM 
  WHERE  (TBM.ID = :MAINTB_ID)
  INTO   :MAIN_BASE_TYPE_ID, :MAIN_BUFFER_VAR, :MAIN_SC_REF, :MAIN_SC_REF_DLG, :MAIN_SC_ITEM, :MAIN_SC_ITEM_DLG;

  FOR
    SELECT  TC.ID, TC.NAME, TC.HINT, TC.FLAG_DELETE, TC.FIELD_TYPE, TC.ALIGNMENT
           ,TC.FORMAT, TC.WIDTH, COALESCE(TC.COL_INDEX,0) AS COL_INDEX, TC.ROW_INDEX, TC.ORIENTATION
           ,TC.PICK_LIST, TC.KEY_LIST, TC.CALC_SQL, TC.REF_TABLE, TC.REF_FIELD
           ,TC.REF_KEYFIELD, TC.REF_WHERE, TC.REF_WHEREEDIT,TC.FLAG_FOOTER
           ,TC.FLAG_ADDITIONAL, COALESCE(TC.FLAG_PERIODICAL,0) AS FLAG_PERIODICAL, TC.DEFAULT_VALUE
           ,TC.EDT_LEFT, TC.EDT_TOP, TC.SUBKONTO_FIELD
    FROM   TABL$_TB_COLS TC 
    WHERE  (TC.TB_ID = :TB_ID) 
    ORDER BY FLAG_PERIODICAL, COL_INDEX, NAME, ID 
    INTO    :ID, :NAME, :HINT, :FLAG_DELETE, :FIELD_TYPE, :ALIGNMENT, :FORMAT
           ,:WIDTH, :COL_INDEX, :ROW_INDEX, :ORIENTATION, :PICK_LIST, :KEY_LIST
           ,:CALC_SQL, :REF_TABLE, :REF_FIELD, :REF_KEYFIELD, :REF_WHERE, :REF_WHEREEDIT
           ,:FLAG_FOOTER, :FLAG_ADDITIONAL, :FLAG_PERIODICAL, :DEFAULT_VALUE
           ,:EDT_LEFT, :EDT_TOP, :SUBKONTO_FIELD
  DO  
/*
    IF(EXISTS(
      SELECT R.RDB$FIELD_ID
      FROM   RDB$RELATION_FIELDS R
      WHERE  (TRIM(R.RDB$RELATION_NAME) = :TB_ID)
        AND  (TRIM(R.RDB$FIELD_NAME)    = :ID)
    ) OR (TRIM(:CALC_SQL) <> '') OR )THEN  
*/
      BEGIN 
      COLOR           = 0;
      FLAG_UPDNULL    = 0;
      EMPTY_VALUE     = 0;
      FLAG_UPDDEFAULT = 0;
      IF(:P_VER20111001 = 1)THEN
        EXECUTE STATEMENT ('SELECT FIRST 1 T.COLOR FROM TABL$_TB_COLS T WHERE (T.TB_ID = ?TB_ID)AND(T.ID = ?ID)')(
          TB_ID := :TB_ID
         ,ID    := :ID
        ) INTO :COLOR;  
      IF(:P_VER20111101 = 1)THEN
        EXECUTE STATEMENT ('SELECT FIRST 1 COALESCE(T.FLAG_UPDNULL,0), T.EMPTY_VALUE, COALESCE(T.FLAG_UPDDEFAULT,0) FROM TABL$_TB_COLS T WHERE (T.TB_ID = ?TB_ID)AND(T.ID = ?ID)')(
          TB_ID := :TB_ID
         ,ID    := :ID
        ) INTO :FLAG_UPDNULL, :EMPTY_VALUE, :FLAG_UPDDEFAULT;
      IF(:COLOR = 0)THEN COLOR = 0xFFF0F0;
      ACCS_FLAG_READ  = 0;
      ACCS_FLAG_WRITE = 0;
      FOOTER_COUNT    = 0; 
      REF_BUFFER_VAR  = '';
      REF_SC_REF      = '';
      REF_SC_REF_DLG  = ''; 
      REF_SC_ITEM     = '';
      REF_SC_ITEM_DLG = '';
      IF(TRIM(:REF_TABLE) <> '')THEN
        BEGIN 
        SELECT FIRST 1 TB1.BUFFER_VAR, TB1.SC_REF, TB1.SC_REF_DLG, TB1.SC_ITEM, TB1.SC_ITEM_DLG
        FROM   TABL$_TB TB1 
        WHERE  (TB1.ID = :REF_TABLE) 
        INTO   :REF_BUFFER_VAR, :REF_SC_REF, :REF_SC_REF_DLG, :REF_SC_ITEM, :REF_SC_ITEM_DLG;
        END 
      IF(:FLAG_FOOTER <> 0)THEN
        BEGIN
        SELECT COUNT(TF.ID)
        FROM   TABL$_TB_COLS_FOOTERS TF
        WHERE  (TF.TB_ID = :TB_ID)
          AND  (TF.TC_ID = :ID ) 
        INTO  :FOOTER_COUNT;
        END   
      ACCS_FLAG_READ  = 0;
      ACCS_FLAG_WRITE = 0;
      SELECT COALESCE(COUNT(TC.ID),0)
      FROM   TABL$_TB_COLS TC, TABL$_USERS_ACCS UA
      WHERE  (TC.TB_ID   = :TB_ID)
        AND  (TC.ID      = :ID)
        AND  (UA.USER_ID = :USER_ID)
        AND  (TC.ACCSS CONTAINING '~'||UA.ROLE_ID||'~')
      INTO   :ACCS_FLAG_READ;
      SELECT COALESCE(COUNT(TC.ID),0)
      FROM   TABL$_TB_COLS TC, TABL$_USERS_ACCS UA
      WHERE  (TC.TB_ID   = :TB_ID)
        AND  (TC.ID      = :ID)
        AND  (UA.USER_ID = :USER_ID)
        AND  (TC.ACCSSW CONTAINING '~'||UA.ROLE_ID||'~')
      INTO   :ACCS_FLAG_WRITE;
      SUSPEND;
      END 
END
