EXECUTE BLOCK(
  Q_TB_ID      TYPE OF COLUMN TABL$_TB_COLS.TB_ID       = ?TB_ID
 ,Q_TC_ID      TYPE OF COLUMN TABL$_TB_COLS.ID          = ?ID
 ,Q_ROLE_ID    TYPE OF COLUMN TABL$_USERS_ROLES.ID      = ?ROLE_ID
 ,Q_FLAG_READ  TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE = ?FLAG_READ
 ,Q_FLAG_WRITE TYPE OF COLUMN TABL$_TB_COLS.FLAG_DELETE = ?FLAG_WRITE
)AS
  DECLARE VARIABLE P_POS     TYPE OF COLUMN TABL$_MENU.ID;
  DECLARE VARIABLE P_ROLE_ID TYPE OF COLUMN TABL$_USERS_ROLES.ID;
  DECLARE VARIABLE p_ACCSS   TYPE OF COLUMN TABL$_TB_COLS.ACCSS;
  DECLARE VARIABLE p_ACCSSW  TYPE OF COLUMN TABL$_TB_COLS.ACCSSW;
BEGIN
  SELECT FIRST 1 T.ACCSS, T.ACCSSW
  FROM   TABL$_TB_COLS T
  WHERE  (T.TB_ID = :Q_TB_ID)
    AND  (T.ID    = :Q_TC_ID)
  INTO   :P_ACCSS, :P_ACCSSW;
  IF(:P_ACCSS  IS NULL)THEN P_ACCSS  = '~';
  IF(:P_ACCSSW IS NULL)THEN P_ACCSSW = '~';
  FOR SELECT R.ID FROM TABL$_USERS_ROLES R WHERE((R.ID = :Q_ROLE_ID) OR (:Q_ROLE_ID < 0)) ORDER BY R.ID INTO :P_ROLE_ID DO
    BEGIN
    IF(:Q_FLAG_READ >= 0)THEN
      BEGIN
      IF(:Q_FLAG_READ = 1)THEN
        BEGIN
        IF(:P_ACCSS NOT CONTAINING '~'||:P_ROLE_ID||'~')THEN
          BEGIN
          IF(SUBSTRING(:P_ACCSS FROM CHAR_LENGTH(:P_ACCSS) FOR 1) <> '~')THEN
            P_ACCSS = :P_ACCSS||'~';
          P_ACCSS = :P_ACCSS||:P_ROLE_ID||'~';
          END
        END
       ELSE
        BEGIN
        IF(:P_ACCSS CONTAINING '~'||:P_ROLE_ID||'~')THEN
          BEGIN
          P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
          WHILE(:P_POS > 0)DO
            BEGIN
            P_ACCSS = SUBSTRING(:P_ACCSS FROM 1 FOR (:P_POS - 1)) || SUBSTRING(:P_ACCSS FROM (:P_POS + CHAR_LENGTH('~'||:P_ROLE_ID)));
            P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
            END
          END
        END
      END
    IF(:Q_FLAG_WRITE >= 0)THEN
      BEGIN
      IF(:Q_FLAG_WRITE = 1)THEN
        BEGIN
        IF(:P_ACCSSW NOT CONTAINING '~'||:P_ROLE_ID||'~')THEN
          BEGIN
          IF(SUBSTRING(:P_ACCSSW FROM CHAR_LENGTH(:P_ACCSSW) FOR 1) <> '~')THEN
            P_ACCSSW = :P_ACCSSW||'~';
          P_ACCSSW = :P_ACCSSW||:P_ROLE_ID||'~';
          END
        END
       ELSE
        BEGIN
        IF(:P_ACCSSW CONTAINING '~'||:P_ROLE_ID||'~')THEN
          BEGIN
          P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSSW);
          WHILE(:P_POS > 0)DO
            BEGIN
            P_ACCSSW = SUBSTRING(:P_ACCSSW FROM 1 FOR (:P_POS - 1)) || SUBSTRING(:P_ACCSSW FROM (:P_POS + CHAR_LENGTH('~'||:P_ROLE_ID)));
            P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSSW);
            END
          END
        END
      END
    END
  UPDATE TABL$_TB_COLS T SET
     T.ACCSS  = :P_ACCSS
    ,T.ACCSSW = :P_ACCSSW
  WHERE  (T.TB_ID = :Q_TB_ID)
    AND  (T.ID    = :Q_TC_ID);
END
