EXECUTE BLOCK(
  Q_RPT_ID   TYPE OF COLUMN TABL$_TB_DOCSRPT.ID          = ?RPT_ID
 ,Q_ROLE_ID  TYPE OF COLUMN TABL$_USERS_ROLES.ID         = ?ROLE_ID
 ,Q_FLAG     TYPE OF COLUMN TABL$_TB_DOCSRPT.FLAG_DELETE = ?FLAG
)AS
  DECLARE VARIABLE P_POS     TYPE OF COLUMN TABL$_MENU.ID;
  DECLARE VARIABLE P_ROLE_ID TYPE OF COLUMN TABL$_USERS_ROLES.ID;
  DECLARE VARIABLE P_ACCSS   TYPE OF COLUMN TABL$_TB_DOCSRPT.ACCSS;
BEGIN
  SELECT FIRST 1 T.ACCSS FROM TABL$_TB_DOCSRPT T WHERE(T.ID = :Q_RPT_ID)INTO :P_ACCSS;
  FOR SELECT R.ID FROM TABL$_USERS_ROLES R WHERE((R.ID = :Q_ROLE_ID)OR(:Q_ROLE_ID < 0))ORDER BY R.ID INTO :P_ROLE_ID DO
    IF(:Q_FLAG = 1)THEN
      BEGIN
      IF(:P_ACCSS NOT CONTAINING '~'||:P_ROLE_ID||'~')THEN
        BEGIN
        IF(SUBSTRING(:P_ACCSS FROM CHAR_LENGTH(:P_ACCSS) FOR 1) <> '~')THEN
          P_ACCSS = :P_ACCSS||'~';
        P_ACCSS = :P_ACCSS||:P_ROLE_ID||'~';
        END
      END
     ELSE
      BEGIN
      IF(:P_ACCSS CONTAINING '~'||:P_ROLE_ID||'~')THEN
        BEGIN
        P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
        WHILE(:P_POS > 0)DO
          BEGIN
          P_ACCSS = SUBSTRING(:P_ACCSS FROM 1 FOR (:P_POS - 1)) || SUBSTRING(:P_ACCSS FROM (:P_POS + CHAR_LENGTH('~'||:P_ROLE_ID)));
          P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
          END
        END
      END
  UPDATE TABL$_TB_DOCSRPT R SET
    R.ACCSS = :P_ACCSS
  WHERE (R.ID = :Q_RPT_ID);
END
