EXECUTE BLOCK (
   Q_OBJ_ID   TYPE OF COLUMN TABL$_MENU.ID          = ?OBJ_ID
  ,Q_ROLE_ID  TYPE OF COLUMN TABL$_USERS_ROLES.ID   = ?ROLE_ID
  ,Q_FLAG     TYPE OF COLUMN TABL$_MENU.FLAG_DELETE = ?FLAG
)AS
  DECLARE VARIABLE P_ACCSS   TYPE OF COLUMN TABL$_MENU.ACCSS;
  DECLARE VARIABLE P_POS     TYPE OF COLUMN TABL$_MENU.ID;
  DECLARE VARIABLE P_ROLE_ID TYPE OF COLUMN TABL$_USERS_ROLES.ID;
BEGIN
  SELECT FIRST 1 M.ACCSS FROM TABL$_MENU M WHERE(M.ID = :Q_OBJ_ID) INTO :P_ACCSS;
  FOR SELECT R.ID FROM TABL$_USERS_ROLES R WHERE ((R.ID = :Q_ROLE_ID) OR (:Q_ROLE_ID < 0)) ORDER BY R.ID INTO :P_ROLE_ID DO
    IF(:Q_FLAG = 1)THEN
      BEGIN
      IF(:P_ACCSS NOT CONTAINING '~'||:P_ROLE_ID||'~')THEN
        BEGIN
        IF(SUBSTRING(:P_ACCSS FROM CHAR_LENGTH(:P_ACCSS) FOR 1) <> '~')THEN
          P_ACCSS = :P_ACCSS||'~';
        P_ACCSS = :P_ACCSS||:P_ROLE_ID||'~';
        END
      END
     ELSE
      BEGIN
      IF(:P_ACCSS CONTAINING '~'||:P_ROLE_ID||'~')THEN
        BEGIN
        P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
        WHILE(:P_POS > 0)DO
          BEGIN
          P_ACCSS = SUBSTRING(:P_ACCSS FROM 1 FOR (:P_POS - 1)) || SUBSTRING(:P_ACCSS FROM (:P_POS + CHAR_LENGTH('~'||:P_ROLE_ID)));
          P_POS = POSITION('~'||:P_ROLE_ID||'~' IN :P_ACCSS);
          END
        END
      END
  UPDATE TABL$_MENU M SET M.ACCSS = :P_ACCSS WHERE (M.ID = :Q_OBJ_ID);
END
