EXECUTE BLOCK (
   Q_TB_ID           TYPE OF COLUMN TABL$_TB.ID    = ?PQ_TB_ID
  ,Q_USER_VAR        TYPE OF COLUMN TABL$_USERS.ID = ?PQ_USER_VAR
)RETURNS(
   USER_ID           TYPE OF COLUMN TABL$_USERS.ID
  ,TB_ID             TYPE OF COLUMN TABL$_TB.ID
  ,TB_NAME           TYPE OF COLUMN TABL$_TB.NAME
  ,TB_CHILD_TYPE     TYPE OF COLUMN TABL$_TB.BASE_TYPE_ID
  ,TB_CHILD_ID       TYPE OF COLUMN TABL$_TB.ID
  ,TB_CHILD_NAME     TYPE OF COLUMN TABL$_TB.NAME
  ,TB_CHILD_GENR     TYPE OF COLUMN TABL$_TB.GENR
  ,TB_CHILD_GENR_FLD TYPE OF COLUMN TABL$_TB.GENR_FLD
  ,TB_CHILD_HASBLOB  TYPE OF COLUMN TABL$_TB_TYPES.ID
  ,TB_CHILD_ACCSSEL  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_CHILD_ACCSEDT  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_CHILD_ACCSINS  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_CHILD_ACCSUPD  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_CHILD_ACCSDEL  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_CHILD_ACCSPRN  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,INDEX_FIELDS      TYPE OF COLUMN TABL$_TB_CHILDS.INDEX_FIELDS
  ,KEY_FIELDS        TYPE OF COLUMN TABL$_TB_CHILDS.KEY_FIELDS
)AS
  DECLARE VARIABLE P_USERS_ROLES TYPE OF COLUMN TABL$J_4.DOCSTR;
BEGIN
  USER_ID = RDB$GET_CONTEXT('USER_SESSION',:Q_USER_VAR);
  SELECT '~'||LIST(UA.ROLE_ID,'~')||'~' FROM TABL$_USERS_ACCS UA WHERE (UA.USER_ID = :USER_ID)INTO :P_USERS_ROLES;
  TB_ID   = :Q_TB_ID;
  SELECT FIRST 1 T.NAME FROM TABL$_TB T WHERE(T.ID = :TB_ID)INTO :TB_NAME;
  FOR
    SELECT DISTINCT TB.BASE_TYPE_ID, TC.TB_CHILD_ID, TB.NAME, TC.INDEX_FIELDS
          ,TC.KEY_FIELDS, TB.GENR, TB.GENR_FLD
    FROM   TABL$_TB_CHILDS TC, TABL$_TB TB
    WHERE  (TC.TB_ID = :TB_ID)
      AND  (TC.CHILD_TYPE = 1)
      AND  (TC.FLAG_SHOW = 1)
      AND  (TB.ID = TC.TB_CHILD_ID)
    ORDER BY TB.NAME
    INTO   :TB_CHILD_TYPE, :TB_CHILD_ID, :TB_CHILD_NAME, :INDEX_FIELDS
          ,:KEY_FIELDS, :TB_CHILD_GENR, :TB_CHILD_GENR_FLD
  DO 
    IF(EXISTS(
      SELECT R.RDB$RELATION_ID
      FROM   RDB$RELATIONS R
      WHERE  (TRIM(R.RDB$RELATION_NAME) = TRIM(:TB_CHILD_ID) )
    ))THEN
    BEGIN
    TB_CHILD_HASBLOB = 0; TB_CHILD_ACCSSEL = 0; TB_CHILD_ACCSPRN = 0;
    TB_CHILD_ACCSEDT = 0; TB_CHILD_ACCSINS = 0; TB_CHILD_ACCSUPD = 0; TB_CHILD_ACCSDEL = 0;
    SELECT COALESCE(COUNT(TC.ID),0)
    FROM   TABL$_TB_COLS TC
    WHERE  (TC.TB_ID = :TB_CHILD_ID)
      AND  (TC.FIELD_TYPE STARTING WITH 'DOMN$BLOB')
    INTO   :TB_CHILD_HASBLOB;  
    TB_CHILD_ACCSSEL = 0;
    TB_CHILD_ACCSINS = 0;
    TB_CHILD_ACCSUPD = 0;
    TB_CHILD_ACCSDEL = 0;
    TB_CHILD_ACCSPRN = 0;
    SELECT COALESCE(COUNT(TB.ID), 0)
    FROM   TABL$_TB TB, TABL$_USERS_ACCS UA
    WHERE  (TB.ID      = :TB_CHILD_ID)
      AND  (UA.USER_ID = :USER_ID)
      AND  (TB.ACCSS CONTAINING '~'||UA.ROLE_ID||'~')
    INTO   :TB_CHILD_ACCSSEL;
    SELECT COALESCE(COUNT(TB.ID), 0)
    FROM   TABL$_TB TB, TABL$_USERS_ACCS UA
    WHERE  (TB.ID      = :TB_CHILD_ID)
      AND  (UA.USER_ID = :USER_ID)
      AND  (TB.ACCSS_INS CONTAINING '~'||UA.ROLE_ID||'~')
    INTO   :TB_CHILD_ACCSINS;
    SELECT COALESCE(COUNT(TB.ID), 0)
    FROM   TABL$_TB TB, TABL$_USERS_ACCS UA
    WHERE  (TB.ID      = :TB_CHILD_ID)
      AND  (UA.USER_ID = :USER_ID)
      AND  (TB.ACCSS_UPD CONTAINING '~'||UA.ROLE_ID||'~')
    INTO   :TB_CHILD_ACCSUPD;
    SELECT COALESCE(COUNT(TB.ID), 0)
    FROM   TABL$_TB TB, TABL$_USERS_ACCS UA
    WHERE  (TB.ID      = :TB_CHILD_ID)
      AND  (UA.USER_ID = :USER_ID)
      AND  (TB.ACCSS_DEL CONTAINING '~'||UA.ROLE_ID||'~')
    INTO   :TB_CHILD_ACCSDEL;
    SELECT COALESCE(COUNT(TB.ID), 0)
    FROM   TABL$_TB TB, TABL$_USERS_ACCS UA
    WHERE  (TB.ID      = :TB_CHILD_ID)
      AND  (UA.USER_ID = :USER_ID)
      AND  (TB.ACCSS_PRINT CONTAINING '~'||UA.ROLE_ID||'~')
    INTO   :TB_CHILD_ACCSPRN;
    TB_CHILD_ACCSEDT = :TB_CHILD_ACCSINS + :TB_CHILD_ACCSUPD + :TB_CHILD_ACCSDEL;
    IF(:TB_CHILD_ACCSSEL > 0)THEN
      BEGIN
      IF(POSITION(UPPER(:TB_NAME) IN UPPER(:TB_CHILD_NAME)) = 1)THEN
        TB_CHILD_NAME = SUBSTRING(:TB_CHILD_NAME FROM CHAR_LENGTH(:TB_NAME)+1);
      WHILE((:TB_CHILD_NAME STARTING WITH ':') OR (:TB_CHILD_NAME STARTING WITH ' ')  OR (:TB_CHILD_NAME STARTING WITH '/'))DO
        TB_CHILD_NAME = SUBSTRING(:TB_CHILD_NAME FROM 2);
      SUSPEND;
      END
    END
END
