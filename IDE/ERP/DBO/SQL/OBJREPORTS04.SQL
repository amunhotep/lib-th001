EXECUTE BLOCK(
  Q_OBJ_ID    TYPE OF COLUMN TABL$_TB_DOCSRPT.OBJ_ID  = ?OBJ_ID
 ,Q_USER_ID   TYPE OF COLUMN TABL$_USERS.ID           = ?USER_ID
 ,Q_SUBTYPE   TYPE OF COLUMN TABL$_TB_DOCSRPT.SUBTYPE = ?SUBTYPE
)RETURNS(
  TYPE_ID     TYPE OF COLUMN TABL$_TB_TYPES.ID
 ,TYPE_NAME   TYPE OF COLUMN TABL$_TB_TYPES.NAME2
 ,ID          TYPE OF COLUMN TABL$_TB_DOCSRPT.ID
 ,NAME        TYPE OF COLUMN TABL$_TB_DOCSRPT.NAME
 ,FLAG_DELETE TYPE OF COLUMN TABL$_TB_DOCSRPT.FLAG_DELETE
 ,ORDERID     TYPE OF COLUMN TABL$_TB_DOCSRPT.ORDERID
 ,SUBTYPE     TYPE OF COLUMN TABL$_TB_DOCSRPT.SUBTYPE
 ,PATH        TYPE OF COLUMN TABL$_TB_DOCSRPT.PATH
 ,DESCR       TYPE OF COLUMN TABL$_TB_DOCSRPT.DESCR
)AS
  DECLARE VARIABLE P_TYPE_ID TYPE OF COLUMN TABL$_TB_DOCSRPT.OBJ_ID;
  DECLARE VARIABLE P_ACCSS   TYPE OF COLUMN TABL$_TB_DOCSRPT.ID;
BEGIN
  SELECT FIRST 1 TB.ID, TB.NAME2
  FROM   TABL$_TB_TYPES TB
  WHERE  (TB.ID = :Q_OBJ_ID)
  INTO   :TYPE_ID, :TYPE_NAME;

  FOR
    SELECT TMP.ID
    FROM   (WITH RECURSIVE TTT AS(
              SELECT T1.ID, T1.PARENT_ID FROM TABL$_TB_TYPES T1         WHERE(T1.ID = :TYPE_ID)
              UNION ALL
              SELECT T2.ID, T2.PARENT_ID FROM TABL$_TB_TYPES T2, TTT T3 WHERE(T2.ID = T3.PARENT_ID)
            )SELECT TN.ID FROM TTT TN
           )TMP
    INTO   :P_TYPE_ID
  DO
    FOR
      SELECT R.ID, R.NAME, R.FLAG_DELETE, R.ORDERID, R.SUBTYPE, R.PATH, R.DESCR
      FROM   TABL$_TB_DOCSRPT R
      WHERE  (TRIM(R.OBJ_ID) = :P_TYPE_ID)
        AND  (R.SUBTYPE = :Q_SUBTYPE)
        AND  ( (R.FLAG_DELETE = 0) OR (R.FLAG_DELETE IS NULL) )
      ORDER BY R.ORDERID ASCENDING, R.NAME ASCENDING
      INTO   :ID, :NAME, :FLAG_DELETE, :ORDERID, :SUBTYPE, :PATH, :DESCR
    DO
      BEGIN
      P_ACCSS = 0;
      SELECT COALESCE(COUNT(R.ID),0)
      FROM   TABL$_TB_DOCSRPT R, TABL$_USERS_ACCS UA
      WHERE  (R.ID       = :ID)
        AND  (UA.USER_ID = :Q_USER_ID)
        AND  (R.ACCSS CONTAINING '~'||UA.ROLE_ID||'~')
      INTO   :P_ACCSS;
      IF(:P_ACCSS > 0)THEN SUSPEND;
      END
END
