EXECUTE BLOCK (
   Q_TYPE_ID  TYPE OF COLUMN TABL$_TB_TYPES.ID = ?PQ_TYPE_ID 
  ,Q_USER_VAR TYPE OF COLUMN TABL$_USERS.ID    = ?PQ_USER_VAR
)RETURNS ( 
   TB_ID      TYPE OF COLUMN TABL$_TB.ID
  ,TB_NAME    TYPE OF COLUMN TABL$_TB.NAME
  ,BUFFER_VAR TYPE OF COLUMN TABL$_TB.BUFFER_VAR
)AS
  DECLARE VARIABLE P_SQL        DOMN$BLOB_SQL;
  DECLARE VARIABLE P_TYPE_IDS   DOMN$BLOB_TEXT;
  DECLARE VARIABLE P_JRNL_TABLE TYPE OF COLUMN TABL$_TB.ID;
BEGIN 
  SELECT FIRST 1 T1.ID
  FROM   TABL$_TB T1
  WHERE  (T1.TYPE_ID     = 4)
    AND  (T1.FLAG_MASTER = 1)
  INTO   :P_JRNL_TABLE;

  WITH RECURSIVE DOCTREE AS(
    SELECT DOCTREE1.ID, DOCTREE1.PARENT_ID FROM TABL$_TB_TYPES DOCTREE1 WHERE (DOCTREE1.ID = :Q_TYPE_ID)
    UNION ALL
    SELECT DOCTREE2.ID, DOCTREE2.PARENT_ID FROM TABL$_TB_TYPES DOCTREE2, DOCTREE DOCTREE3 WHERE (DOCTREE2.ID = DOCTREE3.PARENT_ID)
  )SELECT FIRST 1 '~'||LIST(DTR.ID,'~')||'~' FROM DOCTREE DTR INTO :P_TYPE_IDS;

  IF(NOT(EXISTS(
    SELECT RF.RDB$FIELD_ID
    FROM   RDB$RELATION_FIELDS RF
    WHERE  (TRIM(RF.RDB$RELATION_NAME) = 'TABL$_TB_CHILDS')
      AND  (TRIM(RF.RDB$FIELD_NAME) = 'TYPE_ID')
  )))THEN
    BEGIN
    P_SQL =
      'SELECT TB.ID, TB.NAME, TB.BUFFER_VAR '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'FROM   TABL$_TB TB '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'WHERE  ('''||:P_TYPE_IDS||''' CONTAINING ''~''||TB.TYPE_ID||''~'') '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  AND  (TB.FLAG_MASTER = 0) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  AND  (TB.BASE_TYPE_ID = 4) ';
    END
   ELSE
    BEGIN
    P_SQL =
      'SELECT DISTINCT T.ID, T.NAME, T.BUFFER_VAR FROM ('||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  SELECT TB.ID, TB.NAME, TB.BUFFER_VAR '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  FROM   TABL$_TB TB '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  WHERE  ('''||:P_TYPE_IDS||''' CONTAINING ''~''||TB.TYPE_ID||''~'') '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  (TB.FLAG_MASTER = 0) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  (TB.BASE_TYPE_ID = 4) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  UNION ALL '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  SELECT TC.TB_CHILD_ID, T1.NAME, T1.BUFFER_VAR '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  FROM   TABL$_TB_CHILDS TC, TABL$_TB T1 '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  WHERE  (TC.CHILD_TYPE = 2) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  (TC.FLAG_SHOW  = 1) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  ('''||:P_TYPE_IDS||''' CONTAINING ''~''||TC.TYPE_ID||''~'') '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  (TC.TB_ID = '''||:P_JRNL_TABLE||''') '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    AND  (T1.ID = TC.TB_CHILD_ID) '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      ')T ';
    END
  FOR EXECUTE STATEMENT :P_SQL INTO :TB_ID, :TB_NAME, :BUFFER_VAR DO SUSPEND;
END
