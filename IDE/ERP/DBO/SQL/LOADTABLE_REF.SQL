EXECUTE BLOCK (
   Q_TB_ID               TYPE OF COLUMN TABL$_TB.ID    = ?PQ_TB_ID
  ,Q_USER_VAR            TYPE OF COLUMN TABL$_USERS.ID = ?PQ_USER_VAR
)RETURNS (
   USER_ID               TYPE OF COLUMN TABL$_USERS.ID
  ,TB_EXISTS             TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_REL_EXISTS         TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_FLAG_EXTERNAL      TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_FLAG_MOVE          TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_SEL_CNT       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_INS_CNT       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_UPD_CNT       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_DEL_CNT       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_EDIT_CNT      TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_ACCS_PRN_CNT       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_TYPE_ID            TYPE OF COLUMN TABL$_TB.TYPE_ID
  ,TB_BASE_TYPE_ID       TYPE OF COLUMN TABL$_TB.BASE_TYPE_ID
  ,TB_ID                 TYPE OF COLUMN TABL$_TB.ID
  ,TB_NAME               TYPE OF COLUMN TABL$_TB.NAME
  ,TB_FLAG_DELETE        TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,TB_TREE               TYPE OF COLUMN TABL$_TB.TREE
  ,TB_GENR               TYPE OF COLUMN TABL$_TB.GENR
  ,TB_GENR_FLD           TYPE OF COLUMN TABL$_TB.GENR_FLD
  ,TB_BUFFER_VAR         TYPE OF COLUMN TABL$_TB.BUFFER_VAR
  ,TB_DLG_HEIGHT         TYPE OF COLUMN TABL$_TB.DLG_HEIGHT
  ,TB_DLG_WIDTH          TYPE OF COLUMN TABL$_TB.DLG_WIDTH
  ,TB_SC_ITEM            TYPE OF COLUMN TABL$_TB.SC_ITEM
  ,TB_SC_REF             TYPE OF COLUMN TABL$_TB.SC_REF
  ,TB_SC_ITEM_DLG        TYPE OF COLUMN TABL$_TB.SC_ITEM_DLG
  ,TB_SC_REF_DLG         TYPE OF COLUMN TABL$_TB.SC_REF_DLG
  ,TB_FLAG_FORM          TYPE OF COLUMN TABL$_TB.FLAG_FORM
  ,TB_FLAG_MASTER        TYPE OF COLUMN TABL$_TB.FLAG_MASTER
  ,TB_ROOT_PARENT_ID     TYPE OF COLUMN TABL$_TB.ROOT_PARENT_ID
  ,TB_STATE_FIELDNAME    TYPE OF COLUMN TABL$_TB.STATE_FIELDNAME
  ,TB_FLAG_SHOW_ITEM_ID  TYPE OF COLUMN TABL$_TB.FLAG_SHOW_ITEM_ID
  ,TB_FLAG_SHOWGROUPBAR  TYPE OF COLUMN TABL$_TB.FLAG_SHOWGROUPBAR
  ,TB_FLAG_EDITINGRID    TYPE OF COLUMN TABL$_TB.FLAG_EDITINGRID
  ,TB_CHILD_COUNT        TYPE OF COLUMN TABL$_TB.TYPE_ID
  ,TB_BLOB_COUNT         TYPE OF COLUMN TABL$_TB.TYPE_ID
  ,PARENTTB_EXISTS       TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,PARENTTB_ID           TYPE OF COLUMN TABL$_TB.ID
  ,PARENTTB_NAME         TYPE OF COLUMN TABL$_TB.NAME
  ,PARENTTB_INDEX_FIELDS TYPE OF COLUMN TABL$_TB_CHILDS.INDEX_FIELDS
  ,PARENTTB_KEY_FIELDS   TYPE OF COLUMN TABL$_TB_CHILDS.KEY_FIELDS
  ,PARENTTB_SC_REF_DLG   TYPE OF COLUMN TABL$_TB.SC_REF_DLG
  ,PARENTTB_BUFFER_VAR   TYPE OF COLUMN TABL$_TB.BUFFER_VAR
  ,GROUPTB_EXISTS        TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,GROUPTB_ID            TYPE OF COLUMN TABL$_TB.ID
  ,GROUPTB_INDEX_FIELDS  TYPE OF COLUMN TABL$_TB_CHILDS.INDEX_FIELDS
  ,GROUPTB_KEY_FIELDS    TYPE OF COLUMN TABL$_TB_CHILDS.KEY_FIELDS
  ,GROUPTB_BUFFER_VAR    TYPE OF COLUMN TABL$_TB.BUFFER_VAR
  ,GROUPTB_ROOT_ID       TYPE OF COLUMN TABL$_TB.ROOT_PARENT_ID
  ,GROUPTB_SHOWID        TYPE OF COLUMN TABL$_TB.FLAG_SHOW_ITEM_ID
  ,GROUPTB_ACCS_SEL_CNT  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,GROUPTB_ACCS_INS_CNT  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,GROUPTB_ACCS_UPD_CNT  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
  ,GROUPTB_ACCS_DEL_CNT  TYPE OF COLUMN TABL$_TB.FLAG_DELETE
)AS 
  DECLARE VARIABLE P_ROLE_ID TYPE OF COLUMN TABL$_USERS_ROLES.ID;
  DECLARE VARIABLE P_ACCS    TYPE OF COLUMN TABL$_TB.FLAG_DELETE;
BEGIN
  USER_ID          = RDB$GET_CONTEXT('USER_SESSION',:Q_USER_VAR);
  TB_EXISTS        = 0;
  TB_REL_EXISTS    = 0;
  TB_FLAG_MOVE     = 0;
  TB_ACCS_SEL_CNT  = 0;
  TB_CHILD_COUNT   = 0;
  TB_FLAG_EXTERNAL = 0;
  IF(NOT(EXISTS(SELECT TB.ID FROM TABL$_TB TB WHERE(TB.ID = :Q_TB_ID))))THEN 
    BEGIN 
    SUSPEND; 
    EXIT; 
    END 
  TB_EXISTS = 1;
  IF(NOT(    EXISTS(SELECT R.RDB$RELATION_ID  FROM RDB$RELATIONS  R WHERE(TRIM(R.RDB$RELATION_NAME ) = :Q_TB_ID))
          OR EXISTS(SELECT P.RDB$PROCEDURE_ID FROM RDB$PROCEDURES P WHERE(TRIM(P.RDB$PROCEDURE_NAME) = :Q_TB_ID))
  ))THEN
    BEGIN 
    SUSPEND; 
    EXIT; 
    END 
  TB_REL_EXISTS   = 1;
  TB_ACCS_SEL_CNT = 0;
  TB_ACCS_INS_CNT = 0;
  TB_ACCS_UPD_CNT = 0;
  TB_ACCS_DEL_CNT = 0;
  TB_ACCS_PRN_CNT = 0;
  FOR
    SELECT DISTINCT UA.ROLE_ID
    FROM   TABL$_USERS_ACCS UA
    WHERE  (UA.USER_ID = :USER_ID)
    INTO   :P_ROLE_ID
  DO
    BEGIN
    P_ACCS = 0;
    SELECT COALESCE(COUNT(TB.ID),0)
    FROM   TABL$_TB TB
    WHERE  (TB.ID = :Q_TB_ID)
      AND  (TB.ACCSS CONTAINING '~'||:P_ROLE_ID||'~')
    INTO   :P_ACCS; TB_ACCS_SEL_CNT = :TB_ACCS_SEL_CNT + :P_ACCS;
    P_ACCS = 0;
    SELECT COALESCE(COUNT(TB.ID),0)
    FROM   TABL$_TB TB
    WHERE  (TB.ID = :Q_TB_ID)
      AND  (TB.ACCSS_INS CONTAINING '~'||:P_ROLE_ID||'~')
    INTO   :P_ACCS; TB_ACCS_INS_CNT = :TB_ACCS_INS_CNT + :P_ACCS;
    P_ACCS = 0;
    SELECT COALESCE(COUNT(TB.ID),0)
    FROM   TABL$_TB TB
    WHERE  (TB.ID = :Q_TB_ID)
      AND  (TB.ACCSS_UPD CONTAINING '~'||:P_ROLE_ID||'~')
    INTO   :P_ACCS; TB_ACCS_UPD_CNT = :TB_ACCS_UPD_CNT + :P_ACCS;
    P_ACCS = 0;
    SELECT COALESCE(COUNT(TB.ID),0)
    FROM   TABL$_TB TB
    WHERE  (TB.ID = :Q_TB_ID)
      AND  (TB.ACCSS_DEL CONTAINING '~'||:P_ROLE_ID||'~')
    INTO   :P_ACCS; TB_ACCS_DEL_CNT = :TB_ACCS_DEL_CNT + :P_ACCS;
    P_ACCS = 0;
    SELECT COALESCE(COUNT(TB.ID),0)
    FROM   TABL$_TB TB
    WHERE  (TB.ID = :Q_TB_ID)
      AND  (TB.ACCSS_PRINT CONTAINING '~'||:P_ROLE_ID||'~')
    INTO   :P_ACCS; TB_ACCS_PRN_CNT = :TB_ACCS_PRN_CNT + :P_ACCS;
    END
  TB_ACCS_EDIT_CNT = :TB_ACCS_INS_CNT + :TB_ACCS_UPD_CNT + :TB_ACCS_DEL_CNT;
  SELECT FIRST 1 T.TYPE_ID, T.BASE_TYPE_ID, T.ID, T.NAME, T.FLAG_DELETE, T.TREE, T.GENR, T.GENR_FLD, T.BUFFER_VAR,
         T.DLG_HEIGHT, T.DLG_WIDTH, T.SC_ITEM, T.SC_REF, T.SC_ITEM_DLG, T.SC_REF_DLG, 
         T.FLAG_FORM, T.FLAG_MASTER, T.ROOT_PARENT_ID, T.STATE_FIELDNAME, 
         T.FLAG_SHOW_ITEM_ID, T.FLAG_SHOWGROUPBAR, T.FLAG_EDITINGRID 
  FROM   TABL$_TB T 
  WHERE  (T.ID = :Q_TB_ID) 
  INTO   :TB_TYPE_ID, :TB_BASE_TYPE_ID, :TB_ID, :TB_NAME, :TB_FLAG_DELETE, :TB_TREE, :TB_GENR, :TB_GENR_FLD,
         :TB_BUFFER_VAR, :TB_DLG_HEIGHT, :TB_DLG_WIDTH, :TB_SC_ITEM, :TB_SC_REF, 
         :TB_SC_ITEM_DLG, :TB_SC_REF_DLG, :TB_FLAG_FORM, :TB_FLAG_MASTER, 
         :TB_ROOT_PARENT_ID, :TB_STATE_FIELDNAME, :TB_FLAG_SHOW_ITEM_ID, 
         :TB_FLAG_SHOWGROUPBAR, :TB_FLAG_EDITINGRID; 
  PARENTTB_EXISTS = 0; 
  IF(EXISTS(SELECT TBC.TB_ID FROM TABL$_TB_CHILDS TBC WHERE(TBC.TB_CHILD_ID = :TB_ID)AND(TBC.CHILD_TYPE = 1)))THEN 
    BEGIN 
    PARENTTB_EXISTS = 1; 
    SELECT FIRST 1 TBC.TB_ID, TBC.INDEX_FIELDS, TBC.KEY_FIELDS, T.NAME, T.BUFFER_VAR, T.SC_REF_DLG 
    FROM   TABL$_TB_CHILDS TBC, TABL$_TB T 
    WHERE  (TBC.TB_CHILD_ID = :TB_ID) 
      AND  (TBC.CHILD_TYPE = 1) 
      AND  (T.ID = TBC.TB_ID) 
    INTO   :PARENTTB_ID, :PARENTTB_INDEX_FIELDS, :PARENTTB_KEY_FIELDS, 
           :PARENTTB_NAME, :PARENTTB_BUFFER_VAR, :PARENTTB_SC_REF_DLG; 
    END 
  GROUPTB_EXISTS = 0; 
  IF(EXISTS(SELECT TBC.TB_ID FROM TABL$_TB_CHILDS TBC WHERE(TBC.TB_CHILD_ID = :TB_ID)AND(TBC.CHILD_TYPE = 4)))THEN 
    BEGIN 
    GROUPTB_EXISTS = 1; 
    SELECT FIRST 1 TBC.TB_ID, TBC.INDEX_FIELDS, TBC.KEY_FIELDS, T.BUFFER_VAR, T.ROOT_PARENT_ID, T.FLAG_SHOW_ITEM_ID 
    FROM   TABL$_TB_CHILDS TBC, TABL$_TB T 
    WHERE  (TBC.TB_CHILD_ID = :TB_ID) 
      AND  (TBC.CHILD_TYPE  = 4) 
      AND  (T.ID            = TBC.TB_ID) 
    INTO   :GROUPTB_ID, :GROUPTB_INDEX_FIELDS, :GROUPTB_KEY_FIELDS, :GROUPTB_BUFFER_VAR, :GROUPTB_ROOT_ID, :GROUPTB_SHOWID; 
    GROUPTB_ACCS_SEL_CNT = 0;
    GROUPTB_ACCS_INS_CNT = 0;
    GROUPTB_ACCS_UPD_CNT = 0;
    GROUPTB_ACCS_DEL_CNT = 0;
    FOR
      SELECT DISTINCT UA.ROLE_ID
      FROM   TABL$_USERS_ACCS UA
      WHERE  (UA.USER_ID = :USER_ID)
      INTO   :P_ROLE_ID
    DO
      BEGIN
      P_ACCS = 0;
      SELECT COALESCE(COUNT(TB.ID),0)
      FROM   TABL$_TB TB
      WHERE  (TB.ID = :GROUPTB_ID)
        AND  (TB.ACCSS CONTAINING '~'||:P_ROLE_ID||'~')
      INTO   :P_ACCS; GROUPTB_ACCS_SEL_CNT = :GROUPTB_ACCS_SEL_CNT + :P_ACCS;
      P_ACCS = 0;
      SELECT COALESCE(COUNT(TB.ID),0)
      FROM   TABL$_TB TB
      WHERE  (TB.ID = :GROUPTB_ID)
        AND  (TB.ACCSS_INS CONTAINING '~'||:P_ROLE_ID||'~')
      INTO   :P_ACCS; GROUPTB_ACCS_INS_CNT = :GROUPTB_ACCS_INS_CNT + :P_ACCS;
      P_ACCS = 0;
      SELECT COALESCE(COUNT(TB.ID),0)
      FROM   TABL$_TB TB
      WHERE  (TB.ID = :GROUPTB_ID)
        AND  (TB.ACCSS_UPD CONTAINING '~'||:P_ROLE_ID||'~')
      INTO   :P_ACCS; GROUPTB_ACCS_UPD_CNT = :GROUPTB_ACCS_UPD_CNT + :P_ACCS;
      P_ACCS = 0;
      SELECT COALESCE(COUNT(TB.ID),0)
      FROM   TABL$_TB TB
      WHERE  (TB.ID = :GROUPTB_ID)
        AND  (TB.ACCSS_DEL CONTAINING '~'||:P_ROLE_ID||'~')
      INTO   :P_ACCS; GROUPTB_ACCS_DEL_CNT = :GROUPTB_ACCS_DEL_CNT + :P_ACCS;
      END
    END

  SELECT COALESCE(COUNT(DISTINCT TC.TB_CHILD_ID),0)
  FROM   TABL$_TB_CHILDS TC, TABL$_TB TB, TABL$_USERS_ACCS UA
  WHERE  (TC.TB_ID       = :TB_ID)
    AND  (TB.ID          = TC.TB_CHILD_ID)
    AND  (TB.ACCSS CONTAINING '~'||UA.ROLE_ID||'~')
    AND  (UA.USER_ID     = :USER_ID)
  INTO   :TB_CHILD_COUNT;

  SELECT COALESCE(COUNT(DISTINCT TC.ID),0)
  FROM   TABL$_TB_COLS TC, TABL$_USERS_ACCS UA
  WHERE  (TC.TB_ID     = :TB_ID)
    AND  (TC.FIELD_TYPE STARTING WITH 'DOMN$BLOB')
    AND  (TC.ACCSS CONTAINING '~'||UA.ROLE_ID||'~')
    AND  (UA.USER_ID   = :USER_ID)
  INTO   :TB_BLOB_COUNT;

  IF(EXISTS(SELECT E.ID FROM TABL$_EXCHANGE E WHERE(E.TB_ID = :TB_ID)))THEN
    TB_FLAG_EXTERNAL = 1;
  IF(:TB_BASE_TYPE_ID = 6)THEN
    BEGIN
    WITH RECURSIVE TTB AS(
        SELECT TT1.ID, TT1.PARENT_ID FROM TABL$_TB_TYPES TT1 WHERE (TT1.ID = :TB_TYPE_ID)
        UNION ALL
        SELECT TT2.ID, TT2.PARENT_ID FROM TABL$_TB_TYPES TT2, TTB TT3 WHERE (TT2.ID = TT3.PARENT_ID)
    )SELECT COALESCE(COUNT(T1.ID),0) FROM TTB T1 WHERE (T1.ID = 1000031) INTO :TB_FLAG_MOVE;
    END
  SUSPEND;
END
