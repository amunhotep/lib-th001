-- PEAKTOP:IDE/ERP/DBO/SQL/TRIGGERS/CHECK_FOR_TREETABLES.SQL
EXECUTE BLOCK AS
  DECLARE VARIABLE P_RELATION_NAME DOMN$PSTRING;
  DECLARE VARIABLE P_TRIGGER_NAME  DOMN$PSTRING;
  DECLARE VARIABLE P_CONDITION     DOMN$PSTRING;
  DECLARE VARIABLE P_CNT           DOMN$INTEGER;
  DECLARE VARIABLE P_SQL           DOMN$BLOB_SQL;
BEGIN
  FOR
    SELECT DISTINCT TRIM(F.RDB$RELATION_NAME)
          ,(SELECT COUNT(FF.RDB$FIELD_NAME)
            FROM   RDB$RELATION_FIELDS FF
            WHERE  (FF.RDB$RELATION_NAME = F.RDB$RELATION_NAME)
              AND  (TRIM(FF.RDB$FIELD_NAME) = 'PATH')
            )
    FROM   RDB$RELATION_FIELDS F
    WHERE  (TRIM(F.RDB$FIELD_NAME) = 'PARENT_ID')
      AND  (F.RDB$RELATION_NAME STARTING WITH 'TABL$')
    INTO   :P_RELATION_NAME, :P_CNT
  DO
    BEGIN
    P_CONDITION = '(NEW.ID <> OLD.ID)';
    IF(:P_CNT > 0)THEN
      BEGIN
      P_CONDITION = '( (NEW.ID <> OLD.ID) OR (NEW.NAME <> OLD.NAME) )';
      END
    -- UPDATE TRIGGER
    P_TRIGGER_NAME = SUBSTRING(:P_RELATION_NAME FROM 5);
    P_TRIGGER_NAME = 'TRIG'||:P_TRIGGER_NAME;
    IF(CHAR_LENGTH(:P_TRIGGER_NAME) > 24)THEN
      P_TRIGGER_NAME = SUBSTRING(:P_TRIGGER_NAME FROM 1 FOR 24);
    P_SQL =
      'CREATE OR ALTER TRIGGER '||:P_TRIGGER_NAME||'_AU_245 FOR '||:P_RELATION_NAME||' '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'ACTIVE AFTER UPDATE POSITION 245 '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'AS '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'BEGIN '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  IF'||:P_CONDITION||'THEN '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    UPDATE '||:P_RELATION_NAME||' R001 SET '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '      R001.PARENT_ID = NEW.ID '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '    WHERE (R001.PARENT_ID = OLD.ID); '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'END';
    EXECUTE STATEMENT :P_SQL;
    -- DELETE TRIGGER
    P_TRIGGER_NAME = SUBSTRING(:P_RELATION_NAME FROM 5);
    P_TRIGGER_NAME = 'TRIG'||:P_TRIGGER_NAME;
    IF(CHAR_LENGTH(:P_TRIGGER_NAME) > 24)THEN
      P_TRIGGER_NAME = SUBSTRING(:P_TRIGGER_NAME FROM 1 FOR 24);
    P_SQL =
      'CREATE OR ALTER TRIGGER '||:P_TRIGGER_NAME||'_BD_245 FOR '||:P_RELATION_NAME||' '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'ACTIVE BEFORE DELETE POSITION 245 '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'AS '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'BEGIN '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      '  DELETE FROM '||:P_RELATION_NAME||' R001 WHERE (R001.PARENT_ID = OLD.ID); '||ASCII_CHAR(13)||ASCII_CHAR(10)||
      'END';
    EXECUTE STATEMENT :P_SQL;
    END
END
