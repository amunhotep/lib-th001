EXECUTE BLOCK (
  Q_OBJECT_GUID TYPE OF COLUMN TABL$_BUFFER.NAME = ?PQ_OBJECT_GUID
 ,Q_OBJECT_NAME TYPE OF COLUMN TABL$_TB.ID       = ?PQ_OBJECT_NAME
 ,Q_USER_VAR    TYPE OF COLUMN TABL$_USERS.ID    = ?PQ_USER_VAR
) RETURNS(
  TB_ID         TYPE OF COLUMN TABL$_TB.ID
 ,TB_NAME       TYPE OF COLUMN TABL$_TB.NAME
 ,ID            TYPE OF COLUMN TABL$_BUFFER.OBJ_ID
 ,NAME          TYPE OF COLUMN TABL$_BUFFER.OBJ_ID
 ,FLAG_DELETE   TYPE OF COLUMN TABL$_BUFFER.FLAG_DELETE
 ,USER_ID       TYPE OF COLUMN TABL$_BUFFER.USER_ID
 ,B_ID          TYPE OF COLUMN TABL$_BUFFER.ID
 ,B_NAME        TYPE OF COLUMN TABL$_BUFFER.NAME
)AS
  DECLARE VARIABLE P_SQL_STMT DOMN$BLOB_SQL;
BEGIN
  TB_ID = :Q_OBJECT_NAME;
  SELECT FIRST 1 T1.NAME FROM TABL$_TB T1 WHERE (T1.ID = :TB_ID)INTO :TB_NAME;
  USER_ID = RDB$GET_CONTEXT('USER_SESSION',:Q_USER_VAR);
/*
  IF(NOT(EXISTS(
    SELECT B.ID
    FROM   TABL$_BUFFER B
    WHERE  (B.OBJ_NAME= :TB_ID)
      AND  (B.USER_ID = :USER_ID)
      AND  (B.NAME    = :Q_OBJECT_GUID)
  )))THEN
    BEGIN
    P_SQL_STMT = 'SELECT T1.ID FROM '||:TB_ID||' T1 ORDER BY T1.ID ';
    FOR EXECUTE STATEMENT :P_SQL_STMT INTO :ID DO
      INSERT INTO TABL$_BUFFER(NAME, FLAG_DELETE, USER_ID, OBJ_NAME, OBJ_ID)
        VALUES(:Q_OBJECT_GUID, 1, :USER_ID,:TB_ID,:ID);
    END
*/
  IF(UPPER(TRIM(:USER_ID)) = 'MANAGER')THEN
    BEGIN
    IF(UPPER(TRIM(:TB_ID)) IN ('TABL$R_FIRMS'))THEN
      BEGIN
      FOR
        SELECT B.ID, B.NAME, B.FLAG_DELETE, B.OBJ_ID
        FROM   TABL$_BUFFER B
        WHERE  (B.OBJ_NAME= :TB_ID)
          AND  (B.USER_ID = :USER_ID)
          AND  (B.NAME    = :Q_OBJECT_GUID)
          AND  (B.OBJ_ID  = '0')
        INTO   :B_ID, :B_NAME, :FLAG_DELETE, :ID
      DO
        BEGIN
        P_SQL_STMT = 'SELECT FIRST 1 T1.NAME FROM '||:TB_ID||' T1 WHERE( T1.ID = '''||:ID||''') ';
        EXECUTE STATEMENT :P_SQL_STMT INTO :NAME;
        SUSPEND;
        END
      END
     ELSE
      FOR
        SELECT B.ID, B.NAME, B.FLAG_DELETE, B.OBJ_ID
        FROM   TABL$_BUFFER B
        WHERE  (B.OBJ_NAME= :TB_ID)
          AND  (B.USER_ID = :USER_ID)
          AND  (B.NAME    = :Q_OBJECT_GUID)
        ORDER BY B.OBJ_ID 
        INTO   :B_ID, :B_NAME, :FLAG_DELETE, :ID
      DO
        BEGIN
        P_SQL_STMT = 'SELECT FIRST 1 T1.NAME FROM '||:TB_ID||' T1 WHERE( T1.ID = '''||:ID||''') ';
        EXECUTE STATEMENT :P_SQL_STMT INTO :NAME;
        SUSPEND;
        END
    END
   ELSE
    FOR
      SELECT B.ID, B.NAME, B.FLAG_DELETE, B.OBJ_ID
      FROM   TABL$_BUFFER B
      WHERE  (B.OBJ_NAME= :TB_ID)
        AND  (B.USER_ID = :USER_ID)
        AND  (B.NAME    = :Q_OBJECT_GUID)
      ORDER BY B.OBJ_ID 
      INTO   :B_ID, :B_NAME, :FLAG_DELETE, :ID
    DO
      BEGIN
      P_SQL_STMT = 'SELECT FIRST 1 T1.NAME FROM '||:TB_ID||' T1 WHERE( T1.ID = '''||:ID||''') ';
      EXECUTE STATEMENT :P_SQL_STMT INTO :NAME;
      SUSPEND;
      END
END
